<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>MRI | Research Documentation for VIRTEM</title>
  <meta name="description" content="Documentation for bookdown" />
  <meta name="generator" content="bookdown 0.19 and GitBook 2.6.7" />

  <meta property="og:title" content="MRI | Research Documentation for VIRTEM" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://seankross.com/bookdown-start/" />
  
  <meta property="og:description" content="Documentation for bookdown" />
  <meta name="github-repo" content="jacbel/virtem_code" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="MRI | Research Documentation for VIRTEM" />
  
  <meta name="twitter:description" content="Documentation for bookdown" />
  

<meta name="author" content="Jacob Bellmund" />


<meta name="date" content="2021-03-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="prepare-behavioral-data.html"/>
<link rel="next" href="rsa-searchlight.html"/>
<script src="libs/header-attrs-2.3/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Purpose</a></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html"><i class="fa fa-check"></i>Analysis Setup</a>
<ul>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#defining-general-variables-and-folders"><i class="fa fa-check"></i>Defining general variables and folders</a>
<ul>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#folder-structure"><i class="fa fa-check"></i>Folder Structure</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#define-analysis-functions"><i class="fa fa-check"></i>Define Analysis Functions</a>
<ul>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#analysis-logic"><i class="fa fa-check"></i>Analysis Logic</a></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#rsa-on-pattern-similarity-change-illustration"><i class="fa fa-check"></i>RSA on Pattern Similarity Change Illustration</a></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#brain-plots-in-ggplot"><i class="fa fa-check"></i>Brain Plots in ggplot</a></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#ggbrain-functions-to-get-template-background"><i class="fa fa-check"></i>ggBrain functions to get template background</a></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#waiting-for-cluster-jobs"><i class="fa fa-check"></i>Waiting for Cluster Jobs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="design-day-learning-task.html"><a href="design-day-learning-task.html"><i class="fa fa-check"></i>Design Day Learning Task</a>
<ul>
<li class="chapter" data-level="" data-path="design-day-learning-task.html"><a href="design-day-learning-task.html#load-design-files"><i class="fa fa-check"></i>Load design files</a></li>
<li class="chapter" data-level="" data-path="design-day-learning-task.html"><a href="design-day-learning-task.html#plots-to-illustrate-design"><i class="fa fa-check"></i>Plots to illustrate design</a>
<ul>
<li class="chapter" data-level="" data-path="design-day-learning-task.html"><a href="design-day-learning-task.html#design-over-view-plot"><i class="fa fa-check"></i>Design over view plot</a></li>
<li class="chapter" data-level="" data-path="design-day-learning-task.html"><a href="design-day-learning-task.html#virtual-time-for-each-event-on-each-of-the-four-days"><i class="fa fa-check"></i>Virtual time for each event on each of the four days</a></li>
<li class="chapter" data-level="" data-path="design-day-learning-task.html"><a href="design-day-learning-task.html#scanner-time-for-each-event-on-each-of-the-four-days"><i class="fa fa-check"></i>Scanner time for each event on each of the four days</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html"><i class="fa fa-check"></i>Prepare behavioral data</a>
<ul>
<li class="chapter" data-level="" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html#prepare-design-table"><i class="fa fa-check"></i>Prepare design table</a></li>
<li class="chapter" data-level="" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html#prepare-data-from-the-day-sorting-task"><i class="fa fa-check"></i>Prepare data from the day sorting task</a></li>
<li class="chapter" data-level="" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html#prepare-data-from-the-timeline-task"><i class="fa fa-check"></i>Prepare data from the timeline task</a></li>
<li class="chapter" data-level="" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html#combine-data-across-subjects"><i class="fa fa-check"></i>Combine data across subjects</a></li>
<li class="chapter" data-level="" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html#check-behavior-in-picture-viewing-tasks"><i class="fa fa-check"></i>Check behavior in picture viewing tasks</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html"><i class="fa fa-check"></i>MRI</a>
<ul>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#regions-of-interest"><i class="fa fa-check"></i>Regions of Interest</a>
<ul>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#create-masks-from-freesurfer"><i class="fa fa-check"></i>Create masks from Freesurfer</a></li>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#coregister-freesurfer-masks-to-functional-space"><i class="fa fa-check"></i>Coregister Freesurfer masks to functional space</a></li>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#atlas-masks"><i class="fa fa-check"></i>Atlas masks</a></li>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#intersecting-the-masks"><i class="fa fa-check"></i>Intersecting the masks</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#group-level-masks"><i class="fa fa-check"></i>Group-Level Masks</a>
<ul>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#probabilistic-roi-image"><i class="fa fa-check"></i>Probabilistic ROI Image</a></li>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#field-of-view-mask"><i class="fa fa-check"></i>Field of View Mask</a></li>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#create-gray-matter-mask"><i class="fa fa-check"></i>Create Gray Matter Mask</a></li>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#small-volume-correction-mask"><i class="fa fa-check"></i>Small Volume Correction Mask</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#quantify-representational-change"><i class="fa fa-check"></i>Quantify Representational Change</a>
<ul>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#calculate-correlation-matrices"><i class="fa fa-check"></i>Calculate correlation matrices</a></li>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#calculate-pattern-similarity-change"><i class="fa fa-check"></i>Calculate Pattern Similarity Change</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mri.html"><a href="mri.html#combine-behavioral-and-fmri-data-for-rsa"><i class="fa fa-check"></i>Combine behavioral and fMRI data for RSA</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html"><i class="fa fa-check"></i>RSA Searchlight</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#prepare-functional-data-for-searchlight-analysis"><i class="fa fa-check"></i>Prepare functional data for searchlight analysis</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#preprocessing-1"><i class="fa fa-check"></i>Preprocessing</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#data-cleaning-extract-residuals-from-motion-parameter-regression"><i class="fa fa-check"></i>Data cleaning: Extract residuals from motion parameter regression</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#extract-relevant-volumes-1"><i class="fa fa-check"></i>Extract relevant volumes</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#concatenate-relevant-volumes"><i class="fa fa-check"></i>Concatenate relevant volumes</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#first-level-rsa-searchlight"><i class="fa fa-check"></i>First-level RSA Searchlight</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#set-analysis-parameters"><i class="fa fa-check"></i>Set analysis parameters</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#prepare-rsa-predictions"><i class="fa fa-check"></i>Prepare RSA-predictions</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#prepare-lookup-table-for-searchlight"><i class="fa fa-check"></i>Prepare lookup table for searchlight</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#check-the-spheres-we-created"><i class="fa fa-check"></i>Check the spheres we created</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#prepare-dataframe-with-input-for-analysis"><i class="fa fa-check"></i>Prepare dataframe with input for analysis</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#define-the-function-that-implements-the-analysis"><i class="fa fa-check"></i>Define the function that implements the analysis</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#run-the-searchlights"><i class="fa fa-check"></i>Run the searchlights</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#combine-the-chunks"><i class="fa fa-check"></i>Combine the chunks</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#searchlight-group-level"><i class="fa fa-check"></i>Searchlight group level</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#move-first-level-images-to-mni-space"><i class="fa fa-check"></i>Move first-level images to MNI space</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#merge-and-smooth-first-level-images"><i class="fa fa-check"></i>Merge and smooth first-level images</a></li>
<li class="chapter" data-level="0.0.1" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#run-fsl-randomise"><i class="fa fa-check"></i><b>0.0.1</b> Run FSL Randomise</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#find-searchlight-clusters-and-atlas-label"><i class="fa fa-check"></i>Find searchlight clusters and atlas label</a></li>
<li class="chapter" data-level="0.0.2" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#create-outlines-of-significant-clusters"><i class="fa fa-check"></i><b>0.0.2</b> Create outlines of significant clusters</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#prepare-rsa-in-searchlight-peak"><i class="fa fa-check"></i>Prepare RSA in searchlight peak</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#preparing-the-roi"><i class="fa fa-check"></i>Preparing the ROI</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#calculating-the-correlation-matrices"><i class="fa fa-check"></i>Calculating the correlation matrices</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#calculate-pattern-similarity-change-1"><i class="fa fa-check"></i>Calculate Pattern Similarity Change</a></li>
<li class="chapter" data-level="" data-path="rsa-searchlight.html"><a href="rsa-searchlight.html#combine-behavioral-and-fmri-data-for-rsa-1"><i class="fa fa-check"></i>Combine behavioral and fMRI data for RSA</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html"><i class="fa fa-check"></i>Behavioral Analysis</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#introductory-notes"><i class="fa fa-check"></i>Introductory notes</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#day-sorting-task-data"><i class="fa fa-check"></i>Day sorting task data</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#timeline-task-data"><i class="fa fa-check"></i>Timeline task data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#load-the-data"><i class="fa fa-check"></i>Load the data</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#day-sorting-task"><i class="fa fa-check"></i>Day Sorting Task</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#calculate-percentage-of-correct-responses"><i class="fa fa-check"></i>Calculate percentage of correct responses</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#plot-of-day-sorting-performance"><i class="fa fa-check"></i>Plot of day sorting performance</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#timeline-task"><i class="fa fa-check"></i>Timeline Task</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#visualize-the-raw-data"><i class="fa fa-check"></i>Visualize the raw data</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#accuracy-of-remembered-time"><i class="fa fa-check"></i>Accuracy of remembered time</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#time-metrics-underlying-remembered-times"><i class="fa fa-check"></i>Time metrics underlying remembered times</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#compose-figure-for-behavioral-data"><i class="fa fa-check"></i>Compose Figure for Behavioral Data</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#generalization-bias-in-behavior"><i class="fa fa-check"></i>Generalization bias in behavior</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#quantify-relative-time-of-other-events"><i class="fa fa-check"></i>Quantify relative time of other events</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#test-generalization-bias"><i class="fa fa-check"></i>Test Generalization Bias</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#replication-of-generalization-bias"><i class="fa fa-check"></i>Replication of Generalization Bias</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#replication-data-quantify-relative-time-of-other-events"><i class="fa fa-check"></i>Replication data: Quantify relative time of other events</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#replication-data-test-generalization-bias"><i class="fa fa-check"></i>Replication data: Test Generalization Bias</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html"><i class="fa fa-check"></i>RSA on Pattern Similarity Change</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#load-data"><i class="fa fa-check"></i>Load data</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#prepare-time-metrics-for-rsa"><i class="fa fa-check"></i>Prepare Time Metrics for RSA</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#visualize-regions-of-interests"><i class="fa fa-check"></i>Visualize Regions of Interests</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#template-background-image-with-fov"><i class="fa fa-check"></i>Template background image with FOV</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#anterior-hippocampus-roi"><i class="fa fa-check"></i>Anterior hippocampus ROI</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#anterior-lateral-entorhinal-cortex"><i class="fa fa-check"></i>Anterior-lateral entorhinal cortex</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#first-level-rsa"><i class="fa fa-check"></i>First-level RSA</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-within-sequence"><i class="fa fa-check"></i>aHPC: virtual time within sequence</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#second-level-analysis"><i class="fa fa-check"></i>Second-level analysis</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-2"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#not-driven-by-first-last-event-pairs"><i class="fa fa-check"></i>Not driven by first &amp; last event pairs</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-within-sequence-when-including-order-real-time"><i class="fa fa-check"></i>aHPC: virtual time within sequence when including order &amp; real time</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#one-model-with-multiple-predictors"><i class="fa fa-check"></i>One model with multiple predictors</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-explains-residuals-of-order-and-real-time"><i class="fa fa-check"></i>Virtual time explains residuals of order and real time</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-across-sequences"><i class="fa fa-check"></i>aHPC: virtual time across sequences</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#second-level-analysis-1"><i class="fa fa-check"></i>Second-level analysis</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-4"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-within-vs.-across-sequences"><i class="fa fa-check"></i>aHPC: virtual time within vs. across sequences</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#second-level-analysis-2"><i class="fa fa-check"></i>Second-level analysis</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-5"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#visualization-pattern-similarity-change"><i class="fa fa-check"></i>Visualization Pattern Similarity Change</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec"><i class="fa fa-check"></i>alEC</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec-virtual-time-withinacross-sequences-separately"><i class="fa fa-check"></i>alEC: virtual time within/across sequences separately</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec-virtual-time-within-vs.-across-sequences"><i class="fa fa-check"></i>alEC: virtual time within vs. across sequences</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec-virtual-time-for-all-event-pairs"><i class="fa fa-check"></i>alEC: virtual time for all event pairs</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-vs.-alec"><i class="fa fa-check"></i>aHPC vs. alEC</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#summary-statistics-8"><i class="fa fa-check"></i>Summary Statistics</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-7"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#searchlight-results"><i class="fa fa-check"></i>Searchlight Results</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-within-sequence"><i class="fa fa-check"></i>Virtual Time Within Sequence</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-across-sequences-in-within-searchlight-cluster"><i class="fa fa-check"></i>Virtual Time Across Sequences in Within-Searchlight Cluster</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-across-sequences"><i class="fa fa-check"></i>Virtual Time Across Sequences</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#visualization-of-overlap"><i class="fa fa-check"></i>Visualization of Overlap</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-sequences-interaction"><i class="fa fa-check"></i>Virtual Time &amp; Sequences Interaction</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#exploratory-searchlight-results"><i class="fa fa-check"></i>Exploratory Searchlight Results</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#correlation-of-behavioral-generalization-bias-with-searchlight-effects"><i class="fa fa-check"></i>Correlation of behavioral generalization bias with searchlight effects</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#correlation-with-across-sequence-searchlight-effect"><i class="fa fa-check"></i>Correlation with across-sequence searchlight effect</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#correlation-with-same-sequence-searchlight-effect"><i class="fa fa-check"></i>Correlation with same-sequence searchlight effect</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#bias-figure"><i class="fa fa-check"></i>Bias Figure</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#supplemental-tables"><i class="fa fa-check"></i>Supplemental Tables</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html"><i class="fa fa-check"></i>Signal to noise ratio</a>
<ul>
<li class="chapter" data-level="" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html#calculate-temporal-snr-for-each-voxel"><i class="fa fa-check"></i>Calculate temporal SNR for each voxel</a></li>
<li class="chapter" data-level="" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html#average-tsnr-for-each-roi"><i class="fa fa-check"></i>Average tSNR for each ROI</a></li>
<li class="chapter" data-level="" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html#contrast-tsnr-between-ahpc-and-alec"><i class="fa fa-check"></i>Contrast tSNR between aHPC and alEC</a></li>
<li class="chapter" data-level="" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html#plot-tsnr-per-roi"><i class="fa fa-check"></i>Plot tSNR per ROI</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="credit.html"><a href="credit.html"><i class="fa fa-check"></i>Credit</a>
<ul>
<li class="chapter" data-level="" data-path="credit.html"><a href="credit.html#list-of-packages"><i class="fa fa-check"></i>List of packages</a>
<ul>
<li class="chapter" data-level="" data-path="credit.html"><a href="credit.html#references"><i class="fa fa-check"></i>References</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="credit.html"><a href="credit.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Research Documentation for VIRTEM</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="mri" class="section level1 unnumbered">
<h1>MRI</h1>
<div id="regions-of-interest" class="section level2 unnumbered">
<h2>Regions of Interest</h2>
<p>We want to run ROI-based representational similarity analyses to test how the hippocampal-entorhinal system represents the learned temporal relationships. We will focus our analysis on the anterior hippocampus (aHPC) and anterolateral entorhinal cortex (alEC).</p>
<p>To define participant-specific ROI masks, we want to combine masks from the individual Freesurfer parcellations of the HPC and EC with masks dividing the subregions of the HPC and EC. Specifically, these are based on the Harvard-Oxford atlas distributed with FSL for the hippocampus and on the EC subregion masks from <a href="http://elifesciences.org/content/4/e06738">Navarro Schröder et al. (eLife, 2015)</a>.</p>
<p>For now, we will use the Freesurfer segmentation run by Lorena Deuker, which is saved in virtem/data/mri/freesurfer. This was obtained via the recon-all command. All masks will be co-registered to the analysis space, which is the space of the wholebrain functional images. This relies on the FSL transformation matrices and warp files stored in the virtem/data/mri/processed/wholebrain.</p>
<p>Here is the list of ROIs we want to get from Freesurfer with the corresponding numeric labels.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="mri.html#cb31-1" aria-hidden="true"></a><span class="co"># name of Freesurfer ROIs and their numeric labels</span></span>
<span id="cb31-2"><a href="mri.html#cb31-2" aria-hidden="true"></a><span class="kw">head</span>(rois_fs)</span>
<span id="cb31-3"><a href="mri.html#cb31-3" aria-hidden="true"></a>labels_fs</span></code></pre></div>
<p>We will mostly be working in the ROIs directory <strong>virtem/data/mri/rois</strong>. Within that folder we will create separate folders for each ROI and for the different analysis steps.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="mri.html#cb32-1" aria-hidden="true"></a>dirs<span class="op">$</span>rois_fs_dirs</span></code></pre></div>
<div id="create-masks-from-freesurfer" class="section level3 unnumbered">
<h3>Create masks from Freesurfer</h3>
<p>First we want to create nifti masks from the Freesurfer parcellation. These are first saved in the space of the participant’s highres structural space.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="mri.html#cb33-1" aria-hidden="true"></a><span class="co"># create freesurfer subfolder for in each ROI folder</span></span>
<span id="cb33-2"><a href="mri.html#cb33-2" aria-hidden="true"></a><span class="kw">invisible</span>(<span class="kw">lapply</span>(<span class="kw">file.path</span>(dirs<span class="op">$</span>rois_fs_dirs, <span class="st">&quot;freesurfer_highres_space&quot;</span>),</span>
<span id="cb33-3"><a href="mri.html#cb33-3" aria-hidden="true"></a>                 <span class="cf">function</span>(x) <span class="cf">if</span>(<span class="op">!</span><span class="kw">dir.exists</span>(x)) <span class="kw">dir.create</span>(x)))</span>
<span id="cb33-4"><a href="mri.html#cb33-4" aria-hidden="true"></a></span>
<span id="cb33-5"><a href="mri.html#cb33-5" aria-hidden="true"></a><span class="cf">for</span> (sub_id <span class="cf">in</span> subjects){</span>
<span id="cb33-6"><a href="mri.html#cb33-6" aria-hidden="true"></a>    </span>
<span id="cb33-7"><a href="mri.html#cb33-7" aria-hidden="true"></a>  <span class="co"># get the name of the ROIs(fs = from freesurfer, hs = highres space)</span></span>
<span id="cb33-8"><a href="mri.html#cb33-8" aria-hidden="true"></a>  out_roi_fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rois_fs_dirs, <span class="st">&quot;freesurfer_highres_space&quot;</span>, </span>
<span id="cb33-9"><a href="mri.html#cb33-9" aria-hidden="true"></a>                          <span class="kw">sprintf</span>(<span class="st">&quot;P%s_%s_fs_hs.nii.gz&quot;</span>, sub_id, rois_fs))</span>
<span id="cb33-10"><a href="mri.html#cb33-10" aria-hidden="true"></a></span>
<span id="cb33-11"><a href="mri.html#cb33-11" aria-hidden="true"></a>  <span class="co"># load the structural image</span></span>
<span id="cb33-12"><a href="mri.html#cb33-12" aria-hidden="true"></a>  highres_fn &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb33-13"><a href="mri.html#cb33-13" aria-hidden="true"></a>                     <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, sub_id, <span class="st">&quot;.feat&quot;</span>), <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;highres.nii.gz&quot;</span>)</span>
<span id="cb33-14"><a href="mri.html#cb33-14" aria-hidden="true"></a>  highres_nii &lt;-<span class="st"> </span><span class="kw">readNIfTI2</span>(highres_fn)</span>
<span id="cb33-15"><a href="mri.html#cb33-15" aria-hidden="true"></a>        </span>
<span id="cb33-16"><a href="mri.html#cb33-16" aria-hidden="true"></a>  <span class="co"># load the freesurfer output</span></span>
<span id="cb33-17"><a href="mri.html#cb33-17" aria-hidden="true"></a>  freesurf_fn &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;freesurfer&quot;</span>, </span>
<span id="cb33-18"><a href="mri.html#cb33-18" aria-hidden="true"></a>                      <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, sub_id), <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;aparc+aseg-in-rawavg.nii&quot;</span>)</span>
<span id="cb33-19"><a href="mri.html#cb33-19" aria-hidden="true"></a>  aparc_nii &lt;-<span class="st"> </span><span class="kw">readNIfTI2</span>(freesurf_fn)</span>
<span id="cb33-20"><a href="mri.html#cb33-20" aria-hidden="true"></a></span>
<span id="cb33-21"><a href="mri.html#cb33-21" aria-hidden="true"></a>  <span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(rois_fs)){</span>
<span id="cb33-22"><a href="mri.html#cb33-22" aria-hidden="true"></a>    </span>
<span id="cb33-23"><a href="mri.html#cb33-23" aria-hidden="true"></a>    <span class="co"># initialize all mask voxels as zeros</span></span>
<span id="cb33-24"><a href="mri.html#cb33-24" aria-hidden="true"></a>    mask_idx &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="kw">dim</span>(<span class="kw">img_data</span>(highres_nii)))</span>
<span id="cb33-25"><a href="mri.html#cb33-25" aria-hidden="true"></a>    </span>
<span id="cb33-26"><a href="mri.html#cb33-26" aria-hidden="true"></a>    <span class="co"># set voxels of the ROI to one            </span></span>
<span id="cb33-27"><a href="mri.html#cb33-27" aria-hidden="true"></a>    mask_idx[<span class="kw">img_data</span>(aparc_nii) <span class="op">%in%</span><span class="st"> </span>labels_fs[[i_roi]]] &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb33-28"><a href="mri.html#cb33-28" aria-hidden="true"></a>    </span>
<span id="cb33-29"><a href="mri.html#cb33-29" aria-hidden="true"></a>    <span class="co"># create nifti based on the Freesurfer image</span></span>
<span id="cb33-30"><a href="mri.html#cb33-30" aria-hidden="true"></a>    roi_nii &lt;-<span class="st"> </span>highres_nii</span>
<span id="cb33-31"><a href="mri.html#cb33-31" aria-hidden="true"></a>    <span class="kw">img_data</span>(roi_nii) &lt;-<span class="st"> </span>mask_idx</span>
<span id="cb33-32"><a href="mri.html#cb33-32" aria-hidden="true"></a>    </span>
<span id="cb33-33"><a href="mri.html#cb33-33" aria-hidden="true"></a>    <span class="co"># write the nifti to file</span></span>
<span id="cb33-34"><a href="mri.html#cb33-34" aria-hidden="true"></a>    <span class="kw">writenii</span>(<span class="dt">nim =</span> roi_nii, <span class="dt">filename =</span> out_roi_fn[i_roi])</span>
<span id="cb33-35"><a href="mri.html#cb33-35" aria-hidden="true"></a>    </span>
<span id="cb33-36"><a href="mri.html#cb33-36" aria-hidden="true"></a>    <span class="co"># find coordinates for sensible slices to plot (most frequent value in each dim)</span></span>
<span id="cb33-37"><a href="mri.html#cb33-37" aria-hidden="true"></a>    coords &lt;-<span class="st"> </span><span class="kw">arrayInd</span>(<span class="kw">which</span>(<span class="kw">as.logical</span>(mask_idx)), <span class="kw">dim</span>(mask_idx))</span>
<span id="cb33-38"><a href="mri.html#cb33-38" aria-hidden="true"></a>    coords &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">min</span>(statip<span class="op">::</span><span class="kw">mfv</span>(coords[,<span class="dv">1</span>])), </span>
<span id="cb33-39"><a href="mri.html#cb33-39" aria-hidden="true"></a>                <span class="kw">min</span>(statip<span class="op">::</span><span class="kw">mfv</span>(coords[,<span class="dv">2</span>])), </span>
<span id="cb33-40"><a href="mri.html#cb33-40" aria-hidden="true"></a>                <span class="kw">min</span>(statip<span class="op">::</span><span class="kw">mfv</span>(coords[,<span class="dv">3</span>])))</span>
<span id="cb33-41"><a href="mri.html#cb33-41" aria-hidden="true"></a>    </span>
<span id="cb33-42"><a href="mri.html#cb33-42" aria-hidden="true"></a>    <span class="co"># save a diagnostic plot as a PDF</span></span>
<span id="cb33-43"><a href="mri.html#cb33-43" aria-hidden="true"></a>    fname &lt;-<span class="st"> </span>tools<span class="op">::</span><span class="kw">file_path_sans_ext</span>(out_roi_fn[i_roi], <span class="dt">compression =</span> <span class="st">&quot;TRUE&quot;</span>)</span>
<span id="cb33-44"><a href="mri.html#cb33-44" aria-hidden="true"></a>    <span class="kw">pdf</span>(<span class="kw">paste0</span>(fname,<span class="st">&quot;.pdf&quot;</span>))</span>
<span id="cb33-45"><a href="mri.html#cb33-45" aria-hidden="true"></a>    <span class="kw">ortho2</span>(<span class="kw">robust_window</span>(highres_nii, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.999</span>)), <span class="dt">y =</span> roi_nii,</span>
<span id="cb33-46"><a href="mri.html#cb33-46" aria-hidden="true"></a>           <span class="dt">col.y =</span> roi_colors_fs[i_roi], <span class="dt">xyz =</span> coords,</span>
<span id="cb33-47"><a href="mri.html#cb33-47" aria-hidden="true"></a>           <span class="dt">text =</span> <span class="kw">sprintf</span>(<span class="st">&quot;P%s: %s&quot;</span>, sub_id, rois_fs[i_roi]),</span>
<span id="cb33-48"><a href="mri.html#cb33-48" aria-hidden="true"></a>           <span class="dt">crosshairs =</span> <span class="ot">FALSE</span>)</span>
<span id="cb33-49"><a href="mri.html#cb33-49" aria-hidden="true"></a>    <span class="kw">invisible</span>(<span class="kw">dev.off</span>())</span>
<span id="cb33-50"><a href="mri.html#cb33-50" aria-hidden="true"></a>  } </span>
<span id="cb33-51"><a href="mri.html#cb33-51" aria-hidden="true"></a>}</span></code></pre></div>
<p>To get an overview of the ROIs that we just created, we create a merged PDF of the diagnostic plots. We do this for each ROI separately. The files are saved to the specific ROI folders.</p>
</div>
<div id="coregister-freesurfer-masks-to-functional-space" class="section level3 unnumbered">
<h3>Coregister Freesurfer masks to functional space</h3>
<p>Next we <strong>coregister the masks</strong> from freesurfer from the highres structural space to the functional analysis space. For this we will use FSL flirt based on the registration files obtained during preprocessing of the wholebrain functional images. Further we will mask them with our <strong>partial field of view mask</strong> based on the sequence used during the picture viewing tasks. Lastly, we apply a <strong>threshold of 0.5</strong> to binarize the ROI masks.</p>
<p>To make sure everything went well, we create diagnostic image for every subject, which we collect in a PDF for visual inspection.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="mri.html#cb34-1" aria-hidden="true"></a><span class="co"># create samespace freesurfer subfolder for in each ROI folder</span></span>
<span id="cb34-2"><a href="mri.html#cb34-2" aria-hidden="true"></a><span class="kw">invisible</span>(<span class="kw">lapply</span>(<span class="kw">file.path</span>(dirs<span class="op">$</span>rois_fs_dirs, <span class="st">&quot;freesurfer_samespace&quot;</span>),</span>
<span id="cb34-3"><a href="mri.html#cb34-3" aria-hidden="true"></a>                 <span class="cf">function</span>(x) <span class="cf">if</span>(<span class="op">!</span><span class="kw">dir.exists</span>(x)) <span class="kw">dir.create</span>(x)))</span>
<span id="cb34-4"><a href="mri.html#cb34-4" aria-hidden="true"></a></span>
<span id="cb34-5"><a href="mri.html#cb34-5" aria-hidden="true"></a><span class="co"># name of transformation matrix file to move from highres to functional space</span></span>
<span id="cb34-6"><a href="mri.html#cb34-6" aria-hidden="true"></a>highres2func &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb34-7"><a href="mri.html#cb34-7" aria-hidden="true"></a>                     <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb34-8"><a href="mri.html#cb34-8" aria-hidden="true"></a>                     <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;highres2example_func.mat&quot;</span>)</span>
<span id="cb34-9"><a href="mri.html#cb34-9" aria-hidden="true"></a></span>
<span id="cb34-10"><a href="mri.html#cb34-10" aria-hidden="true"></a><span class="co"># use the mean EPI of wholebrain image as a reference</span></span>
<span id="cb34-11"><a href="mri.html#cb34-11" aria-hidden="true"></a>mean_epi &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb34-12"><a href="mri.html#cb34-12" aria-hidden="true"></a>                 <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;_wholebrain.nii.gz&quot;</span>))</span>
<span id="cb34-13"><a href="mri.html#cb34-13" aria-hidden="true"></a></span>
<span id="cb34-14"><a href="mri.html#cb34-14" aria-hidden="true"></a><span class="co"># functional mask (picture viewing tasks not scanned with wholebrain coverage)</span></span>
<span id="cb34-15"><a href="mri.html#cb34-15" aria-hidden="true"></a>brain_mask_ss &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, </span>
<span id="cb34-16"><a href="mri.html#cb34-16" aria-hidden="true"></a>                      <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb34-17"><a href="mri.html#cb34-17" aria-hidden="true"></a>                      <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;_common_mask.nii.gz&quot;</span>))</span>
<span id="cb34-18"><a href="mri.html#cb34-18" aria-hidden="true"></a></span>
<span id="cb34-19"><a href="mri.html#cb34-19" aria-hidden="true"></a><span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(rois_fs)){</span>
<span id="cb34-20"><a href="mri.html#cb34-20" aria-hidden="true"></a>  </span>
<span id="cb34-21"><a href="mri.html#cb34-21" aria-hidden="true"></a>  <span class="co"># define the file names of ROI files in highres space</span></span>
<span id="cb34-22"><a href="mri.html#cb34-22" aria-hidden="true"></a>  roi_hs &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rois_fs_dirs[i_roi], <span class="st">&quot;freesurfer_highres_space&quot;</span>, </span>
<span id="cb34-23"><a href="mri.html#cb34-23" aria-hidden="true"></a>                        <span class="kw">sprintf</span>(<span class="st">&quot;P%s_%s_fs_hs.nii.gz&quot;</span>, </span>
<span id="cb34-24"><a href="mri.html#cb34-24" aria-hidden="true"></a>                                subjects, rois_fs[i_roi]))</span>
<span id="cb34-25"><a href="mri.html#cb34-25" aria-hidden="true"></a>  </span>
<span id="cb34-26"><a href="mri.html#cb34-26" aria-hidden="true"></a>  <span class="co"># define output files in samespace (ss) = analysis space based on the wholebrain EPI</span></span>
<span id="cb34-27"><a href="mri.html#cb34-27" aria-hidden="true"></a>  roi_ss &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rois_fs_dirs[i_roi], <span class="st">&quot;freesurfer_samespace&quot;</span>, </span>
<span id="cb34-28"><a href="mri.html#cb34-28" aria-hidden="true"></a>                      <span class="kw">sprintf</span>(<span class="st">&quot;P%s_%s_fs_ss.nii.gz&quot;</span>, subjects, rois_fs[i_roi]))</span>
<span id="cb34-29"><a href="mri.html#cb34-29" aria-hidden="true"></a>  </span>
<span id="cb34-30"><a href="mri.html#cb34-30" aria-hidden="true"></a>  <span class="co"># define file names for masked ROI files</span></span>
<span id="cb34-31"><a href="mri.html#cb34-31" aria-hidden="true"></a>  roi_ss_masked &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rois_fs_dirs[i_roi], <span class="st">&quot;freesurfer_samespace&quot;</span>, </span>
<span id="cb34-32"><a href="mri.html#cb34-32" aria-hidden="true"></a>                      <span class="kw">sprintf</span>(<span class="st">&quot;P%s_%s_fs_ss_masked.nii.gz&quot;</span>, </span>
<span id="cb34-33"><a href="mri.html#cb34-33" aria-hidden="true"></a>                              subjects, rois_fs[i_roi]))</span>
<span id="cb34-34"><a href="mri.html#cb34-34" aria-hidden="true"></a>  </span>
<span id="cb34-35"><a href="mri.html#cb34-35" aria-hidden="true"></a><span class="co">#  # define file names for binarized masks</span></span>
<span id="cb34-36"><a href="mri.html#cb34-36" aria-hidden="true"></a><span class="co">#  roi_ss_bin &lt;- file.path(dirs$rois_fs_dirs[i_roi], &quot;freesurfer_samespace&quot;, </span></span>
<span id="cb34-37"><a href="mri.html#cb34-37" aria-hidden="true"></a><span class="co">#                          sprintf(&quot;P%s_%s_fs_ss_masked_bin.nii.gz&quot;, </span></span>
<span id="cb34-38"><a href="mri.html#cb34-38" aria-hidden="true"></a><span class="co">#                                  subjects, rois_fs[i_roi]))</span></span>
<span id="cb34-39"><a href="mri.html#cb34-39" aria-hidden="true"></a>  </span>
<span id="cb34-40"><a href="mri.html#cb34-40" aria-hidden="true"></a>  <span class="co"># apply FSL flirt to move ROI from highres to wholebrain functional space</span></span>
<span id="cb34-41"><a href="mri.html#cb34-41" aria-hidden="true"></a>  out &lt;-<span class="st"> </span><span class="kw">mapply</span>(flirt_apply, <span class="dt">infile =</span> roi_hs, <span class="dt">reffile =</span> mean_epi, </span>
<span id="cb34-42"><a href="mri.html#cb34-42" aria-hidden="true"></a>                <span class="dt">initmat =</span> highres2func, <span class="dt">outfile =</span> roi_ss,</span>
<span id="cb34-43"><a href="mri.html#cb34-43" aria-hidden="true"></a>                <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">FALSE</span>)</span>
<span id="cb34-44"><a href="mri.html#cb34-44" aria-hidden="true"></a>  </span>
<span id="cb34-45"><a href="mri.html#cb34-45" aria-hidden="true"></a>  <span class="co"># mask to make sure to reduce to partial field of view </span></span>
<span id="cb34-46"><a href="mri.html#cb34-46" aria-hidden="true"></a>  <span class="co">#out &lt;- mapply(fsl_mask, file = roi_ss, mask = brain_mask_ss, outfile = roi_ss_masked,</span></span>
<span id="cb34-47"><a href="mri.html#cb34-47" aria-hidden="true"></a>  <span class="co">#              verbose = FALSE, retimg = FALSE)</span></span>
<span id="cb34-48"><a href="mri.html#cb34-48" aria-hidden="true"></a>  <span class="kw">invisible</span>(<span class="kw">mapply</span>(fsl_maths, <span class="dt">file =</span> roi_ss, <span class="dt">opts =</span> <span class="kw">sprintf</span>(<span class="st">&quot;-min %s&quot;</span>, brain_mask_ss), <span class="dt">outfile =</span> roi_ss_masked,</span>
<span id="cb34-49"><a href="mri.html#cb34-49" aria-hidden="true"></a>                   <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">FALSE</span>))</span>
<span id="cb34-50"><a href="mri.html#cb34-50" aria-hidden="true"></a>  </span>
<span id="cb34-51"><a href="mri.html#cb34-51" aria-hidden="true"></a>  <span class="co"># use fslmaths to threshold the masked ROIs at 0.5 and then binarize</span></span>
<span id="cb34-52"><a href="mri.html#cb34-52" aria-hidden="true"></a><span class="co">#  out &lt;- mapply(fsl_thresh, file=roi_ss_masked, outfile=roi_ss_bin, thresh=0.5, opts=&quot;-bin&quot;,</span></span>
<span id="cb34-53"><a href="mri.html#cb34-53" aria-hidden="true"></a><span class="co">#                verbose = FALSE, retimg = FALSE)</span></span>
<span id="cb34-54"><a href="mri.html#cb34-54" aria-hidden="true"></a>}</span></code></pre></div>

</div>
<div id="atlas-masks" class="section level3 unnumbered">
<h3>Atlas masks</h3>
<p>Above, we generated masks of the Hippocampus and Entorhinal Cortex based on the Freesurfer segmentation of each participant’s structural image. Our hypotheses concern the anterior portion of the hippomcapus and the anterior-lateral entorhinal subregion, specifically. Hence, we want to split the participant-specific masks.</p>
<ul>
<li>For the hippocampus, we will start out with the probabilistic masks based on the Harvard-Oxford atlas delivered with FSL. Masks for the right and left hippocampus will be combined, thresholded at 50% probability and split in an anterior and posterior section. We will define the anterior hippocampus as all voxels anterior to MNI y = -21 based on <a href="https://www.sciencedirect.com/science/article/pii/S1364661313000673">Poppenk et al. (TiCS, 2013)</a>. They “propose that foci at or anterior to y = -21 mm in MNI space (y = -20 mm in Talairach space) may be regarded as falling in the aHPC, as this coordinate incorporates the uncal apex in the MNI152 template and current neuroanatomical atlases”.</li>
<li>We will define the anterolateral entorhinal cortex based on <a href="http://elifesciences.org/content/4/e06738">Navarro Schröder et al. (eLife, 2015)</a>. Specifically, we will use a mask for the dominant mode of connectivity change within the EC, which is shown in <a href="https://elifesciences.org/articles/06738/figures#fig2">Figure 2</a> of the original paper.</li>
</ul>
<p>The code below assumes that masks for the left and right hippocampus were extracted from the Harvard-Oxford atlas (MNI space 1mm). Likewise, it assumes the EC subregion masks (MNI space 1mm, obtained from <a href="https://www.researchgate.net/profile/Tobias_Navarro_Schroeder">Tobias Navarro Schröder</a> to be included in the folder. After the hippocampus masks are combined, thresholded, and split, the masks will be co-registered to the functional analysis space.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="mri.html#cb35-1" aria-hidden="true"></a><span class="co"># define the name of the ROIs in MNI space</span></span>
<span id="cb35-2"><a href="mri.html#cb35-2" aria-hidden="true"></a>rois_hpc_fnames &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;mni_masks&quot;</span>, <span class="kw">paste0</span>(rois_hpc,<span class="st">&quot;.nii.gz&quot;</span>))</span>
<span id="cb35-3"><a href="mri.html#cb35-3" aria-hidden="true"></a></span>
<span id="cb35-4"><a href="mri.html#cb35-4" aria-hidden="true"></a><span class="co"># combine atlas mask across hemispheres and split into anterior &amp; posterior if not done</span></span>
<span id="cb35-5"><a href="mri.html#cb35-5" aria-hidden="true"></a>atlas_fnames &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;mni_masks&quot;</span>, </span>
<span id="cb35-6"><a href="mri.html#cb35-6" aria-hidden="true"></a>                   <span class="kw">c</span>(<span class="st">&quot;harvardoxford-subcortical_prob_Left_Hippocampus.nii.gz&quot;</span>,</span>
<span id="cb35-7"><a href="mri.html#cb35-7" aria-hidden="true"></a>                     <span class="st">&quot;harvardoxford-subcortical_prob_Right_Hippocampus.nii.gz&quot;</span>,</span>
<span id="cb35-8"><a href="mri.html#cb35-8" aria-hidden="true"></a>                     <span class="st">&quot;harvardoxford-hpc_lr.nii.gz&quot;</span>,</span>
<span id="cb35-9"><a href="mri.html#cb35-9" aria-hidden="true"></a>                     <span class="st">&quot;harvardoxford-hpc_lr_tresh50_bin.nii.gz&quot;</span>))</span>
<span id="cb35-10"><a href="mri.html#cb35-10" aria-hidden="true"></a><span class="co"># combine the left and right HPC mask from the Harvard-Oxford atlas</span></span>
<span id="cb35-11"><a href="mri.html#cb35-11" aria-hidden="true"></a><span class="kw">fsladd</span>(atlas_fnames[<span class="dv">1</span>], atlas_fnames[<span class="dv">2</span>],<span class="dt">outfile =</span> atlas_fnames[<span class="dv">3</span>],</span>
<span id="cb35-12"><a href="mri.html#cb35-12" aria-hidden="true"></a>       <span class="dt">retimg =</span> <span class="ot">FALSE</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb35-13"><a href="mri.html#cb35-13" aria-hidden="true"></a></span>
<span id="cb35-14"><a href="mri.html#cb35-14" aria-hidden="true"></a><span class="co"># threshold at 50 percent probability</span></span>
<span id="cb35-15"><a href="mri.html#cb35-15" aria-hidden="true"></a><span class="kw">fsl_thresh</span>(atlas_fnames[<span class="dv">3</span>], <span class="dt">outfile =</span> atlas_fnames[<span class="dv">4</span>], <span class="dt">thresh =</span> <span class="dv">50</span>, <span class="dt">opts =</span> <span class="st">&quot;-bin&quot;</span>,</span>
<span id="cb35-16"><a href="mri.html#cb35-16" aria-hidden="true"></a>           <span class="dt">retimg =</span> <span class="ot">FALSE</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb35-17"><a href="mri.html#cb35-17" aria-hidden="true"></a></span>
<span id="cb35-18"><a href="mri.html#cb35-18" aria-hidden="true"></a><span class="co"># create anterior hippocampus ROI by creating a volume with all voxels anterior</span></span>
<span id="cb35-19"><a href="mri.html#cb35-19" aria-hidden="true"></a><span class="co"># to MNI y=-21 (y=105 in matrix coordinates) and mask this with the binary HPC ROI</span></span>
<span id="cb35-20"><a href="mri.html#cb35-20" aria-hidden="true"></a>opts =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;-mul 0 -add 1 -roi 0 182 105 -1 0 182 0 1 -mas %s&quot;</span>, atlas_fnames[<span class="dv">4</span>])</span>
<span id="cb35-21"><a href="mri.html#cb35-21" aria-hidden="true"></a><span class="kw">fsl_maths</span>(<span class="dt">file =</span> atlas_fnames[<span class="dv">4</span>], <span class="dt">outfile =</span> rois_hpc_fnames[<span class="dv">1</span>], <span class="dt">opts =</span> opts,</span>
<span id="cb35-22"><a href="mri.html#cb35-22" aria-hidden="true"></a>          <span class="dt">retimg =</span> <span class="ot">FALSE</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb35-23"><a href="mri.html#cb35-23" aria-hidden="true"></a></span>
<span id="cb35-24"><a href="mri.html#cb35-24" aria-hidden="true"></a><span class="co"># create posterior hippocampus ROI by creating a volume with all voxels posterior</span></span>
<span id="cb35-25"><a href="mri.html#cb35-25" aria-hidden="true"></a><span class="co"># to MNI y=-21 (y=105 in matrix, incl. y=-21) and mask this with the binary HPC ROI</span></span>
<span id="cb35-26"><a href="mri.html#cb35-26" aria-hidden="true"></a>opts =<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;-mul 0 -add 1 -roi 0 182 0 105 0 182 0 1 -mas %s&quot;</span>, atlas_fnames[<span class="dv">4</span>])</span>
<span id="cb35-27"><a href="mri.html#cb35-27" aria-hidden="true"></a><span class="kw">fsl_maths</span>(<span class="dt">file =</span> atlas_fnames[<span class="dv">4</span>], <span class="dt">outfile =</span> rois_hpc_fnames[<span class="dv">2</span>], <span class="dt">opts =</span> opts,</span>
<span id="cb35-28"><a href="mri.html#cb35-28" aria-hidden="true"></a>          <span class="dt">retimg =</span> <span class="ot">FALSE</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<p>Here are some diagnostic plots for the ROIs that we will use (in MNI 1mm space).</p>
<p>The resulting ROI masks can now be coregistered from MNI 1mm space to the analysis space of the wholebrain functional sequence. Finally, they are thresholded at a probability of 0.5.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="mri.html#cb36-1" aria-hidden="true"></a><span class="co"># name of transformation matrix file to move from highres to functional space</span></span>
<span id="cb36-2"><a href="mri.html#cb36-2" aria-hidden="true"></a>standard2func &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb36-3"><a href="mri.html#cb36-3" aria-hidden="true"></a>                     <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb36-4"><a href="mri.html#cb36-4" aria-hidden="true"></a>                     <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;standard2example_func.mat&quot;</span>)</span>
<span id="cb36-5"><a href="mri.html#cb36-5" aria-hidden="true"></a></span>
<span id="cb36-6"><a href="mri.html#cb36-6" aria-hidden="true"></a><span class="co"># use the mean EPI of wholebrain image as a reference</span></span>
<span id="cb36-7"><a href="mri.html#cb36-7" aria-hidden="true"></a>mean_epi &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb36-8"><a href="mri.html#cb36-8" aria-hidden="true"></a>                 <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;_wholebrain.nii.gz&quot;</span>))</span>
<span id="cb36-9"><a href="mri.html#cb36-9" aria-hidden="true"></a></span>
<span id="cb36-10"><a href="mri.html#cb36-10" aria-hidden="true"></a><span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(rois_mni)){</span>
<span id="cb36-11"><a href="mri.html#cb36-11" aria-hidden="true"></a>  </span>
<span id="cb36-12"><a href="mri.html#cb36-12" aria-hidden="true"></a>  <span class="co">#file name of ROI file in standard MNI space</span></span>
<span id="cb36-13"><a href="mri.html#cb36-13" aria-hidden="true"></a>  roi_mni &lt;-<span class="st"> </span>rois_mni_fnames[i_roi]</span>
<span id="cb36-14"><a href="mri.html#cb36-14" aria-hidden="true"></a>  </span>
<span id="cb36-15"><a href="mri.html#cb36-15" aria-hidden="true"></a>  <span class="co"># define output files in samespace (ss) = analysis space based on the wholebrain EPI</span></span>
<span id="cb36-16"><a href="mri.html#cb36-16" aria-hidden="true"></a>  roi_ss &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rois_mni_ss_dirs[i_roi],</span>
<span id="cb36-17"><a href="mri.html#cb36-17" aria-hidden="true"></a>                      <span class="kw">sprintf</span>(<span class="st">&quot;P%s_%s_ss.nii.gz&quot;</span>, subjects, rois_mni[i_roi]))</span>
<span id="cb36-18"><a href="mri.html#cb36-18" aria-hidden="true"></a></span>
<span id="cb36-19"><a href="mri.html#cb36-19" aria-hidden="true"></a>  <span class="co"># apply FSL flirt to move ROI from standard to wholebrain functional space</span></span>
<span id="cb36-20"><a href="mri.html#cb36-20" aria-hidden="true"></a>  <span class="kw">invisible</span>(<span class="kw">mapply</span>(flirt_apply, <span class="dt">infile =</span> roi_mni, <span class="dt">reffile =</span> mean_epi, </span>
<span id="cb36-21"><a href="mri.html#cb36-21" aria-hidden="true"></a>                   <span class="dt">initmat =</span> standard2func, <span class="dt">outfile =</span> roi_ss,</span>
<span id="cb36-22"><a href="mri.html#cb36-22" aria-hidden="true"></a>                   <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">FALSE</span>))</span>
<span id="cb36-23"><a href="mri.html#cb36-23" aria-hidden="true"></a>  </span>
<span id="cb36-24"><a href="mri.html#cb36-24" aria-hidden="true"></a>  <span class="co"># use fslmaths to binarize the masked ROIs using a threshold of 0.5</span></span>
<span id="cb36-25"><a href="mri.html#cb36-25" aria-hidden="true"></a>  out &lt;-<span class="st"> </span><span class="kw">mapply</span>(fsl_thresh, <span class="dt">file =</span> roi_ss, <span class="dt">outfile =</span> roi_ss, <span class="dt">thresh =</span> <span class="fl">0.5</span>, <span class="dt">opts =</span> <span class="st">&quot;-bin&quot;</span>,</span>
<span id="cb36-26"><a href="mri.html#cb36-26" aria-hidden="true"></a>                <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">FALSE</span>)</span>
<span id="cb36-27"><a href="mri.html#cb36-27" aria-hidden="true"></a>}</span></code></pre></div>

</div>
<div id="intersecting-the-masks" class="section level3 unnumbered">
<h3>Intersecting the masks</h3>
<p>In the last step, we intersect the masks from Freesurfer with the respective subregion masks. At this point, both masks are in the functional analysis space and have been binarized. Finally, we generate a PDF of diagnostic plots to check the final ROI masks.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="mri.html#cb37-1" aria-hidden="true"></a><span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(rois)){</span>
<span id="cb37-2"><a href="mri.html#cb37-2" aria-hidden="true"></a>  </span>
<span id="cb37-3"><a href="mri.html#cb37-3" aria-hidden="true"></a>  <span class="co"># define ROI files in samespace (ss) = analysis space based on the wholebrain EPI</span></span>
<span id="cb37-4"><a href="mri.html#cb37-4" aria-hidden="true"></a>  roi_ss &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rois_ss_dirs[i_roi],</span>
<span id="cb37-5"><a href="mri.html#cb37-5" aria-hidden="true"></a>                      <span class="kw">sprintf</span>(<span class="st">&quot;P%s_%s_ss.nii.gz&quot;</span>, subjects, rois[i_roi]))</span>
<span id="cb37-6"><a href="mri.html#cb37-6" aria-hidden="true"></a>  </span>
<span id="cb37-7"><a href="mri.html#cb37-7" aria-hidden="true"></a>  <span class="co"># define file names for ROI files masked with freesurfer (i.e. our output)</span></span>
<span id="cb37-8"><a href="mri.html#cb37-8" aria-hidden="true"></a>  roi_ss_fs &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rois_ss_dirs[i_roi],</span>
<span id="cb37-9"><a href="mri.html#cb37-9" aria-hidden="true"></a>                      <span class="kw">sprintf</span>(<span class="st">&quot;P%s_%s_ss_fs.nii.gz&quot;</span>, subjects, rois[i_roi]))</span>
<span id="cb37-10"><a href="mri.html#cb37-10" aria-hidden="true"></a>  </span>
<span id="cb37-11"><a href="mri.html#cb37-11" aria-hidden="true"></a>  <span class="co"># use HPC or EC mask from freesurfer? if not HPC or EC use graymatter mask</span></span>
<span id="cb37-12"><a href="mri.html#cb37-12" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="kw">grepl</span>(<span class="st">&quot;HPC&quot;</span>, rois[i_roi])){</span>
<span id="cb37-13"><a href="mri.html#cb37-13" aria-hidden="true"></a>    fs_roi &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;hpc_lr&quot;</span>, <span class="st">&quot;freesurfer_samespace&quot;</span>,</span>
<span id="cb37-14"><a href="mri.html#cb37-14" aria-hidden="true"></a>                   <span class="co">#sprintf(&quot;P%s_%s_fs_ss_masked_bin.nii.gz&quot;,subjects, &quot;hpc_lr&quot;))</span></span>
<span id="cb37-15"><a href="mri.html#cb37-15" aria-hidden="true"></a>                   <span class="kw">sprintf</span>(<span class="st">&quot;P%s_%s_fs_ss_masked.nii.gz&quot;</span>,subjects, <span class="st">&quot;hpc_lr&quot;</span>))</span>
<span id="cb37-16"><a href="mri.html#cb37-16" aria-hidden="true"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="kw">grepl</span>(<span class="st">&quot;EC&quot;</span>, rois[i_roi])){</span>
<span id="cb37-17"><a href="mri.html#cb37-17" aria-hidden="true"></a>    fs_roi &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;ec_lr&quot;</span>, <span class="st">&quot;freesurfer_samespace&quot;</span>,</span>
<span id="cb37-18"><a href="mri.html#cb37-18" aria-hidden="true"></a>                   <span class="co">#sprintf(&quot;P%s_%s_fs_ss_masked_bin.nii.gz&quot;,subjects, &quot;ec_lr&quot;))</span></span>
<span id="cb37-19"><a href="mri.html#cb37-19" aria-hidden="true"></a>                   <span class="kw">sprintf</span>(<span class="st">&quot;P%s_%s_fs_ss_masked.nii.gz&quot;</span>,subjects, <span class="st">&quot;ec_lr&quot;</span>))</span>
<span id="cb37-20"><a href="mri.html#cb37-20" aria-hidden="true"></a>  } <span class="cf">else</span> {<span class="co">#/data/pt_02261/virtem/data/mri/processed/samespace/VIRTEM_P035/VIRTEM_P035_common_graymatter_mask.nii.gz</span></span>
<span id="cb37-21"><a href="mri.html#cb37-21" aria-hidden="true"></a>      </span>
<span id="cb37-22"><a href="mri.html#cb37-22" aria-hidden="true"></a>    <span class="co"># mask gray matter mask with brain mask to account for partial FOV. Result will be used to mask ROIs</span></span>
<span id="cb37-23"><a href="mri.html#cb37-23" aria-hidden="true"></a>    gm_mask_fn &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb37-24"><a href="mri.html#cb37-24" aria-hidden="true"></a>                   <span class="kw">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_graymatter_mask.nii.gz&quot;</span>,subjects))</span>
<span id="cb37-25"><a href="mri.html#cb37-25" aria-hidden="true"></a>    brain_mask_fn &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb37-26"><a href="mri.html#cb37-26" aria-hidden="true"></a>                   <span class="kw">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_mask_perBlock.nii.gz&quot;</span>,subjects))</span>
<span id="cb37-27"><a href="mri.html#cb37-27" aria-hidden="true"></a>    fs_roi &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb37-28"><a href="mri.html#cb37-28" aria-hidden="true"></a>                   <span class="kw">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_graymatter_mask_brainmasked.nii.gz&quot;</span>,subjects))</span>
<span id="cb37-29"><a href="mri.html#cb37-29" aria-hidden="true"></a>    <span class="kw">invisible</span>(<span class="kw">mapply</span>(fsl_mask, <span class="dt">file =</span> gm_mask_fn, <span class="dt">mask =</span> brain_mask_fn, <span class="dt">outfile =</span> fs_roi,</span>
<span id="cb37-30"><a href="mri.html#cb37-30" aria-hidden="true"></a>                   <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">FALSE</span>))</span>
<span id="cb37-31"><a href="mri.html#cb37-31" aria-hidden="true"></a>  }</span>
<span id="cb37-32"><a href="mri.html#cb37-32" aria-hidden="true"></a>    <span class="co">#} else {stop(&quot;Don&#39;t know which Freesurfer mask to use!&quot;)}</span></span>
<span id="cb37-33"><a href="mri.html#cb37-33" aria-hidden="true"></a>  </span>
<span id="cb37-34"><a href="mri.html#cb37-34" aria-hidden="true"></a>  <span class="co"># mask the subregion mask with the Freesufer ROI</span></span>
<span id="cb37-35"><a href="mri.html#cb37-35" aria-hidden="true"></a>  <span class="kw">invisible</span>(<span class="kw">mapply</span>(fsl_maths, <span class="dt">file =</span> roi_ss, <span class="dt">opts =</span> <span class="kw">sprintf</span>(<span class="st">&quot;-min %s&quot;</span>, fs_roi), <span class="dt">outfile =</span> roi_ss_fs,</span>
<span id="cb37-36"><a href="mri.html#cb37-36" aria-hidden="true"></a>                   <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">FALSE</span>))</span>
<span id="cb37-37"><a href="mri.html#cb37-37" aria-hidden="true"></a>  <span class="co">#invisible(mapply(fsl_mask, file = roi_ss, mask = fs_roi, outfile = roi_ss_fs,</span></span>
<span id="cb37-38"><a href="mri.html#cb37-38" aria-hidden="true"></a>  <span class="co">#                 verbose = FALSE, retimg = FALSE))</span></span>
<span id="cb37-39"><a href="mri.html#cb37-39" aria-hidden="true"></a>  </span>
<span id="cb37-40"><a href="mri.html#cb37-40" aria-hidden="true"></a>  <span class="co"># threshold the resulting mask at a probability of 0.5 and binarize it</span></span>
<span id="cb37-41"><a href="mri.html#cb37-41" aria-hidden="true"></a>  <span class="kw">invisible</span>(<span class="kw">mapply</span>(fsl_thresh, <span class="dt">file =</span> roi_ss_fs, <span class="dt">outfile =</span> roi_ss_fs, </span>
<span id="cb37-42"><a href="mri.html#cb37-42" aria-hidden="true"></a>                   <span class="dt">thresh =</span> <span class="fl">0.500000000000000000000000000000000000001</span>, <span class="dt">opts =</span> <span class="st">&quot;-bin&quot;</span>,</span>
<span id="cb37-43"><a href="mri.html#cb37-43" aria-hidden="true"></a>                   <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">FALSE</span>))</span>
<span id="cb37-44"><a href="mri.html#cb37-44" aria-hidden="true"></a>}</span></code></pre></div>

</div>
</div>
<div id="group-level-masks" class="section level2 unnumbered">
<h2>Group-Level Masks</h2>
<p>Lastly, we create some group-level masks for visualization and further analysis:</p>
<ul>
<li>probabilistic ROI image for visualization of ROIs</li>
<li>a field of view mask in MNI space</li>
<li>a gray matter mask in MNI space</li>
<li>a small volume correction mask</li>
</ul>
<p>We create these images in their respective folders, but also copy them to the analysis data folder so they can be shared.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="mri.html#cb38-1" aria-hidden="true"></a><span class="co"># create the group mask folder</span></span>
<span id="cb38-2"><a href="mri.html#cb38-2" aria-hidden="true"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">dir.exists</span>(<span class="kw">file.path</span>(dirs<span class="op">$</span>data4analysis, <span class="st">&quot;mni1mm_masks&quot;</span>))){</span>
<span id="cb38-3"><a href="mri.html#cb38-3" aria-hidden="true"></a>  <span class="kw">dir.create</span>(<span class="kw">file.path</span>(dirs<span class="op">$</span>data4analysis, <span class="st">&quot;mni1mm_masks&quot;</span>))}</span>
<span id="cb38-4"><a href="mri.html#cb38-4" aria-hidden="true"></a></span>
<span id="cb38-5"><a href="mri.html#cb38-5" aria-hidden="true"></a><span class="co"># copy MNI image there</span></span>
<span id="cb38-6"><a href="mri.html#cb38-6" aria-hidden="true"></a><span class="kw">file.copy</span>(<span class="kw">mni_fname</span>(<span class="dt">mm=</span><span class="dv">1</span>, <span class="dt">brain =</span> <span class="ot">TRUE</span>), <span class="kw">file.path</span>(dirs<span class="op">$</span>data4analysis, <span class="st">&quot;mni1mm_masks&quot;</span>))</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div id="probabilistic-roi-image" class="section level3 unnumbered">
<h3>Probabilistic ROI Image</h3>
<p>For later visualization we move the masks to MNI space and threshold at 0.5.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="mri.html#cb40-1" aria-hidden="true"></a><span class="co"># name of transformation matrix file to move from common functional to MNI 1mm space</span></span>
<span id="cb40-2"><a href="mri.html#cb40-2" aria-hidden="true"></a>func2standard &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb40-3"><a href="mri.html#cb40-3" aria-hidden="true"></a>                     <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb40-4"><a href="mri.html#cb40-4" aria-hidden="true"></a>                     <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;example_func2standard.mat&quot;</span>)</span>
<span id="cb40-5"><a href="mri.html#cb40-5" aria-hidden="true"></a></span>
<span id="cb40-6"><a href="mri.html#cb40-6" aria-hidden="true"></a><span class="co"># use MNI 1mm image as a reference</span></span>
<span id="cb40-7"><a href="mri.html#cb40-7" aria-hidden="true"></a>mni_1mm &lt;-<span class="st"> </span><span class="kw">mni_fname</span>(<span class="dt">mm=</span><span class="dv">1</span>)</span>
<span id="cb40-8"><a href="mri.html#cb40-8" aria-hidden="true"></a></span>
<span id="cb40-9"><a href="mri.html#cb40-9" aria-hidden="true"></a><span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(rois)){</span>
<span id="cb40-10"><a href="mri.html#cb40-10" aria-hidden="true"></a>  </span>
<span id="cb40-11"><a href="mri.html#cb40-11" aria-hidden="true"></a>  <span class="co"># where to put the output</span></span>
<span id="cb40-12"><a href="mri.html#cb40-12" aria-hidden="true"></a>  out_dir &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, rois[i_roi], <span class="st">&quot;mni_1mm&quot;</span>)</span>
<span id="cb40-13"><a href="mri.html#cb40-13" aria-hidden="true"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="kw">dir.exists</span>(out_dir)){<span class="kw">dir.create</span>(out_dir)}</span>
<span id="cb40-14"><a href="mri.html#cb40-14" aria-hidden="true"></a>  </span>
<span id="cb40-15"><a href="mri.html#cb40-15" aria-hidden="true"></a>  <span class="co"># define input files in samespace (ss) = analysis space based on the wholebrain EPI</span></span>
<span id="cb40-16"><a href="mri.html#cb40-16" aria-hidden="true"></a>  roi_ss &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, rois[i_roi], <span class="st">&quot;samespace&quot;</span>,</span>
<span id="cb40-17"><a href="mri.html#cb40-17" aria-hidden="true"></a>                 <span class="kw">sprintf</span>(<span class="st">&quot;P%s_%s_ss.nii.gz&quot;</span>, subjects, rois[i_roi]))</span>
<span id="cb40-18"><a href="mri.html#cb40-18" aria-hidden="true"></a></span>
<span id="cb40-19"><a href="mri.html#cb40-19" aria-hidden="true"></a>  <span class="co">#file name of output ROI file in standard MNI space</span></span>
<span id="cb40-20"><a href="mri.html#cb40-20" aria-hidden="true"></a>  roi_mni &lt;-<span class="st"> </span><span class="kw">file.path</span>(out_dir, <span class="kw">sprintf</span>(<span class="st">&quot;P%s_%s_mni1mm.nii.gz&quot;</span>, subjects, rois[i_roi]))</span>
<span id="cb40-21"><a href="mri.html#cb40-21" aria-hidden="true"></a>  </span>
<span id="cb40-22"><a href="mri.html#cb40-22" aria-hidden="true"></a>  <span class="co"># apply FSL flirt to move ROI from wholebrain functional space to MNI space</span></span>
<span id="cb40-23"><a href="mri.html#cb40-23" aria-hidden="true"></a>  <span class="kw">invisible</span>(<span class="kw">mapply</span>(flirt_apply, <span class="dt">infile =</span> roi_ss, <span class="dt">reffile =</span> mni_1mm, </span>
<span id="cb40-24"><a href="mri.html#cb40-24" aria-hidden="true"></a>                   <span class="dt">initmat =</span> func2standard, <span class="dt">outfile =</span> roi_mni,</span>
<span id="cb40-25"><a href="mri.html#cb40-25" aria-hidden="true"></a>                   <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">FALSE</span>))</span>
<span id="cb40-26"><a href="mri.html#cb40-26" aria-hidden="true"></a>  </span>
<span id="cb40-27"><a href="mri.html#cb40-27" aria-hidden="true"></a>  <span class="co"># use fslmaths to binarize the ROI using a threshold of 0.5</span></span>
<span id="cb40-28"><a href="mri.html#cb40-28" aria-hidden="true"></a>  out &lt;-<span class="st"> </span><span class="kw">mapply</span>(fsl_thresh, <span class="dt">file =</span> roi_mni, <span class="dt">outfile =</span> roi_mni, <span class="dt">thresh =</span> <span class="fl">0.5</span>, <span class="dt">opts =</span> <span class="st">&quot;-bin&quot;</span>,</span>
<span id="cb40-29"><a href="mri.html#cb40-29" aria-hidden="true"></a>                <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">FALSE</span>)</span>
<span id="cb40-30"><a href="mri.html#cb40-30" aria-hidden="true"></a>  </span>
<span id="cb40-31"><a href="mri.html#cb40-31" aria-hidden="true"></a>  <span class="co"># create summary image</span></span>
<span id="cb40-32"><a href="mri.html#cb40-32" aria-hidden="true"></a>  out_fn &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, rois[i_roi], </span>
<span id="cb40-33"><a href="mri.html#cb40-33" aria-hidden="true"></a>                 <span class="kw">sprintf</span>(<span class="st">&quot;%s_group_prob_mni1mm.nii.gz&quot;</span>,rois[i_roi]))</span>
<span id="cb40-34"><a href="mri.html#cb40-34" aria-hidden="true"></a>  <span class="kw">fslmaths</span>(<span class="dt">file =</span> roi_mni, <span class="dt">outfile =</span> out_fn, </span>
<span id="cb40-35"><a href="mri.html#cb40-35" aria-hidden="true"></a>           <span class="dt">opts =</span> <span class="kw">sprintf</span>(<span class="st">&quot;-add %s&quot;</span>, <span class="kw">paste0</span>(roi_mni[<span class="dv">2</span><span class="op">:</span><span class="kw">length</span>(roi_mni)])),</span>
<span id="cb40-36"><a href="mri.html#cb40-36" aria-hidden="true"></a>           <span class="dt">verbose=</span><span class="ot">FALSE</span>)</span>
<span id="cb40-37"><a href="mri.html#cb40-37" aria-hidden="true"></a>  <span class="kw">fslmaths</span>(<span class="dt">file =</span> out_fn, <span class="dt">outfile =</span> out_fn, </span>
<span id="cb40-38"><a href="mri.html#cb40-38" aria-hidden="true"></a>         <span class="dt">opts =</span> <span class="kw">sprintf</span>(<span class="st">&quot;-div %d&quot;</span>, <span class="kw">length</span>(roi_mni)),</span>
<span id="cb40-39"><a href="mri.html#cb40-39" aria-hidden="true"></a>         <span class="dt">verbose=</span><span class="ot">FALSE</span>)</span>
<span id="cb40-40"><a href="mri.html#cb40-40" aria-hidden="true"></a>  </span>
<span id="cb40-41"><a href="mri.html#cb40-41" aria-hidden="true"></a>  <span class="co"># copy to data sharing folder</span></span>
<span id="cb40-42"><a href="mri.html#cb40-42" aria-hidden="true"></a>  <span class="kw">file.copy</span>(<span class="dt">from =</span> out_fn, <span class="dt">to =</span> <span class="kw">file.path</span>(dirs<span class="op">$</span>data4analysis, <span class="st">&quot;mni1mm_masks&quot;</span>))</span>
<span id="cb40-43"><a href="mri.html#cb40-43" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div id="field-of-view-mask" class="section level3 unnumbered">
<h3>Field of View Mask</h3>
<p>Next, we create a mask of our field of view, i.e. voxels covered in our functional images. We do so by registering the subject-specific brain masks from FEAT (in whole-brain functional space, already combined across blocks) to MNI space. After thresholding, the result is a binary mask to illustrate the FOV when plotting brain images in the main analysis script.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="mri.html#cb41-1" aria-hidden="true"></a><span class="co"># folder for output</span></span>
<span id="cb41-2"><a href="mri.html#cb41-2" aria-hidden="true"></a><span class="cf">if</span>(<span class="op">!</span><span class="kw">dir.exists</span>(<span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;fov&quot;</span>))){</span>
<span id="cb41-3"><a href="mri.html#cb41-3" aria-hidden="true"></a>  <span class="kw">dir.create</span>(<span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;fov&quot;</span>), <span class="dt">recursive=</span><span class="ot">TRUE</span>)}</span>
<span id="cb41-4"><a href="mri.html#cb41-4" aria-hidden="true"></a></span>
<span id="cb41-5"><a href="mri.html#cb41-5" aria-hidden="true"></a><span class="co"># name of transformation matrix file to move from the shared functional space to MNI 1mm</span></span>
<span id="cb41-6"><a href="mri.html#cb41-6" aria-hidden="true"></a>func2standard &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb41-7"><a href="mri.html#cb41-7" aria-hidden="true"></a>                      <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb41-8"><a href="mri.html#cb41-8" aria-hidden="true"></a>                      <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;example_func2standard.mat&quot;</span>)</span>
<span id="cb41-9"><a href="mri.html#cb41-9" aria-hidden="true"></a></span>
<span id="cb41-10"><a href="mri.html#cb41-10" aria-hidden="true"></a><span class="co"># subject-specific brain (FOV) masks in whole-brain functional space</span></span>
<span id="cb41-11"><a href="mri.html#cb41-11" aria-hidden="true"></a>subj_masks &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>samespace_dir, <span class="kw">sprintf</span>(<span class="st">&quot;VIRTEM_P%s&quot;</span>,subjects),</span>
<span id="cb41-12"><a href="mri.html#cb41-12" aria-hidden="true"></a>                        <span class="kw">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_mask_perBlock.nii.gz&quot;</span>,subjects))</span>
<span id="cb41-13"><a href="mri.html#cb41-13" aria-hidden="true"></a></span>
<span id="cb41-14"><a href="mri.html#cb41-14" aria-hidden="true"></a><span class="co"># output file name after moving to MNI space</span></span>
<span id="cb41-15"><a href="mri.html#cb41-15" aria-hidden="true"></a>subj_masks_mni &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;fov&quot;</span>), </span>
<span id="cb41-16"><a href="mri.html#cb41-16" aria-hidden="true"></a>                            <span class="kw">sprintf</span>(<span class="st">&quot;%s_fov_mask_mni.nii.gz&quot;</span>, subjects))</span>
<span id="cb41-17"><a href="mri.html#cb41-17" aria-hidden="true"></a></span>
<span id="cb41-18"><a href="mri.html#cb41-18" aria-hidden="true"></a><span class="co"># apply FSL flirt to move from wholebrain functional space to 1mm MNI space</span></span>
<span id="cb41-19"><a href="mri.html#cb41-19" aria-hidden="true"></a><span class="kw">invisible</span>(<span class="kw">mapply</span>(flirt_apply,</span>
<span id="cb41-20"><a href="mri.html#cb41-20" aria-hidden="true"></a>                 <span class="dt">infile =</span> subj_masks,</span>
<span id="cb41-21"><a href="mri.html#cb41-21" aria-hidden="true"></a>                 <span class="dt">reffile =</span> <span class="kw">mni_fname</span>(<span class="st">&quot;1&quot;</span>),</span>
<span id="cb41-22"><a href="mri.html#cb41-22" aria-hidden="true"></a>                 <span class="dt">initmat =</span> func2standard,</span>
<span id="cb41-23"><a href="mri.html#cb41-23" aria-hidden="true"></a>                 <span class="dt">outfile =</span> subj_masks_mni,</span>
<span id="cb41-24"><a href="mri.html#cb41-24" aria-hidden="true"></a>                 <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">FALSE</span>))</span>
<span id="cb41-25"><a href="mri.html#cb41-25" aria-hidden="true"></a></span>
<span id="cb41-26"><a href="mri.html#cb41-26" aria-hidden="true"></a><span class="co"># merge the files into a 4D file</span></span>
<span id="cb41-27"><a href="mri.html#cb41-27" aria-hidden="true"></a>mask_4d &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;fov&quot;</span>, <span class="st">&quot;4d_fov_mask_mni.nii.gz&quot;</span>)</span>
<span id="cb41-28"><a href="mri.html#cb41-28" aria-hidden="true"></a><span class="kw">fslmerge</span>(<span class="dt">infiles =</span> subj_masks_mni, <span class="dt">direction =</span> <span class="st">&quot;t&quot;</span>, <span class="dt">outfile =</span> mask_4d, <span class="dt">retimg =</span> <span class="ot">FALSE</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb41-29"><a href="mri.html#cb41-29" aria-hidden="true"></a></span>
<span id="cb41-30"><a href="mri.html#cb41-30" aria-hidden="true"></a><span class="co"># create binary mask </span></span>
<span id="cb41-31"><a href="mri.html#cb41-31" aria-hidden="true"></a>fov_mask &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;fov&quot;</span>, <span class="st">&quot;fov_mask_mni.nii.gz&quot;</span>)</span>
<span id="cb41-32"><a href="mri.html#cb41-32" aria-hidden="true"></a>fov_mask_nii &lt;-<span class="st"> </span><span class="kw">fslmaths</span>(mask_4d, <span class="dt">outfile =</span> fov_mask, </span>
<span id="cb41-33"><a href="mri.html#cb41-33" aria-hidden="true"></a>                         <span class="dt">opts =</span> <span class="st">&quot;-thr 0.3 -bin -Tmean -thr 0.3 -bin&quot;</span>,</span>
<span id="cb41-34"><a href="mri.html#cb41-34" aria-hidden="true"></a>                         <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">TRUE</span>)</span>
<span id="cb41-35"><a href="mri.html#cb41-35" aria-hidden="true"></a></span>
<span id="cb41-36"><a href="mri.html#cb41-36" aria-hidden="true"></a><span class="co"># quick plot</span></span>
<span id="cb41-37"><a href="mri.html#cb41-37" aria-hidden="true"></a><span class="kw">ortho2</span>(fov_mask_nii, <span class="dt">xyz=</span><span class="kw">c</span>(<span class="dv">100</span>,<span class="dv">100</span>,<span class="dv">50</span>))</span>
<span id="cb41-38"><a href="mri.html#cb41-38" aria-hidden="true"></a></span>
<span id="cb41-39"><a href="mri.html#cb41-39" aria-hidden="true"></a><span class="co"># copy to data sharing folder</span></span>
<span id="cb41-40"><a href="mri.html#cb41-40" aria-hidden="true"></a><span class="kw">file.copy</span>(<span class="dt">from =</span> fov_mask, <span class="dt">to =</span> <span class="kw">file.path</span>(dirs<span class="op">$</span>data4analysis, <span class="st">&quot;mni1mm_masks&quot;</span>))</span></code></pre></div>
</div>
<div id="create-gray-matter-mask" class="section level3 unnumbered">
<h3>Create Gray Matter Mask</h3>
<p>From the subject-specific gray matter masks (in whole-brain functional space) we create a merged, binary mask in MNI space. We use this to run FSL Randomise for all gray matter voxels (we only use gray matter voxels as features for our searchlight analysis).</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="mri.html#cb42-1" aria-hidden="true"></a><span class="co"># folder for output</span></span>
<span id="cb42-2"><a href="mri.html#cb42-2" aria-hidden="true"></a><span class="cf">if</span>(<span class="op">!</span><span class="kw">dir.exists</span>(<span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;gray_matter&quot;</span>))){</span>
<span id="cb42-3"><a href="mri.html#cb42-3" aria-hidden="true"></a>  <span class="kw">dir.create</span>(<span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;gray_matter&quot;</span>), <span class="dt">recursive=</span><span class="ot">TRUE</span>)}</span>
<span id="cb42-4"><a href="mri.html#cb42-4" aria-hidden="true"></a></span>
<span id="cb42-5"><a href="mri.html#cb42-5" aria-hidden="true"></a><span class="co"># name of transformation matrix file to move from the shared functional space to MNI 1mm</span></span>
<span id="cb42-6"><a href="mri.html#cb42-6" aria-hidden="true"></a>func2standard &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb42-7"><a href="mri.html#cb42-7" aria-hidden="true"></a>                      <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb42-8"><a href="mri.html#cb42-8" aria-hidden="true"></a>                      <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;example_func2standard.mat&quot;</span>)</span>
<span id="cb42-9"><a href="mri.html#cb42-9" aria-hidden="true"></a></span>
<span id="cb42-10"><a href="mri.html#cb42-10" aria-hidden="true"></a><span class="co"># subject-specific gray matter masks in whole-brain functional space</span></span>
<span id="cb42-11"><a href="mri.html#cb42-11" aria-hidden="true"></a>subj_masks &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>samespace_dir, <span class="kw">sprintf</span>(<span class="st">&quot;VIRTEM_P%s&quot;</span>,subjects),</span>
<span id="cb42-12"><a href="mri.html#cb42-12" aria-hidden="true"></a>                        <span class="kw">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_graymatter_mask_brainmasked.nii.gz&quot;</span>, subjects))</span>
<span id="cb42-13"><a href="mri.html#cb42-13" aria-hidden="true"></a></span>
<span id="cb42-14"><a href="mri.html#cb42-14" aria-hidden="true"></a><span class="co"># output file name in MNI space</span></span>
<span id="cb42-15"><a href="mri.html#cb42-15" aria-hidden="true"></a>subj_masks_mni &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;gray_matter&quot;</span>, </span>
<span id="cb42-16"><a href="mri.html#cb42-16" aria-hidden="true"></a>                            <span class="kw">sprintf</span>(<span class="st">&quot;%s_graymatter_mni.nii.gz&quot;</span>, subjects))</span>
<span id="cb42-17"><a href="mri.html#cb42-17" aria-hidden="true"></a></span>
<span id="cb42-18"><a href="mri.html#cb42-18" aria-hidden="true"></a><span class="co"># apply FSL flirt to move from wholebrain functional space to 1mm MNI space</span></span>
<span id="cb42-19"><a href="mri.html#cb42-19" aria-hidden="true"></a><span class="kw">invisible</span>(<span class="kw">mapply</span>(flirt_apply,</span>
<span id="cb42-20"><a href="mri.html#cb42-20" aria-hidden="true"></a>                 <span class="dt">infile =</span> subj_masks,</span>
<span id="cb42-21"><a href="mri.html#cb42-21" aria-hidden="true"></a>                 <span class="dt">reffile =</span> <span class="kw">mni_fname</span>(<span class="st">&quot;1&quot;</span>),</span>
<span id="cb42-22"><a href="mri.html#cb42-22" aria-hidden="true"></a>                 <span class="dt">initmat =</span> func2standard,</span>
<span id="cb42-23"><a href="mri.html#cb42-23" aria-hidden="true"></a>                 <span class="dt">outfile =</span> subj_masks_mni,</span>
<span id="cb42-24"><a href="mri.html#cb42-24" aria-hidden="true"></a>                 <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">FALSE</span>))</span>
<span id="cb42-25"><a href="mri.html#cb42-25" aria-hidden="true"></a></span>
<span id="cb42-26"><a href="mri.html#cb42-26" aria-hidden="true"></a><span class="co"># merge the files into a 4D file</span></span>
<span id="cb42-27"><a href="mri.html#cb42-27" aria-hidden="true"></a>gm_4d &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;gray_matter&quot;</span>, <span class="st">&quot;4d_graymatter_mni.nii.gz&quot;</span>)</span>
<span id="cb42-28"><a href="mri.html#cb42-28" aria-hidden="true"></a><span class="kw">fslmerge</span>(<span class="dt">infiles =</span> subj_masks_mni, <span class="dt">direction =</span> <span class="st">&quot;t&quot;</span>, <span class="dt">outfile =</span> gm_4d, <span class="dt">retimg =</span> <span class="ot">FALSE</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</span>
<span id="cb42-29"><a href="mri.html#cb42-29" aria-hidden="true"></a></span>
<span id="cb42-30"><a href="mri.html#cb42-30" aria-hidden="true"></a><span class="co"># create binary gray matter mask by thresholding and combining across subjects liberally</span></span>
<span id="cb42-31"><a href="mri.html#cb42-31" aria-hidden="true"></a>mni_brain_mask &lt;-<span class="st"> </span><span class="kw">mni_fname</span>(<span class="dt">mm =</span> <span class="st">&quot;1&quot;</span>, <span class="dt">brain=</span><span class="ot">TRUE</span>, <span class="dt">mask=</span><span class="ot">TRUE</span>)</span>
<span id="cb42-32"><a href="mri.html#cb42-32" aria-hidden="true"></a>gm_mask &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;gray_matter&quot;</span>, <span class="st">&quot;gray_matter_mask.nii.gz&quot;</span>)</span>
<span id="cb42-33"><a href="mri.html#cb42-33" aria-hidden="true"></a>gm_mask_nii &lt;-<span class="st"> </span><span class="kw">fslmaths</span>(gm_4d, <span class="dt">outfile =</span> gm_mask, </span>
<span id="cb42-34"><a href="mri.html#cb42-34" aria-hidden="true"></a>                        <span class="dt">opts =</span> <span class="kw">sprintf</span>(<span class="st">&quot;-thr 0.3 -bin -Tmean -thr 0.3 -bin -mas %s&quot;</span>,</span>
<span id="cb42-35"><a href="mri.html#cb42-35" aria-hidden="true"></a>                                       mni_brain_mask),</span>
<span id="cb42-36"><a href="mri.html#cb42-36" aria-hidden="true"></a>                        <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">retimg =</span> <span class="ot">TRUE</span>)</span>
<span id="cb42-37"><a href="mri.html#cb42-37" aria-hidden="true"></a></span>
<span id="cb42-38"><a href="mri.html#cb42-38" aria-hidden="true"></a><span class="co"># let&#39;s have a look at the mask we created</span></span>
<span id="cb42-39"><a href="mri.html#cb42-39" aria-hidden="true"></a>mni_nii &lt;-<span class="st"> </span><span class="kw">readNIfTI2</span>(<span class="kw">mni_fname</span>(<span class="st">&quot;1&quot;</span>))</span>
<span id="cb42-40"><a href="mri.html#cb42-40" aria-hidden="true"></a><span class="kw">ortho2</span>(mni_nii, <span class="dt">y =</span> gm_mask_nii, <span class="dt">xyz =</span> <span class="kw">c</span>(<span class="dv">63</span>, <span class="dv">113</span>, <span class="dv">50</span>))</span>
<span id="cb42-41"><a href="mri.html#cb42-41" aria-hidden="true"></a><span class="kw">ortho2</span>(mni_nii, <span class="dt">y =</span> gm_mask_nii, <span class="dt">xyz =</span> <span class="kw">c</span>(<span class="dv">71</span>, <span class="dv">127</span>, <span class="dv">39</span>))</span></code></pre></div>
</div>
<div id="small-volume-correction-mask" class="section level3 unnumbered">
<h3>Small Volume Correction Mask</h3>
<p>The small volume correction mask should consists of our a priori ROIs, the anterior hippocampus and the anterior-lateral entorhinal cortex. We use the subject-specific masks, moved back to MNI space for this.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="mri.html#cb43-1" aria-hidden="true"></a><span class="co"># folder for output</span></span>
<span id="cb43-2"><a href="mri.html#cb43-2" aria-hidden="true"></a><span class="cf">if</span>(<span class="op">!</span><span class="kw">dir.exists</span>(<span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;svc&quot;</span>))){</span>
<span id="cb43-3"><a href="mri.html#cb43-3" aria-hidden="true"></a>  <span class="kw">dir.create</span>(<span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;svc&quot;</span>), <span class="dt">recursive=</span><span class="ot">TRUE</span>)}</span>
<span id="cb43-4"><a href="mri.html#cb43-4" aria-hidden="true"></a></span>
<span id="cb43-5"><a href="mri.html#cb43-5" aria-hidden="true"></a><span class="co"># create the SVC mask by merging aHPC and alEC ROIs</span></span>
<span id="cb43-6"><a href="mri.html#cb43-6" aria-hidden="true"></a>aHPC_fn &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;aHPC_lr&quot;</span>,</span>
<span id="cb43-7"><a href="mri.html#cb43-7" aria-hidden="true"></a>                <span class="kw">sprintf</span>(<span class="st">&quot;%s_group_prob_mni1mm.nii.gz&quot;</span>, <span class="st">&quot;aHPC_lr&quot;</span>))</span>
<span id="cb43-8"><a href="mri.html#cb43-8" aria-hidden="true"></a>alEC_fn &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;alEC_lr&quot;</span>,</span>
<span id="cb43-9"><a href="mri.html#cb43-9" aria-hidden="true"></a>                <span class="kw">sprintf</span>(<span class="st">&quot;%s_group_prob_mni1mm.nii.gz&quot;</span>, <span class="st">&quot;alEC_lr&quot;</span>))</span>
<span id="cb43-10"><a href="mri.html#cb43-10" aria-hidden="true"></a>svc_mask_fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>mask_dir, <span class="st">&quot;svc&quot;</span>, <span class="st">&quot;svc_mask.nii.gz&quot;</span>)</span>
<span id="cb43-11"><a href="mri.html#cb43-11" aria-hidden="true"></a><span class="kw">fsl_add</span>(<span class="dt">file =</span> aHPC_fn, <span class="dt">file2 =</span> alEC_fn, <span class="dt">outfile =</span> svc_mask_fn, </span>
<span id="cb43-12"><a href="mri.html#cb43-12" aria-hidden="true"></a>        <span class="dt">retimg =</span> <span class="ot">FALSE</span>)</span>
<span id="cb43-13"><a href="mri.html#cb43-13" aria-hidden="true"></a>svc_nii &lt;-<span class="st"> </span><span class="kw">fslmaths</span>(<span class="dt">file =</span> svc_mask_fn, <span class="dt">outfile =</span> svc_mask_fn, </span>
<span id="cb43-14"><a href="mri.html#cb43-14" aria-hidden="true"></a>                    <span class="dt">opts =</span> <span class="kw">sprintf</span>(<span class="st">&quot;-thr 0.99 -bin -mas %s&quot;</span>, gm_mask), </span>
<span id="cb43-15"><a href="mri.html#cb43-15" aria-hidden="true"></a>                    <span class="dt">retimg =</span> <span class="ot">TRUE</span>)</span>
<span id="cb43-16"><a href="mri.html#cb43-16" aria-hidden="true"></a></span>
<span id="cb43-17"><a href="mri.html#cb43-17" aria-hidden="true"></a><span class="co"># let&#39;s have a look at the mask we created</span></span>
<span id="cb43-18"><a href="mri.html#cb43-18" aria-hidden="true"></a>mni_nii &lt;-<span class="st"> </span><span class="kw">readNIfTI2</span>(<span class="kw">mni_fname</span>(<span class="st">&quot;1&quot;</span>))</span>
<span id="cb43-19"><a href="mri.html#cb43-19" aria-hidden="true"></a><span class="kw">ortho2</span>(mni_nii, <span class="dt">y =</span> svc_nii, <span class="dt">xyz =</span> <span class="kw">c</span>(<span class="dv">63</span>, <span class="dv">113</span>, <span class="dv">50</span>))</span>
<span id="cb43-20"><a href="mri.html#cb43-20" aria-hidden="true"></a><span class="kw">ortho2</span>(mni_nii, <span class="dt">y =</span> svc_nii, <span class="dt">xyz =</span> <span class="kw">c</span>(<span class="dv">71</span>, <span class="dv">127</span>, <span class="dv">39</span>))</span></code></pre></div>

</div>
</div>
<div id="quantify-representational-change" class="section level2 unnumbered">
<h2>Quantify Representational Change</h2>
<p>###Get multi-voxel patterns from ROIs {-}</p>
<p>We want to run RSA on the multi-voxel patterns corresponding to the object presentations during the picture viewing tasks. For this, we use the data as it was preprocessed by Lorena Deuker. We will do some further cleaning and extract the relevant volumes from the time series to eventually run RSA.</p>
<div id="preprocessing" class="section level4 unnumbered">
<h4>Preprocessing</h4>
<p>Preprocessing was performed with FSL (<a href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/" class="uri">http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/</a>). All three functional scans and the short wholebrain functional scan were submitted to motion correction and high-pass filtering (for very slow drifts) separately. For the two picture viewing tasks, every sub-block was preprocessed independently even though the scanner was not stopped in between. This was done because participants often moved in the short breaks between sub-blocks and we aimed to remove these parts of the data and achieve a better coregistration across sessions. For those participants with a fieldmap scan, distortion correction was applied to the functional data sets. No spatial smoothing was performed. All functional datasets were then registered to the preprocessed mean image of the wholebrain scan. This was done to ensure that voxels from separate sessions and sub-blocks were corresponding to the same anatomical location.</p>
<p>The brain masks from the functional sessions were also registered to the wholebrain space and intersected: only voxels which were covered all sub-blocks in both picture viewing sessions were analyzed during the next step. The whole brain functional images were registered to the individual structural scans. The structural scans were then in turn normalized to the MNI template (at 1mm resolution). Grey-matter segmentation was done on the structural images and the results were mapped back to the space of the wholebrain functional scan for later use in the analysis.</p>
</div>
<div id="extract-roi-time-series-and-calculate-residuals-from-motion-parameter-regression" class="section level4 unnumbered">
<h4>Extract ROI time series and calculate residuals from motion parameter regression</h4>
<p>In this first section of the script we will create a dataframe that includes the relevant file names for the files that are needed to extract the clean time series. These files include the motion parameters from FSL Feat, which was run on the functional data from the picture viewing task. As described above, these data were split into 10 blocks. We will use the preprocessed Feat output images which were already co-registered to the analysis space (‘samespace’). Further, we will use a mask to only include voxels with data in all blocks. This mask has already been created and is available in the analysis space. Additionally, we will use the graymatter mask and ROI masks(both already co-registered to the analysis space).</p>
<div id="build-data-frame-with-files-and-folders" class="section level5 unnumbered">
<h5>Build data frame with files and folders</h5>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="mri.html#cb44-1" aria-hidden="true"></a><span class="co">#PREPARE DATA FRAME FOR CLEANING</span></span>
<span id="cb44-2"><a href="mri.html#cb44-2" aria-hidden="true"></a></span>
<span id="cb44-3"><a href="mri.html#cb44-3" aria-hidden="true"></a><span class="co"># create a tibble with filenames etc for data cleaning, start with subject IDs</span></span>
<span id="cb44-4"><a href="mri.html#cb44-4" aria-hidden="true"></a>func_dat_df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">subject =</span> <span class="kw">rep</span>(<span class="kw">as.numeric</span>(subjects), <span class="dt">each =</span> n_runs <span class="op">*</span><span class="st"> </span>n_blocks))</span>
<span id="cb44-5"><a href="mri.html#cb44-5" aria-hidden="true"></a><span class="co"># add run info (run 1 and 2 equal the pre and post PVT)</span></span>
<span id="cb44-6"><a href="mri.html#cb44-6" aria-hidden="true"></a>func_dat_df &lt;-<span class="st"> </span><span class="kw">add_column</span>(func_dat_df, <span class="dt">run =</span> <span class="kw">rep</span>(<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>n_runs, <span class="dt">each =</span> n_blocks), n_subs))</span>
<span id="cb44-7"><a href="mri.html#cb44-7" aria-hidden="true"></a><span class="co"># add block information (blocks 1 to 10 are the PVT blocks preprocessed separately)</span></span>
<span id="cb44-8"><a href="mri.html#cb44-8" aria-hidden="true"></a>func_dat_df &lt;-<span class="st"> </span><span class="kw">add_column</span>(func_dat_df, <span class="dt">block =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>n_blocks, n_subs<span class="op">*</span>n_runs))</span>
<span id="cb44-9"><a href="mri.html#cb44-9" aria-hidden="true"></a><span class="co"># add the motion parameter file</span></span>
<span id="cb44-10"><a href="mri.html#cb44-10" aria-hidden="true"></a>func_dat_df &lt;-<span class="st"> </span><span class="kw">add_column</span>(func_dat_df, <span class="dt">mc_par_fn =</span> </span>
<span id="cb44-11"><a href="mri.html#cb44-11" aria-hidden="true"></a>                            <span class="kw">file.path</span>(dirs<span class="op">$</span>feat_dir,</span>
<span id="cb44-12"><a href="mri.html#cb44-12" aria-hidden="true"></a>                                      <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P0&quot;</span>, func_dat_df<span class="op">$</span>subject),</span>
<span id="cb44-13"><a href="mri.html#cb44-13" aria-hidden="true"></a>                                      <span class="kw">sprintf</span>(<span class="st">&quot;RSA_%02d_Block%02d.feat&quot;</span>,</span>
<span id="cb44-14"><a href="mri.html#cb44-14" aria-hidden="true"></a>                                              func_dat_df<span class="op">$</span>run, func_dat_df<span class="op">$</span>block),</span>
<span id="cb44-15"><a href="mri.html#cb44-15" aria-hidden="true"></a>                                      <span class="st">&quot;mc&quot;</span>, <span class="st">&quot;prefiltered_func_data_mcf.par&quot;</span>))</span>
<span id="cb44-16"><a href="mri.html#cb44-16" aria-hidden="true"></a><span class="co"># add the functional data file</span></span>
<span id="cb44-17"><a href="mri.html#cb44-17" aria-hidden="true"></a>func_dat_df &lt;-<span class="st"> </span><span class="kw">add_column</span>(func_dat_df, <span class="dt">filtered_func =</span> </span>
<span id="cb44-18"><a href="mri.html#cb44-18" aria-hidden="true"></a>                            <span class="kw">file.path</span>(dirs<span class="op">$</span>samespace_dir,</span>
<span id="cb44-19"><a href="mri.html#cb44-19" aria-hidden="true"></a>                                      <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P0&quot;</span>, func_dat_df<span class="op">$</span>subject),</span>
<span id="cb44-20"><a href="mri.html#cb44-20" aria-hidden="true"></a>                                      <span class="kw">sprintf</span>(<span class="st">&quot;VIRTEM_P%03d_RSA_%02d_Block%02d_func.nii.gz&quot;</span>,</span>
<span id="cb44-21"><a href="mri.html#cb44-21" aria-hidden="true"></a>                                              func_dat_df<span class="op">$</span>subject, func_dat_df<span class="op">$</span>run, func_dat_df<span class="op">$</span>block)))</span>
<span id="cb44-22"><a href="mri.html#cb44-22" aria-hidden="true"></a><span class="co"># add the brain mask data file</span></span>
<span id="cb44-23"><a href="mri.html#cb44-23" aria-hidden="true"></a>func_dat_df &lt;-<span class="st"> </span><span class="kw">add_column</span>(func_dat_df, <span class="dt">brain_mask =</span> </span>
<span id="cb44-24"><a href="mri.html#cb44-24" aria-hidden="true"></a>                            <span class="kw">file.path</span>(dirs<span class="op">$</span>samespace_dir,</span>
<span id="cb44-25"><a href="mri.html#cb44-25" aria-hidden="true"></a>                                      <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P0&quot;</span>, func_dat_df<span class="op">$</span>subject),</span>
<span id="cb44-26"><a href="mri.html#cb44-26" aria-hidden="true"></a>                                      <span class="kw">sprintf</span>(<span class="st">&quot;VIRTEM_P%03d_common_mask_perBlock.nii.gz&quot;</span>,</span>
<span id="cb44-27"><a href="mri.html#cb44-27" aria-hidden="true"></a>                                              func_dat_df<span class="op">$</span>subject)))</span>
<span id="cb44-28"><a href="mri.html#cb44-28" aria-hidden="true"></a></span>
<span id="cb44-29"><a href="mri.html#cb44-29" aria-hidden="true"></a><span class="co"># add the graymatter mask file</span></span>
<span id="cb44-30"><a href="mri.html#cb44-30" aria-hidden="true"></a>func_dat_df &lt;-<span class="st"> </span><span class="kw">add_column</span>(func_dat_df, <span class="dt">gray_mask =</span> </span>
<span id="cb44-31"><a href="mri.html#cb44-31" aria-hidden="true"></a>                            <span class="kw">file.path</span>(dirs<span class="op">$</span>samespace_dir,</span>
<span id="cb44-32"><a href="mri.html#cb44-32" aria-hidden="true"></a>                                      <span class="kw">paste0</span>(<span class="st">&quot;VIRTEM_P0&quot;</span>, func_dat_df<span class="op">$</span>subject),</span>
<span id="cb44-33"><a href="mri.html#cb44-33" aria-hidden="true"></a>                                      <span class="kw">sprintf</span>(<span class="st">&quot;VIRTEM_P%03d_common_graymatter_mask.nii.gz&quot;</span>,</span>
<span id="cb44-34"><a href="mri.html#cb44-34" aria-hidden="true"></a>                                              func_dat_df<span class="op">$</span>subject)))</span>
<span id="cb44-35"><a href="mri.html#cb44-35" aria-hidden="true"></a></span>
<span id="cb44-36"><a href="mri.html#cb44-36" aria-hidden="true"></a><span class="co"># add output directory</span></span>
<span id="cb44-37"><a href="mri.html#cb44-37" aria-hidden="true"></a>func_dat_df &lt;-<span class="st"> </span><span class="kw">add_column</span>(func_dat_df, <span class="dt">out_dir =</span> <span class="kw">list</span>(dirs<span class="op">$</span>rsa_roi_clean_timeseries_dirs))</span>
<span id="cb44-38"><a href="mri.html#cb44-38" aria-hidden="true"></a></span>
<span id="cb44-39"><a href="mri.html#cb44-39" aria-hidden="true"></a><span class="co"># add list of ROIs</span></span>
<span id="cb44-40"><a href="mri.html#cb44-40" aria-hidden="true"></a>func_dat_df &lt;-<span class="st"> </span><span class="kw">add_column</span>(func_dat_df, <span class="dt">rois =</span> <span class="kw">list</span>(rois))</span>
<span id="cb44-41"><a href="mri.html#cb44-41" aria-hidden="true"></a></span>
<span id="cb44-42"><a href="mri.html#cb44-42" aria-hidden="true"></a><span class="co"># add list of ROI file names</span></span>
<span id="cb44-43"><a href="mri.html#cb44-43" aria-hidden="true"></a>func_dat_df &lt;-<span class="st"> </span><span class="kw">add_column</span>(func_dat_df, <span class="dt">roi_dirs =</span> <span class="kw">list</span>(dirs<span class="op">$</span>rois_ss_dirs))</span></code></pre></div>
</div>
<div id="define-the-function-used-to-clean-functional-data" class="section level5 unnumbered">
<h5>Define the function used to clean functional data</h5>
<p>In this next section, we will first define a function and then run it on all datasets. In this function, the preprocessed data will be loaded and transformed to matrix format. A combined mask is generated from the respective ROI mask and the graymatter and brain masks. For every voxel within this mask, movement correction parameters are used as predictors in a GLM with the voxel time series as dependent variable. Finally, the residuals from this GLM (i.e. what could not be explained by motion) will be written to a text file.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="mri.html#cb45-1" aria-hidden="true"></a><span class="co"># DEFINE THE FUNCTION TO GET THE RESIDUAL TIME SERIES </span></span>
<span id="cb45-2"><a href="mri.html#cb45-2" aria-hidden="true"></a>run_motion_glm &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">df =</span> func_dat_df[<span class="dv">1</span>,]){</span>
<span id="cb45-3"><a href="mri.html#cb45-3" aria-hidden="true"></a>  </span>
<span id="cb45-4"><a href="mri.html#cb45-4" aria-hidden="true"></a>  <span class="co"># load the motion params and convert to tibble</span></span>
<span id="cb45-5"><a href="mri.html#cb45-5" aria-hidden="true"></a>  mc_pars &lt;-<span class="st"> </span><span class="kw">read.table</span>(df<span class="op">$</span>mc_par_fn, <span class="dt">header =</span> <span class="ot">FALSE</span>)</span>
<span id="cb45-6"><a href="mri.html#cb45-6" aria-hidden="true"></a>  mp_df &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(mc_pars)</span>
<span id="cb45-7"><a href="mri.html#cb45-7" aria-hidden="true"></a>  <span class="kw">colnames</span>(mp_df) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;mp&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>)</span>
<span id="cb45-8"><a href="mri.html#cb45-8" aria-hidden="true"></a>  </span>
<span id="cb45-9"><a href="mri.html#cb45-9" aria-hidden="true"></a>  <span class="co"># load the brain mask and linearize it </span></span>
<span id="cb45-10"><a href="mri.html#cb45-10" aria-hidden="true"></a>  brain_mask_nii &lt;-<span class="st"> </span><span class="kw">readNIfTI2</span>(df<span class="op">$</span>brain_mask)</span>
<span id="cb45-11"><a href="mri.html#cb45-11" aria-hidden="true"></a>  brain_mask_lin &lt;-<span class="st"> </span><span class="kw">c</span>(brain_mask_nii)</span>
<span id="cb45-12"><a href="mri.html#cb45-12" aria-hidden="true"></a>  assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">all.equal</span>(<span class="kw">unique</span>(brain_mask_lin), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)))</span>
<span id="cb45-13"><a href="mri.html#cb45-13" aria-hidden="true"></a>  </span>
<span id="cb45-14"><a href="mri.html#cb45-14" aria-hidden="true"></a>  <span class="co"># load the graymatter mask and linearize it and threshold it at 0.7</span></span>
<span id="cb45-15"><a href="mri.html#cb45-15" aria-hidden="true"></a>  gray_mask_nii &lt;-<span class="st"> </span><span class="kw">readNIfTI2</span>(df<span class="op">$</span>gray_mask)</span>
<span id="cb45-16"><a href="mri.html#cb45-16" aria-hidden="true"></a>  gray_mask_lin &lt;-<span class="st"> </span><span class="kw">c</span>(gray_mask_nii) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.7</span></span>
<span id="cb45-17"><a href="mri.html#cb45-17" aria-hidden="true"></a>  </span>
<span id="cb45-18"><a href="mri.html#cb45-18" aria-hidden="true"></a>  <span class="co"># load the functional data</span></span>
<span id="cb45-19"><a href="mri.html#cb45-19" aria-hidden="true"></a>  func_nii &lt;-<span class="st"> </span><span class="kw">readNIfTI2</span>(df<span class="op">$</span>filtered_func)</span>
<span id="cb45-20"><a href="mri.html#cb45-20" aria-hidden="true"></a>  </span>
<span id="cb45-21"><a href="mri.html#cb45-21" aria-hidden="true"></a>  <span class="co"># create matrix from the functional data with voxels in rows and volumes in columns</span></span>
<span id="cb45-22"><a href="mri.html#cb45-22" aria-hidden="true"></a>  n_vols &lt;-<span class="st"> </span><span class="kw">dim</span>(func_nii)[<span class="dv">4</span>]</span>
<span id="cb45-23"><a href="mri.html#cb45-23" aria-hidden="true"></a>  func_dat_mat &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dt">nrow =</span> <span class="kw">prod</span>(<span class="kw">dim</span>(func_nii)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]), <span class="dt">ncol =</span> n_vols)</span>
<span id="cb45-24"><a href="mri.html#cb45-24" aria-hidden="true"></a>  <span class="cf">for</span>(i_vol <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_vols){</span>
<span id="cb45-25"><a href="mri.html#cb45-25" aria-hidden="true"></a>    func_dat_mat[,i_vol] &lt;-<span class="st"> </span><span class="kw">c</span>(func_nii[,,,i_vol])</span>
<span id="cb45-26"><a href="mri.html#cb45-26" aria-hidden="true"></a>  }</span>
<span id="cb45-27"><a href="mri.html#cb45-27" aria-hidden="true"></a>  </span>
<span id="cb45-28"><a href="mri.html#cb45-28" aria-hidden="true"></a>  <span class="co"># define the roi files    </span></span>
<span id="cb45-29"><a href="mri.html#cb45-29" aria-hidden="true"></a>  roi_files &lt;-<span class="st"> </span><span class="kw">file.path</span>(df<span class="op">$</span>roi_dirs[[<span class="dv">1</span>]], </span>
<span id="cb45-30"><a href="mri.html#cb45-30" aria-hidden="true"></a>                         <span class="kw">sprintf</span>(<span class="st">&quot;P%03d_%s_ss_fs.nii.gz&quot;</span>, df<span class="op">$</span>subject, df<span class="op">$</span>rois[[<span class="dv">1</span>]]))</span>
<span id="cb45-31"><a href="mri.html#cb45-31" aria-hidden="true"></a>  </span>
<span id="cb45-32"><a href="mri.html#cb45-32" aria-hidden="true"></a>  <span class="co"># loop over the ROIs</span></span>
<span id="cb45-33"><a href="mri.html#cb45-33" aria-hidden="true"></a>  <span class="cf">for</span>(i_roi <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(roi_files)){</span>
<span id="cb45-34"><a href="mri.html#cb45-34" aria-hidden="true"></a></span>
<span id="cb45-35"><a href="mri.html#cb45-35" aria-hidden="true"></a>    <span class="co"># load the current ROI and linearize</span></span>
<span id="cb45-36"><a href="mri.html#cb45-36" aria-hidden="true"></a>    roi_nii &lt;-<span class="st"> </span><span class="kw">readNIfTI2</span>(roi_files[i_roi])</span>
<span id="cb45-37"><a href="mri.html#cb45-37" aria-hidden="true"></a>    roi_lin &lt;-<span class="st"> </span><span class="kw">c</span>(roi_nii)</span>
<span id="cb45-38"><a href="mri.html#cb45-38" aria-hidden="true"></a>    </span>
<span id="cb45-39"><a href="mri.html#cb45-39" aria-hidden="true"></a>    <span class="co"># make sure masks and functional data have the same number of voxels</span></span>
<span id="cb45-40"><a href="mri.html#cb45-40" aria-hidden="true"></a>    assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">length</span>(roi_lin) <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(gray_mask_lin))</span>
<span id="cb45-41"><a href="mri.html#cb45-41" aria-hidden="true"></a>    assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">length</span>(roi_lin) <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(brain_mask_lin))</span>
<span id="cb45-42"><a href="mri.html#cb45-42" aria-hidden="true"></a>    assertthat<span class="op">::</span><span class="kw">assert_that</span>(<span class="kw">length</span>(roi_lin) <span class="op">==</span><span class="st"> </span><span class="kw">dim</span>(func_dat_mat)[<span class="dv">1</span>])</span>
<span id="cb45-43"><a href="mri.html#cb45-43" aria-hidden="true"></a>    assertthat<span class="op">::</span><span class="kw">assert_that</span>(n_vols <span class="op">==</span><span class="st"> </span><span class="kw">nrow</span>(mc_pars))</span>
<span id="cb45-44"><a href="mri.html#cb45-44" aria-hidden="true"></a></span>
<span id="cb45-45"><a href="mri.html#cb45-45" aria-hidden="true"></a>    <span class="co"># create a mask combining the ROI, the graymatter, and the functional brain mask</span></span>
<span id="cb45-46"><a href="mri.html#cb45-46" aria-hidden="true"></a>    comb_mask &lt;-<span class="st"> </span><span class="kw">as.logical</span>(roi_lin) <span class="co">#&amp; gray_mask_lin &amp; as.logical(brain_mask_lin)</span></span>
<span id="cb45-47"><a href="mri.html#cb45-47" aria-hidden="true"></a>        </span>
<span id="cb45-48"><a href="mri.html#cb45-48" aria-hidden="true"></a>    <span class="co"># run the GLM for each voxel in the combined mask</span></span>
<span id="cb45-49"><a href="mri.html#cb45-49" aria-hidden="true"></a>    roi_dat &lt;-<span class="st"> </span>func_dat_mat[comb_mask,]</span>
<span id="cb45-50"><a href="mri.html#cb45-50" aria-hidden="true"></a>      </span>
<span id="cb45-51"><a href="mri.html#cb45-51" aria-hidden="true"></a>    <span class="co"># initialize output for cleaned timeseries and then loop over all voxels</span></span>
<span id="cb45-52"><a href="mri.html#cb45-52" aria-hidden="true"></a>    roi_dat_clean &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dt">nrow =</span> <span class="kw">sum</span>(comb_mask), <span class="dt">ncol =</span> n_vols)</span>
<span id="cb45-53"><a href="mri.html#cb45-53" aria-hidden="true"></a>    <span class="cf">for</span>(i_vox <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">sum</span>(comb_mask)){</span>
<span id="cb45-54"><a href="mri.html#cb45-54" aria-hidden="true"></a>      </span>
<span id="cb45-55"><a href="mri.html#cb45-55" aria-hidden="true"></a>      <span class="co"># extract this voxel&#39;s data and merge with motion params</span></span>
<span id="cb45-56"><a href="mri.html#cb45-56" aria-hidden="true"></a>      vox_dat &lt;-<span class="st"> </span>roi_dat[i_vox,]</span>
<span id="cb45-57"><a href="mri.html#cb45-57" aria-hidden="true"></a>      vox_df &lt;-<span class="st"> </span><span class="kw">tibble</span>(vox_dat)</span>
<span id="cb45-58"><a href="mri.html#cb45-58" aria-hidden="true"></a>      vox_df &lt;-<span class="st"> </span><span class="kw">cbind</span>(vox_df, mp_df)</span>
<span id="cb45-59"><a href="mri.html#cb45-59" aria-hidden="true"></a>      </span>
<span id="cb45-60"><a href="mri.html#cb45-60" aria-hidden="true"></a>      <span class="co"># run the glm and store the residuals</span></span>
<span id="cb45-61"><a href="mri.html#cb45-61" aria-hidden="true"></a>      roi_dat_clean[i_vox,] &lt;-<span class="st"> </span><span class="kw">resid</span>(<span class="kw">glm</span>(<span class="st">&#39;vox_dat~mp1+mp2+mp3+mp4+mp5+mp6&#39;</span>, <span class="dt">data =</span> vox_df))</span>
<span id="cb45-62"><a href="mri.html#cb45-62" aria-hidden="true"></a>    }</span>
<span id="cb45-63"><a href="mri.html#cb45-63" aria-hidden="true"></a>    </span>
<span id="cb45-64"><a href="mri.html#cb45-64" aria-hidden="true"></a>    <span class="co"># write clean timeseries data of this ROI to file </span></span>
<span id="cb45-65"><a href="mri.html#cb45-65" aria-hidden="true"></a>    fn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%03d_run%02d_block%02d_%s_clean_timeseries.txt&quot;</span>,</span>
<span id="cb45-66"><a href="mri.html#cb45-66" aria-hidden="true"></a>                  df<span class="op">$</span>subject, df<span class="op">$</span>run, df<span class="op">$</span>block, df<span class="op">$</span>rois[[<span class="dv">1</span>]][i_roi])</span>
<span id="cb45-67"><a href="mri.html#cb45-67" aria-hidden="true"></a>    out_dir_sub &lt;-<span class="st"> </span><span class="kw">file.path</span>(df<span class="op">$</span>out_dir[[<span class="dv">1</span>]][i_roi], <span class="kw">sprintf</span>(<span class="st">&quot;%03d&quot;</span>,df<span class="op">$</span>subject))</span>
<span id="cb45-68"><a href="mri.html#cb45-68" aria-hidden="true"></a>    <span class="cf">if</span>(<span class="op">!</span><span class="kw">dir.exists</span>(out_dir_sub)){<span class="kw">dir.create</span>(out_dir_sub)}                    </span>
<span id="cb45-69"><a href="mri.html#cb45-69" aria-hidden="true"></a>    <span class="kw">write.table</span>(roi_dat_clean, <span class="kw">file.path</span>(out_dir_sub, fn), <span class="dt">append =</span> <span class="ot">FALSE</span>, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>,</span>
<span id="cb45-70"><a href="mri.html#cb45-70" aria-hidden="true"></a>                <span class="dt">row.names =</span> <span class="ot">FALSE</span>, <span class="dt">col.names =</span> <span class="ot">FALSE</span>)</span>
<span id="cb45-71"><a href="mri.html#cb45-71" aria-hidden="true"></a>  }</span>
<span id="cb45-72"><a href="mri.html#cb45-72" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<div id="apply-cleaning-functions" class="section level5 unnumbered">
<h5>Apply cleaning functions</h5>
<p>Now we are ready to apply the cleaning function to all blocks of all participants. Typically, this should be run in parallel to save time.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="mri.html#cb46-1" aria-hidden="true"></a><span class="co"># next step depends on whether we are in parallel or serial mode</span></span>
<span id="cb46-2"><a href="mri.html#cb46-2" aria-hidden="true"></a></span>
<span id="cb46-3"><a href="mri.html#cb46-3" aria-hidden="true"></a><span class="cf">if</span> (<span class="op">!</span>run_parallel){ <span class="co"># run serially</span></span>
<span id="cb46-4"><a href="mri.html#cb46-4" aria-hidden="true"></a></span>
<span id="cb46-5"><a href="mri.html#cb46-5" aria-hidden="true"></a>  <span class="co"># run the function for each row of the data frame,</span></span>
<span id="cb46-6"><a href="mri.html#cb46-6" aria-hidden="true"></a>  <span class="co"># i.e. for each block in each run for each subject</span></span>
<span id="cb46-7"><a href="mri.html#cb46-7" aria-hidden="true"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(func_dat_df)){</span>
<span id="cb46-8"><a href="mri.html#cb46-8" aria-hidden="true"></a>    </span>
<span id="cb46-9"><a href="mri.html#cb46-9" aria-hidden="true"></a>    <span class="kw">tic</span>(<span class="kw">sprintf</span>(<span class="st">&quot;Subject %s, run %d, block %d&quot;</span>,</span>
<span id="cb46-10"><a href="mri.html#cb46-10" aria-hidden="true"></a>                func_dat_df<span class="op">$</span>subject[i], func_dat_df<span class="op">$</span>run[i], func_dat_df<span class="op">$</span>block[i]))</span>
<span id="cb46-11"><a href="mri.html#cb46-11" aria-hidden="true"></a>    <span class="kw">run_motion_glm</span>(<span class="dt">df =</span> func_dat_df[i,])</span>
<span id="cb46-12"><a href="mri.html#cb46-12" aria-hidden="true"></a>    <span class="kw">toc</span>()</span>
<span id="cb46-13"><a href="mri.html#cb46-13" aria-hidden="true"></a>  }</span>
<span id="cb46-14"><a href="mri.html#cb46-14" aria-hidden="true"></a>  </span>
<span id="cb46-15"><a href="mri.html#cb46-15" aria-hidden="true"></a>} <span class="cf">else</span> <span class="cf">if</span> (run_parallel){ <span class="co"># run in parallel, assumes CBS HTCondor is available</span></span>
<span id="cb46-16"><a href="mri.html#cb46-16" aria-hidden="true"></a>  </span>
<span id="cb46-17"><a href="mri.html#cb46-17" aria-hidden="true"></a>  <span class="co"># expand the data frame and write to file</span></span>
<span id="cb46-18"><a href="mri.html#cb46-18" aria-hidden="true"></a>  func_dat_df_long &lt;-<span class="st"> </span><span class="kw">unnest</span>(func_dat_df, <span class="dt">cols =</span> <span class="kw">c</span>(rois, out_dir, roi_dirs))</span>
<span id="cb46-19"><a href="mri.html#cb46-19" aria-hidden="true"></a>  fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;clean_roi_timeseries&quot;</span>),</span>
<span id="cb46-20"><a href="mri.html#cb46-20" aria-hidden="true"></a>                  <span class="st">&quot;htc_config_clean_time_series.txt&quot;</span>)</span>
<span id="cb46-21"><a href="mri.html#cb46-21" aria-hidden="true"></a>  fn_def &lt;-<span class="st"> </span><span class="kw">cat</span>(<span class="kw">sprintf</span>(<span class="st">&#39;&quot;fn &lt;- &quot;%s&quot;&#39;</span>,fn))</span>
<span id="cb46-22"><a href="mri.html#cb46-22" aria-hidden="true"></a>  <span class="kw">write.table</span>(func_dat_df_long, fn,</span>
<span id="cb46-23"><a href="mri.html#cb46-23" aria-hidden="true"></a>              <span class="dt">append =</span> <span class="ot">FALSE</span>, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>, <span class="dt">col.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb46-24"><a href="mri.html#cb46-24" aria-hidden="true"></a>  </span>
<span id="cb46-25"><a href="mri.html#cb46-25" aria-hidden="true"></a>  <span class="co"># store the function definition as text</span></span>
<span id="cb46-26"><a href="mri.html#cb46-26" aria-hidden="true"></a>  func_def &lt;-<span class="st"> </span><span class="kw">capture.output</span>(run_motion_glm)</span>
<span id="cb46-27"><a href="mri.html#cb46-27" aria-hidden="true"></a>  func_def[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;run_motion_glm &lt;- &quot;</span>,func_def[<span class="dv">1</span>])</span>
<span id="cb46-28"><a href="mri.html#cb46-28" aria-hidden="true"></a>  <span class="co">#func_def &lt;- func_def[-length(func_def)]</span></span>
<span id="cb46-29"><a href="mri.html#cb46-29" aria-hidden="true"></a>  </span>
<span id="cb46-30"><a href="mri.html#cb46-30" aria-hidden="true"></a>  <span class="co">#write the Rscript that we want to run</span></span>
<span id="cb46-31"><a href="mri.html#cb46-31" aria-hidden="true"></a>  rscript_fn &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;clean_roi_timeseries&quot;</span>, <span class="st">&quot;run_clean_timeseries.R&quot;</span>)</span>
<span id="cb46-32"><a href="mri.html#cb46-32" aria-hidden="true"></a>  con &lt;-<span class="st"> </span><span class="kw">file</span>(rscript_fn)</span>
<span id="cb46-33"><a href="mri.html#cb46-33" aria-hidden="true"></a>  <span class="kw">open</span>(con, <span class="st">&quot;w&quot;</span>)</span>
<span id="cb46-34"><a href="mri.html#cb46-34" aria-hidden="true"></a>  <span class="kw">writeLines</span>(<span class="kw">c</span>(</span>
<span id="cb46-35"><a href="mri.html#cb46-35" aria-hidden="true"></a>    <span class="st">&quot;</span><span class="ch">\n</span><span class="st"># handle input&quot;</span>,</span>
<span id="cb46-36"><a href="mri.html#cb46-36" aria-hidden="true"></a>    <span class="st">&quot;args = commandArgs()&quot;</span>,</span>
<span id="cb46-37"><a href="mri.html#cb46-37" aria-hidden="true"></a>    <span class="st">&quot;i &lt;- as.numeric(args[length(args)])&quot;</span>,</span>
<span id="cb46-38"><a href="mri.html#cb46-38" aria-hidden="true"></a>    <span class="st">&quot;</span><span class="ch">\n</span><span class="st">#load required packages&quot;</span>,</span>
<span id="cb46-39"><a href="mri.html#cb46-39" aria-hidden="true"></a>    <span class="kw">noquote</span>(<span class="kw">sprintf</span>(<span class="st">&#39;lib_dir &lt;- &quot;%s&quot;&#39;</span>,<span class="st">&quot;/data/pt_02261/virtem/virtem_code/R3.6.1/library/Linux&quot;</span>)),</span>
<span id="cb46-40"><a href="mri.html#cb46-40" aria-hidden="true"></a>    <span class="st">&#39;.libPaths(c(lib_dir,.libPaths()))&#39;</span>,</span>
<span id="cb46-41"><a href="mri.html#cb46-41" aria-hidden="true"></a>    <span class="st">&#39;lapply(c(&quot;oro.nifti&quot;, &quot;assertthat&quot;, &quot;dplyr&quot;, &quot;neurobase&quot;), library, character.only = TRUE)&#39;</span>,</span>
<span id="cb46-42"><a href="mri.html#cb46-42" aria-hidden="true"></a>    <span class="st">&quot;</span><span class="ch">\n</span><span class="st"># read the data and transform ROI column back to list&quot;</span>,</span>
<span id="cb46-43"><a href="mri.html#cb46-43" aria-hidden="true"></a>    <span class="kw">noquote</span>(<span class="kw">sprintf</span>(<span class="st">&#39;fn &lt;- &quot;%s&quot;&#39;</span>,fn)),</span>
<span id="cb46-44"><a href="mri.html#cb46-44" aria-hidden="true"></a>    <span class="st">&#39;func_dat_df &lt;- read.table(fn, sep = &quot;,&quot;, header = TRUE, stringsAsFactors = FALSE)&#39;</span>,</span>
<span id="cb46-45"><a href="mri.html#cb46-45" aria-hidden="true"></a>    <span class="st">&quot;</span><span class="ch">\n</span><span class="st">#define the function to run motion GLM&quot;</span>,</span>
<span id="cb46-46"><a href="mri.html#cb46-46" aria-hidden="true"></a>    func_def,</span>
<span id="cb46-47"><a href="mri.html#cb46-47" aria-hidden="true"></a>    <span class="st">&quot;</span><span class="ch">\n</span><span class="st"># run the function on one line of the data frame&quot;</span>,</span>
<span id="cb46-48"><a href="mri.html#cb46-48" aria-hidden="true"></a>    <span class="st">&quot;run_motion_glm(df = func_dat_df[i,])&quot;</span>),con)</span>
<span id="cb46-49"><a href="mri.html#cb46-49" aria-hidden="true"></a>  <span class="kw">close</span>(con)</span>
<span id="cb46-50"><a href="mri.html#cb46-50" aria-hidden="true"></a>  </span>
<span id="cb46-51"><a href="mri.html#cb46-51" aria-hidden="true"></a>  <span class="co"># folder for condor output</span></span>
<span id="cb46-52"><a href="mri.html#cb46-52" aria-hidden="true"></a>  htc_dir &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;htc_logs&quot;</span>, <span class="st">&quot;clean_timeseries&quot;</span>)</span>
<span id="cb46-53"><a href="mri.html#cb46-53" aria-hidden="true"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">exists</span>(htc_dir)){<span class="kw">dir.create</span>(htc_dir, <span class="dt">recursive =</span> <span class="ot">TRUE</span>)}</span>
<span id="cb46-54"><a href="mri.html#cb46-54" aria-hidden="true"></a>  </span>
<span id="cb46-55"><a href="mri.html#cb46-55" aria-hidden="true"></a>  <span class="co"># write the submit script</span></span>
<span id="cb46-56"><a href="mri.html#cb46-56" aria-hidden="true"></a>  fn &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;clean_roi_timeseries&quot;</span>, <span class="st">&quot;run_clean_timeseries.submit&quot;</span>)</span>
<span id="cb46-57"><a href="mri.html#cb46-57" aria-hidden="true"></a>  con &lt;-<span class="st"> </span><span class="kw">file</span>(fn)</span>
<span id="cb46-58"><a href="mri.html#cb46-58" aria-hidden="true"></a>  <span class="kw">open</span>(con, <span class="st">&quot;w&quot;</span>)</span>
<span id="cb46-59"><a href="mri.html#cb46-59" aria-hidden="true"></a>  <span class="kw">writeLines</span>(<span class="kw">c</span>(</span>
<span id="cb46-60"><a href="mri.html#cb46-60" aria-hidden="true"></a>    <span class="st">&quot;universe = vanilla&quot;</span>,</span>
<span id="cb46-61"><a href="mri.html#cb46-61" aria-hidden="true"></a>    <span class="st">&quot;executable = /afs/cbs.mpg.de/software/scripts/envwrap&quot;</span>,</span>
<span id="cb46-62"><a href="mri.html#cb46-62" aria-hidden="true"></a>    <span class="st">&quot;request_memory = 9000&quot;</span>,</span>
<span id="cb46-63"><a href="mri.html#cb46-63" aria-hidden="true"></a>    <span class="st">&quot;notification = error&quot;</span></span>
<span id="cb46-64"><a href="mri.html#cb46-64" aria-hidden="true"></a>    ),con)</span>
<span id="cb46-65"><a href="mri.html#cb46-65" aria-hidden="true"></a></span>
<span id="cb46-66"><a href="mri.html#cb46-66" aria-hidden="true"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(func_dat_df_long)){</span>
<span id="cb46-67"><a href="mri.html#cb46-67" aria-hidden="true"></a>        <span class="kw">writeLines</span>(<span class="kw">c</span>(</span>
<span id="cb46-68"><a href="mri.html#cb46-68" aria-hidden="true"></a>        <span class="kw">sprintf</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">arguments = R+ --version 3.6.1 Rscript %s %d&quot;</span>, rscript_fn, i),</span>
<span id="cb46-69"><a href="mri.html#cb46-69" aria-hidden="true"></a>        <span class="kw">sprintf</span>(<span class="st">&quot;log = %s/%d.log&quot;</span>, htc_dir, i),</span>
<span id="cb46-70"><a href="mri.html#cb46-70" aria-hidden="true"></a>        <span class="kw">sprintf</span>(<span class="st">&quot;output = %s/%d.out&quot;</span>, htc_dir, i),</span>
<span id="cb46-71"><a href="mri.html#cb46-71" aria-hidden="true"></a>        <span class="kw">sprintf</span>(<span class="st">&quot;error = %s/%d.err&quot;</span>, htc_dir, i),</span>
<span id="cb46-72"><a href="mri.html#cb46-72" aria-hidden="true"></a>        <span class="kw">sprintf</span>(<span class="st">&quot;Queue</span><span class="ch">\n</span><span class="st">&quot;</span>)),con)</span>
<span id="cb46-73"><a href="mri.html#cb46-73" aria-hidden="true"></a>        }</span>
<span id="cb46-74"><a href="mri.html#cb46-74" aria-hidden="true"></a>  <span class="kw">close</span>(con)</span>
<span id="cb46-75"><a href="mri.html#cb46-75" aria-hidden="true"></a>  </span>
<span id="cb46-76"><a href="mri.html#cb46-76" aria-hidden="true"></a>  <span class="co"># submit to condor</span></span>
<span id="cb46-77"><a href="mri.html#cb46-77" aria-hidden="true"></a>  <span class="co">#system(&quot;reset-memory-max&quot;)</span></span>
<span id="cb46-78"><a href="mri.html#cb46-78" aria-hidden="true"></a>  batch_id &lt;-<span class="st"> </span><span class="kw">system</span>(<span class="kw">paste</span>(<span class="st">&quot;condor_submit&quot;</span>, fn), <span class="dt">intern =</span> <span class="ot">TRUE</span>)</span>
<span id="cb46-79"><a href="mri.html#cb46-79" aria-hidden="true"></a>  batch_id &lt;-<span class="st"> </span><span class="kw">regmatches</span>(batch_id[<span class="dv">2</span>], <span class="kw">gregexpr</span>(<span class="st">&quot;[[:digit:]]+&quot;</span>, batch_id[<span class="dv">2</span>]))[[<span class="dv">1</span>]][<span class="dv">2</span>]</span>
<span id="cb46-80"><a href="mri.html#cb46-80" aria-hidden="true"></a>  <span class="co">#system(&quot;reset-memory-max&quot;)</span></span>
<span id="cb46-81"><a href="mri.html#cb46-81" aria-hidden="true"></a>  </span>
<span id="cb46-82"><a href="mri.html#cb46-82" aria-hidden="true"></a>  <span class="kw">sprintf</span>(<span class="st">&quot;submitted jobs (ID = %s) to clean time series in ROIs. Time to wait...&quot;</span>, batch_id)</span>
<span id="cb46-83"><a href="mri.html#cb46-83" aria-hidden="true"></a>  <span class="kw">pause_until_batch_done</span>(<span class="dt">batch_id =</span> batch_id, <span class="dt">wait_interval =</span> <span class="dv">300</span>)</span>
<span id="cb46-84"><a href="mri.html#cb46-84" aria-hidden="true"></a>}</span></code></pre></div>
</div>
</div>
<div id="extract-relevant-volumes" class="section level4 unnumbered">
<h4>Extract relevant volumes</h4>
<p>As the presentation of images in the PVT pre and post blocks was locked to the onset of a new volume (see above), the third volume after image onset was selected for every trial (effectively covering the time between 4540-6810 ms after stimulus onset).</p>
<p>In this step, we split the presentation logfile from the picture viewing task into the 10 blocks. We reference the volume count to the first volume of each block and extract the relevant volumes from the cleaned ROI timeseries data, accounting for the temporal offset. This is done for each ROI and each block separately in both the pre and post runs. The data are written to file. These output files include the multi-voxel patterns (rows) for each image (columns) that was presented during the picture viewing tasks, including the catch images. The columns are sorted based on the presentation order during the picture viewing task.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="mri.html#cb47-1" aria-hidden="true"></a>offset_tr =<span class="st"> </span><span class="dv">2</span></span>
<span id="cb47-2"><a href="mri.html#cb47-2" aria-hidden="true"></a></span>
<span id="cb47-3"><a href="mri.html#cb47-3" aria-hidden="true"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb47-4"><a href="mri.html#cb47-4" aria-hidden="true"></a>  <span class="cf">for</span> (i_run <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_runs){</span>
<span id="cb47-5"><a href="mri.html#cb47-5" aria-hidden="true"></a>    </span>
<span id="cb47-6"><a href="mri.html#cb47-6" aria-hidden="true"></a>    <span class="co"># load the logfile for this run (pre or post)</span></span>
<span id="cb47-7"><a href="mri.html#cb47-7" aria-hidden="true"></a>    log_fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>pvt_log_dir, <span class="kw">sprintf</span>(<span class="st">&#39;P%s_%svirtem.txt&#39;</span>, i_sub, runs[i_run]))</span>
<span id="cb47-8"><a href="mri.html#cb47-8" aria-hidden="true"></a>    log &lt;-<span class="st"> </span><span class="kw">read.table</span>(log_fn)</span>
<span id="cb47-9"><a href="mri.html#cb47-9" aria-hidden="true"></a>    <span class="kw">colnames</span>(log) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;pic&quot;</span>, <span class="st">&quot;fix_start&quot;</span>, <span class="st">&quot;pic_start&quot;</span>, <span class="st">&quot;volume&quot;</span>, <span class="st">&quot;response&quot;</span>, <span class="st">&quot;RT&quot;</span>, <span class="st">&quot;trial_end&quot;</span>)</span>
<span id="cb47-10"><a href="mri.html#cb47-10" aria-hidden="true"></a>    </span>
<span id="cb47-11"><a href="mri.html#cb47-11" aria-hidden="true"></a>    <span class="co"># split the log file into the 10 blocks</span></span>
<span id="cb47-12"><a href="mri.html#cb47-12" aria-hidden="true"></a>    log_split &lt;-<span class="st"> </span><span class="kw">split</span>(log, <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">each =</span> <span class="dv">21</span>))</span>
<span id="cb47-13"><a href="mri.html#cb47-13" aria-hidden="true"></a>    </span>
<span id="cb47-14"><a href="mri.html#cb47-14" aria-hidden="true"></a>    <span class="co"># reference volume numbers to the first volume of that block</span></span>
<span id="cb47-15"><a href="mri.html#cb47-15" aria-hidden="true"></a>    vol_block &lt;-<span class="st"> </span><span class="kw">lapply</span>(log_split, <span class="cf">function</span>(x){x<span class="op">$</span>volume <span class="op">-</span><span class="st"> </span>x<span class="op">$</span>volume[<span class="dv">1</span>]})</span>
<span id="cb47-16"><a href="mri.html#cb47-16" aria-hidden="true"></a>    log_split &lt;-<span class="st"> </span><span class="kw">mapply</span>(cbind, log_split, <span class="st">&quot;vol_block&quot;</span>=vol_block, <span class="dt">SIMPLIFY=</span><span class="ot">FALSE</span>)</span>
<span id="cb47-17"><a href="mri.html#cb47-17" aria-hidden="true"></a>    </span>
<span id="cb47-18"><a href="mri.html#cb47-18" aria-hidden="true"></a>    <span class="cf">for</span> (i_roi <span class="cf">in</span> rois){</span>
<span id="cb47-19"><a href="mri.html#cb47-19" aria-hidden="true"></a>      <span class="cf">for</span> (i_block <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>){</span>
<span id="cb47-20"><a href="mri.html#cb47-20" aria-hidden="true"></a>      </span>
<span id="cb47-21"><a href="mri.html#cb47-21" aria-hidden="true"></a>        <span class="co"># load the ROI timeseries</span></span>
<span id="cb47-22"><a href="mri.html#cb47-22" aria-hidden="true"></a>        fn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s_run%02d_block%02d_%s_clean_timeseries.txt&quot;</span>,</span>
<span id="cb47-23"><a href="mri.html#cb47-23" aria-hidden="true"></a>                      i_sub, i_run, i_block, i_roi)</span>
<span id="cb47-24"><a href="mri.html#cb47-24" aria-hidden="true"></a>        dir &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_dir, <span class="st">&quot;clean_roi_timeseries&quot;</span>, i_roi, i_sub)</span>
<span id="cb47-25"><a href="mri.html#cb47-25" aria-hidden="true"></a>        roi_dat &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="kw">file.path</span>(dir, fn), <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>)</span>
<span id="cb47-26"><a href="mri.html#cb47-26" aria-hidden="true"></a>        </span>
<span id="cb47-27"><a href="mri.html#cb47-27" aria-hidden="true"></a>        <span class="co"># index of relevant volumes when accounting for offset</span></span>
<span id="cb47-28"><a href="mri.html#cb47-28" aria-hidden="true"></a>        rel_vols &lt;-<span class="st"> </span>log_split[[i_block]]<span class="op">$</span>vol_block <span class="op">+</span><span class="st"> </span>offset_tr</span>
<span id="cb47-29"><a href="mri.html#cb47-29" aria-hidden="true"></a>        </span>
<span id="cb47-30"><a href="mri.html#cb47-30" aria-hidden="true"></a>        <span class="co"># extract the relevant volumes from the ROI timeseries data</span></span>
<span id="cb47-31"><a href="mri.html#cb47-31" aria-hidden="true"></a>        <span class="cf">if</span>(i_block <span class="op">==</span><span class="st"> </span><span class="dv">1</span>){rel_dat &lt;-<span class="st"> </span>roi_dat[,rel_vols]} <span class="cf">else</span>{ </span>
<span id="cb47-32"><a href="mri.html#cb47-32" aria-hidden="true"></a>          rel_dat &lt;-<span class="st"> </span><span class="kw">cbind</span>(rel_dat, roi_dat[,rel_vols])}</span>
<span id="cb47-33"><a href="mri.html#cb47-33" aria-hidden="true"></a>      }</span>
<span id="cb47-34"><a href="mri.html#cb47-34" aria-hidden="true"></a>      </span>
<span id="cb47-35"><a href="mri.html#cb47-35" aria-hidden="true"></a>      <span class="co"># save the relevant data</span></span>
<span id="cb47-36"><a href="mri.html#cb47-36" aria-hidden="true"></a>      out_dir &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_dir, <span class="st">&quot;relevant_roi_volumes&quot;</span>, i_roi)</span>
<span id="cb47-37"><a href="mri.html#cb47-37" aria-hidden="true"></a>      <span class="cf">if</span>(<span class="op">!</span><span class="kw">dir.exists</span>(out_dir)){<span class="kw">dir.create</span>(out_dir, <span class="dt">recursive =</span> <span class="ot">TRUE</span>)}</span>
<span id="cb47-38"><a href="mri.html#cb47-38" aria-hidden="true"></a>      fn &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s_%s_%s_relevant_volumes.txt&quot;</span>, i_sub, i_roi, runs[i_run])</span>
<span id="cb47-39"><a href="mri.html#cb47-39" aria-hidden="true"></a>      <span class="kw">write.table</span>(rel_dat, <span class="kw">file.path</span>(out_dir, fn), <span class="dt">append =</span> <span class="ot">FALSE</span>, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb47-40"><a href="mri.html#cb47-40" aria-hidden="true"></a>                  <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>, <span class="dt">col.names =</span> <span class="ot">FALSE</span>)</span>
<span id="cb47-41"><a href="mri.html#cb47-41" aria-hidden="true"></a>    }</span>
<span id="cb47-42"><a href="mri.html#cb47-42" aria-hidden="true"></a>  }</span>
<span id="cb47-43"><a href="mri.html#cb47-43" aria-hidden="true"></a>}</span></code></pre></div>

</div>
<div id="calculate-correlation-matrices" class="section level3 unnumbered">
<h3>Calculate correlation matrices</h3>
<p>Next, we need to calculate pair-wise correlations between the multi-voxel patterns from the picture viewing tasks. We will restrict the analysis to the 20 scenes during the learning task and discard the data for the target scene. The correlation matrix will first be calculated for trial-by-trial comparisons of multi-voxel patterns. These will then be averaged excluding comparisons of patterns from the same block. The resulting correlation matrices that are saved are ordered according to picture identity (i.e. picture 1-20 x picture 1-20).</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="mri.html#cb48-1" aria-hidden="true"></a><span class="co"># for all 10x10 comparisons we will be averaging all comparisons apart from the diagonal</span></span>
<span id="cb48-2"><a href="mri.html#cb48-2" aria-hidden="true"></a><span class="co"># to exclude same_block comparisons</span></span>
<span id="cb48-3"><a href="mri.html#cb48-3" aria-hidden="true"></a>no_diag &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dt">data =</span> <span class="ot">TRUE</span>, <span class="dt">nrow=</span><span class="dv">10</span>, <span class="dt">ncol =</span> <span class="dv">10</span>)</span>
<span id="cb48-4"><a href="mri.html#cb48-4" aria-hidden="true"></a><span class="kw">diag</span>(no_diag)&lt;-<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb48-5"><a href="mri.html#cb48-5" aria-hidden="true"></a></span>
<span id="cb48-6"><a href="mri.html#cb48-6" aria-hidden="true"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb48-7"><a href="mri.html#cb48-7" aria-hidden="true"></a>  <span class="cf">for</span> (i_run <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_runs){</span>
<span id="cb48-8"><a href="mri.html#cb48-8" aria-hidden="true"></a>    </span>
<span id="cb48-9"><a href="mri.html#cb48-9" aria-hidden="true"></a>    <span class="cf">for</span>(i_roi <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(rois)){</span>
<span id="cb48-10"><a href="mri.html#cb48-10" aria-hidden="true"></a>      </span>
<span id="cb48-11"><a href="mri.html#cb48-11" aria-hidden="true"></a>      <span class="co"># load the logfile for this run (pre or post) (Note to self: moved here 6 March when hunting ghosts)</span></span>
<span id="cb48-12"><a href="mri.html#cb48-12" aria-hidden="true"></a>      log_fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>pvt_log_dir, <span class="kw">sprintf</span>(<span class="st">&#39;P%s_%svirtem.txt&#39;</span>, i_sub, runs[i_run]))</span>
<span id="cb48-13"><a href="mri.html#cb48-13" aria-hidden="true"></a>      log &lt;-<span class="st"> </span><span class="kw">read.table</span>(log_fn)</span>
<span id="cb48-14"><a href="mri.html#cb48-14" aria-hidden="true"></a>      <span class="kw">colnames</span>(log) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;pic&quot;</span>, <span class="st">&quot;fix_start&quot;</span>, <span class="st">&quot;pic_start&quot;</span>, <span class="st">&quot;volume&quot;</span>, <span class="st">&quot;response&quot;</span>, <span class="st">&quot;RT&quot;</span>, <span class="st">&quot;trial_end&quot;</span>)</span>
<span id="cb48-15"><a href="mri.html#cb48-15" aria-hidden="true"></a>      </span>
<span id="cb48-16"><a href="mri.html#cb48-16" aria-hidden="true"></a>      <span class="co"># load the relevant MRI volumes (i.e. multi-voxel patterns)</span></span>
<span id="cb48-17"><a href="mri.html#cb48-17" aria-hidden="true"></a>      fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_roi_rel_vol_dirs[i_roi], </span>
<span id="cb48-18"><a href="mri.html#cb48-18" aria-hidden="true"></a>                      <span class="kw">sprintf</span>(<span class="st">&quot;%s_%s_%s_relevant_volumes.txt&quot;</span>, i_sub, rois[i_roi], runs[i_run]))</span>
<span id="cb48-19"><a href="mri.html#cb48-19" aria-hidden="true"></a>      rel_dat &lt;-<span class="st"> </span><span class="kw">read.table</span>(fn, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>)</span>
<span id="cb48-20"><a href="mri.html#cb48-20" aria-hidden="true"></a>      </span>
<span id="cb48-21"><a href="mri.html#cb48-21" aria-hidden="true"></a>      <span class="co"># remove patterns &amp; log entries corresponding to the target picture (catch trials)</span></span>
<span id="cb48-22"><a href="mri.html#cb48-22" aria-hidden="true"></a>      rel_dat &lt;-<span class="st"> </span>rel_dat[, log<span class="op">$</span>pic <span class="op">!=</span><span class="st"> </span><span class="dv">21</span>]</span>
<span id="cb48-23"><a href="mri.html#cb48-23" aria-hidden="true"></a>      log &lt;-<span class="st"> </span>log[log<span class="op">$</span>pic <span class="op">!=</span><span class="st"> </span><span class="dv">21</span>,]</span>
<span id="cb48-24"><a href="mri.html#cb48-24" aria-hidden="true"></a>      </span>
<span id="cb48-25"><a href="mri.html#cb48-25" aria-hidden="true"></a>      <span class="co"># order the data according to picture identity</span></span>
<span id="cb48-26"><a href="mri.html#cb48-26" aria-hidden="true"></a>      rel_dat &lt;-<span class="st"> </span>rel_dat[,<span class="kw">order</span>(log<span class="op">$</span>pic)]</span>
<span id="cb48-27"><a href="mri.html#cb48-27" aria-hidden="true"></a>      <span class="kw">colnames</span>(rel_dat) &lt;-<span class="st"> </span>log<span class="op">$</span>pic[<span class="kw">order</span>(log<span class="op">$</span>pic)]</span>
<span id="cb48-28"><a href="mri.html#cb48-28" aria-hidden="true"></a>      </span>
<span id="cb48-29"><a href="mri.html#cb48-29" aria-hidden="true"></a>      <span class="co"># write to file for diagnostic purposes</span></span>
<span id="cb48-30"><a href="mri.html#cb48-30" aria-hidden="true"></a>      fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_roi_rel_vol_dirs[i_roi], </span>
<span id="cb48-31"><a href="mri.html#cb48-31" aria-hidden="true"></a>                      <span class="kw">sprintf</span>(<span class="st">&quot;%s_%s_%s_relevant_volumes_ordered.txt&quot;</span>, i_sub, rois[i_roi], runs[i_run]))</span>
<span id="cb48-32"><a href="mri.html#cb48-32" aria-hidden="true"></a>      <span class="kw">write.table</span>(rel_dat, fn, <span class="dt">append =</span> <span class="ot">FALSE</span>, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb48-33"><a href="mri.html#cb48-33" aria-hidden="true"></a>                  <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>, <span class="dt">col.names =</span> <span class="ot">FALSE</span>)</span>
<span id="cb48-34"><a href="mri.html#cb48-34" aria-hidden="true"></a>      </span>
<span id="cb48-35"><a href="mri.html#cb48-35" aria-hidden="true"></a>      <span class="co"># calculate the correlation matrix (trial by trial correlations at this point)</span></span>
<span id="cb48-36"><a href="mri.html#cb48-36" aria-hidden="true"></a>      corr_mat_trial &lt;-<span class="st"> </span><span class="kw">cor</span>(rel_dat)</span>
<span id="cb48-37"><a href="mri.html#cb48-37" aria-hidden="true"></a>      <span class="co">#diag(corr_mat_trial)&lt;-0</span></span>
<span id="cb48-38"><a href="mri.html#cb48-38" aria-hidden="true"></a>      <span class="co">#corrplot(corr_mat_trial, method = &quot;color&quot;, is.corr=FALSE,</span></span>
<span id="cb48-39"><a href="mri.html#cb48-39" aria-hidden="true"></a>      <span class="co">#         cl.lim = c(min(corr_mat_trial),max(corr_mat_trial)), addgrid.col = NA)</span></span>
<span id="cb48-40"><a href="mri.html#cb48-40" aria-hidden="true"></a>      <span class="co"># save the correlation matrix</span></span>
<span id="cb48-41"><a href="mri.html#cb48-41" aria-hidden="true"></a>      fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_roi_corr_mat_dirs[i_roi], </span>
<span id="cb48-42"><a href="mri.html#cb48-42" aria-hidden="true"></a>                      <span class="kw">sprintf</span>(<span class="st">&quot;%s_%s_%s_corr_mat_trial.txt&quot;</span>, i_sub, rois[i_roi], runs[i_run]))</span>
<span id="cb48-43"><a href="mri.html#cb48-43" aria-hidden="true"></a>      <span class="kw">write.table</span>(corr_mat_trial, fn, <span class="dt">append =</span> <span class="ot">FALSE</span>, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb48-44"><a href="mri.html#cb48-44" aria-hidden="true"></a>                  <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>, <span class="dt">col.names =</span> <span class="ot">FALSE</span>)</span>
<span id="cb48-45"><a href="mri.html#cb48-45" aria-hidden="true"></a>      </span>
<span id="cb48-46"><a href="mri.html#cb48-46" aria-hidden="true"></a>      <span class="co"># initialize correlation matrix condition by condition</span></span>
<span id="cb48-47"><a href="mri.html#cb48-47" aria-hidden="true"></a>      corr_mat &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dt">nrow =</span> <span class="dv">20</span>, <span class="dt">ncol =</span> <span class="dv">20</span>, <span class="dt">dimnames =</span> <span class="kw">c</span>(<span class="kw">list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>), <span class="kw">list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>)))</span>
<span id="cb48-48"><a href="mri.html#cb48-48" aria-hidden="true"></a>      </span>
<span id="cb48-49"><a href="mri.html#cb48-49" aria-hidden="true"></a>      <span class="co"># loop over all picture comparisons</span></span>
<span id="cb48-50"><a href="mri.html#cb48-50" aria-hidden="true"></a>      <span class="cf">for</span>(i_pic1 <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">20</span>){</span>
<span id="cb48-51"><a href="mri.html#cb48-51" aria-hidden="true"></a>        <span class="cf">for</span>(i_pic2 <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">20</span>){</span>
<span id="cb48-52"><a href="mri.html#cb48-52" aria-hidden="true"></a>          </span>
<span id="cb48-53"><a href="mri.html#cb48-53" aria-hidden="true"></a>          <span class="co"># extract the current 10x10 correlation matrix</span></span>
<span id="cb48-54"><a href="mri.html#cb48-54" aria-hidden="true"></a>          i1 &lt;-<span class="st"> </span>(<span class="dv">1</span><span class="op">+</span>(i_pic1<span class="dv">-1</span>)<span class="op">*</span><span class="dv">10</span>)<span class="op">:</span>(i_pic1<span class="op">*</span><span class="dv">10</span>)</span>
<span id="cb48-55"><a href="mri.html#cb48-55" aria-hidden="true"></a>          i2 &lt;-<span class="st"> </span>(<span class="dv">1</span><span class="op">+</span>(i_pic2<span class="dv">-1</span>)<span class="op">*</span><span class="dv">10</span>)<span class="op">:</span>(i_pic2<span class="op">*</span><span class="dv">10</span>)</span>
<span id="cb48-56"><a href="mri.html#cb48-56" aria-hidden="true"></a>          curr_mat &lt;-<span class="st"> </span>corr_mat_trial[i1, i2]</span>
<span id="cb48-57"><a href="mri.html#cb48-57" aria-hidden="true"></a>          </span>
<span id="cb48-58"><a href="mri.html#cb48-58" aria-hidden="true"></a>          <span class="co"># average the corrlations while excluding diagonal (same block comparisons)</span></span>
<span id="cb48-59"><a href="mri.html#cb48-59" aria-hidden="true"></a>          corr_mat[i_pic1, i_pic2] &lt;-<span class="st"> </span><span class="kw">mean</span>(curr_mat[no_diag])</span>
<span id="cb48-60"><a href="mri.html#cb48-60" aria-hidden="true"></a>        }</span>
<span id="cb48-61"><a href="mri.html#cb48-61" aria-hidden="true"></a>      }</span>
<span id="cb48-62"><a href="mri.html#cb48-62" aria-hidden="true"></a>      <span class="co"># diagnostic plot</span></span>
<span id="cb48-63"><a href="mri.html#cb48-63" aria-hidden="true"></a>      <span class="co">#corrplot(corr_mat, method = &quot;color&quot;, is.corr=FALSE,</span></span>
<span id="cb48-64"><a href="mri.html#cb48-64" aria-hidden="true"></a>      <span class="co">#   cl.lim = c(min(corr_mat),max(corr_mat)), addgrid.col = NA)</span></span>
<span id="cb48-65"><a href="mri.html#cb48-65" aria-hidden="true"></a>      </span>
<span id="cb48-66"><a href="mri.html#cb48-66" aria-hidden="true"></a>      <span class="co"># save the correlation matrix</span></span>
<span id="cb48-67"><a href="mri.html#cb48-67" aria-hidden="true"></a>      fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_roi_corr_mat_dirs[i_roi], </span>
<span id="cb48-68"><a href="mri.html#cb48-68" aria-hidden="true"></a>                      <span class="kw">sprintf</span>(<span class="st">&quot;%s_%s_%s_corr_mat.txt&quot;</span>, i_sub, rois[i_roi], runs[i_run]))</span>
<span id="cb48-69"><a href="mri.html#cb48-69" aria-hidden="true"></a>      <span class="kw">write.table</span>(corr_mat, fn, <span class="dt">append =</span> <span class="ot">FALSE</span>, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb48-70"><a href="mri.html#cb48-70" aria-hidden="true"></a>                  <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>, <span class="dt">col.names =</span> <span class="ot">FALSE</span>)</span>
<span id="cb48-71"><a href="mri.html#cb48-71" aria-hidden="true"></a>    }</span>
<span id="cb48-72"><a href="mri.html#cb48-72" aria-hidden="true"></a>  }</span>
<span id="cb48-73"><a href="mri.html#cb48-73" aria-hidden="true"></a>}</span></code></pre></div>

</div>
<div id="calculate-pattern-similarity-change" class="section level3 unnumbered">
<h3>Calculate Pattern Similarity Change</h3>
<p>In the next step, we calculate how the correlation between patterns change from the first to the second picture viewing task, i.e. through the day learning task. To do this, we load both correlation matrices and reduce them to the upper triangle, excluding the diagonal. Then, the correlations are Fisher Z-transformed and the similarity values from the pre-learning picture viewing task are subtracted from those of the post-learning picture viewing task to isolate pattern similarity change. The correlations and their changes are then saved together with information about the pictures that were compared.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="mri.html#cb49-1" aria-hidden="true"></a><span class="cf">for</span>(i_sub <span class="cf">in</span> subjects){</span>
<span id="cb49-2"><a href="mri.html#cb49-2" aria-hidden="true"></a>  <span class="cf">for</span>(i_roi <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(rois)){</span>
<span id="cb49-3"><a href="mri.html#cb49-3" aria-hidden="true"></a>  </span>
<span id="cb49-4"><a href="mri.html#cb49-4" aria-hidden="true"></a>    <span class="co"># load pre correlation matrix</span></span>
<span id="cb49-5"><a href="mri.html#cb49-5" aria-hidden="true"></a>    fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_roi_corr_mat_dirs[i_roi], </span>
<span id="cb49-6"><a href="mri.html#cb49-6" aria-hidden="true"></a>                    <span class="kw">sprintf</span>(<span class="st">&quot;%s_%s_pre_corr_mat.txt&quot;</span>, i_sub, rois[i_roi]))</span>
<span id="cb49-7"><a href="mri.html#cb49-7" aria-hidden="true"></a>    corr_mat_pre &lt;-<span class="st"> </span><span class="kw">read.table</span>(fn, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>)    </span>
<span id="cb49-8"><a href="mri.html#cb49-8" aria-hidden="true"></a>    </span>
<span id="cb49-9"><a href="mri.html#cb49-9" aria-hidden="true"></a>    <span class="co"># load post correlation matrix</span></span>
<span id="cb49-10"><a href="mri.html#cb49-10" aria-hidden="true"></a>    fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_roi_corr_mat_dirs[i_roi], </span>
<span id="cb49-11"><a href="mri.html#cb49-11" aria-hidden="true"></a>                    <span class="kw">sprintf</span>(<span class="st">&quot;%s_%s_post_corr_mat.txt&quot;</span>, i_sub, rois[i_roi]))</span>
<span id="cb49-12"><a href="mri.html#cb49-12" aria-hidden="true"></a>    corr_mat_post &lt;-<span class="st"> </span><span class="kw">read.table</span>(fn, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>)</span>
<span id="cb49-13"><a href="mri.html#cb49-13" aria-hidden="true"></a>    </span>
<span id="cb49-14"><a href="mri.html#cb49-14" aria-hidden="true"></a>    <span class="co"># reduce to upper triangle of correlations (without diagonal)</span></span>
<span id="cb49-15"><a href="mri.html#cb49-15" aria-hidden="true"></a>    pre_corrs &lt;-<span class="st"> </span>corr_mat_pre[<span class="kw">upper.tri</span>(corr_mat_pre, <span class="dt">diag =</span> <span class="ot">FALSE</span>)]</span>
<span id="cb49-16"><a href="mri.html#cb49-16" aria-hidden="true"></a>    post_corrs &lt;-<span class="st"> </span>corr_mat_post[<span class="kw">upper.tri</span>(corr_mat_post, <span class="dt">diag =</span> <span class="ot">FALSE</span>)]</span>
<span id="cb49-17"><a href="mri.html#cb49-17" aria-hidden="true"></a>    </span>
<span id="cb49-18"><a href="mri.html#cb49-18" aria-hidden="true"></a>    <span class="co"># create a tibble with the correlations </span></span>
<span id="cb49-19"><a href="mri.html#cb49-19" aria-hidden="true"></a>    pics &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">upper.tri</span>(corr_mat_post), <span class="dt">arr.ind=</span><span class="ot">TRUE</span>)</span>
<span id="cb49-20"><a href="mri.html#cb49-20" aria-hidden="true"></a>    corr_df &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">pic1 =</span> pics[,<span class="dv">1</span>], <span class="dt">pic2 =</span> pics[,<span class="dv">2</span>], pre_corrs, post_corrs)</span>
<span id="cb49-21"><a href="mri.html#cb49-21" aria-hidden="true"></a>    </span>
<span id="cb49-22"><a href="mri.html#cb49-22" aria-hidden="true"></a>    <span class="co"># Fisher Z transform correlations and calculate pattern similarity change</span></span>
<span id="cb49-23"><a href="mri.html#cb49-23" aria-hidden="true"></a>    <span class="co"># by subtracting the pre-correlations from the post-correlations</span></span>
<span id="cb49-24"><a href="mri.html#cb49-24" aria-hidden="true"></a>    corr_df<span class="op">$</span>ps_change &lt;-<span class="st"> </span><span class="kw">FisherZ</span>(corr_df<span class="op">$</span>post_corrs) <span class="op">-</span><span class="st"> </span><span class="kw">FisherZ</span>(corr_df<span class="op">$</span>pre_corrs)</span>
<span id="cb49-25"><a href="mri.html#cb49-25" aria-hidden="true"></a>    </span>
<span id="cb49-26"><a href="mri.html#cb49-26" aria-hidden="true"></a>    <span class="co"># write to file</span></span>
<span id="cb49-27"><a href="mri.html#cb49-27" aria-hidden="true"></a>    fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_roi_ps_change_dirs[i_roi], </span>
<span id="cb49-28"><a href="mri.html#cb49-28" aria-hidden="true"></a>                    <span class="kw">sprintf</span>(<span class="st">&quot;%s_%s_pattern_similarity_change.txt&quot;</span>, i_sub, rois[i_roi]))</span>
<span id="cb49-29"><a href="mri.html#cb49-29" aria-hidden="true"></a>    <span class="kw">write.table</span>(corr_df, fn, <span class="dt">append =</span> <span class="ot">FALSE</span>, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb49-30"><a href="mri.html#cb49-30" aria-hidden="true"></a>                <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>, <span class="dt">col.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb49-31"><a href="mri.html#cb49-31" aria-hidden="true"></a>  }</span>
<span id="cb49-32"><a href="mri.html#cb49-32" aria-hidden="true"></a>}</span></code></pre></div>

</div>
</div>
<div id="combine-behavioral-and-fmri-data-for-rsa" class="section level2 unnumbered">
<h2>Combine behavioral and fMRI data for RSA</h2>
<p>To create input for the RSA the next step is to combine the similarity change data with the behavioral data, so that we can do meaningful analyses. First the behavioral data is loaded and brought into the same pair-wise format as the similarity change data. Both datasets are combined for each subject and then written to disk.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="mri.html#cb50-1" aria-hidden="true"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb50-2"><a href="mri.html#cb50-2" aria-hidden="true"></a>  </span>
<span id="cb50-3"><a href="mri.html#cb50-3" aria-hidden="true"></a>  <span class="co"># load the behavioral data</span></span>
<span id="cb50-4"><a href="mri.html#cb50-4" aria-hidden="true"></a>  fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>timeline_dat_dir, <span class="kw">sprintf</span>(<span class="st">&quot;%s_behavior_tbl_timeline.txt&quot;</span>, i_sub))</span>
<span id="cb50-5"><a href="mri.html#cb50-5" aria-hidden="true"></a>  col_types_list &lt;-<span class="st"> </span><span class="kw">cols_only</span>(<span class="dt">sub_id =</span> <span class="kw">col_character</span>(), <span class="dt">day =</span> <span class="kw">col_factor</span>(), </span>
<span id="cb50-6"><a href="mri.html#cb50-6" aria-hidden="true"></a>                              <span class="dt">event =</span> <span class="kw">col_integer</span>(), <span class="dt">pic =</span> <span class="kw">col_integer</span>(),</span>
<span id="cb50-7"><a href="mri.html#cb50-7" aria-hidden="true"></a>                              <span class="dt">virtual_time =</span> <span class="kw">col_double</span>(), <span class="dt">real_time =</span> <span class="kw">col_double</span>(),</span>
<span id="cb50-8"><a href="mri.html#cb50-8" aria-hidden="true"></a>                              <span class="dt">memory_time =</span> <span class="kw">col_double</span>(), <span class="dt">memory_order =</span> <span class="kw">col_double</span>(), </span>
<span id="cb50-9"><a href="mri.html#cb50-9" aria-hidden="true"></a>                              <span class="dt">sorted_day =</span> <span class="kw">col_integer</span>())</span>
<span id="cb50-10"><a href="mri.html#cb50-10" aria-hidden="true"></a>  beh_dat &lt;-<span class="st"> </span><span class="kw">read_csv</span>(fn, <span class="dt">col_types =</span> col_types_list)</span>
<span id="cb50-11"><a href="mri.html#cb50-11" aria-hidden="true"></a>  </span>
<span id="cb50-12"><a href="mri.html#cb50-12" aria-hidden="true"></a>  <span class="co"># sort behavioral data according to picture identity</span></span>
<span id="cb50-13"><a href="mri.html#cb50-13" aria-hidden="true"></a>  beh_dat_ordered &lt;-<span class="st"> </span>beh_dat[<span class="kw">order</span>(beh_dat<span class="op">$</span>pic),]</span>
<span id="cb50-14"><a href="mri.html#cb50-14" aria-hidden="true"></a>  </span>
<span id="cb50-15"><a href="mri.html#cb50-15" aria-hidden="true"></a>  <span class="co"># find the order of comparisons</span></span>
<span id="cb50-16"><a href="mri.html#cb50-16" aria-hidden="true"></a>  pairs &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">upper.tri</span>(<span class="kw">matrix</span>(<span class="dt">nrow =</span> <span class="dv">20</span>, <span class="dt">ncol =</span> <span class="dv">20</span>)), <span class="dt">arr.ind=</span><span class="ot">TRUE</span>)</span>
<span id="cb50-17"><a href="mri.html#cb50-17" aria-hidden="true"></a>  </span>
<span id="cb50-18"><a href="mri.html#cb50-18" aria-hidden="true"></a>  <span class="co"># extract the data for the first and second picture in each pair from the behavioral data</span></span>
<span id="cb50-19"><a href="mri.html#cb50-19" aria-hidden="true"></a>  pic1_dat &lt;-<span class="st"> </span>beh_dat_ordered[pairs[,<span class="dv">1</span>],]</span>
<span id="cb50-20"><a href="mri.html#cb50-20" aria-hidden="true"></a>  pic2_dat &lt;-<span class="st"> </span>beh_dat_ordered[pairs[,<span class="dv">2</span>],]</span>
<span id="cb50-21"><a href="mri.html#cb50-21" aria-hidden="true"></a>  <span class="kw">colnames</span>(pic1_dat) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">colnames</span>(pic1_dat), <span class="st">&quot;1&quot;</span>)</span>
<span id="cb50-22"><a href="mri.html#cb50-22" aria-hidden="true"></a>  <span class="kw">colnames</span>(pic2_dat) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">colnames</span>(pic2_dat), <span class="st">&quot;2&quot;</span>)</span>
<span id="cb50-23"><a href="mri.html#cb50-23" aria-hidden="true"></a>  </span>
<span id="cb50-24"><a href="mri.html#cb50-24" aria-hidden="true"></a>  <span class="co"># combine the two tibbles</span></span>
<span id="cb50-25"><a href="mri.html#cb50-25" aria-hidden="true"></a>  pair_dat &lt;-<span class="st"> </span><span class="kw">cbind</span>(pic1_dat, pic2_dat)</span>
<span id="cb50-26"><a href="mri.html#cb50-26" aria-hidden="true"></a>  </span>
<span id="cb50-27"><a href="mri.html#cb50-27" aria-hidden="true"></a>  <span class="co"># reorder the tibble columns to make a bit more sense</span></span>
<span id="cb50-28"><a href="mri.html#cb50-28" aria-hidden="true"></a>  pair_dat &lt;-<span class="st"> </span>pair_dat <span class="op">%&gt;%</span></span>
<span id="cb50-29"><a href="mri.html#cb50-29" aria-hidden="true"></a><span class="st">    </span><span class="kw">select</span>(sub_id1,</span>
<span id="cb50-30"><a href="mri.html#cb50-30" aria-hidden="true"></a>           day1, day2,</span>
<span id="cb50-31"><a href="mri.html#cb50-31" aria-hidden="true"></a>           pic1, pic2,</span>
<span id="cb50-32"><a href="mri.html#cb50-32" aria-hidden="true"></a>           event1, event2, </span>
<span id="cb50-33"><a href="mri.html#cb50-33" aria-hidden="true"></a>           virtual_time1, virtual_time2, </span>
<span id="cb50-34"><a href="mri.html#cb50-34" aria-hidden="true"></a>           real_time1, real_time2, </span>
<span id="cb50-35"><a href="mri.html#cb50-35" aria-hidden="true"></a>           memory_order1, memory_order2, </span>
<span id="cb50-36"><a href="mri.html#cb50-36" aria-hidden="true"></a>           memory_time1, memory_time2, </span>
<span id="cb50-37"><a href="mri.html#cb50-37" aria-hidden="true"></a>           sorted_day1, sorted_day2) <span class="op">%&gt;%</span></span>
<span id="cb50-38"><a href="mri.html#cb50-38" aria-hidden="true"></a><span class="st">    </span><span class="kw">rename</span>(<span class="dt">sub_id =</span> sub_id1)</span>
<span id="cb50-39"><a href="mri.html#cb50-39" aria-hidden="true"></a>  </span>
<span id="cb50-40"><a href="mri.html#cb50-40" aria-hidden="true"></a>  rsa_dat &lt;-<span class="st"> </span><span class="kw">tibble</span>()</span>
<span id="cb50-41"><a href="mri.html#cb50-41" aria-hidden="true"></a>  <span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(rois)){</span>
<span id="cb50-42"><a href="mri.html#cb50-42" aria-hidden="true"></a>    </span>
<span id="cb50-43"><a href="mri.html#cb50-43" aria-hidden="true"></a>    <span class="co"># load the pattern similarity change data for this ROI</span></span>
<span id="cb50-44"><a href="mri.html#cb50-44" aria-hidden="true"></a>    fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_roi_ps_change_dirs[i_roi], </span>
<span id="cb50-45"><a href="mri.html#cb50-45" aria-hidden="true"></a>                    <span class="kw">sprintf</span>(<span class="st">&quot;%s_%s_pattern_similarity_change.txt&quot;</span>, i_sub, rois[i_roi]))</span>
<span id="cb50-46"><a href="mri.html#cb50-46" aria-hidden="true"></a>    ps_change_dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(fn)</span>
<span id="cb50-47"><a href="mri.html#cb50-47" aria-hidden="true"></a>    </span>
<span id="cb50-48"><a href="mri.html#cb50-48" aria-hidden="true"></a>    <span class="co"># make sure files have the same order</span></span>
<span id="cb50-49"><a href="mri.html#cb50-49" aria-hidden="true"></a>    assertthat<span class="op">::</span><span class="kw">are_equal</span>(<span class="kw">c</span>(pair_dat<span class="op">$</span>pic1, pair_dat<span class="op">$</span>pic2), <span class="kw">c</span>(ps_change_dat<span class="op">$</span>pic1, ps_change_dat<span class="op">$</span>pic2))</span>
<span id="cb50-50"><a href="mri.html#cb50-50" aria-hidden="true"></a>    </span>
<span id="cb50-51"><a href="mri.html#cb50-51" aria-hidden="true"></a>    <span class="co"># add column with ROI name</span></span>
<span id="cb50-52"><a href="mri.html#cb50-52" aria-hidden="true"></a>    ps_change_dat &lt;-<span class="st"> </span><span class="kw">add_column</span>(ps_change_dat, <span class="dt">roi =</span> rois[i_roi])</span>
<span id="cb50-53"><a href="mri.html#cb50-53" aria-hidden="true"></a></span>
<span id="cb50-54"><a href="mri.html#cb50-54" aria-hidden="true"></a>    <span class="co"># collect the data from this ROI and merge into long data frame</span></span>
<span id="cb50-55"><a href="mri.html#cb50-55" aria-hidden="true"></a>    roi_dat &lt;-<span class="st"> </span><span class="kw">cbind</span>(pair_dat, ps_change_dat[,<span class="dv">3</span><span class="op">:</span><span class="dv">6</span>])</span>
<span id="cb50-56"><a href="mri.html#cb50-56" aria-hidden="true"></a>    rsa_dat &lt;-<span class="st"> </span><span class="kw">rbind</span>(rsa_dat, roi_dat)</span>
<span id="cb50-57"><a href="mri.html#cb50-57" aria-hidden="true"></a>  }</span>
<span id="cb50-58"><a href="mri.html#cb50-58" aria-hidden="true"></a>  </span>
<span id="cb50-59"><a href="mri.html#cb50-59" aria-hidden="true"></a>  <span class="co"># write to file</span></span>
<span id="cb50-60"><a href="mri.html#cb50-60" aria-hidden="true"></a>  fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_dat_dir, <span class="kw">sprintf</span>(<span class="st">&quot;%s_data_for_rsa.txt&quot;</span>,i_sub))</span>
<span id="cb50-61"><a href="mri.html#cb50-61" aria-hidden="true"></a>  <span class="kw">write.table</span>(rsa_dat, fn, <span class="dt">append =</span> <span class="ot">FALSE</span>, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb50-62"><a href="mri.html#cb50-62" aria-hidden="true"></a>              <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>, <span class="dt">col.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb50-63"><a href="mri.html#cb50-63" aria-hidden="true"></a>}</span></code></pre></div>
<p>Finally, the datasets are combined across subjects.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="mri.html#cb51-1" aria-hidden="true"></a><span class="co"># set up a dataframe to collect the data</span></span>
<span id="cb51-2"><a href="mri.html#cb51-2" aria-hidden="true"></a>rsa_dat =<span class="st"> </span><span class="kw">tibble</span>()</span>
<span id="cb51-3"><a href="mri.html#cb51-3" aria-hidden="true"></a></span>
<span id="cb51-4"><a href="mri.html#cb51-4" aria-hidden="true"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb51-5"><a href="mri.html#cb51-5" aria-hidden="true"></a></span>
<span id="cb51-6"><a href="mri.html#cb51-6" aria-hidden="true"></a>  <span class="co"># load data from CSV</span></span>
<span id="cb51-7"><a href="mri.html#cb51-7" aria-hidden="true"></a>  fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>rsa_dat_dir, <span class="kw">sprintf</span>(<span class="st">&quot;%s_data_for_rsa.txt&quot;</span>,i_sub))</span>
<span id="cb51-8"><a href="mri.html#cb51-8" aria-hidden="true"></a>  col_types_list &lt;-<span class="st"> </span><span class="kw">cols_only</span>(</span>
<span id="cb51-9"><a href="mri.html#cb51-9" aria-hidden="true"></a>        <span class="dt">sub_id =</span> <span class="kw">col_character</span>(),</span>
<span id="cb51-10"><a href="mri.html#cb51-10" aria-hidden="true"></a>        <span class="dt">day1 =</span> <span class="kw">col_integer</span>(), <span class="dt">day2 =</span> <span class="kw">col_integer</span>(),</span>
<span id="cb51-11"><a href="mri.html#cb51-11" aria-hidden="true"></a>        <span class="dt">event1 =</span> <span class="kw">col_integer</span>(), <span class="dt">event2 =</span> <span class="kw">col_integer</span>(),</span>
<span id="cb51-12"><a href="mri.html#cb51-12" aria-hidden="true"></a>        <span class="dt">pic1 =</span> <span class="kw">col_integer</span>(), <span class="dt">pic2 =</span> <span class="kw">col_integer</span>(),</span>
<span id="cb51-13"><a href="mri.html#cb51-13" aria-hidden="true"></a>        <span class="dt">virtual_time1 =</span> <span class="kw">col_double</span>(), <span class="dt">virtual_time2 =</span> <span class="kw">col_double</span>(),</span>
<span id="cb51-14"><a href="mri.html#cb51-14" aria-hidden="true"></a>        <span class="dt">real_time1 =</span> <span class="kw">col_double</span>(), <span class="dt">real_time2 =</span> <span class="kw">col_double</span>(),</span>
<span id="cb51-15"><a href="mri.html#cb51-15" aria-hidden="true"></a>        <span class="dt">memory_time1 =</span> <span class="kw">col_double</span>(), <span class="dt">memory_time2 =</span> <span class="kw">col_double</span>(), </span>
<span id="cb51-16"><a href="mri.html#cb51-16" aria-hidden="true"></a>        <span class="dt">memory_order1 =</span> <span class="kw">col_double</span>(), <span class="dt">memory_order2 =</span> <span class="kw">col_double</span>(), </span>
<span id="cb51-17"><a href="mri.html#cb51-17" aria-hidden="true"></a>        <span class="dt">sorted_day1 =</span> <span class="kw">col_integer</span>(), <span class="dt">sorted_day2 =</span> <span class="kw">col_integer</span>(),</span>
<span id="cb51-18"><a href="mri.html#cb51-18" aria-hidden="true"></a>        <span class="dt">pre_corrs  =</span> <span class="kw">col_double</span>(), <span class="dt">post_corrs =</span> <span class="kw">col_double</span>(),</span>
<span id="cb51-19"><a href="mri.html#cb51-19" aria-hidden="true"></a>        <span class="dt">ps_change =</span> <span class="kw">col_double</span>(), <span class="dt">roi =</span> <span class="kw">col_factor</span>()</span>
<span id="cb51-20"><a href="mri.html#cb51-20" aria-hidden="true"></a>  )</span>
<span id="cb51-21"><a href="mri.html#cb51-21" aria-hidden="true"></a>  sub_dat &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">read_csv</span>(fn, <span class="dt">col_types =</span> col_types_list))</span>
<span id="cb51-22"><a href="mri.html#cb51-22" aria-hidden="true"></a>  </span>
<span id="cb51-23"><a href="mri.html#cb51-23" aria-hidden="true"></a>  <span class="co"># append to table with data from all subjects</span></span>
<span id="cb51-24"><a href="mri.html#cb51-24" aria-hidden="true"></a>  rsa_dat &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(sub_dat, rsa_dat)</span>
<span id="cb51-25"><a href="mri.html#cb51-25" aria-hidden="true"></a>}</span>
<span id="cb51-26"><a href="mri.html#cb51-26" aria-hidden="true"></a></span>
<span id="cb51-27"><a href="mri.html#cb51-27" aria-hidden="true"></a><span class="co"># sort the data</span></span>
<span id="cb51-28"><a href="mri.html#cb51-28" aria-hidden="true"></a>rsa_dat &lt;-<span class="st"> </span>rsa_dat[<span class="kw">with</span>(rsa_dat, <span class="kw">order</span>(sub_id, day1, day2, event1, event2)),]</span>
<span id="cb51-29"><a href="mri.html#cb51-29" aria-hidden="true"></a></span>
<span id="cb51-30"><a href="mri.html#cb51-30" aria-hidden="true"></a><span class="co"># write to file</span></span>
<span id="cb51-31"><a href="mri.html#cb51-31" aria-hidden="true"></a>fn &lt;-<span class="st"> </span><span class="kw">file.path</span>(dirs<span class="op">$</span>data4analysis, <span class="st">&quot;rsa_data_rois.txt&quot;</span>)</span>
<span id="cb51-32"><a href="mri.html#cb51-32" aria-hidden="true"></a><span class="kw">write.table</span>(rsa_dat, fn, <span class="dt">append =</span> <span class="ot">FALSE</span>, <span class="dt">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb51-33"><a href="mri.html#cb51-33" aria-hidden="true"></a>            <span class="dt">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>, <span class="dt">col.names =</span> <span class="ot">TRUE</span>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="prepare-behavioral-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="rsa-searchlight.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
