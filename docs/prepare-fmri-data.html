<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 Prepare (f)MRI Data | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences</title>
  <meta name="description" content="6 Prepare (f)MRI Data | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences" />
  <meta name="generator" content="bookdown 0.19 and GitBook 2.6.7" />

  <meta property="og:title" content="6 Prepare (f)MRI Data | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://jacbel.github.io/virtem_code/" />
  
  <meta property="og:description" content="6 Prepare (f)MRI Data | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences" />
  <meta name="github-repo" content="jacbel/virtem_code" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 Prepare (f)MRI Data | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences" />
  
  <meta name="twitter:description" content="6 Prepare (f)MRI Data | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences" />
  

<meta name="author" content="Jacob L. S. Bellmund" />


<meta name="date" content="2022-01-27" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="behavioral-analysis.html"/>
<link rel="next" href="run-rsa-searchlight.html"/>
<script src="libs/header-attrs-2.9/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Overview</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#purpose"><i class="fa fa-check"></i><b>1.1</b> Purpose</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#contents"><i class="fa fa-check"></i><b>1.2</b> Contents</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#contact"><i class="fa fa-check"></i><b>1.3</b> Contact</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#license-information"><i class="fa fa-check"></i><b>1.4</b> License Information</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="analysis-setup.html"><a href="analysis-setup.html"><i class="fa fa-check"></i><b>2</b> Analysis Setup</a>
<ul>
<li class="chapter" data-level="2.1" data-path="analysis-setup.html"><a href="analysis-setup.html#defining-variables-and-folders"><i class="fa fa-check"></i><b>2.1</b> Defining Variables and Folders</a>
<ul>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#folder-structure"><i class="fa fa-check"></i>Folder Structure</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="analysis-setup.html"><a href="analysis-setup.html#define-analysis-functions"><i class="fa fa-check"></i><b>2.2</b> Define Analysis Functions</a>
<ul>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#analysis-logic"><i class="fa fa-check"></i>Analysis Logic</a></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#brain-plots-in-ggplot"><i class="fa fa-check"></i>Brain Plots in ggplot</a></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#ggbrain-functions-to-get-template-background"><i class="fa fa-check"></i>ggBrain functions to get template background</a></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#waiting-for-cluster-jobs"><i class="fa fa-check"></i>Waiting for Cluster Jobs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html"><i class="fa fa-check"></i><b>3</b> Illustrations of Task Design and Analysis Logic</a>
<ul>
<li class="chapter" data-level="3.1" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#day-learning-task-design"><i class="fa fa-check"></i><b>3.1</b> Day Learning Task Design</a>
<ul>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#events-in-virtual-and-real-time"><i class="fa fa-check"></i>Events in virtual and real time</a></li>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#events-in-virtual-time"><i class="fa fa-check"></i>Events in virtual time</a></li>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#events-in-real-time"><i class="fa fa-check"></i>Events in real time</a></li>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#correlations-of-virtual-time-with-order-and-real-time"><i class="fa fa-check"></i>Correlations of virtual time with order and real time</a></li>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#time-cues-in-virtual-and-real-time"><i class="fa fa-check"></i>Time cues in virtual and real time</a></li>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#supplemental-figure-for-task-design"><i class="fa fa-check"></i>Supplemental figure for task design</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#representational-similarity-analysis-logic"><i class="fa fa-check"></i><b>3.2</b> Representational Similarity Analysis Logic</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html"><i class="fa fa-check"></i><b>4</b> Prepare behavioral data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html#sorting-task"><i class="fa fa-check"></i><b>4.1</b> Sorting task</a></li>
<li class="chapter" data-level="4.2" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html#timeline-task"><i class="fa fa-check"></i><b>4.2</b> Timeline task</a></li>
<li class="chapter" data-level="4.3" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html#picture-viewing-tasks"><i class="fa fa-check"></i><b>4.3</b> Picture viewing tasks</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html"><i class="fa fa-check"></i><b>5</b> Behavioral Analysis</a>
<ul>
<li class="chapter" data-level="5.1" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#sorting-task-1"><i class="fa fa-check"></i><b>5.1</b> Sorting Task</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#calculate-percentage-of-correct-responses"><i class="fa fa-check"></i>Calculate percentage of correct responses</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#plot-sorting-performance"><i class="fa fa-check"></i>Plot sorting performance</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#sorting-errors-as-a-function-of-sequence-position"><i class="fa fa-check"></i>Sorting errors as a function of sequence position</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#timeline-task-1"><i class="fa fa-check"></i><b>5.2</b> Timeline Task</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#visualize-the-raw-data"><i class="fa fa-check"></i>Visualize the raw data</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#accuracy-of-remembered-times"><i class="fa fa-check"></i>Accuracy of remembered times</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#relationship-of-sorting-errors-and-timeline-errors"><i class="fa fa-check"></i>Relationship of sorting errors and timeline errors</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#time-metrics-underlying-remembered-times"><i class="fa fa-check"></i>Time metrics underlying remembered times</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#compose-figure-for-behavioral-data"><i class="fa fa-check"></i>Compose Figure for Behavioral Data</a></li>
<li class="chapter" data-level="5.3" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#generalization-bias"><i class="fa fa-check"></i><b>5.3</b> Generalization bias</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#quantify-relative-time-of-other-events"><i class="fa fa-check"></i>Quantify relative time of other events</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#test-generalization-bias"><i class="fa fa-check"></i>Test Generalization Bias</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#replication-of-generalization-bias"><i class="fa fa-check"></i><b>5.4</b> Replication of Generalization Bias</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#replication-data-quantify-relative-time-of-other-events"><i class="fa fa-check"></i>Replication data: Quantify relative time of other events</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#replication-data-test-generalization-bias"><i class="fa fa-check"></i>Replication data: Test Generalization Bias</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#swap-errors"><i class="fa fa-check"></i><b>5.5</b> Swap Errors</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#descriptives-of-swap-errors"><i class="fa fa-check"></i>Descriptives of swap errors</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#swap-errors-as-a-function-of-sequence-position"><i class="fa fa-check"></i>Swap errors as a function of sequence position</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#swap-error-more-frequent-than-expected-from-chance"><i class="fa fa-check"></i>Swap error: More frequent than expected from chance?</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#swap-errors-and-generalization-bias"><i class="fa fa-check"></i>Swap errors and generalization bias</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html"><i class="fa fa-check"></i><b>6</b> Prepare (f)MRI Data</a>
<ul>
<li class="chapter" data-level="6.1" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#regions-of-interest"><i class="fa fa-check"></i><b>6.1</b> Regions of Interest</a>
<ul>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#freesurfer-masks"><i class="fa fa-check"></i>FreeSurfer Masks</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#subregion-masks-mni"><i class="fa fa-check"></i>Subregion masks (MNI)</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#final-rois-from-intersection-of-masks"><i class="fa fa-check"></i>Final ROIs from intersection of masks</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#group-level-masks"><i class="fa fa-check"></i><b>6.2</b> Group-Level Masks</a>
<ul>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#probabilistic-rois-for-visualization"><i class="fa fa-check"></i>Probabilistic ROIs for visualization</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#field-of-view-mask-for-visualization"><i class="fa fa-check"></i>Field of view mask for visualization</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#gray-matter-mask"><i class="fa fa-check"></i>Gray matter mask</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#small-volume-correction-mask"><i class="fa fa-check"></i>Small Volume Correction Mask</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#quantify-representational-change"><i class="fa fa-check"></i><b>6.3</b> Quantify Representational Change</a>
<ul>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#get-multi-voxel-patterns-from-rois"><i class="fa fa-check"></i>Get multi-voxel patterns from ROIs</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#calculate-correlation-matrices"><i class="fa fa-check"></i>Calculate correlation matrices</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#calculate-pattern-similarity-change"><i class="fa fa-check"></i>Calculate Pattern Similarity Change</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#combine-behavioral-and-fmri-data-for-rsa"><i class="fa fa-check"></i><b>6.4</b> Combine behavioral and fMRI data for RSA</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html"><i class="fa fa-check"></i><b>7</b> Run RSA Searchlight</a>
<ul>
<li class="chapter" data-level="7.1" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#prepare-functional-data"><i class="fa fa-check"></i><b>7.1</b> Prepare functional data</a>
<ul>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#data-cleaning-extract-residuals-from-motion-parameter-regression"><i class="fa fa-check"></i>Data cleaning: Extract residuals from motion parameter regression</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#extract-relevant-volumes-1"><i class="fa fa-check"></i>Extract relevant volumes</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#concatenate-relevant-volumes"><i class="fa fa-check"></i>Concatenate relevant volumes</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#first-level-rsa-searchlight"><i class="fa fa-check"></i><b>7.2</b> First-level RSA searchlight</a>
<ul>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#set-analysis-parameters"><i class="fa fa-check"></i>Set analysis parameters</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#prepare-rsa-predictions"><i class="fa fa-check"></i>Prepare RSA-predictions</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#create-lookup-table-for-searchlight"><i class="fa fa-check"></i>Create lookup table for searchlight</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#dataframe-with-input-for-analysis"><i class="fa fa-check"></i>Dataframe with input for analysis</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#searchlight-implementation"><i class="fa fa-check"></i>Searchlight implementation</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#group-level-searchlight-analysis"><i class="fa fa-check"></i><b>7.3</b> Group-level searchlight analysis</a>
<ul>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#move-first-level-images-to-mni-space"><i class="fa fa-check"></i>Move first-level images to MNI space</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#merge-and-smooth-first-level-images"><i class="fa fa-check"></i>Merge and smooth first-level images</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#run-fsl-randomise"><i class="fa fa-check"></i>Run FSL Randomise</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#find-searchlight-clusters-and-atlas-labels"><i class="fa fa-check"></i>Find searchlight clusters and atlas labels</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#create-outlines-of-significant-clusters"><i class="fa fa-check"></i>Create outlines of significant clusters</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#prepare-rsa-in-searchlight-peak"><i class="fa fa-check"></i><b>7.4</b> Prepare RSA in searchlight peak</a>
<ul>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#create-the-roi-mask"><i class="fa fa-check"></i>Create the ROI mask</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#calculating-the-correlation-matrices"><i class="fa fa-check"></i>Calculating the correlation matrices</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#calculate-pattern-similarity-change-1"><i class="fa fa-check"></i>Calculate Pattern Similarity Change</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#combine-behavioral-and-fmri-data-for-rsa-1"><i class="fa fa-check"></i>Combine behavioral and fMRI data for RSA</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html"><i class="fa fa-check"></i><b>8</b> RSA on Pattern Similarity Change</a>
<ul>
<li class="chapter" data-level="8.1" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#time-metrics-to-quantify-event-relations"><i class="fa fa-check"></i><b>8.1</b> Time metrics to quantify event relations</a></li>
<li class="chapter" data-level="8.2" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#visualize-regions-of-interests"><i class="fa fa-check"></i><b>8.2</b> Visualize Regions of Interests</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#template-background-image-with-fov"><i class="fa fa-check"></i>Template background image with FOV</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#anterior-hippocampus-roi"><i class="fa fa-check"></i>Anterior hippocampus ROI</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#anterior-lateral-entorhinal-cortex"><i class="fa fa-check"></i>Anterior-lateral entorhinal cortex</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#first-level-rsa"><i class="fa fa-check"></i><b>8.3</b> First-level RSA</a></li>
<li class="chapter" data-level="8.4" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-within-sequence"><i class="fa fa-check"></i><b>8.4</b> aHPC: virtual time within sequence</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#summary-statistics-3"><i class="fa fa-check"></i>Summary statistics</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-2"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#representational-change-visualization"><i class="fa fa-check"></i>Representational Change Visualization</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#not-driven-by-first-last-event-pairs"><i class="fa fa-check"></i>Not driven by first &amp; last event pairs</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-within-sequence-when-including-order-real-time"><i class="fa fa-check"></i><b>8.5</b> aHPC: virtual time within sequence when including order &amp; real time</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#one-model-with-multiple-predictors"><i class="fa fa-check"></i>One model with multiple predictors</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-explains-residuals-of-order-and-real-time"><i class="fa fa-check"></i>Virtual time explains residuals of order and real time</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-across-sequences"><i class="fa fa-check"></i><b>8.6</b> aHPC: virtual time across sequences</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#summary-statistics-7"><i class="fa fa-check"></i>Summary statistics</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-5"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#representational-change-visualization-1"><i class="fa fa-check"></i>Representational Change Visualization</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-across-sequence-when-including-order-real-time"><i class="fa fa-check"></i><b>8.7</b> aHPC: virtual time across sequence when including order &amp; real time</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#summary-statistics-8"><i class="fa fa-check"></i>Summary Statistics</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-6"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
</ul></li>
<li class="chapter" data-level="8.8" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-within-vs.-across-sequences"><i class="fa fa-check"></i><b>8.8</b> aHPC: virtual time within vs. across sequences</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#second-level-analysis"><i class="fa fa-check"></i>Second-level analysis</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-7"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#interaction-of-sequence-membership-and-order"><i class="fa fa-check"></i>Interaction of sequence membership and order</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#interaction-of-sequence-membership-and-real-time"><i class="fa fa-check"></i>Interaction of sequence membership and real time</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#interaction-of-sequence-membership-and-virtual-time-when-including-interactions-with-other-time-metrics"><i class="fa fa-check"></i>Interaction of sequence membership and virtual time when including interactions with other time metrics</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#mds"><i class="fa fa-check"></i>MDS</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#umap"><i class="fa fa-check"></i>UMAP</a></li>
</ul></li>
<li class="chapter" data-level="8.9" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec"><i class="fa fa-check"></i><b>8.9</b> alEC</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec-virtual-time-withinacross-sequences-separately"><i class="fa fa-check"></i>alEC: virtual time within/across sequences separately</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec-virtual-time-within-vs.-across-sequences"><i class="fa fa-check"></i>alEC: virtual time within vs. across sequences</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec-virtual-time-for-all-event-pairs"><i class="fa fa-check"></i>alEC: virtual time for all event pairs</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec-virtual-time-for-all-event-pairs-when-including-order-real-time"><i class="fa fa-check"></i>alEC: virtual time for all event pairs when including order &amp; real time</a></li>
</ul></li>
<li class="chapter" data-level="8.10" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-vs.-alec"><i class="fa fa-check"></i><b>8.10</b> aHPC vs. alEC</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#summary-statistics-12"><i class="fa fa-check"></i>Summary Statistics</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-10"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
</ul></li>
<li class="chapter" data-level="8.11" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#searchlight-results"><i class="fa fa-check"></i><b>8.11</b> Searchlight Results</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-within-sequence"><i class="fa fa-check"></i>Virtual Time Within Sequence</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-across-sequences-in-within-searchlight-cluster"><i class="fa fa-check"></i>Virtual Time Across Sequences in Within-Searchlight Cluster</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-across-sequences"><i class="fa fa-check"></i>Virtual Time Across Sequences</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#visualization-of-overlap"><i class="fa fa-check"></i>Visualization of Overlap</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-sequence-interaction"><i class="fa fa-check"></i>Virtual Time &amp; Sequence Interaction</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#exploratory-searchlight-results"><i class="fa fa-check"></i>Exploratory Searchlight Results</a></li>
</ul></li>
<li class="chapter" data-level="8.12" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#correlation-of-behavioral-generalization-bias-with-searchlight-effects"><i class="fa fa-check"></i><b>8.12</b> Correlation of behavioral generalization bias with searchlight effects</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#correlation-with-across-sequence-searchlight-effect"><i class="fa fa-check"></i>Correlation with across-sequence searchlight effect</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#correlation-with-same-sequence-searchlight-effect"><i class="fa fa-check"></i>Correlation with same-sequence searchlight effect</a></li>
</ul></li>
<li class="chapter" data-level="8.13" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#mixed-model-summaries"><i class="fa fa-check"></i><b>8.13</b> Mixed Model Summaries</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#supplemental-figure-1"><i class="fa fa-check"></i>Supplemental Figure</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#supplemental-tables"><i class="fa fa-check"></i>Supplemental Tables</a></li>
<li class="chapter" data-level="8.13.1" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#source-data"><i class="fa fa-check"></i><b>8.13.1</b> Source data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html"><i class="fa fa-check"></i><b>9</b> Signal to noise ratio</a>
<ul>
<li class="chapter" data-level="9.1" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html#calculate-voxel-wise-temporal-snr"><i class="fa fa-check"></i><b>9.1</b> Calculate voxel-wise temporal SNR</a></li>
<li class="chapter" data-level="9.2" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html#average-tsnr-per-roi"><i class="fa fa-check"></i><b>9.2</b> Average tSNR per ROI</a></li>
<li class="chapter" data-level="9.3" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html#contrast-tsnr-between-ahpc-and-alec"><i class="fa fa-check"></i><b>9.3</b> Contrast tSNR between aHPC and alEC</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html"><i class="fa fa-check"></i><b>10</b> RSA in searchlight peak with different threshold</a>
<ul>
<li class="chapter" data-level="10.1" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#prepare-rsa-in-searchlight-peak-1"><i class="fa fa-check"></i><b>10.1</b> Prepare RSA in searchlight peak</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#create-the-roi-mask-1"><i class="fa fa-check"></i>Create the ROI mask</a></li>
<li class="chapter" data-level="" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#calculating-the-correlation-matrices-1"><i class="fa fa-check"></i>Calculating the correlation matrices</a></li>
<li class="chapter" data-level="" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#calculate-pattern-similarity-change-2"><i class="fa fa-check"></i>Calculate Pattern Similarity Change</a></li>
<li class="chapter" data-level="" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#combine-behavioral-and-fmri-data-for-rsa-2"><i class="fa fa-check"></i>Combine behavioral and fMRI data for RSA</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#rsa"><i class="fa fa-check"></i><b>10.2</b> RSA</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html"><i class="fa fa-check"></i><b>11</b> Univariate GLM: Relative time</a>
<ul>
<li class="chapter" data-level="11.1" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#copy-feat-folder-from-preprocessing-to-first-level-glm-directory"><i class="fa fa-check"></i><b>11.1</b> Copy FEAT-folder from Preprocessing to First-Level GLM directory</a></li>
<li class="chapter" data-level="11.2" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#prepare-glm"><i class="fa fa-check"></i><b>11.2</b> Prepare GLM</a>
<ul>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#compute-relative-time"><i class="fa fa-check"></i>Compute relative time</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#write-custom-ev-files-for-fsl-feat"><i class="fa fa-check"></i>Write custom EV files for FSL FEAT</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#glm-design-files"><i class="fa fa-check"></i>GLM Design files</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#prepare-confound-ev"><i class="fa fa-check"></i>Prepare confound EV</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#create-design-matrix"><i class="fa fa-check"></i>Create design matrix</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#run-1st-level-glm-on-htcondor"><i class="fa fa-check"></i><b>11.3</b> Run 1st-level GLM on HTCondor</a></li>
<li class="chapter" data-level="11.4" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#group-level-1"><i class="fa fa-check"></i><b>11.4</b> Group-level</a>
<ul>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#move-first-level-images-to-mni-space-1"><i class="fa fa-check"></i>Move first-level images to MNI space</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#merge-first-level-images"><i class="fa fa-check"></i>Merge first-level images</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#smooth-first-level-images"><i class="fa fa-check"></i>Smooth first-level images</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#average-first-level-images"><i class="fa fa-check"></i>Average first-level images</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#ahpc-roi-analysis"><i class="fa fa-check"></i>aHPC ROI analysis</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#run-fsl-randomise-1"><i class="fa fa-check"></i>Run FSL Randomise</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#results-in-ahpc-and-alec"><i class="fa fa-check"></i>Results in aHPC and alEC</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#fov-results"><i class="fa fa-check"></i>FOV results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="credit.html"><a href="credit.html"><i class="fa fa-check"></i><b>12</b> Credit</a>
<ul>
<li class="chapter" data-level="12.1" data-path="credit.html"><a href="credit.html#list-of-packages"><i class="fa fa-check"></i><b>12.1</b> List of packages</a></li>
<li class="chapter" data-level="12.2" data-path="credit.html"><a href="credit.html#references"><i class="fa fa-check"></i><b>12.2</b> References</a></li>
<li class="chapter" data-level="12.3" data-path="credit.html"><a href="credit.html#session-info"><i class="fa fa-check"></i><b>12.3</b> Session Info</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="prepare-fmri-data" class="section level1" number="6">
<h1><span class="header-section-number">6</span> Prepare (f)MRI Data</h1>
<div id="regions-of-interest" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Regions of Interest</h2>
<p>We want to run ROI-based representational similarity analyses to test how the hippocampal-entorhinal system represents the learned temporal relationships. We will focus our analysis on the anterior hippocampus (aHPC) and anterolateral entorhinal cortex (alEC).</p>
<blockquote>
<p>Following our previous work on sequence representations in the hippocampus and entorhinal cortex (Bellmund et al., 2019; Deuker et al., 2016), we focused our analysis on the anterior hippocampus and the anterior-lateral entorhinal cortex.</p>
</blockquote>
<p>To define participant-specific ROI masks, we want to combine masks from the individual Freesurfer parcellations of the HPC and EC with masks dividing the subregions of the HPC and EC. Specifically, these are based on the Harvard-Oxford atlas distributed with FSL for the hippocampus and on the EC subregion masks from <a href="http://elifesciences.org/content/4/e06738">Navarro Schröder et al. (eLife, 2015)</a>.</p>
<p>We use the Freesurfer segmentation as run by Lorena Deuker. This was obtained via the recon-all command. All masks will be co-registered to the analysis space, which is the space of the wholebrain functional images. This relies on the FSL transformation matrices and warp files obtained from running FEAT on the wholebrain functional images.</p>
<div id="freesurfer-masks" class="section level3 unnumbered">
<h3>FreeSurfer Masks</h3>
<blockquote>
<p>Region of interest (ROI) masks were based on participant-specific FreeSurfer segmentations (version 6.0.0-2), which yielded masks for the entire hippocampus and entorhinal cortex. These were co-registered to participants’ functional space.</p>
</blockquote>
<div id="create-masks-from-parcellation" class="section level4 unnumbered">
<h4>Create Masks from Parcellation</h4>
<p>First, we want to create nifti masks from the FreeSurfer parcellation. These are saved in the space of the participant’s highres structural space.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="prepare-fmri-data.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create freesurfer subfolder for in each ROI folder</span></span>
<span id="cb134-2"><a href="prepare-fmri-data.html#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>rois_fs_dirs, <span class="st">&quot;freesurfer_highres_space&quot;</span>),</span>
<span id="cb134-3"><a href="prepare-fmri-data.html#cb134-3" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">function</span>(x) <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(x)) <span class="fu">dir.create</span>(x)))</span>
<span id="cb134-4"><a href="prepare-fmri-data.html#cb134-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-5"><a href="prepare-fmri-data.html#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (sub_id <span class="cf">in</span> subjects){</span>
<span id="cb134-6"><a href="prepare-fmri-data.html#cb134-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-7"><a href="prepare-fmri-data.html#cb134-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the name of the ROIs(fs = from freesurfer, hs = highres space)</span></span>
<span id="cb134-8"><a href="prepare-fmri-data.html#cb134-8" aria-hidden="true" tabindex="-1"></a>  out_roi_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rois_fs_dirs, <span class="st">&quot;freesurfer_highres_space&quot;</span>, </span>
<span id="cb134-9"><a href="prepare-fmri-data.html#cb134-9" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_fs_hs.nii.gz&quot;</span>, sub_id, rois_fs))</span>
<span id="cb134-10"><a href="prepare-fmri-data.html#cb134-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-11"><a href="prepare-fmri-data.html#cb134-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the structural image</span></span>
<span id="cb134-12"><a href="prepare-fmri-data.html#cb134-12" aria-hidden="true" tabindex="-1"></a>  highres_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb134-13"><a href="prepare-fmri-data.html#cb134-13" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, sub_id, <span class="st">&quot;.feat&quot;</span>), <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;highres.nii.gz&quot;</span>)</span>
<span id="cb134-14"><a href="prepare-fmri-data.html#cb134-14" aria-hidden="true" tabindex="-1"></a>  highres_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(highres_fn)</span>
<span id="cb134-15"><a href="prepare-fmri-data.html#cb134-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb134-16"><a href="prepare-fmri-data.html#cb134-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the freesurfer output</span></span>
<span id="cb134-17"><a href="prepare-fmri-data.html#cb134-17" aria-hidden="true" tabindex="-1"></a>  freesurf_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;freesurfer&quot;</span>, </span>
<span id="cb134-18"><a href="prepare-fmri-data.html#cb134-18" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, sub_id), <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;aparc+aseg-in-rawavg.nii&quot;</span>)</span>
<span id="cb134-19"><a href="prepare-fmri-data.html#cb134-19" aria-hidden="true" tabindex="-1"></a>  aparc_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(freesurf_fn)</span>
<span id="cb134-20"><a href="prepare-fmri-data.html#cb134-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-21"><a href="prepare-fmri-data.html#cb134-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rois_fs)){</span>
<span id="cb134-22"><a href="prepare-fmri-data.html#cb134-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-23"><a href="prepare-fmri-data.html#cb134-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># initialize all mask voxels as zeros</span></span>
<span id="cb134-24"><a href="prepare-fmri-data.html#cb134-24" aria-hidden="true" tabindex="-1"></a>    mask_idx <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">dim</span>(<span class="fu">img_data</span>(highres_nii)))</span>
<span id="cb134-25"><a href="prepare-fmri-data.html#cb134-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-26"><a href="prepare-fmri-data.html#cb134-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set voxels of the ROI to one            </span></span>
<span id="cb134-27"><a href="prepare-fmri-data.html#cb134-27" aria-hidden="true" tabindex="-1"></a>    mask_idx[<span class="fu">img_data</span>(aparc_nii) <span class="sc">%in%</span> labels_fs[[i_roi]]] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb134-28"><a href="prepare-fmri-data.html#cb134-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-29"><a href="prepare-fmri-data.html#cb134-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create nifti based on the Freesurfer image</span></span>
<span id="cb134-30"><a href="prepare-fmri-data.html#cb134-30" aria-hidden="true" tabindex="-1"></a>    roi_nii <span class="ot">&lt;-</span> highres_nii</span>
<span id="cb134-31"><a href="prepare-fmri-data.html#cb134-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">img_data</span>(roi_nii) <span class="ot">&lt;-</span> mask_idx</span>
<span id="cb134-32"><a href="prepare-fmri-data.html#cb134-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-33"><a href="prepare-fmri-data.html#cb134-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write the nifti to file</span></span>
<span id="cb134-34"><a href="prepare-fmri-data.html#cb134-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writenii</span>(<span class="at">nim =</span> roi_nii, <span class="at">filename =</span> out_roi_fn[i_roi])</span>
<span id="cb134-35"><a href="prepare-fmri-data.html#cb134-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-36"><a href="prepare-fmri-data.html#cb134-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># find coordinates for sensible slices to plot (most frequent value in each dim)</span></span>
<span id="cb134-37"><a href="prepare-fmri-data.html#cb134-37" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> <span class="fu">arrayInd</span>(<span class="fu">which</span>(<span class="fu">as.logical</span>(mask_idx)), <span class="fu">dim</span>(mask_idx))</span>
<span id="cb134-38"><a href="prepare-fmri-data.html#cb134-38" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(statip<span class="sc">::</span><span class="fu">mfv</span>(coords[,<span class="dv">1</span>])), </span>
<span id="cb134-39"><a href="prepare-fmri-data.html#cb134-39" aria-hidden="true" tabindex="-1"></a>                <span class="fu">min</span>(statip<span class="sc">::</span><span class="fu">mfv</span>(coords[,<span class="dv">2</span>])), </span>
<span id="cb134-40"><a href="prepare-fmri-data.html#cb134-40" aria-hidden="true" tabindex="-1"></a>                <span class="fu">min</span>(statip<span class="sc">::</span><span class="fu">mfv</span>(coords[,<span class="dv">3</span>])))</span>
<span id="cb134-41"><a href="prepare-fmri-data.html#cb134-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb134-42"><a href="prepare-fmri-data.html#cb134-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save a diagnostic plot as a PDF</span></span>
<span id="cb134-43"><a href="prepare-fmri-data.html#cb134-43" aria-hidden="true" tabindex="-1"></a>    fname <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(out_roi_fn[i_roi], <span class="at">compression =</span> <span class="st">&quot;TRUE&quot;</span>)</span>
<span id="cb134-44"><a href="prepare-fmri-data.html#cb134-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pdf</span>(<span class="fu">paste0</span>(fname,<span class="st">&quot;.pdf&quot;</span>))</span>
<span id="cb134-45"><a href="prepare-fmri-data.html#cb134-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ortho2</span>(<span class="fu">robust_window</span>(highres_nii, <span class="at">probs =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.999</span>)), <span class="at">y =</span> roi_nii,</span>
<span id="cb134-46"><a href="prepare-fmri-data.html#cb134-46" aria-hidden="true" tabindex="-1"></a>           <span class="at">col.y =</span> roi_colors_fs[i_roi], <span class="at">xyz =</span> coords,</span>
<span id="cb134-47"><a href="prepare-fmri-data.html#cb134-47" aria-hidden="true" tabindex="-1"></a>           <span class="at">text =</span> <span class="fu">sprintf</span>(<span class="st">&quot;P%s: %s&quot;</span>, sub_id, rois_fs[i_roi]),</span>
<span id="cb134-48"><a href="prepare-fmri-data.html#cb134-48" aria-hidden="true" tabindex="-1"></a>           <span class="at">crosshairs =</span> <span class="cn">FALSE</span>)</span>
<span id="cb134-49"><a href="prepare-fmri-data.html#cb134-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">invisible</span>(<span class="fu">dev.off</span>())</span>
<span id="cb134-50"><a href="prepare-fmri-data.html#cb134-50" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb134-51"><a href="prepare-fmri-data.html#cb134-51" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>To get an overview of the ROIs that we just created, we create a merged PDF of the diagnostic plots. We do this for each ROI separately. The files are saved to the specific ROI folders.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="prepare-fmri-data.html#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a PDF of diagnostic plots for each ROI</span></span>
<span id="cb135-2"><a href="prepare-fmri-data.html#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rois_fs)){</span>
<span id="cb135-3"><a href="prepare-fmri-data.html#cb135-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-4"><a href="prepare-fmri-data.html#cb135-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># find all the PDF files of this ROI</span></span>
<span id="cb135-5"><a href="prepare-fmri-data.html#cb135-5" aria-hidden="true" tabindex="-1"></a>  fnames <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(</span>
<span id="cb135-6"><a href="prepare-fmri-data.html#cb135-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_fs_hs.nii.gz&quot;</span>, subjects, rois_fs[i_roi]), <span class="at">compression =</span> <span class="st">&quot;TRUE&quot;</span>)</span>
<span id="cb135-7"><a href="prepare-fmri-data.html#cb135-7" aria-hidden="true" tabindex="-1"></a>  fnames <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rois_fs_dirs[i_roi], <span class="st">&quot;freesurfer_highres_space&quot;</span>,</span>
<span id="cb135-8"><a href="prepare-fmri-data.html#cb135-8" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">paste0</span>(fnames, <span class="st">&quot;.pdf&quot;</span>))</span>
<span id="cb135-9"><a href="prepare-fmri-data.html#cb135-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-10"><a href="prepare-fmri-data.html#cb135-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># merge PDFs together</span></span>
<span id="cb135-11"><a href="prepare-fmri-data.html#cb135-11" aria-hidden="true" tabindex="-1"></a>  merged_pdf <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, rois_fs[i_roi], </span>
<span id="cb135-12"><a href="prepare-fmri-data.html#cb135-12" aria-hidden="true" tabindex="-1"></a>               <span class="fu">paste0</span>(rois_fs[i_roi], <span class="st">&quot;_freesurfer_highres_space.pdf&quot;</span>))</span>
<span id="cb135-13"><a href="prepare-fmri-data.html#cb135-13" aria-hidden="true" tabindex="-1"></a>  cmd <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;pdfunite&quot;</span>, <span class="fu">paste</span>(fnames, <span class="at">collapse =</span> <span class="st">&quot; &quot;</span>), merged_pdf)</span>
<span id="cb135-14"><a href="prepare-fmri-data.html#cb135-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system</span>(cmd)</span>
<span id="cb135-15"><a href="prepare-fmri-data.html#cb135-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="coregister-freesurfer-masks-to-functional-space" class="section level4 unnumbered">
<h4>Coregister FreeSurfer masks to functional space</h4>
<p>Next we coregister the masks from FreeSurfer from the highres structural space to the functional analysis space. For this we will use FSL flirt based on the registration files obtained during preprocessing of the wholebrain functional images. Further we will mask them with our partial field of view mask based on the sequence used during the picture viewing tasks.</p>
<p>To make sure everything went well, we create diagnostic image for every subject, which we collect in a PDF for visual inspection.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="prepare-fmri-data.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create samespace freesurfer subfolder for in each ROI folder</span></span>
<span id="cb136-2"><a href="prepare-fmri-data.html#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>rois_fs_dirs, <span class="st">&quot;freesurfer_samespace&quot;</span>),</span>
<span id="cb136-3"><a href="prepare-fmri-data.html#cb136-3" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">function</span>(x) <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(x)) <span class="fu">dir.create</span>(x)))</span>
<span id="cb136-4"><a href="prepare-fmri-data.html#cb136-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-5"><a href="prepare-fmri-data.html#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="co"># name of transformation matrix file to move from highres to functional space</span></span>
<span id="cb136-6"><a href="prepare-fmri-data.html#cb136-6" aria-hidden="true" tabindex="-1"></a>highres2func <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb136-7"><a href="prepare-fmri-data.html#cb136-7" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb136-8"><a href="prepare-fmri-data.html#cb136-8" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;highres2example_func.mat&quot;</span>)</span>
<span id="cb136-9"><a href="prepare-fmri-data.html#cb136-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-10"><a href="prepare-fmri-data.html#cb136-10" aria-hidden="true" tabindex="-1"></a><span class="co"># use the mean EPI of wholebrain image as a reference</span></span>
<span id="cb136-11"><a href="prepare-fmri-data.html#cb136-11" aria-hidden="true" tabindex="-1"></a>mean_epi <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb136-12"><a href="prepare-fmri-data.html#cb136-12" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;_wholebrain.nii.gz&quot;</span>))</span>
<span id="cb136-13"><a href="prepare-fmri-data.html#cb136-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-14"><a href="prepare-fmri-data.html#cb136-14" aria-hidden="true" tabindex="-1"></a><span class="co"># functional mask (picture viewing tasks not scanned with wholebrain coverage)</span></span>
<span id="cb136-15"><a href="prepare-fmri-data.html#cb136-15" aria-hidden="true" tabindex="-1"></a>brain_mask_ss <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, </span>
<span id="cb136-16"><a href="prepare-fmri-data.html#cb136-16" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb136-17"><a href="prepare-fmri-data.html#cb136-17" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;_common_mask.nii.gz&quot;</span>))</span>
<span id="cb136-18"><a href="prepare-fmri-data.html#cb136-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-19"><a href="prepare-fmri-data.html#cb136-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rois_fs)){</span>
<span id="cb136-20"><a href="prepare-fmri-data.html#cb136-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-21"><a href="prepare-fmri-data.html#cb136-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define the file names of ROI files in highres space</span></span>
<span id="cb136-22"><a href="prepare-fmri-data.html#cb136-22" aria-hidden="true" tabindex="-1"></a>  roi_hs <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rois_fs_dirs[i_roi], <span class="st">&quot;freesurfer_highres_space&quot;</span>, </span>
<span id="cb136-23"><a href="prepare-fmri-data.html#cb136-23" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_fs_hs.nii.gz&quot;</span>, </span>
<span id="cb136-24"><a href="prepare-fmri-data.html#cb136-24" aria-hidden="true" tabindex="-1"></a>                                subjects, rois_fs[i_roi]))</span>
<span id="cb136-25"><a href="prepare-fmri-data.html#cb136-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-26"><a href="prepare-fmri-data.html#cb136-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define output files in samespace (ss) = analysis space based on the wholebrain EPI</span></span>
<span id="cb136-27"><a href="prepare-fmri-data.html#cb136-27" aria-hidden="true" tabindex="-1"></a>  roi_ss <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rois_fs_dirs[i_roi], <span class="st">&quot;freesurfer_samespace&quot;</span>, </span>
<span id="cb136-28"><a href="prepare-fmri-data.html#cb136-28" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_fs_ss.nii.gz&quot;</span>, subjects, rois_fs[i_roi]))</span>
<span id="cb136-29"><a href="prepare-fmri-data.html#cb136-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-30"><a href="prepare-fmri-data.html#cb136-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define file names for masked ROI files</span></span>
<span id="cb136-31"><a href="prepare-fmri-data.html#cb136-31" aria-hidden="true" tabindex="-1"></a>  roi_ss_masked <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rois_fs_dirs[i_roi], <span class="st">&quot;freesurfer_samespace&quot;</span>, </span>
<span id="cb136-32"><a href="prepare-fmri-data.html#cb136-32" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_fs_ss_masked.nii.gz&quot;</span>, </span>
<span id="cb136-33"><a href="prepare-fmri-data.html#cb136-33" aria-hidden="true" tabindex="-1"></a>                              subjects, rois_fs[i_roi]))</span>
<span id="cb136-34"><a href="prepare-fmri-data.html#cb136-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-35"><a href="prepare-fmri-data.html#cb136-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-36"><a href="prepare-fmri-data.html#cb136-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># apply FSL flirt to move ROI from highres to wholebrain functional space</span></span>
<span id="cb136-37"><a href="prepare-fmri-data.html#cb136-37" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">mapply</span>(flirt_apply, <span class="at">infile =</span> roi_hs, <span class="at">reffile =</span> mean_epi, </span>
<span id="cb136-38"><a href="prepare-fmri-data.html#cb136-38" aria-hidden="true" tabindex="-1"></a>                <span class="at">initmat =</span> highres2func, <span class="at">outfile =</span> roi_ss,</span>
<span id="cb136-39"><a href="prepare-fmri-data.html#cb136-39" aria-hidden="true" tabindex="-1"></a>                <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>)</span>
<span id="cb136-40"><a href="prepare-fmri-data.html#cb136-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-41"><a href="prepare-fmri-data.html#cb136-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mask to make sure to reduce to partial field of view </span></span>
<span id="cb136-42"><a href="prepare-fmri-data.html#cb136-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">mapply</span>(fsl_maths, <span class="at">file =</span> roi_ss, <span class="at">opts =</span> <span class="fu">sprintf</span>(<span class="st">&quot;-min %s&quot;</span>, brain_mask_ss), <span class="at">outfile =</span> roi_ss_masked,</span>
<span id="cb136-43"><a href="prepare-fmri-data.html#cb136-43" aria-hidden="true" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>))</span>
<span id="cb136-44"><a href="prepare-fmri-data.html#cb136-44" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="prepare-fmri-data.html#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostic plotting</span></span>
<span id="cb137-2"><a href="prepare-fmri-data.html#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rois_fs)){</span>
<span id="cb137-3"><a href="prepare-fmri-data.html#cb137-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-4"><a href="prepare-fmri-data.html#cb137-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define file names for binarized masks</span></span>
<span id="cb137-5"><a href="prepare-fmri-data.html#cb137-5" aria-hidden="true" tabindex="-1"></a>  roi_to_plot <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rois_fs_dirs[i_roi], <span class="st">&quot;freesurfer_samespace&quot;</span>, </span>
<span id="cb137-6"><a href="prepare-fmri-data.html#cb137-6" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_fs_ss_masked.nii.gz&quot;</span>, </span>
<span id="cb137-7"><a href="prepare-fmri-data.html#cb137-7" aria-hidden="true" tabindex="-1"></a>                                   subjects, rois_fs[i_roi]))</span>
<span id="cb137-8"><a href="prepare-fmri-data.html#cb137-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-9"><a href="prepare-fmri-data.html#cb137-9" aria-hidden="true" tabindex="-1"></a>  fnames <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;character&quot;</span>, <span class="fu">length</span>(subjects))</span>
<span id="cb137-10"><a href="prepare-fmri-data.html#cb137-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_sub <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(subjects)){</span>
<span id="cb137-11"><a href="prepare-fmri-data.html#cb137-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-12"><a href="prepare-fmri-data.html#cb137-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load nifti of mean epi and the roi mask</span></span>
<span id="cb137-13"><a href="prepare-fmri-data.html#cb137-13" aria-hidden="true" tabindex="-1"></a>    mean_epi_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(mean_epi[i_sub])</span>
<span id="cb137-14"><a href="prepare-fmri-data.html#cb137-14" aria-hidden="true" tabindex="-1"></a>    roi_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(roi_to_plot[i_sub])</span>
<span id="cb137-15"><a href="prepare-fmri-data.html#cb137-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-16"><a href="prepare-fmri-data.html#cb137-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># find coordinates for sensible slices to plot</span></span>
<span id="cb137-17"><a href="prepare-fmri-data.html#cb137-17" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> <span class="fu">arrayInd</span>(<span class="fu">which</span>(<span class="fu">as.logical</span>(<span class="fu">img_data</span>(roi_nii))), <span class="fu">dim</span>(<span class="fu">img_data</span>(roi_nii)))</span>
<span id="cb137-18"><a href="prepare-fmri-data.html#cb137-18" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(statip<span class="sc">::</span><span class="fu">mfv</span>(coords[,<span class="dv">1</span>])), </span>
<span id="cb137-19"><a href="prepare-fmri-data.html#cb137-19" aria-hidden="true" tabindex="-1"></a>                <span class="fu">min</span>(statip<span class="sc">::</span><span class="fu">mfv</span>(coords[,<span class="dv">2</span>])), </span>
<span id="cb137-20"><a href="prepare-fmri-data.html#cb137-20" aria-hidden="true" tabindex="-1"></a>                <span class="fu">min</span>(statip<span class="sc">::</span><span class="fu">mfv</span>(coords[,<span class="dv">3</span>])))</span>
<span id="cb137-21"><a href="prepare-fmri-data.html#cb137-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb137-22"><a href="prepare-fmri-data.html#cb137-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save a diagnostic plot as a PDF</span></span>
<span id="cb137-23"><a href="prepare-fmri-data.html#cb137-23" aria-hidden="true" tabindex="-1"></a>    fnames[i_sub] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(roi_to_plot[i_sub], <span class="at">compression =</span> <span class="st">&quot;TRUE&quot;</span>),<span class="st">&quot;.pdf&quot;</span>)</span>
<span id="cb137-24"><a href="prepare-fmri-data.html#cb137-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pdf</span>(fnames[i_sub])</span>
<span id="cb137-25"><a href="prepare-fmri-data.html#cb137-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ortho2</span>(<span class="fu">robust_window</span>(mean_epi_nii, <span class="at">probs =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.999</span>)), <span class="at">y =</span> roi_nii,</span>
<span id="cb137-26"><a href="prepare-fmri-data.html#cb137-26" aria-hidden="true" tabindex="-1"></a>           <span class="at">col.y =</span> roi_colors_fs[i_roi], <span class="at">xyz =</span> coords,</span>
<span id="cb137-27"><a href="prepare-fmri-data.html#cb137-27" aria-hidden="true" tabindex="-1"></a>           <span class="at">text =</span> <span class="fu">sprintf</span>(<span class="st">&quot;P%s: %s</span><span class="sc">\n</span><span class="st">masked&quot;</span>, subjects[i_sub], rois_fs[i_roi]),</span>
<span id="cb137-28"><a href="prepare-fmri-data.html#cb137-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">crosshairs =</span> <span class="cn">FALSE</span>)</span>
<span id="cb137-29"><a href="prepare-fmri-data.html#cb137-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">invisible</span>(<span class="fu">dev.off</span>())</span>
<span id="cb137-30"><a href="prepare-fmri-data.html#cb137-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb137-31"><a href="prepare-fmri-data.html#cb137-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-32"><a href="prepare-fmri-data.html#cb137-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># merge PDFs together</span></span>
<span id="cb137-33"><a href="prepare-fmri-data.html#cb137-33" aria-hidden="true" tabindex="-1"></a>  merged_pdf <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, rois_fs[i_roi], </span>
<span id="cb137-34"><a href="prepare-fmri-data.html#cb137-34" aria-hidden="true" tabindex="-1"></a>               <span class="fu">paste0</span>(rois_fs[i_roi], <span class="st">&quot;_freesurfer_samespace_masked.pdf&quot;</span>))</span>
<span id="cb137-35"><a href="prepare-fmri-data.html#cb137-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">#pdf_combine(fnames, output = merged_pdf) # pdftools doesn&#39;t work on remote linux?</span></span>
<span id="cb137-36"><a href="prepare-fmri-data.html#cb137-36" aria-hidden="true" tabindex="-1"></a>  cmd <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;pdfunite&quot;</span>, <span class="fu">paste</span>(fnames, <span class="at">collapse =</span> <span class="st">&quot; &quot;</span>), merged_pdf)</span>
<span id="cb137-37"><a href="prepare-fmri-data.html#cb137-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system</span>(cmd)</span>
<span id="cb137-38"><a href="prepare-fmri-data.html#cb137-38" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>

</div>
</div>
<div id="subregion-masks-mni" class="section level3 unnumbered">
<h3>Subregion masks (MNI)</h3>
<blockquote>
<p>We defined anterior hippocampus using the Harvard-Oxford atlas mask (thresholded at 50% probability), selecting all voxels anterior to MNI y=-21 based on Poppenk et al. (2013). The resulting anterior hippocampus mask was also co-registered to participants’ functional space and intersected with the participant-specific hippocampal mask from FreeSurfer. The mask for the anterior-lateral entorhinal cortex was based on Navarro Schröder et al. (2015). It was co-registered to participants’ functional space and intersected with the entorhinal cortex mask from FreeSurfer.</p>
</blockquote>
<p>Above, we generated masks of the Hippocampus and Entorhinal Cortex based on the Freesurfer segmentation of each participant’s structural image. Our hypotheses concern the anterior portion of the hippocampus and the anterior-lateral entorhinal subregion, specifically. Hence, we want to split the participant-specific masks.</p>
<ul>
<li>For the hippocampus, we will start out with the probabilistic masks based on the Harvard-Oxford atlas delivered with FSL. Masks for the right and left hippocampus will be combined, thresholded at 50% probability and split in an anterior and posterior section. We will define the anterior hippocampus as all voxels anterior to MNI y = -21 based on <a href="https://www.sciencedirect.com/science/article/pii/S1364661313000673">Poppenk et al. (TiCS, 2013)</a>. They “propose that foci at or anterior to y = -21 mm in MNI space (y = -20 mm in Talairach space) may be regarded as falling in the aHPC, as this coordinate incorporates the uncal apex in the MNI152 template and current neuroanatomical atlases”.</li>
<li>We will define the anterolateral entorhinal cortex based on <a href="http://elifesciences.org/content/4/e06738">Navarro Schröder et al. (eLife, 2015)</a>. Specifically, we will use a mask for the dominant mode of connectivity change within the EC, which is shown in <a href="https://elifesciences.org/articles/06738/figures#fig2">Figure 2</a> of the original paper.</li>
</ul>
<p>The code below assumes that masks for the left and right hippocampus were extracted from the Harvard-Oxford atlas (MNI space 1mm). Likewise, it assumes the EC subregion masks (MNI space 1mm, obtained from <a href="https://www.researchgate.net/profile/Tobias_Navarro_Schroeder">Tobias Navarro Schröder</a> to be included in the folder. After the hippocampus masks are combined, thresholded, and split, the masks will be co-registered to the functional analysis space.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="prepare-fmri-data.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define the name of the ROIs in MNI space</span></span>
<span id="cb138-2"><a href="prepare-fmri-data.html#cb138-2" aria-hidden="true" tabindex="-1"></a>rois_hpc_fnames <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;mni_masks&quot;</span>, <span class="fu">paste0</span>(rois_hpc,<span class="st">&quot;.nii.gz&quot;</span>))</span>
<span id="cb138-3"><a href="prepare-fmri-data.html#cb138-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-4"><a href="prepare-fmri-data.html#cb138-4" aria-hidden="true" tabindex="-1"></a><span class="co"># combine atlas mask across hemispheres and split into anterior &amp; posterior if not done</span></span>
<span id="cb138-5"><a href="prepare-fmri-data.html#cb138-5" aria-hidden="true" tabindex="-1"></a>atlas_fnames <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;mni_masks&quot;</span>, </span>
<span id="cb138-6"><a href="prepare-fmri-data.html#cb138-6" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="st">&quot;harvardoxford-subcortical_prob_Left_Hippocampus.nii.gz&quot;</span>,</span>
<span id="cb138-7"><a href="prepare-fmri-data.html#cb138-7" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;harvardoxford-subcortical_prob_Right_Hippocampus.nii.gz&quot;</span>,</span>
<span id="cb138-8"><a href="prepare-fmri-data.html#cb138-8" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;harvardoxford-hpc_lr.nii.gz&quot;</span>,</span>
<span id="cb138-9"><a href="prepare-fmri-data.html#cb138-9" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;harvardoxford-hpc_lr_tresh50_bin.nii.gz&quot;</span>))</span>
<span id="cb138-10"><a href="prepare-fmri-data.html#cb138-10" aria-hidden="true" tabindex="-1"></a><span class="co"># combine the left and right HPC mask from the Harvard-Oxford atlas</span></span>
<span id="cb138-11"><a href="prepare-fmri-data.html#cb138-11" aria-hidden="true" tabindex="-1"></a><span class="fu">fsl_add</span>(atlas_fnames[<span class="dv">1</span>], atlas_fnames[<span class="dv">2</span>],<span class="at">outfile =</span> atlas_fnames[<span class="dv">3</span>],</span>
<span id="cb138-12"><a href="prepare-fmri-data.html#cb138-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">retimg =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb138-13"><a href="prepare-fmri-data.html#cb138-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-14"><a href="prepare-fmri-data.html#cb138-14" aria-hidden="true" tabindex="-1"></a><span class="co"># threshold at 50 percent probability</span></span>
<span id="cb138-15"><a href="prepare-fmri-data.html#cb138-15" aria-hidden="true" tabindex="-1"></a><span class="fu">fsl_thresh</span>(atlas_fnames[<span class="dv">3</span>], <span class="at">outfile =</span> atlas_fnames[<span class="dv">4</span>], <span class="at">thresh =</span> <span class="dv">50</span>, <span class="at">opts =</span> <span class="st">&quot;-bin&quot;</span>,</span>
<span id="cb138-16"><a href="prepare-fmri-data.html#cb138-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">retimg =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb138-17"><a href="prepare-fmri-data.html#cb138-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-18"><a href="prepare-fmri-data.html#cb138-18" aria-hidden="true" tabindex="-1"></a><span class="co"># create anterior hippocampus ROI by creating a volume with all voxels anterior</span></span>
<span id="cb138-19"><a href="prepare-fmri-data.html#cb138-19" aria-hidden="true" tabindex="-1"></a><span class="co"># to MNI y=-21 (y=105 in matrix coordinates) and mask this with the binary HPC ROI</span></span>
<span id="cb138-20"><a href="prepare-fmri-data.html#cb138-20" aria-hidden="true" tabindex="-1"></a>opts <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">&quot;-mul 0 -add 1 -roi 0 182 105 -1 0 182 0 1 -mas %s&quot;</span>, atlas_fnames[<span class="dv">4</span>])</span>
<span id="cb138-21"><a href="prepare-fmri-data.html#cb138-21" aria-hidden="true" tabindex="-1"></a><span class="fu">fsl_maths</span>(<span class="at">file =</span> atlas_fnames[<span class="dv">4</span>], <span class="at">outfile =</span> rois_hpc_fnames[<span class="dv">1</span>], <span class="at">opts =</span> opts,</span>
<span id="cb138-22"><a href="prepare-fmri-data.html#cb138-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">retimg =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Here are some diagnostic plots for the ROIs that we will use (in MNI 1mm space).</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="prepare-fmri-data.html#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># EC ROIs</span></span>
<span id="cb139-2"><a href="prepare-fmri-data.html#cb139-2" aria-hidden="true" tabindex="-1"></a>rois_ec_fnames <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;mni_masks&quot;</span>, <span class="fu">paste0</span>(rois_ec,<span class="st">&quot;.nii.gz&quot;</span>))</span>
<span id="cb139-3"><a href="prepare-fmri-data.html#cb139-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-4"><a href="prepare-fmri-data.html#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="co"># file names for mni ROIs</span></span>
<span id="cb139-5"><a href="prepare-fmri-data.html#cb139-5" aria-hidden="true" tabindex="-1"></a>rois_mni_fnames <span class="ot">&lt;-</span> <span class="fu">c</span>(rois_hpc_fnames, rois_ec_fnames)</span>
<span id="cb139-6"><a href="prepare-fmri-data.html#cb139-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-7"><a href="prepare-fmri-data.html#cb139-7" aria-hidden="true" tabindex="-1"></a><span class="co"># load mni 1mm (here we use the ch2better template from MRIcron)</span></span>
<span id="cb139-8"><a href="prepare-fmri-data.html#cb139-8" aria-hidden="true" tabindex="-1"></a><span class="co">#mni_nii &lt;- here(&quot;data&quot;, &quot;mri&quot;, &quot;rois&quot;, &quot;mni_masks&quot;, &quot;MNI152_T1_1mm_brain.nii.gz&quot;) #%&gt;% readNIfTI2()</span></span>
<span id="cb139-9"><a href="prepare-fmri-data.html#cb139-9" aria-hidden="true" tabindex="-1"></a>mni_nii <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;mni_masks&quot;</span>, <span class="st">&quot;ch2better_mni1mm.nii.gz&quot;</span>)</span>
<span id="cb139-10"><a href="prepare-fmri-data.html#cb139-10" aria-hidden="true" tabindex="-1"></a><span class="co"># register to MNI 1mm space if needed</span></span>
<span id="cb139-11"><a href="prepare-fmri-data.html#cb139-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(mni_nii)){</span>
<span id="cb139-12"><a href="prepare-fmri-data.html#cb139-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">flirt</span>(<span class="at">infile =</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;mni_masks&quot;</span>, <span class="st">&quot;ch2better.nii.gz&quot;</span>),</span>
<span id="cb139-13"><a href="prepare-fmri-data.html#cb139-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">reffile =</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;mni_masks&quot;</span>, <span class="st">&quot;MNI152_T1_1mm_brain.nii.gz&quot;</span>),</span>
<span id="cb139-14"><a href="prepare-fmri-data.html#cb139-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">outfile =</span> mni_nii, <span class="at">omat =</span> <span class="st">&quot;ch2better_to_mni1mm&quot;</span>)</span>
<span id="cb139-15"><a href="prepare-fmri-data.html#cb139-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb139-16"><a href="prepare-fmri-data.html#cb139-16" aria-hidden="true" tabindex="-1"></a>mni_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(mni_nii)</span>
<span id="cb139-17"><a href="prepare-fmri-data.html#cb139-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-18"><a href="prepare-fmri-data.html#cb139-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rois_mni)){</span>
<span id="cb139-19"><a href="prepare-fmri-data.html#cb139-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-20"><a href="prepare-fmri-data.html#cb139-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load roi mask nifti</span></span>
<span id="cb139-21"><a href="prepare-fmri-data.html#cb139-21" aria-hidden="true" tabindex="-1"></a>  roi_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(rois_mni_fnames[i_roi])</span>
<span id="cb139-22"><a href="prepare-fmri-data.html#cb139-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-23"><a href="prepare-fmri-data.html#cb139-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># find coordinates for sensible slices to plot</span></span>
<span id="cb139-24"><a href="prepare-fmri-data.html#cb139-24" aria-hidden="true" tabindex="-1"></a>  coords <span class="ot">&lt;-</span> <span class="fu">arrayInd</span>(<span class="fu">which</span>(<span class="fu">as.logical</span>(<span class="fu">img_data</span>(roi_nii))), <span class="fu">dim</span>(<span class="fu">img_data</span>(roi_nii)))</span>
<span id="cb139-25"><a href="prepare-fmri-data.html#cb139-25" aria-hidden="true" tabindex="-1"></a>  coords <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(statip<span class="sc">::</span><span class="fu">mfv</span>(coords[,<span class="dv">1</span>])), </span>
<span id="cb139-26"><a href="prepare-fmri-data.html#cb139-26" aria-hidden="true" tabindex="-1"></a>              <span class="fu">min</span>(statip<span class="sc">::</span><span class="fu">mfv</span>(coords[,<span class="dv">2</span>])), </span>
<span id="cb139-27"><a href="prepare-fmri-data.html#cb139-27" aria-hidden="true" tabindex="-1"></a>              <span class="fu">min</span>(statip<span class="sc">::</span><span class="fu">mfv</span>(coords[,<span class="dv">3</span>])))</span>
<span id="cb139-28"><a href="prepare-fmri-data.html#cb139-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-29"><a href="prepare-fmri-data.html#cb139-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a diagnostic plot and save as a PDF</span></span>
<span id="cb139-30"><a href="prepare-fmri-data.html#cb139-30" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(rois_mni_fnames[i_roi], <span class="at">compression =</span> <span class="st">&quot;TRUE&quot;</span>),<span class="st">&quot;.pdf&quot;</span>)</span>
<span id="cb139-31"><a href="prepare-fmri-data.html#cb139-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ortho2</span>(<span class="fu">robust_window</span>(mni_nii, <span class="at">probs =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.999</span>)), <span class="at">y =</span> roi_nii, </span>
<span id="cb139-32"><a href="prepare-fmri-data.html#cb139-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">col.y =</span> roi_colors[i_roi], <span class="at">xyz =</span> coords,</span>
<span id="cb139-33"><a href="prepare-fmri-data.html#cb139-33" aria-hidden="true" tabindex="-1"></a>         <span class="at">text =</span> rois_mni[i_roi], <span class="at">crosshairs =</span> <span class="cn">FALSE</span>)</span>
<span id="cb139-34"><a href="prepare-fmri-data.html#cb139-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.copy</span>(pdf, fname)</span>
<span id="cb139-35"><a href="prepare-fmri-data.html#cb139-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">dev.off</span>())</span>
<span id="cb139-36"><a href="prepare-fmri-data.html#cb139-36" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The resulting ROI masks can now be coregistered from MNI 1mm space to the analysis space of the wholebrain functional sequence. Finally, they are thresholded at a probability of 0.5.</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="prepare-fmri-data.html#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># name of transformation matrix file to move from highres to functional space</span></span>
<span id="cb140-2"><a href="prepare-fmri-data.html#cb140-2" aria-hidden="true" tabindex="-1"></a>standard2func <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb140-3"><a href="prepare-fmri-data.html#cb140-3" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb140-4"><a href="prepare-fmri-data.html#cb140-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;standard2example_func.mat&quot;</span>)</span>
<span id="cb140-5"><a href="prepare-fmri-data.html#cb140-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-6"><a href="prepare-fmri-data.html#cb140-6" aria-hidden="true" tabindex="-1"></a><span class="co"># use the mean EPI of wholebrain image as a reference</span></span>
<span id="cb140-7"><a href="prepare-fmri-data.html#cb140-7" aria-hidden="true" tabindex="-1"></a>mean_epi <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb140-8"><a href="prepare-fmri-data.html#cb140-8" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;_wholebrain.nii.gz&quot;</span>))</span>
<span id="cb140-9"><a href="prepare-fmri-data.html#cb140-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-10"><a href="prepare-fmri-data.html#cb140-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rois_mni)){</span>
<span id="cb140-11"><a href="prepare-fmri-data.html#cb140-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-12"><a href="prepare-fmri-data.html#cb140-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#file name of ROI file in standard MNI space</span></span>
<span id="cb140-13"><a href="prepare-fmri-data.html#cb140-13" aria-hidden="true" tabindex="-1"></a>  roi_mni <span class="ot">&lt;-</span> rois_mni_fnames[i_roi]</span>
<span id="cb140-14"><a href="prepare-fmri-data.html#cb140-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-15"><a href="prepare-fmri-data.html#cb140-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define output files in samespace (ss) = analysis space based on the wholebrain EPI</span></span>
<span id="cb140-16"><a href="prepare-fmri-data.html#cb140-16" aria-hidden="true" tabindex="-1"></a>  roi_ss <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rois_mni_ss_dirs[i_roi],</span>
<span id="cb140-17"><a href="prepare-fmri-data.html#cb140-17" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_ss.nii.gz&quot;</span>, subjects, rois_mni[i_roi]))</span>
<span id="cb140-18"><a href="prepare-fmri-data.html#cb140-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-19"><a href="prepare-fmri-data.html#cb140-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># apply FSL flirt to move ROI from standard to wholebrain functional space</span></span>
<span id="cb140-20"><a href="prepare-fmri-data.html#cb140-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">mapply</span>(flirt_apply, <span class="at">infile =</span> roi_mni, <span class="at">reffile =</span> mean_epi, </span>
<span id="cb140-21"><a href="prepare-fmri-data.html#cb140-21" aria-hidden="true" tabindex="-1"></a>                   <span class="at">initmat =</span> standard2func, <span class="at">outfile =</span> roi_ss,</span>
<span id="cb140-22"><a href="prepare-fmri-data.html#cb140-22" aria-hidden="true" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>))</span>
<span id="cb140-23"><a href="prepare-fmri-data.html#cb140-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-24"><a href="prepare-fmri-data.html#cb140-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use fslmaths to binarize the masked ROIs using a threshold of 0.5</span></span>
<span id="cb140-25"><a href="prepare-fmri-data.html#cb140-25" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">mapply</span>(fsl_thresh, <span class="at">file =</span> roi_ss, <span class="at">outfile =</span> roi_ss, <span class="at">thresh =</span> <span class="fl">0.5</span>, <span class="at">opts =</span> <span class="st">&quot;-bin&quot;</span>,</span>
<span id="cb140-26"><a href="prepare-fmri-data.html#cb140-26" aria-hidden="true" tabindex="-1"></a>                <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>)</span>
<span id="cb140-27"><a href="prepare-fmri-data.html#cb140-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>

</div>
<div id="final-rois-from-intersection-of-masks" class="section level3 unnumbered">
<h3>Final ROIs from intersection of masks</h3>
<blockquote>
<p>We defined anterior hippocampus using the Harvard-Oxford atlas mask (thresholded at 50% probability), selecting all voxels anterior to MNI y=-21 based on Poppenk et al. (2013). The resulting anterior hippocampus mask was also co-registered to participants’ functional space and intersected with the participant-specific hippocampal mask from FreeSurfer. The mask for the anterior-lateral entorhinal cortex was based on Navarro Schröder et al. (2015). It was co-registered to participants’ functional space and intersected with the entorhinal cortex mask from FreeSurfer.</p>
</blockquote>
<p>In the last step, we intersect the masks from FreeSurfer with the respective subregion masks. At this point, both masks are in the functional analysis space and have been binarized. Finally, we generate a PDF of diagnostic plots to check the final ROI masks.</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="prepare-fmri-data.html#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rois)){</span>
<span id="cb141-2"><a href="prepare-fmri-data.html#cb141-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-3"><a href="prepare-fmri-data.html#cb141-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define ROI files in samespace (ss) = analysis space based on the wholebrain EPI</span></span>
<span id="cb141-4"><a href="prepare-fmri-data.html#cb141-4" aria-hidden="true" tabindex="-1"></a>  roi_ss <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rois_ss_dirs[i_roi],</span>
<span id="cb141-5"><a href="prepare-fmri-data.html#cb141-5" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_ss.nii.gz&quot;</span>, subjects, rois[i_roi]))</span>
<span id="cb141-6"><a href="prepare-fmri-data.html#cb141-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-7"><a href="prepare-fmri-data.html#cb141-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define file names for ROI files masked with freesurfer (i.e. our output)</span></span>
<span id="cb141-8"><a href="prepare-fmri-data.html#cb141-8" aria-hidden="true" tabindex="-1"></a>  roi_ss_fs <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rois_ss_dirs[i_roi],</span>
<span id="cb141-9"><a href="prepare-fmri-data.html#cb141-9" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_ss_fs.nii.gz&quot;</span>, subjects, rois[i_roi]))</span>
<span id="cb141-10"><a href="prepare-fmri-data.html#cb141-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-11"><a href="prepare-fmri-data.html#cb141-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use HPC or EC mask from freesurfer? if not HPC or EC use graymatter mask</span></span>
<span id="cb141-12"><a href="prepare-fmri-data.html#cb141-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">&quot;HPC&quot;</span>, rois[i_roi])){</span>
<span id="cb141-13"><a href="prepare-fmri-data.html#cb141-13" aria-hidden="true" tabindex="-1"></a>    fs_roi <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;hpc_lr&quot;</span>, <span class="st">&quot;freesurfer_samespace&quot;</span>,</span>
<span id="cb141-14"><a href="prepare-fmri-data.html#cb141-14" aria-hidden="true" tabindex="-1"></a>                   <span class="co">#sprintf(&quot;P%s_%s_fs_ss_masked_bin.nii.gz&quot;,subjects, &quot;hpc_lr&quot;))</span></span>
<span id="cb141-15"><a href="prepare-fmri-data.html#cb141-15" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_fs_ss_masked.nii.gz&quot;</span>,subjects, <span class="st">&quot;hpc_lr&quot;</span>))</span>
<span id="cb141-16"><a href="prepare-fmri-data.html#cb141-16" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">&quot;EC&quot;</span>, rois[i_roi])){</span>
<span id="cb141-17"><a href="prepare-fmri-data.html#cb141-17" aria-hidden="true" tabindex="-1"></a>    fs_roi <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;ec_lr&quot;</span>, <span class="st">&quot;freesurfer_samespace&quot;</span>,</span>
<span id="cb141-18"><a href="prepare-fmri-data.html#cb141-18" aria-hidden="true" tabindex="-1"></a>                   <span class="co">#sprintf(&quot;P%s_%s_fs_ss_masked_bin.nii.gz&quot;,subjects, &quot;ec_lr&quot;))</span></span>
<span id="cb141-19"><a href="prepare-fmri-data.html#cb141-19" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_fs_ss_masked.nii.gz&quot;</span>,subjects, <span class="st">&quot;ec_lr&quot;</span>))</span>
<span id="cb141-20"><a href="prepare-fmri-data.html#cb141-20" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {<span class="co">#/data/pt_02261/virtem/data/mri/processed/samespace/VIRTEM_P035/VIRTEM_P035_common_graymatter_mask.nii.gz</span></span>
<span id="cb141-21"><a href="prepare-fmri-data.html#cb141-21" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb141-22"><a href="prepare-fmri-data.html#cb141-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mask gray matter mask with brain mask to account for partial FOV. Result will be used to mask ROIs</span></span>
<span id="cb141-23"><a href="prepare-fmri-data.html#cb141-23" aria-hidden="true" tabindex="-1"></a>    gm_mask_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb141-24"><a href="prepare-fmri-data.html#cb141-24" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_graymatter_mask.nii.gz&quot;</span>,subjects))</span>
<span id="cb141-25"><a href="prepare-fmri-data.html#cb141-25" aria-hidden="true" tabindex="-1"></a>    brain_mask_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb141-26"><a href="prepare-fmri-data.html#cb141-26" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_mask_perBlock.nii.gz&quot;</span>,subjects))</span>
<span id="cb141-27"><a href="prepare-fmri-data.html#cb141-27" aria-hidden="true" tabindex="-1"></a>    fs_roi <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb141-28"><a href="prepare-fmri-data.html#cb141-28" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_graymatter_mask_brainmasked.nii.gz&quot;</span>,subjects))</span>
<span id="cb141-29"><a href="prepare-fmri-data.html#cb141-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">invisible</span>(<span class="fu">mapply</span>(fsl_mask, <span class="at">file =</span> gm_mask_fn, <span class="at">mask =</span> brain_mask_fn, <span class="at">outfile =</span> fs_roi,</span>
<span id="cb141-30"><a href="prepare-fmri-data.html#cb141-30" aria-hidden="true" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>))</span>
<span id="cb141-31"><a href="prepare-fmri-data.html#cb141-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb141-32"><a href="prepare-fmri-data.html#cb141-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#} else {stop(&quot;Don&#39;t know which Freesurfer mask to use!&quot;)}</span></span>
<span id="cb141-33"><a href="prepare-fmri-data.html#cb141-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-34"><a href="prepare-fmri-data.html#cb141-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mask the subregion mask with the Freesufer ROI</span></span>
<span id="cb141-35"><a href="prepare-fmri-data.html#cb141-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">mapply</span>(fsl_maths, <span class="at">file =</span> roi_ss, <span class="at">opts =</span> <span class="fu">sprintf</span>(<span class="st">&quot;-min %s&quot;</span>, fs_roi), <span class="at">outfile =</span> roi_ss_fs,</span>
<span id="cb141-36"><a href="prepare-fmri-data.html#cb141-36" aria-hidden="true" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>))</span>
<span id="cb141-37"><a href="prepare-fmri-data.html#cb141-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">#invisible(mapply(fsl_mask, file = roi_ss, mask = fs_roi, outfile = roi_ss_fs,</span></span>
<span id="cb141-38"><a href="prepare-fmri-data.html#cb141-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                 verbose = FALSE, retimg = FALSE))</span></span>
<span id="cb141-39"><a href="prepare-fmri-data.html#cb141-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-40"><a href="prepare-fmri-data.html#cb141-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># threshold the resulting mask at a probability of 0.5 and binarize it</span></span>
<span id="cb141-41"><a href="prepare-fmri-data.html#cb141-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">mapply</span>(fsl_thresh, <span class="at">file =</span> roi_ss_fs, <span class="at">outfile =</span> roi_ss_fs, </span>
<span id="cb141-42"><a href="prepare-fmri-data.html#cb141-42" aria-hidden="true" tabindex="-1"></a>                   <span class="at">thresh =</span> <span class="fl">0.500000000000000000000000000000000000001</span>, <span class="at">opts =</span> <span class="st">&quot;-bin&quot;</span>,</span>
<span id="cb141-43"><a href="prepare-fmri-data.html#cb141-43" aria-hidden="true" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>))</span>
<span id="cb141-44"><a href="prepare-fmri-data.html#cb141-44" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>

</div>
</div>
<div id="group-level-masks" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Group-Level Masks</h2>
<p>Lastly, we create some group-level masks for visualization and further analysis:</p>
<ul>
<li>probabilistic ROI image for visualization of ROIs</li>
<li>a field of view mask in MNI space</li>
<li>a gray matter mask in MNI space</li>
<li>a small volume correction mask</li>
</ul>
<p>We create these images in their respective folders, but also copy them to the analysis data folder so they can be shared.</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="prepare-fmri-data.html#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the group mask folder</span></span>
<span id="cb142-2"><a href="prepare-fmri-data.html#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;mni1mm_masks&quot;</span>))){</span>
<span id="cb142-3"><a href="prepare-fmri-data.html#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;mni1mm_masks&quot;</span>))}</span>
<span id="cb142-4"><a href="prepare-fmri-data.html#cb142-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-5"><a href="prepare-fmri-data.html#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="co"># copy MNI image there</span></span>
<span id="cb142-6"><a href="prepare-fmri-data.html#cb142-6" aria-hidden="true" tabindex="-1"></a><span class="fu">file.copy</span>(<span class="fu">mni_fname</span>(<span class="at">mm=</span><span class="dv">1</span>, <span class="at">brain =</span> <span class="cn">TRUE</span>), <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;mni1mm_masks&quot;</span>),</span>
<span id="cb142-7"><a href="prepare-fmri-data.html#cb142-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div id="probabilistic-rois-for-visualization" class="section level3 unnumbered">
<h3>Probabilistic ROIs for visualization</h3>
<p>For later visualization we move the masks to MNI space and threshold at 0.5. We then add the images together and divide by the number of subjects to obtain an image giving us the probablity of each voxel to be included in the ROI.</p>
<p>Visualizations of the ROIs will be created before implementing <a href="rsa-on-pattern-similarity-change.html#rsa-on-pattern-similarity-change">ROI-based RSA</a>.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="prepare-fmri-data.html#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># name of transformation matrix file to move from common functional to MNI 1mm space</span></span>
<span id="cb144-2"><a href="prepare-fmri-data.html#cb144-2" aria-hidden="true" tabindex="-1"></a>func2standard <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb144-3"><a href="prepare-fmri-data.html#cb144-3" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb144-4"><a href="prepare-fmri-data.html#cb144-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;example_func2standard.mat&quot;</span>)</span>
<span id="cb144-5"><a href="prepare-fmri-data.html#cb144-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-6"><a href="prepare-fmri-data.html#cb144-6" aria-hidden="true" tabindex="-1"></a><span class="co"># use MNI 1mm image as a reference</span></span>
<span id="cb144-7"><a href="prepare-fmri-data.html#cb144-7" aria-hidden="true" tabindex="-1"></a>mni_1mm <span class="ot">&lt;-</span> <span class="fu">mni_fname</span>(<span class="at">mm=</span><span class="dv">1</span>)</span>
<span id="cb144-8"><a href="prepare-fmri-data.html#cb144-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-9"><a href="prepare-fmri-data.html#cb144-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rois)){</span>
<span id="cb144-10"><a href="prepare-fmri-data.html#cb144-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-11"><a href="prepare-fmri-data.html#cb144-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># where to put the output</span></span>
<span id="cb144-12"><a href="prepare-fmri-data.html#cb144-12" aria-hidden="true" tabindex="-1"></a>  out_dir <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, rois[i_roi], <span class="st">&quot;mni_1mm&quot;</span>)</span>
<span id="cb144-13"><a href="prepare-fmri-data.html#cb144-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)){<span class="fu">dir.create</span>(out_dir)}</span>
<span id="cb144-14"><a href="prepare-fmri-data.html#cb144-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-15"><a href="prepare-fmri-data.html#cb144-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define input files in samespace (ss) = analysis space based on the wholebrain EPI</span></span>
<span id="cb144-16"><a href="prepare-fmri-data.html#cb144-16" aria-hidden="true" tabindex="-1"></a>  roi_ss <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, rois[i_roi], <span class="st">&quot;samespace&quot;</span>,</span>
<span id="cb144-17"><a href="prepare-fmri-data.html#cb144-17" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_ss.nii.gz&quot;</span>, subjects, rois[i_roi]))</span>
<span id="cb144-18"><a href="prepare-fmri-data.html#cb144-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-19"><a href="prepare-fmri-data.html#cb144-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">#file name of output ROI file in standard MNI space</span></span>
<span id="cb144-20"><a href="prepare-fmri-data.html#cb144-20" aria-hidden="true" tabindex="-1"></a>  roi_mni <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_mni1mm.nii.gz&quot;</span>, subjects, rois[i_roi]))</span>
<span id="cb144-21"><a href="prepare-fmri-data.html#cb144-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-22"><a href="prepare-fmri-data.html#cb144-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># apply FSL flirt to move ROI from wholebrain functional space to MNI space</span></span>
<span id="cb144-23"><a href="prepare-fmri-data.html#cb144-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">mapply</span>(flirt_apply, <span class="at">infile =</span> roi_ss, <span class="at">reffile =</span> mni_1mm, </span>
<span id="cb144-24"><a href="prepare-fmri-data.html#cb144-24" aria-hidden="true" tabindex="-1"></a>                   <span class="at">initmat =</span> func2standard, <span class="at">outfile =</span> roi_mni,</span>
<span id="cb144-25"><a href="prepare-fmri-data.html#cb144-25" aria-hidden="true" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>))</span>
<span id="cb144-26"><a href="prepare-fmri-data.html#cb144-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-27"><a href="prepare-fmri-data.html#cb144-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use fslmaths to binarize the ROI using a threshold of 0.5</span></span>
<span id="cb144-28"><a href="prepare-fmri-data.html#cb144-28" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">mapply</span>(fsl_thresh, <span class="at">file =</span> roi_mni, <span class="at">outfile =</span> roi_mni, <span class="at">thresh =</span> <span class="fl">0.5</span>, <span class="at">opts =</span> <span class="st">&quot;-bin&quot;</span>,</span>
<span id="cb144-29"><a href="prepare-fmri-data.html#cb144-29" aria-hidden="true" tabindex="-1"></a>                <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>)</span>
<span id="cb144-30"><a href="prepare-fmri-data.html#cb144-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-31"><a href="prepare-fmri-data.html#cb144-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create summary image</span></span>
<span id="cb144-32"><a href="prepare-fmri-data.html#cb144-32" aria-hidden="true" tabindex="-1"></a>  out_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, rois[i_roi], </span>
<span id="cb144-33"><a href="prepare-fmri-data.html#cb144-33" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">sprintf</span>(<span class="st">&quot;%s_group_prob_mni1mm.nii.gz&quot;</span>,rois[i_roi]))</span>
<span id="cb144-34"><a href="prepare-fmri-data.html#cb144-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fslmaths</span>(<span class="at">file =</span> roi_mni, <span class="at">outfile =</span> out_fn, </span>
<span id="cb144-35"><a href="prepare-fmri-data.html#cb144-35" aria-hidden="true" tabindex="-1"></a>           <span class="at">opts =</span> <span class="fu">sprintf</span>(<span class="st">&quot;-add %s&quot;</span>, <span class="fu">paste0</span>(roi_mni[<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(roi_mni)])),</span>
<span id="cb144-36"><a href="prepare-fmri-data.html#cb144-36" aria-hidden="true" tabindex="-1"></a>           <span class="at">verbose=</span><span class="cn">FALSE</span>)</span>
<span id="cb144-37"><a href="prepare-fmri-data.html#cb144-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fslmaths</span>(<span class="at">file =</span> out_fn, <span class="at">outfile =</span> out_fn, </span>
<span id="cb144-38"><a href="prepare-fmri-data.html#cb144-38" aria-hidden="true" tabindex="-1"></a>         <span class="at">opts =</span> <span class="fu">sprintf</span>(<span class="st">&quot;-div %d&quot;</span>, <span class="fu">length</span>(roi_mni)),</span>
<span id="cb144-39"><a href="prepare-fmri-data.html#cb144-39" aria-hidden="true" tabindex="-1"></a>         <span class="at">verbose=</span><span class="cn">FALSE</span>)</span>
<span id="cb144-40"><a href="prepare-fmri-data.html#cb144-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-41"><a href="prepare-fmri-data.html#cb144-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># copy to data sharing folder</span></span>
<span id="cb144-42"><a href="prepare-fmri-data.html#cb144-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.copy</span>(<span class="at">from =</span> out_fn, <span class="at">to =</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;mni1mm_masks&quot;</span>),</span>
<span id="cb144-43"><a href="prepare-fmri-data.html#cb144-43" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb144-44"><a href="prepare-fmri-data.html#cb144-44" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="field-of-view-mask-for-visualization" class="section level3 unnumbered">
<h3>Field of view mask for visualization</h3>
<p>Next, we create a mask of our field of view, i.e. voxels covered in our functional images. We do so by registering the subject-specific brain masks from FEAT (in whole-brain functional space, already combined across blocks) to MNI space. After thresholding, the result is a binary mask to illustrate the FOV when plotting brain images in the main analysis script.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="prepare-fmri-data.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># folder for output</span></span>
<span id="cb145-2"><a href="prepare-fmri-data.html#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;fov&quot;</span>))){</span>
<span id="cb145-3"><a href="prepare-fmri-data.html#cb145-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;fov&quot;</span>), <span class="at">recursive=</span><span class="cn">TRUE</span>)}</span>
<span id="cb145-4"><a href="prepare-fmri-data.html#cb145-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-5"><a href="prepare-fmri-data.html#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="co"># name of transformation matrix file to move from the shared functional space to MNI 1mm</span></span>
<span id="cb145-6"><a href="prepare-fmri-data.html#cb145-6" aria-hidden="true" tabindex="-1"></a>func2standard <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb145-7"><a href="prepare-fmri-data.html#cb145-7" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb145-8"><a href="prepare-fmri-data.html#cb145-8" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;example_func2standard.mat&quot;</span>)</span>
<span id="cb145-9"><a href="prepare-fmri-data.html#cb145-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-10"><a href="prepare-fmri-data.html#cb145-10" aria-hidden="true" tabindex="-1"></a><span class="co"># subject-specific brain (FOV) masks in whole-brain functional space</span></span>
<span id="cb145-11"><a href="prepare-fmri-data.html#cb145-11" aria-hidden="true" tabindex="-1"></a>subj_masks <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>samespace_dir, <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%s&quot;</span>,subjects),</span>
<span id="cb145-12"><a href="prepare-fmri-data.html#cb145-12" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_mask_perBlock.nii.gz&quot;</span>,subjects))</span>
<span id="cb145-13"><a href="prepare-fmri-data.html#cb145-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-14"><a href="prepare-fmri-data.html#cb145-14" aria-hidden="true" tabindex="-1"></a><span class="co"># output file name after moving to MNI space</span></span>
<span id="cb145-15"><a href="prepare-fmri-data.html#cb145-15" aria-hidden="true" tabindex="-1"></a>subj_masks_mni <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;fov&quot;</span>), </span>
<span id="cb145-16"><a href="prepare-fmri-data.html#cb145-16" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">sprintf</span>(<span class="st">&quot;%s_fov_mask_mni.nii.gz&quot;</span>, subjects))</span>
<span id="cb145-17"><a href="prepare-fmri-data.html#cb145-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-18"><a href="prepare-fmri-data.html#cb145-18" aria-hidden="true" tabindex="-1"></a><span class="co"># apply FSL flirt to move from wholebrain functional space to 1mm MNI space</span></span>
<span id="cb145-19"><a href="prepare-fmri-data.html#cb145-19" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">mapply</span>(flirt_apply,</span>
<span id="cb145-20"><a href="prepare-fmri-data.html#cb145-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">infile =</span> subj_masks,</span>
<span id="cb145-21"><a href="prepare-fmri-data.html#cb145-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">reffile =</span> <span class="fu">mni_fname</span>(<span class="st">&quot;1&quot;</span>),</span>
<span id="cb145-22"><a href="prepare-fmri-data.html#cb145-22" aria-hidden="true" tabindex="-1"></a>                 <span class="at">initmat =</span> func2standard,</span>
<span id="cb145-23"><a href="prepare-fmri-data.html#cb145-23" aria-hidden="true" tabindex="-1"></a>                 <span class="at">outfile =</span> subj_masks_mni,</span>
<span id="cb145-24"><a href="prepare-fmri-data.html#cb145-24" aria-hidden="true" tabindex="-1"></a>                 <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>))</span>
<span id="cb145-25"><a href="prepare-fmri-data.html#cb145-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-26"><a href="prepare-fmri-data.html#cb145-26" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the files into a 4D file</span></span>
<span id="cb145-27"><a href="prepare-fmri-data.html#cb145-27" aria-hidden="true" tabindex="-1"></a>mask_4d <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;fov&quot;</span>, <span class="st">&quot;4d_fov_mask_mni.nii.gz&quot;</span>)</span>
<span id="cb145-28"><a href="prepare-fmri-data.html#cb145-28" aria-hidden="true" tabindex="-1"></a><span class="fu">fsl_merge</span>(<span class="at">infiles =</span> subj_masks_mni, <span class="at">direction =</span> <span class="st">&quot;t&quot;</span>, <span class="at">outfile =</span> mask_4d, <span class="at">retimg =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb145-29"><a href="prepare-fmri-data.html#cb145-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-30"><a href="prepare-fmri-data.html#cb145-30" aria-hidden="true" tabindex="-1"></a><span class="co"># create binary mask </span></span>
<span id="cb145-31"><a href="prepare-fmri-data.html#cb145-31" aria-hidden="true" tabindex="-1"></a>fov_mask <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;fov&quot;</span>, <span class="st">&quot;fov_mask_mni.nii.gz&quot;</span>)</span>
<span id="cb145-32"><a href="prepare-fmri-data.html#cb145-32" aria-hidden="true" tabindex="-1"></a>fov_mask_nii <span class="ot">&lt;-</span> <span class="fu">fslmaths</span>(mask_4d, <span class="at">outfile =</span> fov_mask, </span>
<span id="cb145-33"><a href="prepare-fmri-data.html#cb145-33" aria-hidden="true" tabindex="-1"></a>                         <span class="at">opts =</span> <span class="st">&quot;-thr 0.3 -bin -Tmean -thr 0.3 -bin&quot;</span>,</span>
<span id="cb145-34"><a href="prepare-fmri-data.html#cb145-34" aria-hidden="true" tabindex="-1"></a>                         <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">TRUE</span>)</span>
<span id="cb145-35"><a href="prepare-fmri-data.html#cb145-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-36"><a href="prepare-fmri-data.html#cb145-36" aria-hidden="true" tabindex="-1"></a><span class="co"># quick plot</span></span>
<span id="cb145-37"><a href="prepare-fmri-data.html#cb145-37" aria-hidden="true" tabindex="-1"></a><span class="fu">ortho2</span>(fov_mask_nii, <span class="at">xyz=</span><span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">100</span>,<span class="dv">50</span>))</span>
<span id="cb145-38"><a href="prepare-fmri-data.html#cb145-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-39"><a href="prepare-fmri-data.html#cb145-39" aria-hidden="true" tabindex="-1"></a><span class="co"># copy to data sharing folder</span></span>
<span id="cb145-40"><a href="prepare-fmri-data.html#cb145-40" aria-hidden="true" tabindex="-1"></a><span class="fu">file.copy</span>(<span class="at">from =</span> fov_mask, <span class="at">to =</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;mni1mm_masks&quot;</span>))</span></code></pre></div>
</div>
<div id="gray-matter-mask" class="section level3 unnumbered">
<h3>Gray matter mask</h3>
<p>From the subject-specific gray matter masks (in whole-brain functional space) we create a merged, binary mask in MNI space. We use this to run FSL Randomise for all gray matter voxels (we only use gray matter voxels as features for our searchlight analysis).</p>
<blockquote>
<p>Gray matter segmentation was done on the structural images and the results were mapped back to the space of the whole-brain functional scan for later use in the analysis.</p>
</blockquote>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="prepare-fmri-data.html#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># folder for output</span></span>
<span id="cb146-2"><a href="prepare-fmri-data.html#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;gray_matter&quot;</span>))){</span>
<span id="cb146-3"><a href="prepare-fmri-data.html#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;gray_matter&quot;</span>), <span class="at">recursive=</span><span class="cn">TRUE</span>)}</span>
<span id="cb146-4"><a href="prepare-fmri-data.html#cb146-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-5"><a href="prepare-fmri-data.html#cb146-5" aria-hidden="true" tabindex="-1"></a><span class="co"># name of transformation matrix file to move from the shared functional space to MNI 1mm</span></span>
<span id="cb146-6"><a href="prepare-fmri-data.html#cb146-6" aria-hidden="true" tabindex="-1"></a>func2standard <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb146-7"><a href="prepare-fmri-data.html#cb146-7" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb146-8"><a href="prepare-fmri-data.html#cb146-8" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;example_func2standard.mat&quot;</span>)</span>
<span id="cb146-9"><a href="prepare-fmri-data.html#cb146-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-10"><a href="prepare-fmri-data.html#cb146-10" aria-hidden="true" tabindex="-1"></a><span class="co"># subject-specific gray matter masks in whole-brain functional space</span></span>
<span id="cb146-11"><a href="prepare-fmri-data.html#cb146-11" aria-hidden="true" tabindex="-1"></a>subj_masks <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>samespace_dir, <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%s&quot;</span>,subjects),</span>
<span id="cb146-12"><a href="prepare-fmri-data.html#cb146-12" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_graymatter_mask_brainmasked.nii.gz&quot;</span>, subjects))</span>
<span id="cb146-13"><a href="prepare-fmri-data.html#cb146-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-14"><a href="prepare-fmri-data.html#cb146-14" aria-hidden="true" tabindex="-1"></a><span class="co"># output file name in MNI space</span></span>
<span id="cb146-15"><a href="prepare-fmri-data.html#cb146-15" aria-hidden="true" tabindex="-1"></a>subj_masks_mni <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;gray_matter&quot;</span>, </span>
<span id="cb146-16"><a href="prepare-fmri-data.html#cb146-16" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">sprintf</span>(<span class="st">&quot;%s_graymatter_mni.nii.gz&quot;</span>, subjects))</span>
<span id="cb146-17"><a href="prepare-fmri-data.html#cb146-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-18"><a href="prepare-fmri-data.html#cb146-18" aria-hidden="true" tabindex="-1"></a><span class="co"># apply FSL flirt to move from wholebrain functional space to 1mm MNI space</span></span>
<span id="cb146-19"><a href="prepare-fmri-data.html#cb146-19" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">mapply</span>(flirt_apply,</span>
<span id="cb146-20"><a href="prepare-fmri-data.html#cb146-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">infile =</span> subj_masks,</span>
<span id="cb146-21"><a href="prepare-fmri-data.html#cb146-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">reffile =</span> <span class="fu">mni_fname</span>(<span class="st">&quot;1&quot;</span>),</span>
<span id="cb146-22"><a href="prepare-fmri-data.html#cb146-22" aria-hidden="true" tabindex="-1"></a>                 <span class="at">initmat =</span> func2standard,</span>
<span id="cb146-23"><a href="prepare-fmri-data.html#cb146-23" aria-hidden="true" tabindex="-1"></a>                 <span class="at">outfile =</span> subj_masks_mni,</span>
<span id="cb146-24"><a href="prepare-fmri-data.html#cb146-24" aria-hidden="true" tabindex="-1"></a>                 <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>))</span>
<span id="cb146-25"><a href="prepare-fmri-data.html#cb146-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-26"><a href="prepare-fmri-data.html#cb146-26" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the files into a 4D file</span></span>
<span id="cb146-27"><a href="prepare-fmri-data.html#cb146-27" aria-hidden="true" tabindex="-1"></a>gm_4d <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;gray_matter&quot;</span>, <span class="st">&quot;4d_graymatter_mni.nii.gz&quot;</span>)</span>
<span id="cb146-28"><a href="prepare-fmri-data.html#cb146-28" aria-hidden="true" tabindex="-1"></a><span class="fu">fsl_merge</span>(<span class="at">infiles =</span> subj_masks_mni, <span class="at">direction =</span> <span class="st">&quot;t&quot;</span>, <span class="at">outfile =</span> gm_4d, <span class="at">retimg =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb146-29"><a href="prepare-fmri-data.html#cb146-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-30"><a href="prepare-fmri-data.html#cb146-30" aria-hidden="true" tabindex="-1"></a><span class="co"># create binary gray matter mask by thresholding and combining across subjects liberally</span></span>
<span id="cb146-31"><a href="prepare-fmri-data.html#cb146-31" aria-hidden="true" tabindex="-1"></a>mni_brain_mask <span class="ot">&lt;-</span> <span class="fu">mni_fname</span>(<span class="at">mm =</span> <span class="st">&quot;1&quot;</span>, <span class="at">brain=</span><span class="cn">TRUE</span>, <span class="at">mask=</span><span class="cn">TRUE</span>)</span>
<span id="cb146-32"><a href="prepare-fmri-data.html#cb146-32" aria-hidden="true" tabindex="-1"></a>gm_mask <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;gray_matter&quot;</span>, <span class="st">&quot;gray_matter_mask.nii.gz&quot;</span>)</span>
<span id="cb146-33"><a href="prepare-fmri-data.html#cb146-33" aria-hidden="true" tabindex="-1"></a>gm_mask_nii <span class="ot">&lt;-</span> <span class="fu">fslmaths</span>(gm_4d, <span class="at">outfile =</span> gm_mask, </span>
<span id="cb146-34"><a href="prepare-fmri-data.html#cb146-34" aria-hidden="true" tabindex="-1"></a>                        <span class="at">opts =</span> <span class="fu">sprintf</span>(<span class="st">&quot;-thr 0.3 -bin -Tmean -thr 0.3 -bin -mas %s&quot;</span>,</span>
<span id="cb146-35"><a href="prepare-fmri-data.html#cb146-35" aria-hidden="true" tabindex="-1"></a>                                       mni_brain_mask),</span>
<span id="cb146-36"><a href="prepare-fmri-data.html#cb146-36" aria-hidden="true" tabindex="-1"></a>                        <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="small-volume-correction-mask" class="section level3 unnumbered">
<h3>Small Volume Correction Mask</h3>
<blockquote>
<p>We corrected for multiple comparisons using a small volume correction mask including our a priori regions of interest, the anterior hippocampus and the anterior-lateral entorhinal cortex.</p>
</blockquote>
<p>The small volume correction mask consists of our a priori ROIs, the anterior hippocampus and the anterior-lateral entorhinal cortex. We use the subject-specific masks, moved back to MNI space for this.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="prepare-fmri-data.html#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># folder for output</span></span>
<span id="cb147-2"><a href="prepare-fmri-data.html#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;svc&quot;</span>))){</span>
<span id="cb147-3"><a href="prepare-fmri-data.html#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;svc&quot;</span>), <span class="at">recursive=</span><span class="cn">TRUE</span>)}</span>
<span id="cb147-4"><a href="prepare-fmri-data.html#cb147-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-5"><a href="prepare-fmri-data.html#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create the SVC mask by merging aHPC and alEC ROIs</span></span>
<span id="cb147-6"><a href="prepare-fmri-data.html#cb147-6" aria-hidden="true" tabindex="-1"></a>aHPC_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;aHPC_lr&quot;</span>,</span>
<span id="cb147-7"><a href="prepare-fmri-data.html#cb147-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">sprintf</span>(<span class="st">&quot;%s_group_prob_mni1mm.nii.gz&quot;</span>, <span class="st">&quot;aHPC_lr&quot;</span>))</span>
<span id="cb147-8"><a href="prepare-fmri-data.html#cb147-8" aria-hidden="true" tabindex="-1"></a>alEC_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;alEC_lr&quot;</span>,</span>
<span id="cb147-9"><a href="prepare-fmri-data.html#cb147-9" aria-hidden="true" tabindex="-1"></a>                <span class="fu">sprintf</span>(<span class="st">&quot;%s_group_prob_mni1mm.nii.gz&quot;</span>, <span class="st">&quot;alEC_lr&quot;</span>))</span>
<span id="cb147-10"><a href="prepare-fmri-data.html#cb147-10" aria-hidden="true" tabindex="-1"></a>svc_mask_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;svc&quot;</span>, <span class="st">&quot;svc_mask.nii.gz&quot;</span>)</span>
<span id="cb147-11"><a href="prepare-fmri-data.html#cb147-11" aria-hidden="true" tabindex="-1"></a><span class="fu">fsl_add</span>(<span class="at">file =</span> aHPC_fn, <span class="at">file2 =</span> alEC_fn, <span class="at">outfile =</span> svc_mask_fn, </span>
<span id="cb147-12"><a href="prepare-fmri-data.html#cb147-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">retimg =</span> <span class="cn">FALSE</span>)</span>
<span id="cb147-13"><a href="prepare-fmri-data.html#cb147-13" aria-hidden="true" tabindex="-1"></a>svc_nii <span class="ot">&lt;-</span> <span class="fu">fslmaths</span>(<span class="at">file =</span> svc_mask_fn, <span class="at">outfile =</span> svc_mask_fn, </span>
<span id="cb147-14"><a href="prepare-fmri-data.html#cb147-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">opts =</span> <span class="fu">sprintf</span>(<span class="st">&quot;-thr 0.99 -bin -mas %s&quot;</span>, gm_mask), </span>
<span id="cb147-15"><a href="prepare-fmri-data.html#cb147-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">retimg =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-16"><a href="prepare-fmri-data.html#cb147-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-17"><a href="prepare-fmri-data.html#cb147-17" aria-hidden="true" tabindex="-1"></a><span class="co"># let&#39;s have a look at the mask we created</span></span>
<span id="cb147-18"><a href="prepare-fmri-data.html#cb147-18" aria-hidden="true" tabindex="-1"></a>mni_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(<span class="fu">mni_fname</span>(<span class="st">&quot;1&quot;</span>))</span>
<span id="cb147-19"><a href="prepare-fmri-data.html#cb147-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ortho2</span>(mni_nii, <span class="at">y =</span> svc_nii, <span class="at">xyz =</span> <span class="fu">c</span>(<span class="dv">63</span>, <span class="dv">113</span>, <span class="dv">50</span>))</span>
<span id="cb147-20"><a href="prepare-fmri-data.html#cb147-20" aria-hidden="true" tabindex="-1"></a><span class="fu">ortho2</span>(mni_nii, <span class="at">y =</span> svc_nii, <span class="at">xyz =</span> <span class="fu">c</span>(<span class="dv">71</span>, <span class="dv">127</span>, <span class="dv">39</span>))</span></code></pre></div>

</div>
</div>
<div id="quantify-representational-change" class="section level2" number="6.3">
<h2><span class="header-section-number">6.3</span> Quantify Representational Change</h2>
<div id="get-multi-voxel-patterns-from-rois" class="section level3 unnumbered">
<h3>Get multi-voxel patterns from ROIs</h3>
<p>We want to run RSA on the multi-voxel patterns corresponding to the object presentations during the picture viewing tasks. For this, we use the data as it was preprocessed by Lorena Deuker. We will do some further cleaning and extract the relevant volumes from the time series to eventually run RSA.</p>
<div id="preprocessing" class="section level4 unnumbered">
<h4>Preprocessing</h4>
<blockquote>
<p>Preprocessing was performed using FSL FEAT (version 6.00). Functional scans from the picture viewing tasks and the whole-brain functional scan were submitted to motion correction and high-pass filtering using FSL FEAT. For the two picture viewing tasks, data from each mini-block was preprocessed independently. For those participants with a field map scan, distortion correction was applied to the functional data sets. No spatial smoothing was performed. Functional images from the two picture viewing tasks were then registered to the preprocessed mean image of the whole-brain functional scan. The whole-brain functional images were registered to the individual structural scans. The structural scans were in turn normalized to the MNI template (1-mm resolution). Gray matter segmentation was done on the structural images, and the results were mapped back to the space of the whole-brain functional scan for later use in the analysis.</p>
</blockquote>
</div>
<div id="extract-roi-time-series-and-calculate-residuals-from-motion-parameter-regression" class="section level4 unnumbered">
<h4>Extract ROI time series and calculate residuals from motion parameter regression</h4>
<p>In this first section of the script we will create a dataframe that includes the relevant file names for the files that are needed to extract the clean time series. These files include the motion parameters from FSL FEAT, which was run on the functional data from the picture viewing task. As described above, these data were split into 10 blocks. We will use the preprocessed FEAT output images which were already co-registered to the analysis space (‘samespace’). Further, we will use a mask to only include voxels with data in all blocks. This mask has already been created and is available in the analysis space. Additionally, we will use the graymatter mask and ROI masks(both already co-registered to the analysis space).</p>
<blockquote>
<p>Representational similarity analysis (RSA) (Kriegeskorte et al., 2008) was first implemented separately for the pre- and post-learning picture viewing task. It was carried out in ROIs co-registered to the whole-brain functional image and in searchlight analyses (see below). For the ROI analyses, preprocessed data were intersected with the participant-specific anterior hippocampus and anterolateral entorhinal cortex ROI masks as well as a brain mask obtained during preprocessing (only voxels within the brain mask in all mini-blocks were analyzed) and the gray matter mask. For each voxel within the ROI mask, motion parameters from FSL MCFLIRT were used as predictors in a general linear model (GLM) with the voxel time series as the dependent variable. The residuals of this GLM (i.e. data that could not be explained by motion) were taken to the next analysis step.</p>
</blockquote>
<p>Build data frame with files and folders:</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="prepare-fmri-data.html#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co">#PREPARE DATA FRAME FOR CLEANING</span></span>
<span id="cb148-2"><a href="prepare-fmri-data.html#cb148-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-3"><a href="prepare-fmri-data.html#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create a tibble with filenames etc for data cleaning, start with subject IDs</span></span>
<span id="cb148-4"><a href="prepare-fmri-data.html#cb148-4" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">subject =</span> <span class="fu">rep</span>(<span class="fu">as.numeric</span>(subjects), <span class="at">each =</span> n_runs <span class="sc">*</span> n_blocks))</span>
<span id="cb148-5"><a href="prepare-fmri-data.html#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="co"># add run info (run 1 and 2 equal the pre and post PVT)</span></span>
<span id="cb148-6"><a href="prepare-fmri-data.html#cb148-6" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">run =</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_runs, <span class="at">each =</span> n_blocks), n_subs))</span>
<span id="cb148-7"><a href="prepare-fmri-data.html#cb148-7" aria-hidden="true" tabindex="-1"></a><span class="co"># add block information (blocks 1 to 10 are the PVT blocks preprocessed separately)</span></span>
<span id="cb148-8"><a href="prepare-fmri-data.html#cb148-8" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">block =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_blocks, n_subs<span class="sc">*</span>n_runs))</span>
<span id="cb148-9"><a href="prepare-fmri-data.html#cb148-9" aria-hidden="true" tabindex="-1"></a><span class="co"># add the motion parameter file</span></span>
<span id="cb148-10"><a href="prepare-fmri-data.html#cb148-10" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">mc_par_fn =</span> </span>
<span id="cb148-11"><a href="prepare-fmri-data.html#cb148-11" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">file.path</span>(dirs<span class="sc">$</span>feat_dir,</span>
<span id="cb148-12"><a href="prepare-fmri-data.html#cb148-12" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P0&quot;</span>, func_dat_df<span class="sc">$</span>subject),</span>
<span id="cb148-13"><a href="prepare-fmri-data.html#cb148-13" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">sprintf</span>(<span class="st">&quot;RSA_%02d_Block%02d.feat&quot;</span>,</span>
<span id="cb148-14"><a href="prepare-fmri-data.html#cb148-14" aria-hidden="true" tabindex="-1"></a>                                              func_dat_df<span class="sc">$</span>run, func_dat_df<span class="sc">$</span>block),</span>
<span id="cb148-15"><a href="prepare-fmri-data.html#cb148-15" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">&quot;mc&quot;</span>, <span class="st">&quot;prefiltered_func_data_mcf.par&quot;</span>))</span>
<span id="cb148-16"><a href="prepare-fmri-data.html#cb148-16" aria-hidden="true" tabindex="-1"></a><span class="co"># add the functional data file</span></span>
<span id="cb148-17"><a href="prepare-fmri-data.html#cb148-17" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">filtered_func =</span> </span>
<span id="cb148-18"><a href="prepare-fmri-data.html#cb148-18" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">file.path</span>(dirs<span class="sc">$</span>samespace_dir,</span>
<span id="cb148-19"><a href="prepare-fmri-data.html#cb148-19" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P0&quot;</span>, func_dat_df<span class="sc">$</span>subject),</span>
<span id="cb148-20"><a href="prepare-fmri-data.html#cb148-20" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%03d_RSA_%02d_Block%02d_func.nii.gz&quot;</span>,</span>
<span id="cb148-21"><a href="prepare-fmri-data.html#cb148-21" aria-hidden="true" tabindex="-1"></a>                                              func_dat_df<span class="sc">$</span>subject, func_dat_df<span class="sc">$</span>run, func_dat_df<span class="sc">$</span>block)))</span>
<span id="cb148-22"><a href="prepare-fmri-data.html#cb148-22" aria-hidden="true" tabindex="-1"></a><span class="co"># add the brain mask data file</span></span>
<span id="cb148-23"><a href="prepare-fmri-data.html#cb148-23" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">brain_mask =</span> </span>
<span id="cb148-24"><a href="prepare-fmri-data.html#cb148-24" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">file.path</span>(dirs<span class="sc">$</span>samespace_dir,</span>
<span id="cb148-25"><a href="prepare-fmri-data.html#cb148-25" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P0&quot;</span>, func_dat_df<span class="sc">$</span>subject),</span>
<span id="cb148-26"><a href="prepare-fmri-data.html#cb148-26" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%03d_common_mask_perBlock.nii.gz&quot;</span>,</span>
<span id="cb148-27"><a href="prepare-fmri-data.html#cb148-27" aria-hidden="true" tabindex="-1"></a>                                              func_dat_df<span class="sc">$</span>subject)))</span>
<span id="cb148-28"><a href="prepare-fmri-data.html#cb148-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-29"><a href="prepare-fmri-data.html#cb148-29" aria-hidden="true" tabindex="-1"></a><span class="co"># add the graymatter mask file</span></span>
<span id="cb148-30"><a href="prepare-fmri-data.html#cb148-30" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">gray_mask =</span> </span>
<span id="cb148-31"><a href="prepare-fmri-data.html#cb148-31" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">file.path</span>(dirs<span class="sc">$</span>samespace_dir,</span>
<span id="cb148-32"><a href="prepare-fmri-data.html#cb148-32" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P0&quot;</span>, func_dat_df<span class="sc">$</span>subject),</span>
<span id="cb148-33"><a href="prepare-fmri-data.html#cb148-33" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%03d_common_graymatter_mask.nii.gz&quot;</span>,</span>
<span id="cb148-34"><a href="prepare-fmri-data.html#cb148-34" aria-hidden="true" tabindex="-1"></a>                                              func_dat_df<span class="sc">$</span>subject)))</span>
<span id="cb148-35"><a href="prepare-fmri-data.html#cb148-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-36"><a href="prepare-fmri-data.html#cb148-36" aria-hidden="true" tabindex="-1"></a><span class="co"># add output directory</span></span>
<span id="cb148-37"><a href="prepare-fmri-data.html#cb148-37" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">out_dir =</span> <span class="fu">list</span>(dirs<span class="sc">$</span>rsa_roi_clean_timeseries_dirs))</span>
<span id="cb148-38"><a href="prepare-fmri-data.html#cb148-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-39"><a href="prepare-fmri-data.html#cb148-39" aria-hidden="true" tabindex="-1"></a><span class="co"># add list of ROIs</span></span>
<span id="cb148-40"><a href="prepare-fmri-data.html#cb148-40" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">rois =</span> <span class="fu">list</span>(rois))</span>
<span id="cb148-41"><a href="prepare-fmri-data.html#cb148-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-42"><a href="prepare-fmri-data.html#cb148-42" aria-hidden="true" tabindex="-1"></a><span class="co"># add list of ROI file names</span></span>
<span id="cb148-43"><a href="prepare-fmri-data.html#cb148-43" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">roi_dirs =</span> <span class="fu">list</span>(dirs<span class="sc">$</span>rois_ss_dirs))</span></code></pre></div>
<div id="define-the-function-used-to-clean-functional-data" class="section level5 unnumbered">
<h5>Define the function used to clean functional data</h5>
<p>In this next section, we will first define a function and then run it on all datasets. In this function, the preprocessed data will be loaded and transformed to matrix format. A combined mask is generated from the respective ROI mask and the graymatter and brain masks. For every voxel within this mask, movement correction parameters are used as predictors in a GLM with the voxel time series as dependent variable. Finally, the residuals from this GLM (i.e. what could not be explained by motion) will be written to a text file.</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="prepare-fmri-data.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DEFINE THE FUNCTION TO GET THE RESIDUAL TIME SERIES </span></span>
<span id="cb149-2"><a href="prepare-fmri-data.html#cb149-2" aria-hidden="true" tabindex="-1"></a>run_motion_glm <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">df =</span> func_dat_df[<span class="dv">1</span>,]){</span>
<span id="cb149-3"><a href="prepare-fmri-data.html#cb149-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-4"><a href="prepare-fmri-data.html#cb149-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the motion params and convert to tibble</span></span>
<span id="cb149-5"><a href="prepare-fmri-data.html#cb149-5" aria-hidden="true" tabindex="-1"></a>  mc_pars <span class="ot">&lt;-</span> <span class="fu">read.table</span>(df<span class="sc">$</span>mc_par_fn, <span class="at">header =</span> <span class="cn">FALSE</span>)</span>
<span id="cb149-6"><a href="prepare-fmri-data.html#cb149-6" aria-hidden="true" tabindex="-1"></a>  mp_df <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(mc_pars)</span>
<span id="cb149-7"><a href="prepare-fmri-data.html#cb149-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(mp_df) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;mp&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb149-8"><a href="prepare-fmri-data.html#cb149-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-9"><a href="prepare-fmri-data.html#cb149-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the brain mask and linearize it </span></span>
<span id="cb149-10"><a href="prepare-fmri-data.html#cb149-10" aria-hidden="true" tabindex="-1"></a>  brain_mask_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(df<span class="sc">$</span>brain_mask)</span>
<span id="cb149-11"><a href="prepare-fmri-data.html#cb149-11" aria-hidden="true" tabindex="-1"></a>  brain_mask_lin <span class="ot">&lt;-</span> <span class="fu">c</span>(brain_mask_nii)</span>
<span id="cb149-12"><a href="prepare-fmri-data.html#cb149-12" aria-hidden="true" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">all.equal</span>(<span class="fu">unique</span>(brain_mask_lin), <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)))</span>
<span id="cb149-13"><a href="prepare-fmri-data.html#cb149-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-14"><a href="prepare-fmri-data.html#cb149-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the graymatter mask and linearize it and threshold it at 0.7</span></span>
<span id="cb149-15"><a href="prepare-fmri-data.html#cb149-15" aria-hidden="true" tabindex="-1"></a>  gray_mask_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(df<span class="sc">$</span>gray_mask)</span>
<span id="cb149-16"><a href="prepare-fmri-data.html#cb149-16" aria-hidden="true" tabindex="-1"></a>  gray_mask_lin <span class="ot">&lt;-</span> <span class="fu">c</span>(gray_mask_nii) <span class="sc">&gt;</span> <span class="fl">0.7</span></span>
<span id="cb149-17"><a href="prepare-fmri-data.html#cb149-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-18"><a href="prepare-fmri-data.html#cb149-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the functional data</span></span>
<span id="cb149-19"><a href="prepare-fmri-data.html#cb149-19" aria-hidden="true" tabindex="-1"></a>  func_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(df<span class="sc">$</span>filtered_func)</span>
<span id="cb149-20"><a href="prepare-fmri-data.html#cb149-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-21"><a href="prepare-fmri-data.html#cb149-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create matrix from the functional data with voxels in rows and volumes in columns</span></span>
<span id="cb149-22"><a href="prepare-fmri-data.html#cb149-22" aria-hidden="true" tabindex="-1"></a>  n_vols <span class="ot">&lt;-</span> <span class="fu">dim</span>(func_nii)[<span class="dv">4</span>]</span>
<span id="cb149-23"><a href="prepare-fmri-data.html#cb149-23" aria-hidden="true" tabindex="-1"></a>  func_dat_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">prod</span>(<span class="fu">dim</span>(func_nii)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]), <span class="at">ncol =</span> n_vols)</span>
<span id="cb149-24"><a href="prepare-fmri-data.html#cb149-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i_vol <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_vols){</span>
<span id="cb149-25"><a href="prepare-fmri-data.html#cb149-25" aria-hidden="true" tabindex="-1"></a>    func_dat_mat[,i_vol] <span class="ot">&lt;-</span> <span class="fu">c</span>(func_nii[,,,i_vol])</span>
<span id="cb149-26"><a href="prepare-fmri-data.html#cb149-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb149-27"><a href="prepare-fmri-data.html#cb149-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-28"><a href="prepare-fmri-data.html#cb149-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define the roi files    </span></span>
<span id="cb149-29"><a href="prepare-fmri-data.html#cb149-29" aria-hidden="true" tabindex="-1"></a>  roi_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(df<span class="sc">$</span>roi_dirs[[<span class="dv">1</span>]], </span>
<span id="cb149-30"><a href="prepare-fmri-data.html#cb149-30" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">sprintf</span>(<span class="st">&quot;P%03d_%s_ss_fs.nii.gz&quot;</span>, df<span class="sc">$</span>subject, df<span class="sc">$</span>rois[[<span class="dv">1</span>]]))</span>
<span id="cb149-31"><a href="prepare-fmri-data.html#cb149-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-32"><a href="prepare-fmri-data.html#cb149-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># loop over the ROIs</span></span>
<span id="cb149-33"><a href="prepare-fmri-data.html#cb149-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(roi_files)){</span>
<span id="cb149-34"><a href="prepare-fmri-data.html#cb149-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-35"><a href="prepare-fmri-data.html#cb149-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load the current ROI and linearize</span></span>
<span id="cb149-36"><a href="prepare-fmri-data.html#cb149-36" aria-hidden="true" tabindex="-1"></a>    roi_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(roi_files[i_roi])</span>
<span id="cb149-37"><a href="prepare-fmri-data.html#cb149-37" aria-hidden="true" tabindex="-1"></a>    roi_lin <span class="ot">&lt;-</span> <span class="fu">c</span>(roi_nii)</span>
<span id="cb149-38"><a href="prepare-fmri-data.html#cb149-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-39"><a href="prepare-fmri-data.html#cb149-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make sure masks and functional data have the same number of voxels</span></span>
<span id="cb149-40"><a href="prepare-fmri-data.html#cb149-40" aria-hidden="true" tabindex="-1"></a>    assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">length</span>(roi_lin) <span class="sc">==</span> <span class="fu">length</span>(gray_mask_lin))</span>
<span id="cb149-41"><a href="prepare-fmri-data.html#cb149-41" aria-hidden="true" tabindex="-1"></a>    assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">length</span>(roi_lin) <span class="sc">==</span> <span class="fu">length</span>(brain_mask_lin))</span>
<span id="cb149-42"><a href="prepare-fmri-data.html#cb149-42" aria-hidden="true" tabindex="-1"></a>    assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">length</span>(roi_lin) <span class="sc">==</span> <span class="fu">dim</span>(func_dat_mat)[<span class="dv">1</span>])</span>
<span id="cb149-43"><a href="prepare-fmri-data.html#cb149-43" aria-hidden="true" tabindex="-1"></a>    assertthat<span class="sc">::</span><span class="fu">assert_that</span>(n_vols <span class="sc">==</span> <span class="fu">nrow</span>(mc_pars))</span>
<span id="cb149-44"><a href="prepare-fmri-data.html#cb149-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-45"><a href="prepare-fmri-data.html#cb149-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create a mask combining the ROI, the graymatter, and the functional brain mask</span></span>
<span id="cb149-46"><a href="prepare-fmri-data.html#cb149-46" aria-hidden="true" tabindex="-1"></a>    comb_mask <span class="ot">&lt;-</span> <span class="fu">as.logical</span>(roi_lin) <span class="co">#&amp; gray_mask_lin &amp; as.logical(brain_mask_lin)</span></span>
<span id="cb149-47"><a href="prepare-fmri-data.html#cb149-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb149-48"><a href="prepare-fmri-data.html#cb149-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># run the GLM for each voxel in the combined mask</span></span>
<span id="cb149-49"><a href="prepare-fmri-data.html#cb149-49" aria-hidden="true" tabindex="-1"></a>    roi_dat <span class="ot">&lt;-</span> func_dat_mat[comb_mask,]</span>
<span id="cb149-50"><a href="prepare-fmri-data.html#cb149-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb149-51"><a href="prepare-fmri-data.html#cb149-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># initialize output for cleaned timeseries and then loop over all voxels</span></span>
<span id="cb149-52"><a href="prepare-fmri-data.html#cb149-52" aria-hidden="true" tabindex="-1"></a>    roi_dat_clean <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">sum</span>(comb_mask), <span class="at">ncol =</span> n_vols)</span>
<span id="cb149-53"><a href="prepare-fmri-data.html#cb149-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i_vox <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">sum</span>(comb_mask)){</span>
<span id="cb149-54"><a href="prepare-fmri-data.html#cb149-54" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb149-55"><a href="prepare-fmri-data.html#cb149-55" aria-hidden="true" tabindex="-1"></a>      <span class="co"># extract this voxel&#39;s data and merge with motion params</span></span>
<span id="cb149-56"><a href="prepare-fmri-data.html#cb149-56" aria-hidden="true" tabindex="-1"></a>      vox_dat <span class="ot">&lt;-</span> roi_dat[i_vox,]</span>
<span id="cb149-57"><a href="prepare-fmri-data.html#cb149-57" aria-hidden="true" tabindex="-1"></a>      vox_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(vox_dat)</span>
<span id="cb149-58"><a href="prepare-fmri-data.html#cb149-58" aria-hidden="true" tabindex="-1"></a>      vox_df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(vox_df, mp_df)</span>
<span id="cb149-59"><a href="prepare-fmri-data.html#cb149-59" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb149-60"><a href="prepare-fmri-data.html#cb149-60" aria-hidden="true" tabindex="-1"></a>      <span class="co"># run the glm and store the residuals</span></span>
<span id="cb149-61"><a href="prepare-fmri-data.html#cb149-61" aria-hidden="true" tabindex="-1"></a>      roi_dat_clean[i_vox,] <span class="ot">&lt;-</span> <span class="fu">resid</span>(<span class="fu">glm</span>(<span class="st">&#39;vox_dat~mp1+mp2+mp3+mp4+mp5+mp6&#39;</span>, <span class="at">data =</span> vox_df))</span>
<span id="cb149-62"><a href="prepare-fmri-data.html#cb149-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb149-63"><a href="prepare-fmri-data.html#cb149-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-64"><a href="prepare-fmri-data.html#cb149-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write clean timeseries data of this ROI to file </span></span>
<span id="cb149-65"><a href="prepare-fmri-data.html#cb149-65" aria-hidden="true" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;%03d_run%02d_block%02d_%s_clean_timeseries.txt&quot;</span>,</span>
<span id="cb149-66"><a href="prepare-fmri-data.html#cb149-66" aria-hidden="true" tabindex="-1"></a>                  df<span class="sc">$</span>subject, df<span class="sc">$</span>run, df<span class="sc">$</span>block, df<span class="sc">$</span>rois[[<span class="dv">1</span>]][i_roi])</span>
<span id="cb149-67"><a href="prepare-fmri-data.html#cb149-67" aria-hidden="true" tabindex="-1"></a>    out_dir_sub <span class="ot">&lt;-</span> <span class="fu">file.path</span>(df<span class="sc">$</span>out_dir[[<span class="dv">1</span>]][i_roi], <span class="fu">sprintf</span>(<span class="st">&quot;%03d&quot;</span>,df<span class="sc">$</span>subject))</span>
<span id="cb149-68"><a href="prepare-fmri-data.html#cb149-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir_sub)){<span class="fu">dir.create</span>(out_dir_sub)}                    </span>
<span id="cb149-69"><a href="prepare-fmri-data.html#cb149-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.table</span>(roi_dat_clean, <span class="fu">file.path</span>(out_dir_sub, fn), <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>,</span>
<span id="cb149-70"><a href="prepare-fmri-data.html#cb149-70" aria-hidden="true" tabindex="-1"></a>                <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb149-71"><a href="prepare-fmri-data.html#cb149-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb149-72"><a href="prepare-fmri-data.html#cb149-72" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="apply-cleaning-function" class="section level5 unnumbered">
<h5>Apply cleaning function</h5>
<p>Now we are ready to apply the cleaning function to all blocks of all participants. Typically, this should be run in parallel to save time.</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="prepare-fmri-data.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># next step depends on whether we are in parallel or serial mode</span></span>
<span id="cb150-2"><a href="prepare-fmri-data.html#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_parallel){ <span class="co"># run serially</span></span>
<span id="cb150-3"><a href="prepare-fmri-data.html#cb150-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-4"><a href="prepare-fmri-data.html#cb150-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># run the function for each row of the data frame,</span></span>
<span id="cb150-5"><a href="prepare-fmri-data.html#cb150-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># i.e. for each block in each run for each subject</span></span>
<span id="cb150-6"><a href="prepare-fmri-data.html#cb150-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(func_dat_df)){</span>
<span id="cb150-7"><a href="prepare-fmri-data.html#cb150-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-8"><a href="prepare-fmri-data.html#cb150-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tic</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Subject %s, run %d, block %d&quot;</span>,</span>
<span id="cb150-9"><a href="prepare-fmri-data.html#cb150-9" aria-hidden="true" tabindex="-1"></a>                func_dat_df<span class="sc">$</span>subject[i], func_dat_df<span class="sc">$</span>run[i], func_dat_df<span class="sc">$</span>block[i]))</span>
<span id="cb150-10"><a href="prepare-fmri-data.html#cb150-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">run_motion_glm</span>(<span class="at">df =</span> func_dat_df[i,])</span>
<span id="cb150-11"><a href="prepare-fmri-data.html#cb150-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toc</span>()</span>
<span id="cb150-12"><a href="prepare-fmri-data.html#cb150-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb150-13"><a href="prepare-fmri-data.html#cb150-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-14"><a href="prepare-fmri-data.html#cb150-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (run_parallel){ <span class="co"># run in parallel, assumes CBS HTCondor is available</span></span>
<span id="cb150-15"><a href="prepare-fmri-data.html#cb150-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-16"><a href="prepare-fmri-data.html#cb150-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># expand the data frame and write to file</span></span>
<span id="cb150-17"><a href="prepare-fmri-data.html#cb150-17" aria-hidden="true" tabindex="-1"></a>  func_dat_df_long <span class="ot">&lt;-</span> <span class="fu">unnest</span>(func_dat_df, <span class="at">cols =</span> <span class="fu">c</span>(rois, out_dir, roi_dirs))</span>
<span id="cb150-18"><a href="prepare-fmri-data.html#cb150-18" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;clean_roi_timeseries&quot;</span>),</span>
<span id="cb150-19"><a href="prepare-fmri-data.html#cb150-19" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;htc_config_clean_time_series.txt&quot;</span>)</span>
<span id="cb150-20"><a href="prepare-fmri-data.html#cb150-20" aria-hidden="true" tabindex="-1"></a>  fn_def <span class="ot">&lt;-</span> <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&#39;&quot;fn &lt;- &quot;%s&quot;&#39;</span>,fn))</span>
<span id="cb150-21"><a href="prepare-fmri-data.html#cb150-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(func_dat_df_long, fn,</span>
<span id="cb150-22"><a href="prepare-fmri-data.html#cb150-22" aria-hidden="true" tabindex="-1"></a>              <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb150-23"><a href="prepare-fmri-data.html#cb150-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-24"><a href="prepare-fmri-data.html#cb150-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># store the function definition as text</span></span>
<span id="cb150-25"><a href="prepare-fmri-data.html#cb150-25" aria-hidden="true" tabindex="-1"></a>  func_def <span class="ot">&lt;-</span> <span class="fu">capture.output</span>(run_motion_glm)</span>
<span id="cb150-26"><a href="prepare-fmri-data.html#cb150-26" aria-hidden="true" tabindex="-1"></a>  func_def[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;run_motion_glm &lt;- &quot;</span>,func_def[<span class="dv">1</span>])</span>
<span id="cb150-27"><a href="prepare-fmri-data.html#cb150-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">#func_def &lt;- func_def[-length(func_def)]</span></span>
<span id="cb150-28"><a href="prepare-fmri-data.html#cb150-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-29"><a href="prepare-fmri-data.html#cb150-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">#write the Rscript that we want to run</span></span>
<span id="cb150-30"><a href="prepare-fmri-data.html#cb150-30" aria-hidden="true" tabindex="-1"></a>  rscript_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;clean_roi_timeseries&quot;</span>, <span class="st">&quot;run_clean_timeseries.R&quot;</span>)</span>
<span id="cb150-31"><a href="prepare-fmri-data.html#cb150-31" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">file</span>(rscript_fn)</span>
<span id="cb150-32"><a href="prepare-fmri-data.html#cb150-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">open</span>(con, <span class="st">&quot;w&quot;</span>)</span>
<span id="cb150-33"><a href="prepare-fmri-data.html#cb150-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(<span class="fu">c</span>(</span>
<span id="cb150-34"><a href="prepare-fmri-data.html#cb150-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st"># handle input&quot;</span>,</span>
<span id="cb150-35"><a href="prepare-fmri-data.html#cb150-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;args = commandArgs()&quot;</span>,</span>
<span id="cb150-36"><a href="prepare-fmri-data.html#cb150-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;i &lt;- as.numeric(args[length(args)])&quot;</span>,</span>
<span id="cb150-37"><a href="prepare-fmri-data.html#cb150-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st">#load required packages&quot;</span>,</span>
<span id="cb150-38"><a href="prepare-fmri-data.html#cb150-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">noquote</span>(<span class="fu">sprintf</span>(<span class="st">&#39;lib_dir &lt;- &quot;%s&quot;&#39;</span>,<span class="st">&quot;/data/pt_02261/virtem/virtem_code/R3.6.1/library/Linux&quot;</span>)),</span>
<span id="cb150-39"><a href="prepare-fmri-data.html#cb150-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;.libPaths(c(lib_dir,.libPaths()))&#39;</span>,</span>
<span id="cb150-40"><a href="prepare-fmri-data.html#cb150-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;lapply(c(&quot;oro.nifti&quot;, &quot;assertthat&quot;, &quot;dplyr&quot;, &quot;neurobase&quot;), library, character.only = TRUE)&#39;</span>,</span>
<span id="cb150-41"><a href="prepare-fmri-data.html#cb150-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st"># read the data and transform ROI column back to list&quot;</span>,</span>
<span id="cb150-42"><a href="prepare-fmri-data.html#cb150-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">noquote</span>(<span class="fu">sprintf</span>(<span class="st">&#39;fn &lt;- &quot;%s&quot;&#39;</span>,fn)),</span>
<span id="cb150-43"><a href="prepare-fmri-data.html#cb150-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;func_dat_df &lt;- read.table(fn, sep = &quot;,&quot;, header = TRUE, stringsAsFactors = FALSE)&#39;</span>,</span>
<span id="cb150-44"><a href="prepare-fmri-data.html#cb150-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st">#define the function to run motion GLM&quot;</span>,</span>
<span id="cb150-45"><a href="prepare-fmri-data.html#cb150-45" aria-hidden="true" tabindex="-1"></a>    func_def,</span>
<span id="cb150-46"><a href="prepare-fmri-data.html#cb150-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st"># run the function on one line of the data frame&quot;</span>,</span>
<span id="cb150-47"><a href="prepare-fmri-data.html#cb150-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;run_motion_glm(df = func_dat_df[i,])&quot;</span>),con)</span>
<span id="cb150-48"><a href="prepare-fmri-data.html#cb150-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(con)</span>
<span id="cb150-49"><a href="prepare-fmri-data.html#cb150-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-50"><a href="prepare-fmri-data.html#cb150-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># folder for condor output</span></span>
<span id="cb150-51"><a href="prepare-fmri-data.html#cb150-51" aria-hidden="true" tabindex="-1"></a>  htc_dir <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;htc_logs&quot;</span>, <span class="st">&quot;clean_timeseries&quot;</span>)</span>
<span id="cb150-52"><a href="prepare-fmri-data.html#cb150-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(htc_dir)){<span class="fu">dir.create</span>(htc_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb150-53"><a href="prepare-fmri-data.html#cb150-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-54"><a href="prepare-fmri-data.html#cb150-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write the submit script</span></span>
<span id="cb150-55"><a href="prepare-fmri-data.html#cb150-55" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;clean_roi_timeseries&quot;</span>, <span class="st">&quot;run_clean_timeseries.submit&quot;</span>)</span>
<span id="cb150-56"><a href="prepare-fmri-data.html#cb150-56" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">file</span>(fn)</span>
<span id="cb150-57"><a href="prepare-fmri-data.html#cb150-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">open</span>(con, <span class="st">&quot;w&quot;</span>)</span>
<span id="cb150-58"><a href="prepare-fmri-data.html#cb150-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(<span class="fu">c</span>(</span>
<span id="cb150-59"><a href="prepare-fmri-data.html#cb150-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;universe = vanilla&quot;</span>,</span>
<span id="cb150-60"><a href="prepare-fmri-data.html#cb150-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;executable = /afs/cbs.mpg.de/software/scripts/envwrap&quot;</span>,</span>
<span id="cb150-61"><a href="prepare-fmri-data.html#cb150-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;request_memory = 9000&quot;</span>,</span>
<span id="cb150-62"><a href="prepare-fmri-data.html#cb150-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;notification = error&quot;</span></span>
<span id="cb150-63"><a href="prepare-fmri-data.html#cb150-63" aria-hidden="true" tabindex="-1"></a>    ),con)</span>
<span id="cb150-64"><a href="prepare-fmri-data.html#cb150-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-65"><a href="prepare-fmri-data.html#cb150-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(func_dat_df_long)){</span>
<span id="cb150-66"><a href="prepare-fmri-data.html#cb150-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">writeLines</span>(<span class="fu">c</span>(</span>
<span id="cb150-67"><a href="prepare-fmri-data.html#cb150-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">arguments = R+ --version 3.6.1 Rscript %s %d&quot;</span>, rscript_fn, i),</span>
<span id="cb150-68"><a href="prepare-fmri-data.html#cb150-68" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;log = %s/%d.log&quot;</span>, htc_dir, i),</span>
<span id="cb150-69"><a href="prepare-fmri-data.html#cb150-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;output = %s/%d.out&quot;</span>, htc_dir, i),</span>
<span id="cb150-70"><a href="prepare-fmri-data.html#cb150-70" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;error = %s/%d.err&quot;</span>, htc_dir, i),</span>
<span id="cb150-71"><a href="prepare-fmri-data.html#cb150-71" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;Queue</span><span class="sc">\n</span><span class="st">&quot;</span>)),con)</span>
<span id="cb150-72"><a href="prepare-fmri-data.html#cb150-72" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb150-73"><a href="prepare-fmri-data.html#cb150-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(con)</span>
<span id="cb150-74"><a href="prepare-fmri-data.html#cb150-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-75"><a href="prepare-fmri-data.html#cb150-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># submit to condor</span></span>
<span id="cb150-76"><a href="prepare-fmri-data.html#cb150-76" aria-hidden="true" tabindex="-1"></a>  <span class="co">#system(&quot;reset-memory-max&quot;)</span></span>
<span id="cb150-77"><a href="prepare-fmri-data.html#cb150-77" aria-hidden="true" tabindex="-1"></a>  batch_id <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="fu">paste</span>(<span class="st">&quot;condor_submit&quot;</span>, fn), <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb150-78"><a href="prepare-fmri-data.html#cb150-78" aria-hidden="true" tabindex="-1"></a>  batch_id <span class="ot">&lt;-</span> <span class="fu">regmatches</span>(batch_id[<span class="dv">2</span>], <span class="fu">gregexpr</span>(<span class="st">&quot;[[:digit:]]+&quot;</span>, batch_id[<span class="dv">2</span>]))[[<span class="dv">1</span>]][<span class="dv">2</span>]</span>
<span id="cb150-79"><a href="prepare-fmri-data.html#cb150-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">#system(&quot;reset-memory-max&quot;)</span></span>
<span id="cb150-80"><a href="prepare-fmri-data.html#cb150-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-81"><a href="prepare-fmri-data.html#cb150-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sprintf</span>(<span class="st">&quot;submitted jobs (ID = %s) to clean time series in ROIs. Time to wait...&quot;</span>, batch_id)</span>
<span id="cb150-82"><a href="prepare-fmri-data.html#cb150-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pause_until_batch_done</span>(<span class="at">batch_id =</span> batch_id, <span class="at">wait_interval =</span> <span class="dv">300</span>)</span>
<span id="cb150-83"><a href="prepare-fmri-data.html#cb150-83" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="extract-relevant-volumes" class="section level4 unnumbered">
<h4>Extract relevant volumes</h4>
<p>As the presentation of images in the PVT pre and post blocks was locked to the onset of a new volume (see above), the second volume after image onset was selected for every trial (effectively covering the time between 2270-4540 ms after stimulus onset).</p>
<p>In this step, we split the presentation logfile from the picture viewing task into the 10 blocks. We reference the volume count to the first volume of each block and extract the relevant volumes from the cleaned ROI timeseries data, accounting for the temporal offset. This is done for each ROI and each block separately in both the pre and post runs. The data are written to file. These output files include the multi-voxel patterns (rows) for each image (columns) that was presented during the picture viewing tasks, including the catch images. The columns are sorted based on the presentation order during the picture viewing task.</p>
<blockquote>
<p>As the presentation of images in the picture viewing tasks was locked to the onset of a new volume (see above), the second volume after image onset was selected for every trial, effectively covering the time between 2270 and 4540 ms after stimulus onset.</p>
</blockquote>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="prepare-fmri-data.html#cb151-1" aria-hidden="true" tabindex="-1"></a>offset_tr <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb151-2"><a href="prepare-fmri-data.html#cb151-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-3"><a href="prepare-fmri-data.html#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb151-4"><a href="prepare-fmri-data.html#cb151-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_run <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_runs){</span>
<span id="cb151-5"><a href="prepare-fmri-data.html#cb151-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-6"><a href="prepare-fmri-data.html#cb151-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load the logfile for this run (pre or post)</span></span>
<span id="cb151-7"><a href="prepare-fmri-data.html#cb151-7" aria-hidden="true" tabindex="-1"></a>    log_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>pvt_log_dir, <span class="fu">sprintf</span>(<span class="st">&#39;P%s_%svirtem.txt&#39;</span>, i_sub, runs[i_run]))</span>
<span id="cb151-8"><a href="prepare-fmri-data.html#cb151-8" aria-hidden="true" tabindex="-1"></a>    log <span class="ot">&lt;-</span> <span class="fu">read.table</span>(log_fn)</span>
<span id="cb151-9"><a href="prepare-fmri-data.html#cb151-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(log) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;pic&quot;</span>, <span class="st">&quot;fix_start&quot;</span>, <span class="st">&quot;pic_start&quot;</span>, <span class="st">&quot;volume&quot;</span>, <span class="st">&quot;response&quot;</span>, <span class="st">&quot;RT&quot;</span>, <span class="st">&quot;trial_end&quot;</span>)</span>
<span id="cb151-10"><a href="prepare-fmri-data.html#cb151-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-11"><a href="prepare-fmri-data.html#cb151-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># split the log file into the 10 blocks</span></span>
<span id="cb151-12"><a href="prepare-fmri-data.html#cb151-12" aria-hidden="true" tabindex="-1"></a>    log_split <span class="ot">&lt;-</span> <span class="fu">split</span>(log, <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">each =</span> <span class="dv">21</span>))</span>
<span id="cb151-13"><a href="prepare-fmri-data.html#cb151-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-14"><a href="prepare-fmri-data.html#cb151-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># reference volume numbers to the first volume of that block</span></span>
<span id="cb151-15"><a href="prepare-fmri-data.html#cb151-15" aria-hidden="true" tabindex="-1"></a>    vol_block <span class="ot">&lt;-</span> <span class="fu">lapply</span>(log_split, <span class="cf">function</span>(x){x<span class="sc">$</span>volume <span class="sc">-</span> x<span class="sc">$</span>volume[<span class="dv">1</span>]})</span>
<span id="cb151-16"><a href="prepare-fmri-data.html#cb151-16" aria-hidden="true" tabindex="-1"></a>    log_split <span class="ot">&lt;-</span> <span class="fu">mapply</span>(cbind, log_split, <span class="st">&quot;vol_block&quot;</span><span class="ot">=</span>vol_block, <span class="at">SIMPLIFY=</span><span class="cn">FALSE</span>)</span>
<span id="cb151-17"><a href="prepare-fmri-data.html#cb151-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-18"><a href="prepare-fmri-data.html#cb151-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_roi <span class="cf">in</span> rois){</span>
<span id="cb151-19"><a href="prepare-fmri-data.html#cb151-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i_block <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb151-20"><a href="prepare-fmri-data.html#cb151-20" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb151-21"><a href="prepare-fmri-data.html#cb151-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># load the ROI timeseries</span></span>
<span id="cb151-22"><a href="prepare-fmri-data.html#cb151-22" aria-hidden="true" tabindex="-1"></a>        fn <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;%s_run%02d_block%02d_%s_clean_timeseries.txt&quot;</span>,</span>
<span id="cb151-23"><a href="prepare-fmri-data.html#cb151-23" aria-hidden="true" tabindex="-1"></a>                      i_sub, i_run, i_block, i_roi)</span>
<span id="cb151-24"><a href="prepare-fmri-data.html#cb151-24" aria-hidden="true" tabindex="-1"></a>        dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_dir, <span class="st">&quot;clean_roi_timeseries&quot;</span>, i_roi, i_sub)</span>
<span id="cb151-25"><a href="prepare-fmri-data.html#cb151-25" aria-hidden="true" tabindex="-1"></a>        roi_dat <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">file.path</span>(dir, fn), <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>)</span>
<span id="cb151-26"><a href="prepare-fmri-data.html#cb151-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb151-27"><a href="prepare-fmri-data.html#cb151-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># index of relevant volumes when accounting for offset</span></span>
<span id="cb151-28"><a href="prepare-fmri-data.html#cb151-28" aria-hidden="true" tabindex="-1"></a>        rel_vols <span class="ot">&lt;-</span> log_split[[i_block]]<span class="sc">$</span>vol_block <span class="sc">+</span> offset_tr</span>
<span id="cb151-29"><a href="prepare-fmri-data.html#cb151-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb151-30"><a href="prepare-fmri-data.html#cb151-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># extract the relevant volumes from the ROI timeseries data</span></span>
<span id="cb151-31"><a href="prepare-fmri-data.html#cb151-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(i_block <span class="sc">==</span> <span class="dv">1</span>){rel_dat <span class="ot">&lt;-</span> roi_dat[,rel_vols]} <span class="cf">else</span>{ </span>
<span id="cb151-32"><a href="prepare-fmri-data.html#cb151-32" aria-hidden="true" tabindex="-1"></a>          rel_dat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(rel_dat, roi_dat[,rel_vols])}</span>
<span id="cb151-33"><a href="prepare-fmri-data.html#cb151-33" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb151-34"><a href="prepare-fmri-data.html#cb151-34" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb151-35"><a href="prepare-fmri-data.html#cb151-35" aria-hidden="true" tabindex="-1"></a>      <span class="co"># save the relevant data</span></span>
<span id="cb151-36"><a href="prepare-fmri-data.html#cb151-36" aria-hidden="true" tabindex="-1"></a>      out_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_dir, <span class="st">&quot;relevant_roi_volumes&quot;</span>, i_roi)</span>
<span id="cb151-37"><a href="prepare-fmri-data.html#cb151-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)){<span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb151-38"><a href="prepare-fmri-data.html#cb151-38" aria-hidden="true" tabindex="-1"></a>      fn <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_%s_relevant_volumes.txt&quot;</span>, i_sub, i_roi, runs[i_run])</span>
<span id="cb151-39"><a href="prepare-fmri-data.html#cb151-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.table</span>(rel_dat, <span class="fu">file.path</span>(out_dir, fn), <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb151-40"><a href="prepare-fmri-data.html#cb151-40" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb151-41"><a href="prepare-fmri-data.html#cb151-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb151-42"><a href="prepare-fmri-data.html#cb151-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-43"><a href="prepare-fmri-data.html#cb151-43" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>

</div>
</div>
<div id="calculate-correlation-matrices" class="section level3 unnumbered">
<h3>Calculate correlation matrices</h3>
<blockquote>
<p>Only data for the 20 event images that were shown in the learning task were analyzed; data for the target stimulus were discarded. The similarity between the multi-voxel activity pattern for every event image in every mini-block with the pattern of every other event in every other mini-block was quantified using Pearson correlation coefficients. Thus, comparisons of scenes from the same mini-block were excluded. Next, we calculated mean, Fisher z-transformed correlation coefficients for every pair of events, yielding separate matrices of pattern similarity estimates for the pre- and the post-learning picture viewing tasks (Figure 3).</p>
</blockquote>
<p>Next, we need to calculate pair-wise correlations between the multi-voxel patterns from the picture viewing tasks. We will restrict the analysis to the 20 scenes during the learning task and discard the data for the target scene. The correlation matrix will first be calculated for trial-by-trial comparisons of multi-voxel patterns. These will then be averaged excluding comparisons of patterns from the same block. The resulting correlation matrices that are saved are ordered according to picture identity (i.e. picture 1-20 x picture 1-20).</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="prepare-fmri-data.html#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for all 10x10 comparisons we will be averaging all comparisons apart from the diagonal</span></span>
<span id="cb152-2"><a href="prepare-fmri-data.html#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to exclude same_block comparisons</span></span>
<span id="cb152-3"><a href="prepare-fmri-data.html#cb152-3" aria-hidden="true" tabindex="-1"></a>no_diag <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="cn">TRUE</span>, <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol =</span> <span class="dv">10</span>)</span>
<span id="cb152-4"><a href="prepare-fmri-data.html#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(no_diag)<span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb152-5"><a href="prepare-fmri-data.html#cb152-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-6"><a href="prepare-fmri-data.html#cb152-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb152-7"><a href="prepare-fmri-data.html#cb152-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_run <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_runs){</span>
<span id="cb152-8"><a href="prepare-fmri-data.html#cb152-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-9"><a href="prepare-fmri-data.html#cb152-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rois)){</span>
<span id="cb152-10"><a href="prepare-fmri-data.html#cb152-10" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-11"><a href="prepare-fmri-data.html#cb152-11" aria-hidden="true" tabindex="-1"></a>      <span class="co"># load the logfile for this run (pre or post) (Note to self: moved here 6 March when hunting ghosts)</span></span>
<span id="cb152-12"><a href="prepare-fmri-data.html#cb152-12" aria-hidden="true" tabindex="-1"></a>      log_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>pvt_log_dir, <span class="fu">sprintf</span>(<span class="st">&#39;P%s_%svirtem.txt&#39;</span>, i_sub, runs[i_run]))</span>
<span id="cb152-13"><a href="prepare-fmri-data.html#cb152-13" aria-hidden="true" tabindex="-1"></a>      log <span class="ot">&lt;-</span> <span class="fu">read.table</span>(log_fn)</span>
<span id="cb152-14"><a href="prepare-fmri-data.html#cb152-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">colnames</span>(log) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;pic&quot;</span>, <span class="st">&quot;fix_start&quot;</span>, <span class="st">&quot;pic_start&quot;</span>, <span class="st">&quot;volume&quot;</span>, <span class="st">&quot;response&quot;</span>, <span class="st">&quot;RT&quot;</span>, <span class="st">&quot;trial_end&quot;</span>)</span>
<span id="cb152-15"><a href="prepare-fmri-data.html#cb152-15" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-16"><a href="prepare-fmri-data.html#cb152-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># load the relevant MRI volumes (i.e. multi-voxel patterns)</span></span>
<span id="cb152-17"><a href="prepare-fmri-data.html#cb152-17" aria-hidden="true" tabindex="-1"></a>      fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_roi_rel_vol_dirs[i_roi], </span>
<span id="cb152-18"><a href="prepare-fmri-data.html#cb152-18" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_%s_relevant_volumes.txt&quot;</span>, i_sub, rois[i_roi], runs[i_run]))</span>
<span id="cb152-19"><a href="prepare-fmri-data.html#cb152-19" aria-hidden="true" tabindex="-1"></a>      rel_dat <span class="ot">&lt;-</span> <span class="fu">read.table</span>(fn, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>)</span>
<span id="cb152-20"><a href="prepare-fmri-data.html#cb152-20" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-21"><a href="prepare-fmri-data.html#cb152-21" aria-hidden="true" tabindex="-1"></a>      <span class="co"># remove patterns &amp; log entries corresponding to the target picture (catch trials)</span></span>
<span id="cb152-22"><a href="prepare-fmri-data.html#cb152-22" aria-hidden="true" tabindex="-1"></a>      rel_dat <span class="ot">&lt;-</span> rel_dat[, log<span class="sc">$</span>pic <span class="sc">!=</span> <span class="dv">21</span>]</span>
<span id="cb152-23"><a href="prepare-fmri-data.html#cb152-23" aria-hidden="true" tabindex="-1"></a>      log <span class="ot">&lt;-</span> log[log<span class="sc">$</span>pic <span class="sc">!=</span> <span class="dv">21</span>,]</span>
<span id="cb152-24"><a href="prepare-fmri-data.html#cb152-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-25"><a href="prepare-fmri-data.html#cb152-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># order the data according to picture identity</span></span>
<span id="cb152-26"><a href="prepare-fmri-data.html#cb152-26" aria-hidden="true" tabindex="-1"></a>      rel_dat <span class="ot">&lt;-</span> rel_dat[,<span class="fu">order</span>(log<span class="sc">$</span>pic)]</span>
<span id="cb152-27"><a href="prepare-fmri-data.html#cb152-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">colnames</span>(rel_dat) <span class="ot">&lt;-</span> log<span class="sc">$</span>pic[<span class="fu">order</span>(log<span class="sc">$</span>pic)]</span>
<span id="cb152-28"><a href="prepare-fmri-data.html#cb152-28" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-29"><a href="prepare-fmri-data.html#cb152-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># write to file for diagnostic purposes</span></span>
<span id="cb152-30"><a href="prepare-fmri-data.html#cb152-30" aria-hidden="true" tabindex="-1"></a>      fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_roi_rel_vol_dirs[i_roi], </span>
<span id="cb152-31"><a href="prepare-fmri-data.html#cb152-31" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_%s_relevant_volumes_ordered.txt&quot;</span>, i_sub, rois[i_roi], runs[i_run]))</span>
<span id="cb152-32"><a href="prepare-fmri-data.html#cb152-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.table</span>(rel_dat, fn, <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb152-33"><a href="prepare-fmri-data.html#cb152-33" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb152-34"><a href="prepare-fmri-data.html#cb152-34" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-35"><a href="prepare-fmri-data.html#cb152-35" aria-hidden="true" tabindex="-1"></a>      <span class="co"># calculate the correlation matrix (trial by trial correlations at this point)</span></span>
<span id="cb152-36"><a href="prepare-fmri-data.html#cb152-36" aria-hidden="true" tabindex="-1"></a>      corr_mat_trial <span class="ot">&lt;-</span> <span class="fu">cor</span>(rel_dat)</span>
<span id="cb152-37"><a href="prepare-fmri-data.html#cb152-37" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-38"><a href="prepare-fmri-data.html#cb152-38" aria-hidden="true" tabindex="-1"></a>      <span class="co"># save the correlation matrix</span></span>
<span id="cb152-39"><a href="prepare-fmri-data.html#cb152-39" aria-hidden="true" tabindex="-1"></a>      fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_roi_corr_mat_dirs[i_roi], </span>
<span id="cb152-40"><a href="prepare-fmri-data.html#cb152-40" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_%s_corr_mat_trial.txt&quot;</span>, i_sub, rois[i_roi], runs[i_run]))</span>
<span id="cb152-41"><a href="prepare-fmri-data.html#cb152-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.table</span>(corr_mat_trial, fn, <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb152-42"><a href="prepare-fmri-data.html#cb152-42" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb152-43"><a href="prepare-fmri-data.html#cb152-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-44"><a href="prepare-fmri-data.html#cb152-44" aria-hidden="true" tabindex="-1"></a>      <span class="co"># initialize correlation matrix condition by condition</span></span>
<span id="cb152-45"><a href="prepare-fmri-data.html#cb152-45" aria-hidden="true" tabindex="-1"></a>      corr_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="dv">20</span>, <span class="at">ncol =</span> <span class="dv">20</span>, <span class="at">dimnames =</span> <span class="fu">c</span>(<span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>), <span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)))</span>
<span id="cb152-46"><a href="prepare-fmri-data.html#cb152-46" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-47"><a href="prepare-fmri-data.html#cb152-47" aria-hidden="true" tabindex="-1"></a>      <span class="co"># loop over all picture comparisons</span></span>
<span id="cb152-48"><a href="prepare-fmri-data.html#cb152-48" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i_pic1 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>){</span>
<span id="cb152-49"><a href="prepare-fmri-data.html#cb152-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(i_pic2 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>){</span>
<span id="cb152-50"><a href="prepare-fmri-data.html#cb152-50" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb152-51"><a href="prepare-fmri-data.html#cb152-51" aria-hidden="true" tabindex="-1"></a>          <span class="co"># extract the current 10x10 correlation matrix</span></span>
<span id="cb152-52"><a href="prepare-fmri-data.html#cb152-52" aria-hidden="true" tabindex="-1"></a>          i1 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">+</span>(i_pic1<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">10</span>)<span class="sc">:</span>(i_pic1<span class="sc">*</span><span class="dv">10</span>)</span>
<span id="cb152-53"><a href="prepare-fmri-data.html#cb152-53" aria-hidden="true" tabindex="-1"></a>          i2 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">+</span>(i_pic2<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">10</span>)<span class="sc">:</span>(i_pic2<span class="sc">*</span><span class="dv">10</span>)</span>
<span id="cb152-54"><a href="prepare-fmri-data.html#cb152-54" aria-hidden="true" tabindex="-1"></a>          curr_mat <span class="ot">&lt;-</span> corr_mat_trial[i1, i2]</span>
<span id="cb152-55"><a href="prepare-fmri-data.html#cb152-55" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb152-56"><a href="prepare-fmri-data.html#cb152-56" aria-hidden="true" tabindex="-1"></a>          <span class="co"># average the corrlations while excluding diagonal (same block comparisons)</span></span>
<span id="cb152-57"><a href="prepare-fmri-data.html#cb152-57" aria-hidden="true" tabindex="-1"></a>          corr_mat[i_pic1, i_pic2] <span class="ot">&lt;-</span> <span class="fu">mean</span>(curr_mat[no_diag])</span>
<span id="cb152-58"><a href="prepare-fmri-data.html#cb152-58" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb152-59"><a href="prepare-fmri-data.html#cb152-59" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb152-60"><a href="prepare-fmri-data.html#cb152-60" aria-hidden="true" tabindex="-1"></a>      <span class="co"># diagnostic plot</span></span>
<span id="cb152-61"><a href="prepare-fmri-data.html#cb152-61" aria-hidden="true" tabindex="-1"></a>      <span class="co">#corrplot(corr_mat, method = &quot;color&quot;, is.corr=FALSE,</span></span>
<span id="cb152-62"><a href="prepare-fmri-data.html#cb152-62" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   cl.lim = c(min(corr_mat),max(corr_mat)), addgrid.col = NA)</span></span>
<span id="cb152-63"><a href="prepare-fmri-data.html#cb152-63" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-64"><a href="prepare-fmri-data.html#cb152-64" aria-hidden="true" tabindex="-1"></a>      <span class="co"># save the correlation matrix</span></span>
<span id="cb152-65"><a href="prepare-fmri-data.html#cb152-65" aria-hidden="true" tabindex="-1"></a>      fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_roi_corr_mat_dirs[i_roi], </span>
<span id="cb152-66"><a href="prepare-fmri-data.html#cb152-66" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_%s_corr_mat.txt&quot;</span>, i_sub, rois[i_roi], runs[i_run]))</span>
<span id="cb152-67"><a href="prepare-fmri-data.html#cb152-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.table</span>(corr_mat, fn, <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb152-68"><a href="prepare-fmri-data.html#cb152-68" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb152-69"><a href="prepare-fmri-data.html#cb152-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb152-70"><a href="prepare-fmri-data.html#cb152-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb152-71"><a href="prepare-fmri-data.html#cb152-71" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>

</div>
<div id="calculate-pattern-similarity-change" class="section level3 unnumbered">
<h3>Calculate Pattern Similarity Change</h3>
<p>In the next step, we calculate how the correlation between patterns change from the first to the second picture viewing task, i.e. through the day learning task. To do this, we load both correlation matrices and reduce them to the upper triangle, excluding the diagonal. Then, the correlations are Fisher Z-transformed and the similarity values from the pre-learning picture viewing task are subtracted from those of the post-learning picture viewing task to isolate pattern similarity change. The correlations and their changes are then saved together with information about the pictures that were compared.</p>
<blockquote>
<p>In order to assess changes in representational similarity due to the day learning task, which took place in between the two picture viewing tasks, we quantified pattern similarity changes as the difference of the respective correlation coefficients for every pair of events between the post-learning picture viewing task and its pre-learning baseline equivalent (Figure 3).</p>
</blockquote>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="prepare-fmri-data.html#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i_sub <span class="cf">in</span> subjects){</span>
<span id="cb153-2"><a href="prepare-fmri-data.html#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rois)){</span>
<span id="cb153-3"><a href="prepare-fmri-data.html#cb153-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-4"><a href="prepare-fmri-data.html#cb153-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load pre correlation matrix</span></span>
<span id="cb153-5"><a href="prepare-fmri-data.html#cb153-5" aria-hidden="true" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_roi_corr_mat_dirs[i_roi], </span>
<span id="cb153-6"><a href="prepare-fmri-data.html#cb153-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_pre_corr_mat.txt&quot;</span>, i_sub, rois[i_roi]))</span>
<span id="cb153-7"><a href="prepare-fmri-data.html#cb153-7" aria-hidden="true" tabindex="-1"></a>    corr_mat_pre <span class="ot">&lt;-</span> <span class="fu">read.table</span>(fn, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>)    </span>
<span id="cb153-8"><a href="prepare-fmri-data.html#cb153-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-9"><a href="prepare-fmri-data.html#cb153-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load post correlation matrix</span></span>
<span id="cb153-10"><a href="prepare-fmri-data.html#cb153-10" aria-hidden="true" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_roi_corr_mat_dirs[i_roi], </span>
<span id="cb153-11"><a href="prepare-fmri-data.html#cb153-11" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_post_corr_mat.txt&quot;</span>, i_sub, rois[i_roi]))</span>
<span id="cb153-12"><a href="prepare-fmri-data.html#cb153-12" aria-hidden="true" tabindex="-1"></a>    corr_mat_post <span class="ot">&lt;-</span> <span class="fu">read.table</span>(fn, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>)</span>
<span id="cb153-13"><a href="prepare-fmri-data.html#cb153-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-14"><a href="prepare-fmri-data.html#cb153-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># reduce to upper triangle of correlations (without diagonal)</span></span>
<span id="cb153-15"><a href="prepare-fmri-data.html#cb153-15" aria-hidden="true" tabindex="-1"></a>    pre_corrs <span class="ot">&lt;-</span> corr_mat_pre[<span class="fu">upper.tri</span>(corr_mat_pre, <span class="at">diag =</span> <span class="cn">FALSE</span>)]</span>
<span id="cb153-16"><a href="prepare-fmri-data.html#cb153-16" aria-hidden="true" tabindex="-1"></a>    post_corrs <span class="ot">&lt;-</span> corr_mat_post[<span class="fu">upper.tri</span>(corr_mat_post, <span class="at">diag =</span> <span class="cn">FALSE</span>)]</span>
<span id="cb153-17"><a href="prepare-fmri-data.html#cb153-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-18"><a href="prepare-fmri-data.html#cb153-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create a tibble with the correlations </span></span>
<span id="cb153-19"><a href="prepare-fmri-data.html#cb153-19" aria-hidden="true" tabindex="-1"></a>    pics <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">upper.tri</span>(corr_mat_post), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb153-20"><a href="prepare-fmri-data.html#cb153-20" aria-hidden="true" tabindex="-1"></a>    corr_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">pic1 =</span> pics[,<span class="dv">1</span>], <span class="at">pic2 =</span> pics[,<span class="dv">2</span>], pre_corrs, post_corrs)</span>
<span id="cb153-21"><a href="prepare-fmri-data.html#cb153-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-22"><a href="prepare-fmri-data.html#cb153-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fisher Z transform correlations and calculate pattern similarity change</span></span>
<span id="cb153-23"><a href="prepare-fmri-data.html#cb153-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># by subtracting the pre-correlations from the post-correlations</span></span>
<span id="cb153-24"><a href="prepare-fmri-data.html#cb153-24" aria-hidden="true" tabindex="-1"></a>    corr_df<span class="sc">$</span>ps_change <span class="ot">&lt;-</span> <span class="fu">FisherZ</span>(corr_df<span class="sc">$</span>post_corrs) <span class="sc">-</span> <span class="fu">FisherZ</span>(corr_df<span class="sc">$</span>pre_corrs)</span>
<span id="cb153-25"><a href="prepare-fmri-data.html#cb153-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-26"><a href="prepare-fmri-data.html#cb153-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write to file</span></span>
<span id="cb153-27"><a href="prepare-fmri-data.html#cb153-27" aria-hidden="true" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_roi_ps_change_dirs[i_roi], </span>
<span id="cb153-28"><a href="prepare-fmri-data.html#cb153-28" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_pattern_similarity_change.txt&quot;</span>, i_sub, rois[i_roi]))</span>
<span id="cb153-29"><a href="prepare-fmri-data.html#cb153-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.table</span>(corr_df, fn, <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb153-30"><a href="prepare-fmri-data.html#cb153-30" aria-hidden="true" tabindex="-1"></a>                <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb153-31"><a href="prepare-fmri-data.html#cb153-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb153-32"><a href="prepare-fmri-data.html#cb153-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>

</div>
</div>
<div id="combine-behavioral-and-fmri-data-for-rsa" class="section level2" number="6.4">
<h2><span class="header-section-number">6.4</span> Combine behavioral and fMRI data for RSA</h2>
<p>To create input for the RSA the next step is to combine the similarity change data with the behavioral data, so that we can do meaningful analyses. First the behavioral data is loaded and brought into the same pair-wise format as the similarity change data. Both datasets are combined for each subject and then written to disk.</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="prepare-fmri-data.html#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb154-2"><a href="prepare-fmri-data.html#cb154-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-3"><a href="prepare-fmri-data.html#cb154-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the behavioral data</span></span>
<span id="cb154-4"><a href="prepare-fmri-data.html#cb154-4" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>timeline_dat_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_behavior_tbl_timeline.txt&quot;</span>, i_sub))</span>
<span id="cb154-5"><a href="prepare-fmri-data.html#cb154-5" aria-hidden="true" tabindex="-1"></a>  col_types_list <span class="ot">&lt;-</span> <span class="fu">cols_only</span>(<span class="at">sub_id =</span> <span class="fu">col_character</span>(), <span class="at">day =</span> <span class="fu">col_factor</span>(), </span>
<span id="cb154-6"><a href="prepare-fmri-data.html#cb154-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">event =</span> <span class="fu">col_integer</span>(), <span class="at">pic =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb154-7"><a href="prepare-fmri-data.html#cb154-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">virtual_time =</span> <span class="fu">col_double</span>(), <span class="at">real_time =</span> <span class="fu">col_double</span>(),</span>
<span id="cb154-8"><a href="prepare-fmri-data.html#cb154-8" aria-hidden="true" tabindex="-1"></a>                              <span class="at">memory_time =</span> <span class="fu">col_double</span>(), <span class="at">memory_order =</span> <span class="fu">col_double</span>(), </span>
<span id="cb154-9"><a href="prepare-fmri-data.html#cb154-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sorted_day =</span> <span class="fu">col_integer</span>())</span>
<span id="cb154-10"><a href="prepare-fmri-data.html#cb154-10" aria-hidden="true" tabindex="-1"></a>  beh_dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fn, <span class="at">col_types =</span> col_types_list)</span>
<span id="cb154-11"><a href="prepare-fmri-data.html#cb154-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-12"><a href="prepare-fmri-data.html#cb154-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sort behavioral data according to picture identity</span></span>
<span id="cb154-13"><a href="prepare-fmri-data.html#cb154-13" aria-hidden="true" tabindex="-1"></a>  beh_dat_ordered <span class="ot">&lt;-</span> beh_dat[<span class="fu">order</span>(beh_dat<span class="sc">$</span>pic),]</span>
<span id="cb154-14"><a href="prepare-fmri-data.html#cb154-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-15"><a href="prepare-fmri-data.html#cb154-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># find the order of comparisons</span></span>
<span id="cb154-16"><a href="prepare-fmri-data.html#cb154-16" aria-hidden="true" tabindex="-1"></a>  pairs <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">upper.tri</span>(<span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="dv">20</span>, <span class="at">ncol =</span> <span class="dv">20</span>)), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb154-17"><a href="prepare-fmri-data.html#cb154-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-18"><a href="prepare-fmri-data.html#cb154-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract the data for the first and second picture in each pair from the behavioral data</span></span>
<span id="cb154-19"><a href="prepare-fmri-data.html#cb154-19" aria-hidden="true" tabindex="-1"></a>  pic1_dat <span class="ot">&lt;-</span> beh_dat_ordered[pairs[,<span class="dv">1</span>],]</span>
<span id="cb154-20"><a href="prepare-fmri-data.html#cb154-20" aria-hidden="true" tabindex="-1"></a>  pic2_dat <span class="ot">&lt;-</span> beh_dat_ordered[pairs[,<span class="dv">2</span>],]</span>
<span id="cb154-21"><a href="prepare-fmri-data.html#cb154-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(pic1_dat) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">colnames</span>(pic1_dat), <span class="st">&quot;1&quot;</span>)</span>
<span id="cb154-22"><a href="prepare-fmri-data.html#cb154-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(pic2_dat) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">colnames</span>(pic2_dat), <span class="st">&quot;2&quot;</span>)</span>
<span id="cb154-23"><a href="prepare-fmri-data.html#cb154-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-24"><a href="prepare-fmri-data.html#cb154-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine the two tibbles</span></span>
<span id="cb154-25"><a href="prepare-fmri-data.html#cb154-25" aria-hidden="true" tabindex="-1"></a>  pair_dat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(pic1_dat, pic2_dat)</span>
<span id="cb154-26"><a href="prepare-fmri-data.html#cb154-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-27"><a href="prepare-fmri-data.html#cb154-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reorder the tibble columns to make a bit more sense</span></span>
<span id="cb154-28"><a href="prepare-fmri-data.html#cb154-28" aria-hidden="true" tabindex="-1"></a>  pair_dat <span class="ot">&lt;-</span> pair_dat <span class="sc">%&gt;%</span></span>
<span id="cb154-29"><a href="prepare-fmri-data.html#cb154-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sub_id1,</span>
<span id="cb154-30"><a href="prepare-fmri-data.html#cb154-30" aria-hidden="true" tabindex="-1"></a>           day1, day2,</span>
<span id="cb154-31"><a href="prepare-fmri-data.html#cb154-31" aria-hidden="true" tabindex="-1"></a>           pic1, pic2,</span>
<span id="cb154-32"><a href="prepare-fmri-data.html#cb154-32" aria-hidden="true" tabindex="-1"></a>           event1, event2, </span>
<span id="cb154-33"><a href="prepare-fmri-data.html#cb154-33" aria-hidden="true" tabindex="-1"></a>           virtual_time1, virtual_time2, </span>
<span id="cb154-34"><a href="prepare-fmri-data.html#cb154-34" aria-hidden="true" tabindex="-1"></a>           real_time1, real_time2, </span>
<span id="cb154-35"><a href="prepare-fmri-data.html#cb154-35" aria-hidden="true" tabindex="-1"></a>           memory_order1, memory_order2, </span>
<span id="cb154-36"><a href="prepare-fmri-data.html#cb154-36" aria-hidden="true" tabindex="-1"></a>           memory_time1, memory_time2, </span>
<span id="cb154-37"><a href="prepare-fmri-data.html#cb154-37" aria-hidden="true" tabindex="-1"></a>           sorted_day1, sorted_day2) <span class="sc">%&gt;%</span></span>
<span id="cb154-38"><a href="prepare-fmri-data.html#cb154-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">sub_id =</span> sub_id1)</span>
<span id="cb154-39"><a href="prepare-fmri-data.html#cb154-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-40"><a href="prepare-fmri-data.html#cb154-40" aria-hidden="true" tabindex="-1"></a>  rsa_dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb154-41"><a href="prepare-fmri-data.html#cb154-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_roi <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rois)){</span>
<span id="cb154-42"><a href="prepare-fmri-data.html#cb154-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-43"><a href="prepare-fmri-data.html#cb154-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load the pattern similarity change data for this ROI</span></span>
<span id="cb154-44"><a href="prepare-fmri-data.html#cb154-44" aria-hidden="true" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_roi_ps_change_dirs[i_roi], </span>
<span id="cb154-45"><a href="prepare-fmri-data.html#cb154-45" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_pattern_similarity_change.txt&quot;</span>, i_sub, rois[i_roi]))</span>
<span id="cb154-46"><a href="prepare-fmri-data.html#cb154-46" aria-hidden="true" tabindex="-1"></a>    ps_change_dat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(fn)</span>
<span id="cb154-47"><a href="prepare-fmri-data.html#cb154-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-48"><a href="prepare-fmri-data.html#cb154-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make sure files have the same order</span></span>
<span id="cb154-49"><a href="prepare-fmri-data.html#cb154-49" aria-hidden="true" tabindex="-1"></a>    assertthat<span class="sc">::</span><span class="fu">are_equal</span>(<span class="fu">c</span>(pair_dat<span class="sc">$</span>pic1, pair_dat<span class="sc">$</span>pic2), <span class="fu">c</span>(ps_change_dat<span class="sc">$</span>pic1, ps_change_dat<span class="sc">$</span>pic2))</span>
<span id="cb154-50"><a href="prepare-fmri-data.html#cb154-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-51"><a href="prepare-fmri-data.html#cb154-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add column with ROI name</span></span>
<span id="cb154-52"><a href="prepare-fmri-data.html#cb154-52" aria-hidden="true" tabindex="-1"></a>    ps_change_dat <span class="ot">&lt;-</span> <span class="fu">add_column</span>(ps_change_dat, <span class="at">roi =</span> rois[i_roi])</span>
<span id="cb154-53"><a href="prepare-fmri-data.html#cb154-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-54"><a href="prepare-fmri-data.html#cb154-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># collect the data from this ROI and merge into long data frame</span></span>
<span id="cb154-55"><a href="prepare-fmri-data.html#cb154-55" aria-hidden="true" tabindex="-1"></a>    roi_dat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(pair_dat, ps_change_dat[,<span class="dv">3</span><span class="sc">:</span><span class="dv">6</span>])</span>
<span id="cb154-56"><a href="prepare-fmri-data.html#cb154-56" aria-hidden="true" tabindex="-1"></a>    rsa_dat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(rsa_dat, roi_dat)</span>
<span id="cb154-57"><a href="prepare-fmri-data.html#cb154-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb154-58"><a href="prepare-fmri-data.html#cb154-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-59"><a href="prepare-fmri-data.html#cb154-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write to file</span></span>
<span id="cb154-60"><a href="prepare-fmri-data.html#cb154-60" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_dat_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_data_for_rsa.txt&quot;</span>,i_sub))</span>
<span id="cb154-61"><a href="prepare-fmri-data.html#cb154-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(rsa_dat, fn, <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb154-62"><a href="prepare-fmri-data.html#cb154-62" aria-hidden="true" tabindex="-1"></a>              <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb154-63"><a href="prepare-fmri-data.html#cb154-63" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Finally, the datasets are combined across subjects.</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="prepare-fmri-data.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up a dataframe to collect the data</span></span>
<span id="cb155-2"><a href="prepare-fmri-data.html#cb155-2" aria-hidden="true" tabindex="-1"></a>rsa_dat <span class="ot">=</span> <span class="fu">tibble</span>()</span>
<span id="cb155-3"><a href="prepare-fmri-data.html#cb155-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-4"><a href="prepare-fmri-data.html#cb155-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb155-5"><a href="prepare-fmri-data.html#cb155-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-6"><a href="prepare-fmri-data.html#cb155-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load data from CSV</span></span>
<span id="cb155-7"><a href="prepare-fmri-data.html#cb155-7" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_dat_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_data_for_rsa.txt&quot;</span>,i_sub))</span>
<span id="cb155-8"><a href="prepare-fmri-data.html#cb155-8" aria-hidden="true" tabindex="-1"></a>  col_types_list <span class="ot">&lt;-</span> <span class="fu">cols_only</span>(</span>
<span id="cb155-9"><a href="prepare-fmri-data.html#cb155-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">sub_id =</span> <span class="fu">col_character</span>(),</span>
<span id="cb155-10"><a href="prepare-fmri-data.html#cb155-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">day1 =</span> <span class="fu">col_integer</span>(), <span class="at">day2 =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb155-11"><a href="prepare-fmri-data.html#cb155-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">event1 =</span> <span class="fu">col_integer</span>(), <span class="at">event2 =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb155-12"><a href="prepare-fmri-data.html#cb155-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">pic1 =</span> <span class="fu">col_integer</span>(), <span class="at">pic2 =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb155-13"><a href="prepare-fmri-data.html#cb155-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">virtual_time1 =</span> <span class="fu">col_double</span>(), <span class="at">virtual_time2 =</span> <span class="fu">col_double</span>(),</span>
<span id="cb155-14"><a href="prepare-fmri-data.html#cb155-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">real_time1 =</span> <span class="fu">col_double</span>(), <span class="at">real_time2 =</span> <span class="fu">col_double</span>(),</span>
<span id="cb155-15"><a href="prepare-fmri-data.html#cb155-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">memory_time1 =</span> <span class="fu">col_double</span>(), <span class="at">memory_time2 =</span> <span class="fu">col_double</span>(), </span>
<span id="cb155-16"><a href="prepare-fmri-data.html#cb155-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">memory_order1 =</span> <span class="fu">col_double</span>(), <span class="at">memory_order2 =</span> <span class="fu">col_double</span>(), </span>
<span id="cb155-17"><a href="prepare-fmri-data.html#cb155-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">sorted_day1 =</span> <span class="fu">col_integer</span>(), <span class="at">sorted_day2 =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb155-18"><a href="prepare-fmri-data.html#cb155-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">pre_corrs  =</span> <span class="fu">col_double</span>(), <span class="at">post_corrs =</span> <span class="fu">col_double</span>(),</span>
<span id="cb155-19"><a href="prepare-fmri-data.html#cb155-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">ps_change =</span> <span class="fu">col_double</span>(), <span class="at">roi =</span> <span class="fu">col_factor</span>()</span>
<span id="cb155-20"><a href="prepare-fmri-data.html#cb155-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb155-21"><a href="prepare-fmri-data.html#cb155-21" aria-hidden="true" tabindex="-1"></a>  sub_dat <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(<span class="fu">read_csv</span>(fn, <span class="at">col_types =</span> col_types_list))</span>
<span id="cb155-22"><a href="prepare-fmri-data.html#cb155-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-23"><a href="prepare-fmri-data.html#cb155-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append to table with data from all subjects</span></span>
<span id="cb155-24"><a href="prepare-fmri-data.html#cb155-24" aria-hidden="true" tabindex="-1"></a>  rsa_dat <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sub_dat, rsa_dat)</span>
<span id="cb155-25"><a href="prepare-fmri-data.html#cb155-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-26"><a href="prepare-fmri-data.html#cb155-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-27"><a href="prepare-fmri-data.html#cb155-27" aria-hidden="true" tabindex="-1"></a><span class="co"># sort the data</span></span>
<span id="cb155-28"><a href="prepare-fmri-data.html#cb155-28" aria-hidden="true" tabindex="-1"></a>rsa_dat <span class="ot">&lt;-</span> rsa_dat[<span class="fu">with</span>(rsa_dat, <span class="fu">order</span>(sub_id, day1, day2, event1, event2)),]</span>
<span id="cb155-29"><a href="prepare-fmri-data.html#cb155-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-30"><a href="prepare-fmri-data.html#cb155-30" aria-hidden="true" tabindex="-1"></a><span class="co"># write to file</span></span>
<span id="cb155-31"><a href="prepare-fmri-data.html#cb155-31" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;rsa_data_rois.txt&quot;</span>)</span>
<span id="cb155-32"><a href="prepare-fmri-data.html#cb155-32" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(rsa_dat, fn, <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb155-33"><a href="prepare-fmri-data.html#cb155-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">TRUE</span>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="behavioral-analysis.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="run-rsa-searchlight.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
