<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 Run RSA Searchlight | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences</title>
  <meta name="description" content="7 Run RSA Searchlight | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences" />
  <meta name="generator" content="bookdown 0.19 and GitBook 2.6.7" />

  <meta property="og:title" content="7 Run RSA Searchlight | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://jacbel.github.io/virtem_code/" />
  
  <meta property="og:description" content="7 Run RSA Searchlight | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences" />
  <meta name="github-repo" content="jacbel/virtem_code" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 Run RSA Searchlight | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences" />
  
  <meta name="twitter:description" content="7 Run RSA Searchlight | Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences" />
  

<meta name="author" content="Jacob L. S. Bellmund" />


<meta name="date" content="2022-01-31" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="prepare-fmri-data.html"/>
<link rel="next" href="rsa-on-pattern-similarity-change.html"/>
<script src="libs/header-attrs-2.9/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Overview</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#purpose"><i class="fa fa-check"></i><b>1.1</b> Purpose</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#contents"><i class="fa fa-check"></i><b>1.2</b> Contents</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#contact"><i class="fa fa-check"></i><b>1.3</b> Contact</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#license-information"><i class="fa fa-check"></i><b>1.4</b> License Information</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="analysis-setup.html"><a href="analysis-setup.html"><i class="fa fa-check"></i><b>2</b> Analysis Setup</a>
<ul>
<li class="chapter" data-level="2.1" data-path="analysis-setup.html"><a href="analysis-setup.html#defining-variables-and-folders"><i class="fa fa-check"></i><b>2.1</b> Defining Variables and Folders</a>
<ul>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#folder-structure"><i class="fa fa-check"></i>Folder Structure</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="analysis-setup.html"><a href="analysis-setup.html#define-analysis-functions"><i class="fa fa-check"></i><b>2.2</b> Define Analysis Functions</a>
<ul>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#analysis-logic"><i class="fa fa-check"></i>Analysis Logic</a></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#brain-plots-in-ggplot"><i class="fa fa-check"></i>Brain Plots in ggplot</a></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#ggbrain-functions-to-get-template-background"><i class="fa fa-check"></i>ggBrain functions to get template background</a></li>
<li class="chapter" data-level="" data-path="analysis-setup.html"><a href="analysis-setup.html#waiting-for-cluster-jobs"><i class="fa fa-check"></i>Waiting for Cluster Jobs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html"><i class="fa fa-check"></i><b>3</b> Illustrations of Task Design and Analysis Logic</a>
<ul>
<li class="chapter" data-level="3.1" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#day-learning-task-design"><i class="fa fa-check"></i><b>3.1</b> Day Learning Task Design</a>
<ul>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#events-in-virtual-and-real-time"><i class="fa fa-check"></i>Events in virtual and real time</a></li>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#events-in-virtual-time"><i class="fa fa-check"></i>Events in virtual time</a></li>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#events-in-real-time"><i class="fa fa-check"></i>Events in real time</a></li>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#correlations-of-virtual-time-with-order-and-real-time"><i class="fa fa-check"></i>Correlations of virtual time with order and real time</a></li>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#time-cues-in-virtual-and-real-time"><i class="fa fa-check"></i>Time cues in virtual and real time</a></li>
<li class="chapter" data-level="" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#supplemental-figure-for-task-design"><i class="fa fa-check"></i>Supplemental figure for task design</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="illustrations-of-task-design-and-analysis-logic.html"><a href="illustrations-of-task-design-and-analysis-logic.html#representational-similarity-analysis-logic"><i class="fa fa-check"></i><b>3.2</b> Representational Similarity Analysis Logic</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html"><i class="fa fa-check"></i><b>4</b> Prepare behavioral data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html#sorting-task"><i class="fa fa-check"></i><b>4.1</b> Sorting task</a></li>
<li class="chapter" data-level="4.2" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html#timeline-task"><i class="fa fa-check"></i><b>4.2</b> Timeline task</a></li>
<li class="chapter" data-level="4.3" data-path="prepare-behavioral-data.html"><a href="prepare-behavioral-data.html#picture-viewing-tasks"><i class="fa fa-check"></i><b>4.3</b> Picture viewing tasks</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html"><i class="fa fa-check"></i><b>5</b> Behavioral Analysis</a>
<ul>
<li class="chapter" data-level="5.1" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#sorting-task-1"><i class="fa fa-check"></i><b>5.1</b> Sorting Task</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#calculate-percentage-of-correct-responses"><i class="fa fa-check"></i>Calculate percentage of correct responses</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#plot-sorting-performance"><i class="fa fa-check"></i>Plot sorting performance</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#sorting-errors-as-a-function-of-sequence-position"><i class="fa fa-check"></i>Sorting errors as a function of sequence position</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#timeline-task-1"><i class="fa fa-check"></i><b>5.2</b> Timeline Task</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#visualize-the-raw-data"><i class="fa fa-check"></i>Visualize the raw data</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#accuracy-of-remembered-times"><i class="fa fa-check"></i>Accuracy of remembered times</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#relationship-of-sorting-errors-and-timeline-errors"><i class="fa fa-check"></i>Relationship of sorting errors and timeline errors</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#time-metrics-underlying-remembered-times"><i class="fa fa-check"></i>Time metrics underlying remembered times</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#compose-figure-for-behavioral-data"><i class="fa fa-check"></i>Compose Figure for Behavioral Data</a></li>
<li class="chapter" data-level="5.3" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#generalization-bias"><i class="fa fa-check"></i><b>5.3</b> Generalization bias</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#quantify-relative-time-of-other-events"><i class="fa fa-check"></i>Quantify relative time of other events</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#test-generalization-bias"><i class="fa fa-check"></i>Test Generalization Bias</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#replication-of-generalization-bias"><i class="fa fa-check"></i><b>5.4</b> Replication of Generalization Bias</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#replication-data-quantify-relative-time-of-other-events"><i class="fa fa-check"></i>Replication data: Quantify relative time of other events</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#replication-data-test-generalization-bias"><i class="fa fa-check"></i>Replication data: Test Generalization Bias</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#swap-errors"><i class="fa fa-check"></i><b>5.5</b> Swap Errors</a>
<ul>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#descriptives-of-swap-errors"><i class="fa fa-check"></i>Descriptives of swap errors</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#swap-errors-as-a-function-of-sequence-position"><i class="fa fa-check"></i>Swap errors as a function of sequence position</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#swap-error-more-frequent-than-expected-from-chance"><i class="fa fa-check"></i>Swap error: More frequent than expected from chance?</a></li>
<li class="chapter" data-level="" data-path="behavioral-analysis.html"><a href="behavioral-analysis.html#swap-errors-and-generalization-bias"><i class="fa fa-check"></i>Swap errors and generalization bias</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html"><i class="fa fa-check"></i><b>6</b> Prepare (f)MRI Data</a>
<ul>
<li class="chapter" data-level="6.1" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#regions-of-interest"><i class="fa fa-check"></i><b>6.1</b> Regions of Interest</a>
<ul>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#freesurfer-masks"><i class="fa fa-check"></i>FreeSurfer Masks</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#subregion-masks-mni"><i class="fa fa-check"></i>Subregion masks (MNI)</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#final-rois-from-intersection-of-masks"><i class="fa fa-check"></i>Final ROIs from intersection of masks</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#group-level-masks"><i class="fa fa-check"></i><b>6.2</b> Group-Level Masks</a>
<ul>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#probabilistic-rois-for-visualization"><i class="fa fa-check"></i>Probabilistic ROIs for visualization</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#field-of-view-mask-for-visualization"><i class="fa fa-check"></i>Field of view mask for visualization</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#gray-matter-mask"><i class="fa fa-check"></i>Gray matter mask</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#small-volume-correction-mask"><i class="fa fa-check"></i>Small Volume Correction Mask</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#quantify-representational-change"><i class="fa fa-check"></i><b>6.3</b> Quantify Representational Change</a>
<ul>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#get-multi-voxel-patterns-from-rois"><i class="fa fa-check"></i>Get multi-voxel patterns from ROIs</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#calculate-correlation-matrices"><i class="fa fa-check"></i>Calculate correlation matrices</a></li>
<li class="chapter" data-level="" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#calculate-pattern-similarity-change"><i class="fa fa-check"></i>Calculate Pattern Similarity Change</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="prepare-fmri-data.html"><a href="prepare-fmri-data.html#combine-behavioral-and-fmri-data-for-rsa"><i class="fa fa-check"></i><b>6.4</b> Combine behavioral and fMRI data for RSA</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html"><i class="fa fa-check"></i><b>7</b> Run RSA Searchlight</a>
<ul>
<li class="chapter" data-level="7.1" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#prepare-functional-data"><i class="fa fa-check"></i><b>7.1</b> Prepare functional data</a>
<ul>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#data-cleaning-extract-residuals-from-motion-parameter-regression"><i class="fa fa-check"></i>Data cleaning: Extract residuals from motion parameter regression</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#extract-relevant-volumes-1"><i class="fa fa-check"></i>Extract relevant volumes</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#concatenate-relevant-volumes"><i class="fa fa-check"></i>Concatenate relevant volumes</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#first-level-rsa-searchlight"><i class="fa fa-check"></i><b>7.2</b> First-level RSA searchlight</a>
<ul>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#set-analysis-parameters"><i class="fa fa-check"></i>Set analysis parameters</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#prepare-rsa-predictions"><i class="fa fa-check"></i>Prepare RSA-predictions</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#create-lookup-table-for-searchlight"><i class="fa fa-check"></i>Create lookup table for searchlight</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#dataframe-with-input-for-analysis"><i class="fa fa-check"></i>Dataframe with input for analysis</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#searchlight-implementation"><i class="fa fa-check"></i>Searchlight implementation</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#group-level-searchlight-analysis"><i class="fa fa-check"></i><b>7.3</b> Group-level searchlight analysis</a>
<ul>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#move-first-level-images-to-mni-space"><i class="fa fa-check"></i>Move first-level images to MNI space</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#merge-and-smooth-first-level-images"><i class="fa fa-check"></i>Merge and smooth first-level images</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#run-fsl-randomise"><i class="fa fa-check"></i>Run FSL Randomise</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#find-searchlight-clusters-and-atlas-labels"><i class="fa fa-check"></i>Find searchlight clusters and atlas labels</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#create-outlines-of-significant-clusters"><i class="fa fa-check"></i>Create outlines of significant clusters</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#prepare-rsa-in-searchlight-peak"><i class="fa fa-check"></i><b>7.4</b> Prepare RSA in searchlight peak</a>
<ul>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#create-the-roi-mask"><i class="fa fa-check"></i>Create the ROI mask</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#calculating-the-correlation-matrices"><i class="fa fa-check"></i>Calculating the correlation matrices</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#calculate-pattern-similarity-change-1"><i class="fa fa-check"></i>Calculate Pattern Similarity Change</a></li>
<li class="chapter" data-level="" data-path="run-rsa-searchlight.html"><a href="run-rsa-searchlight.html#combine-behavioral-and-fmri-data-for-rsa-1"><i class="fa fa-check"></i>Combine behavioral and fMRI data for RSA</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html"><i class="fa fa-check"></i><b>8</b> RSA on Pattern Similarity Change</a>
<ul>
<li class="chapter" data-level="8.1" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#time-metrics-to-quantify-event-relations"><i class="fa fa-check"></i><b>8.1</b> Time metrics to quantify event relations</a></li>
<li class="chapter" data-level="8.2" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#visualize-regions-of-interests"><i class="fa fa-check"></i><b>8.2</b> Visualize Regions of Interests</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#template-background-image-with-fov"><i class="fa fa-check"></i>Template background image with FOV</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#anterior-hippocampus-roi"><i class="fa fa-check"></i>Anterior hippocampus ROI</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#anterior-lateral-entorhinal-cortex"><i class="fa fa-check"></i>Anterior-lateral entorhinal cortex</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#first-level-rsa"><i class="fa fa-check"></i><b>8.3</b> First-level RSA</a></li>
<li class="chapter" data-level="8.4" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-within-sequence"><i class="fa fa-check"></i><b>8.4</b> aHPC: virtual time within sequence</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#summary-statistics-3"><i class="fa fa-check"></i>Summary statistics</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-2"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#representational-change-visualization"><i class="fa fa-check"></i>Representational Change Visualization</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#not-driven-by-first-last-event-pairs"><i class="fa fa-check"></i>Not driven by first &amp; last event pairs</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-within-sequence-when-including-order-real-time"><i class="fa fa-check"></i><b>8.5</b> aHPC: virtual time within sequence when including order &amp; real time</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#one-model-with-multiple-predictors"><i class="fa fa-check"></i>One model with multiple predictors</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-explains-residuals-of-order-and-real-time"><i class="fa fa-check"></i>Virtual time explains residuals of order and real time</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-across-sequences"><i class="fa fa-check"></i><b>8.6</b> aHPC: virtual time across sequences</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#summary-statistics-7"><i class="fa fa-check"></i>Summary statistics</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-5"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#representational-change-visualization-1"><i class="fa fa-check"></i>Representational Change Visualization</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-across-sequence-when-including-order-real-time"><i class="fa fa-check"></i><b>8.7</b> aHPC: virtual time across sequence when including order &amp; real time</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#summary-statistics-8"><i class="fa fa-check"></i>Summary Statistics</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-6"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
</ul></li>
<li class="chapter" data-level="8.8" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-virtual-time-within-vs.-across-sequences"><i class="fa fa-check"></i><b>8.8</b> aHPC: virtual time within vs. across sequences</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#second-level-analysis"><i class="fa fa-check"></i>Second-level analysis</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-7"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#interaction-of-sequence-membership-and-order"><i class="fa fa-check"></i>Interaction of sequence membership and order</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#interaction-of-sequence-membership-and-real-time"><i class="fa fa-check"></i>Interaction of sequence membership and real time</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#interaction-of-sequence-membership-and-virtual-time-when-including-interactions-with-other-time-metrics"><i class="fa fa-check"></i>Interaction of sequence membership and virtual time when including interactions with other time metrics</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#mds"><i class="fa fa-check"></i>MDS</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#umap"><i class="fa fa-check"></i>UMAP</a></li>
</ul></li>
<li class="chapter" data-level="8.9" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec"><i class="fa fa-check"></i><b>8.9</b> alEC</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec-virtual-time-withinacross-sequences-separately"><i class="fa fa-check"></i>alEC: virtual time within/across sequences separately</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec-virtual-time-within-vs.-across-sequences"><i class="fa fa-check"></i>alEC: virtual time within vs. across sequences</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec-virtual-time-for-all-event-pairs"><i class="fa fa-check"></i>alEC: virtual time for all event pairs</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#alec-virtual-time-for-all-event-pairs-when-including-order-real-time"><i class="fa fa-check"></i>alEC: virtual time for all event pairs when including order &amp; real time</a></li>
</ul></li>
<li class="chapter" data-level="8.10" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#ahpc-vs.-alec"><i class="fa fa-check"></i><b>8.10</b> aHPC vs. alEC</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#summary-statistics-12"><i class="fa fa-check"></i>Summary Statistics</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#linear-mixed-effects-10"><i class="fa fa-check"></i>Linear Mixed Effects</a></li>
</ul></li>
<li class="chapter" data-level="8.11" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#searchlight-results"><i class="fa fa-check"></i><b>8.11</b> Searchlight Results</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-within-sequence"><i class="fa fa-check"></i>Virtual Time Within Sequence</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-across-sequences-in-within-searchlight-cluster"><i class="fa fa-check"></i>Virtual Time Across Sequences in Within-Searchlight Cluster</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-across-sequences"><i class="fa fa-check"></i>Virtual Time Across Sequences</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#visualization-of-overlap"><i class="fa fa-check"></i>Visualization of Overlap</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#virtual-time-sequence-interaction"><i class="fa fa-check"></i>Virtual Time &amp; Sequence Interaction</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#exploratory-searchlight-results"><i class="fa fa-check"></i>Exploratory Searchlight Results</a></li>
</ul></li>
<li class="chapter" data-level="8.12" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#correlation-of-behavioral-generalization-bias-with-searchlight-effects"><i class="fa fa-check"></i><b>8.12</b> Correlation of behavioral generalization bias with searchlight effects</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#correlation-with-across-sequence-searchlight-effect"><i class="fa fa-check"></i>Correlation with across-sequence searchlight effect</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#correlation-with-same-sequence-searchlight-effect"><i class="fa fa-check"></i>Correlation with same-sequence searchlight effect</a></li>
</ul></li>
<li class="chapter" data-level="8.13" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#mixed-model-summaries"><i class="fa fa-check"></i><b>8.13</b> Mixed Model Summaries</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#supplemental-figure-1"><i class="fa fa-check"></i>Supplemental Figure</a></li>
<li class="chapter" data-level="" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#supplemental-tables"><i class="fa fa-check"></i>Supplemental Tables</a></li>
<li class="chapter" data-level="8.13.1" data-path="rsa-on-pattern-similarity-change.html"><a href="rsa-on-pattern-similarity-change.html#source-data"><i class="fa fa-check"></i><b>8.13.1</b> Source data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html"><i class="fa fa-check"></i><b>9</b> Signal to noise ratio</a>
<ul>
<li class="chapter" data-level="9.1" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html#calculate-voxel-wise-temporal-snr"><i class="fa fa-check"></i><b>9.1</b> Calculate voxel-wise temporal SNR</a></li>
<li class="chapter" data-level="9.2" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html#average-tsnr-per-roi"><i class="fa fa-check"></i><b>9.2</b> Average tSNR per ROI</a></li>
<li class="chapter" data-level="9.3" data-path="signal-to-noise-ratio.html"><a href="signal-to-noise-ratio.html#contrast-tsnr-between-ahpc-and-alec"><i class="fa fa-check"></i><b>9.3</b> Contrast tSNR between aHPC and alEC</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html"><i class="fa fa-check"></i><b>10</b> RSA in searchlight peak with different threshold</a>
<ul>
<li class="chapter" data-level="10.1" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#prepare-rsa-in-searchlight-peak-1"><i class="fa fa-check"></i><b>10.1</b> Prepare RSA in searchlight peak</a>
<ul>
<li class="chapter" data-level="" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#create-the-roi-mask-1"><i class="fa fa-check"></i>Create the ROI mask</a></li>
<li class="chapter" data-level="" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#calculating-the-correlation-matrices-1"><i class="fa fa-check"></i>Calculating the correlation matrices</a></li>
<li class="chapter" data-level="" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#calculate-pattern-similarity-change-2"><i class="fa fa-check"></i>Calculate Pattern Similarity Change</a></li>
<li class="chapter" data-level="" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#combine-behavioral-and-fmri-data-for-rsa-2"><i class="fa fa-check"></i>Combine behavioral and fMRI data for RSA</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="rsa-in-searchlight-peak-with-different-threshold.html"><a href="rsa-in-searchlight-peak-with-different-threshold.html#rsa"><i class="fa fa-check"></i><b>10.2</b> RSA</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html"><i class="fa fa-check"></i><b>11</b> Univariate GLM: Relative time</a>
<ul>
<li class="chapter" data-level="11.1" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#copy-feat-folder-from-preprocessing-to-first-level-glm-directory"><i class="fa fa-check"></i><b>11.1</b> Copy FEAT-folder from Preprocessing to First-Level GLM directory</a></li>
<li class="chapter" data-level="11.2" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#prepare-glm"><i class="fa fa-check"></i><b>11.2</b> Prepare GLM</a>
<ul>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#compute-relative-time"><i class="fa fa-check"></i>Compute relative time</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#write-custom-ev-files-for-fsl-feat"><i class="fa fa-check"></i>Write custom EV files for FSL FEAT</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#glm-design-files"><i class="fa fa-check"></i>GLM Design files</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#prepare-confound-ev"><i class="fa fa-check"></i>Prepare confound EV</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#create-design-matrix"><i class="fa fa-check"></i>Create design matrix</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#run-1st-level-glm-on-htcondor"><i class="fa fa-check"></i><b>11.3</b> Run 1st-level GLM on HTCondor</a></li>
<li class="chapter" data-level="11.4" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#group-level-1"><i class="fa fa-check"></i><b>11.4</b> Group-level</a>
<ul>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#move-first-level-images-to-mni-space-1"><i class="fa fa-check"></i>Move first-level images to MNI space</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#merge-first-level-images"><i class="fa fa-check"></i>Merge first-level images</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#smooth-first-level-images"><i class="fa fa-check"></i>Smooth first-level images</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#average-first-level-images"><i class="fa fa-check"></i>Average first-level images</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#ahpc-roi-analysis"><i class="fa fa-check"></i>aHPC ROI analysis</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#run-fsl-randomise-1"><i class="fa fa-check"></i>Run FSL Randomise</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#results-in-ahpc-and-alec"><i class="fa fa-check"></i>Results in aHPC and alEC</a></li>
<li class="chapter" data-level="" data-path="univariate-glm-relative-time.html"><a href="univariate-glm-relative-time.html#fov-results"><i class="fa fa-check"></i>FOV results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="credit.html"><a href="credit.html"><i class="fa fa-check"></i><b>12</b> Credit</a>
<ul>
<li class="chapter" data-level="12.1" data-path="credit.html"><a href="credit.html#list-of-packages"><i class="fa fa-check"></i><b>12.1</b> List of packages</a></li>
<li class="chapter" data-level="12.2" data-path="credit.html"><a href="credit.html#references"><i class="fa fa-check"></i><b>12.2</b> References</a></li>
<li class="chapter" data-level="12.3" data-path="credit.html"><a href="credit.html#session-info"><i class="fa fa-check"></i><b>12.3</b> Session Info</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Structuring time: The hippocampus constructs sequence memories that generalize temporal relations across experiences</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="run-rsa-searchlight" class="section level1" number="7">
<h1><span class="header-section-number">7</span> Run RSA Searchlight</h1>
<div id="prepare-functional-data" class="section level2" number="7.1">
<h2><span class="header-section-number">7.1</span> Prepare functional data</h2>
<p>We want to run RSA on the multi-voxel patterns corresponding to the object presentations during the picture viewing tasks. For this, we use the data as it was preprocessed by Lorena Deuker. We will do some further cleaning and extract the relevant volumes from the time series to eventually run RSA searchlights. What will be done in the following sections has been done previously for the ROI data only. Now we do it for the whole field of view in preparation of the RSA searchlights.</p>
<div id="data-cleaning-extract-residuals-from-motion-parameter-regression" class="section level3 unnumbered">
<h3>Data cleaning: Extract residuals from motion parameter regression</h3>
<p>In this first section of the script we will create a dataframe that includes the relevant file names for the files that are needed to calculate the clean time series. These files include the motion parameters from FSL FEAT, which was run on the functional data from the picture viewing task. As described above, these data were split into 10 blocks. We will use the preprocessed FEAT output images which were already co-registered to the analysis space (‘samespace’). Further, we will use a mask to only include voxels with data in all blocks. This mask has already been created and is available in the analysis space.</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="run-rsa-searchlight.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co">#PREPARE DATA FRAME FOR CLEANING</span></span>
<span id="cb149-2"><a href="run-rsa-searchlight.html#cb149-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-3"><a href="run-rsa-searchlight.html#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create a tibble with filenames etc for data cleaning, start with subject IDs</span></span>
<span id="cb149-4"><a href="run-rsa-searchlight.html#cb149-4" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">subject =</span> <span class="fu">rep</span>(<span class="fu">as.numeric</span>(subjects), <span class="at">each =</span> n_runs <span class="sc">*</span> n_blocks))</span>
<span id="cb149-5"><a href="run-rsa-searchlight.html#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="co"># add run info (run 1 and 2 equal the pre and post PVT)</span></span>
<span id="cb149-6"><a href="run-rsa-searchlight.html#cb149-6" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">run =</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_runs, <span class="at">each =</span> n_blocks), n_subs))</span>
<span id="cb149-7"><a href="run-rsa-searchlight.html#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="co"># add block information (blocks 1 to 10 are the PVT blocks preprocessed separately)</span></span>
<span id="cb149-8"><a href="run-rsa-searchlight.html#cb149-8" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">block =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_blocks, n_subs<span class="sc">*</span>n_runs))</span>
<span id="cb149-9"><a href="run-rsa-searchlight.html#cb149-9" aria-hidden="true" tabindex="-1"></a><span class="co"># add the motion parameter file</span></span>
<span id="cb149-10"><a href="run-rsa-searchlight.html#cb149-10" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">mc_par_fn =</span> </span>
<span id="cb149-11"><a href="run-rsa-searchlight.html#cb149-11" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">file.path</span>(dirs<span class="sc">$</span>feat_dir,</span>
<span id="cb149-12"><a href="run-rsa-searchlight.html#cb149-12" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P0&quot;</span>, func_dat_df<span class="sc">$</span>subject),</span>
<span id="cb149-13"><a href="run-rsa-searchlight.html#cb149-13" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">sprintf</span>(<span class="st">&quot;RSA_%02d_Block%02d.feat&quot;</span>,</span>
<span id="cb149-14"><a href="run-rsa-searchlight.html#cb149-14" aria-hidden="true" tabindex="-1"></a>                                              func_dat_df<span class="sc">$</span>run, func_dat_df<span class="sc">$</span>block),</span>
<span id="cb149-15"><a href="run-rsa-searchlight.html#cb149-15" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">&quot;mc&quot;</span>, <span class="st">&quot;prefiltered_func_data_mcf.par&quot;</span>))</span>
<span id="cb149-16"><a href="run-rsa-searchlight.html#cb149-16" aria-hidden="true" tabindex="-1"></a><span class="co"># add the functional data file</span></span>
<span id="cb149-17"><a href="run-rsa-searchlight.html#cb149-17" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">filtered_func =</span> </span>
<span id="cb149-18"><a href="run-rsa-searchlight.html#cb149-18" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">file.path</span>(dirs<span class="sc">$</span>samespace_dir,</span>
<span id="cb149-19"><a href="run-rsa-searchlight.html#cb149-19" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P0&quot;</span>, func_dat_df<span class="sc">$</span>subject),</span>
<span id="cb149-20"><a href="run-rsa-searchlight.html#cb149-20" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%03d_RSA_%02d_Block%02d_func.nii.gz&quot;</span>,</span>
<span id="cb149-21"><a href="run-rsa-searchlight.html#cb149-21" aria-hidden="true" tabindex="-1"></a>                                              func_dat_df<span class="sc">$</span>subject, func_dat_df<span class="sc">$</span>run, func_dat_df<span class="sc">$</span>block)))</span>
<span id="cb149-22"><a href="run-rsa-searchlight.html#cb149-22" aria-hidden="true" tabindex="-1"></a><span class="co"># add the brain mask data file</span></span>
<span id="cb149-23"><a href="run-rsa-searchlight.html#cb149-23" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">brain_mask =</span> </span>
<span id="cb149-24"><a href="run-rsa-searchlight.html#cb149-24" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">file.path</span>(dirs<span class="sc">$</span>samespace_dir,</span>
<span id="cb149-25"><a href="run-rsa-searchlight.html#cb149-25" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P0&quot;</span>, func_dat_df<span class="sc">$</span>subject),</span>
<span id="cb149-26"><a href="run-rsa-searchlight.html#cb149-26" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%03d_common_mask_perBlock.nii.gz&quot;</span>,</span>
<span id="cb149-27"><a href="run-rsa-searchlight.html#cb149-27" aria-hidden="true" tabindex="-1"></a>                                              func_dat_df<span class="sc">$</span>subject)))</span>
<span id="cb149-28"><a href="run-rsa-searchlight.html#cb149-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-29"><a href="run-rsa-searchlight.html#cb149-29" aria-hidden="true" tabindex="-1"></a><span class="co"># add output directory</span></span>
<span id="cb149-30"><a href="run-rsa-searchlight.html#cb149-30" aria-hidden="true" tabindex="-1"></a>func_dat_df <span class="ot">&lt;-</span> <span class="fu">add_column</span>(func_dat_df, <span class="at">out_dir =</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;clean_timeseries&quot;</span>))</span>
<span id="cb149-31"><a href="run-rsa-searchlight.html#cb149-31" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;clean_timeseries&quot;</span>))){</span>
<span id="cb149-32"><a href="run-rsa-searchlight.html#cb149-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;clean_timeseries&quot;</span>))</span>
<span id="cb149-33"><a href="run-rsa-searchlight.html#cb149-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div id="define-function-for-data-cleaning" class="section level4 unnumbered">
<h4>Define function for data cleaning</h4>
<p>In this next section, we will first define a function and then run it on all datasets. In this function, the preprocessed data will be loaded and transformed to matrix format. For every voxel within the brain mask, movement correction parameters are used as predictors in a GLM with the voxel time series as dependent variable. Finally, the residuals from this GLM (i.e. what could not be explained by motion) will be written to a text file.</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="run-rsa-searchlight.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DEFINE THE FUNCTION TO GET THE RESIDUAL TIME SERIES </span></span>
<span id="cb150-2"><a href="run-rsa-searchlight.html#cb150-2" aria-hidden="true" tabindex="-1"></a>run_motion_glm <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">df =</span> func_dat_df[<span class="dv">1</span>,]){</span>
<span id="cb150-3"><a href="run-rsa-searchlight.html#cb150-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-4"><a href="run-rsa-searchlight.html#cb150-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the motion params and convert to tibble</span></span>
<span id="cb150-5"><a href="run-rsa-searchlight.html#cb150-5" aria-hidden="true" tabindex="-1"></a>  mc_pars <span class="ot">&lt;-</span> <span class="fu">read.table</span>(df<span class="sc">$</span>mc_par_fn, <span class="at">header =</span> <span class="cn">FALSE</span>)</span>
<span id="cb150-6"><a href="run-rsa-searchlight.html#cb150-6" aria-hidden="true" tabindex="-1"></a>  mp_df <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(mc_pars)</span>
<span id="cb150-7"><a href="run-rsa-searchlight.html#cb150-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(mp_df) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;mp&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb150-8"><a href="run-rsa-searchlight.html#cb150-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-9"><a href="run-rsa-searchlight.html#cb150-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the brain mask, check it&#39;s only zeros and ones, then convert to logical</span></span>
<span id="cb150-10"><a href="run-rsa-searchlight.html#cb150-10" aria-hidden="true" tabindex="-1"></a>  brain_mask_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(df<span class="sc">$</span>brain_mask)</span>
<span id="cb150-11"><a href="run-rsa-searchlight.html#cb150-11" aria-hidden="true" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(<span class="fu">all.equal</span>(<span class="fu">unique</span>(<span class="fu">c</span>(<span class="fu">img_data</span>(brain_mask_nii))), <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)))</span>
<span id="cb150-12"><a href="run-rsa-searchlight.html#cb150-12" aria-hidden="true" tabindex="-1"></a>  brain_mask <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="fu">dim</span>(brain_mask_nii))</span>
<span id="cb150-13"><a href="run-rsa-searchlight.html#cb150-13" aria-hidden="true" tabindex="-1"></a>  brain_mask[] <span class="ot">&lt;-</span> <span class="fu">as.logical</span>(<span class="fu">img_data</span>(brain_mask_nii))</span>
<span id="cb150-14"><a href="run-rsa-searchlight.html#cb150-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-15"><a href="run-rsa-searchlight.html#cb150-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the functional data</span></span>
<span id="cb150-16"><a href="run-rsa-searchlight.html#cb150-16" aria-hidden="true" tabindex="-1"></a>  func_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(df<span class="sc">$</span>filtered_func)</span>
<span id="cb150-17"><a href="run-rsa-searchlight.html#cb150-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-18"><a href="run-rsa-searchlight.html#cb150-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># initialize output</span></span>
<span id="cb150-19"><a href="run-rsa-searchlight.html#cb150-19" aria-hidden="true" tabindex="-1"></a>  clean_dat <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">dim</span>(func_nii))</span>
<span id="cb150-20"><a href="run-rsa-searchlight.html#cb150-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-21"><a href="run-rsa-searchlight.html#cb150-21" aria-hidden="true" tabindex="-1"></a>  counter <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb150-22"><a href="run-rsa-searchlight.html#cb150-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_dim1 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(func_nii)[<span class="dv">1</span>]){</span>
<span id="cb150-23"><a href="run-rsa-searchlight.html#cb150-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_dim2 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(func_nii)[<span class="dv">2</span>]){</span>
<span id="cb150-24"><a href="run-rsa-searchlight.html#cb150-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i_dim3 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(func_nii)[<span class="dv">3</span>]){</span>
<span id="cb150-25"><a href="run-rsa-searchlight.html#cb150-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (brain_mask[i_dim1,i_dim2,i_dim3]){</span>
<span id="cb150-26"><a href="run-rsa-searchlight.html#cb150-26" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb150-27"><a href="run-rsa-searchlight.html#cb150-27" aria-hidden="true" tabindex="-1"></a>          <span class="co"># extract this voxel&#39;s data and merge with motion params</span></span>
<span id="cb150-28"><a href="run-rsa-searchlight.html#cb150-28" aria-hidden="true" tabindex="-1"></a>          mp_df<span class="sc">$</span>vox_dat <span class="ot">&lt;-</span> func_nii[i_dim1,i_dim2,i_dim3,]</span>
<span id="cb150-29"><a href="run-rsa-searchlight.html#cb150-29" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb150-30"><a href="run-rsa-searchlight.html#cb150-30" aria-hidden="true" tabindex="-1"></a>          <span class="co"># run the glm and store the residuals</span></span>
<span id="cb150-31"><a href="run-rsa-searchlight.html#cb150-31" aria-hidden="true" tabindex="-1"></a>          clean_dat[i_dim1,i_dim2,i_dim3,] <span class="ot">&lt;-</span> <span class="fu">resid</span>(<span class="fu">glm</span>(<span class="st">&#39;vox_dat~mp1+mp2+mp3+mp4+mp5+mp6&#39;</span>, <span class="at">data =</span> mp_df))</span>
<span id="cb150-32"><a href="run-rsa-searchlight.html#cb150-32" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb150-33"><a href="run-rsa-searchlight.html#cb150-33" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb150-34"><a href="run-rsa-searchlight.html#cb150-34" aria-hidden="true" tabindex="-1"></a>      <span class="co"># print a message to show progress</span></span>
<span id="cb150-35"><a href="run-rsa-searchlight.html#cb150-35" aria-hidden="true" tabindex="-1"></a>      counter <span class="ot">&lt;-</span>counter<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb150-36"><a href="run-rsa-searchlight.html#cb150-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (counter<span class="sc">%%</span>(<span class="fu">prod</span>(<span class="fu">dim</span>(func_nii)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])<span class="sc">/</span><span class="dv">100</span>) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb150-37"><a href="run-rsa-searchlight.html#cb150-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">paste0</span>((counter<span class="sc">/</span><span class="fu">prod</span>(<span class="fu">dim</span>(func_nii)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])<span class="sc">*</span><span class="dv">100</span>), <span class="st">&quot;% done&quot;</span>))}     </span>
<span id="cb150-38"><a href="run-rsa-searchlight.html#cb150-38" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb150-39"><a href="run-rsa-searchlight.html#cb150-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb150-40"><a href="run-rsa-searchlight.html#cb150-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb150-41"><a href="run-rsa-searchlight.html#cb150-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-42"><a href="run-rsa-searchlight.html#cb150-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create nifti with same header info as original data from clean time series</span></span>
<span id="cb150-43"><a href="run-rsa-searchlight.html#cb150-43" aria-hidden="true" tabindex="-1"></a>  clean_dat_nii <span class="ot">=</span> <span class="fu">copyNIfTIHeader</span>(<span class="at">img =</span> func_nii, <span class="at">arr =</span> clean_dat)</span>
<span id="cb150-44"><a href="run-rsa-searchlight.html#cb150-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-45"><a href="run-rsa-searchlight.html#cb150-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create output folder</span></span>
<span id="cb150-46"><a href="run-rsa-searchlight.html#cb150-46" aria-hidden="true" tabindex="-1"></a>  out_dir_sub <span class="ot">&lt;-</span> <span class="fu">file.path</span>(df<span class="sc">$</span>out_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%03d&quot;</span>,df<span class="sc">$</span>subject))</span>
<span id="cb150-47"><a href="run-rsa-searchlight.html#cb150-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir_sub)){<span class="fu">dir.create</span>(out_dir_sub, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb150-48"><a href="run-rsa-searchlight.html#cb150-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-49"><a href="run-rsa-searchlight.html#cb150-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write cleaned nifti to file</span></span>
<span id="cb150-50"><a href="run-rsa-searchlight.html#cb150-50" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;%03d_run%02d_block%02d_clean_func_data.nii.gz&quot;</span>,</span>
<span id="cb150-51"><a href="run-rsa-searchlight.html#cb150-51" aria-hidden="true" tabindex="-1"></a>              df<span class="sc">$</span>subject, df<span class="sc">$</span>run, df<span class="sc">$</span>block)</span>
<span id="cb150-52"><a href="run-rsa-searchlight.html#cb150-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writenii</span>(<span class="at">nim =</span> clean_dat_nii, <span class="at">filename =</span> <span class="fu">file.path</span>(out_dir_sub,fn))</span>
<span id="cb150-53"><a href="run-rsa-searchlight.html#cb150-53" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="run-data-cleaning" class="section level4 unnumbered">
<h4>Run data cleaning</h4>
<p>Now actually run the function either in parallel or serially.</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="run-rsa-searchlight.html#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># next step depends on whether we are in parallel or serial mode</span></span>
<span id="cb151-2"><a href="run-rsa-searchlight.html#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_parallel){ <span class="co"># run serially</span></span>
<span id="cb151-3"><a href="run-rsa-searchlight.html#cb151-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-4"><a href="run-rsa-searchlight.html#cb151-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;Attempting to run motion parameter cleaning serially. This will take a very long time if runnning for all subjects&quot;</span>)</span>
<span id="cb151-5"><a href="run-rsa-searchlight.html#cb151-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># run the function for each row of the data frame,</span></span>
<span id="cb151-6"><a href="run-rsa-searchlight.html#cb151-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># i.e. for each block in each run for each subject</span></span>
<span id="cb151-7"><a href="run-rsa-searchlight.html#cb151-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(func_dat_df)){</span>
<span id="cb151-8"><a href="run-rsa-searchlight.html#cb151-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-9"><a href="run-rsa-searchlight.html#cb151-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tic</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Subject %s, run %d, block %d&quot;</span>,</span>
<span id="cb151-10"><a href="run-rsa-searchlight.html#cb151-10" aria-hidden="true" tabindex="-1"></a>                func_dat_df<span class="sc">$</span>subject[i], func_dat_df<span class="sc">$</span>run[i], func_dat_df<span class="sc">$</span>block[i]))</span>
<span id="cb151-11"><a href="run-rsa-searchlight.html#cb151-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">run_motion_glm</span>(<span class="at">df =</span> func_dat_df[i,])</span>
<span id="cb151-12"><a href="run-rsa-searchlight.html#cb151-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toc</span>()</span>
<span id="cb151-13"><a href="run-rsa-searchlight.html#cb151-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-14"><a href="run-rsa-searchlight.html#cb151-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-15"><a href="run-rsa-searchlight.html#cb151-15" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (run_parallel){ <span class="co"># run in parallel, assumes CBS HTCondor is available</span></span>
<span id="cb151-16"><a href="run-rsa-searchlight.html#cb151-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-17"><a href="run-rsa-searchlight.html#cb151-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write the data frame to file</span></span>
<span id="cb151-18"><a href="run-rsa-searchlight.html#cb151-18" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;searchlight&quot;</span>, <span class="st">&quot;clean_timeseries&quot;</span>),</span>
<span id="cb151-19"><a href="run-rsa-searchlight.html#cb151-19" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;htc_config_clean_time_series.txt&quot;</span>)</span>
<span id="cb151-20"><a href="run-rsa-searchlight.html#cb151-20" aria-hidden="true" tabindex="-1"></a>  fn_def <span class="ot">&lt;-</span> <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&#39;&quot;fn &lt;- &quot;%s&quot;&#39;</span>,fn))</span>
<span id="cb151-21"><a href="run-rsa-searchlight.html#cb151-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(func_dat_df, fn,</span>
<span id="cb151-22"><a href="run-rsa-searchlight.html#cb151-22" aria-hidden="true" tabindex="-1"></a>              <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb151-23"><a href="run-rsa-searchlight.html#cb151-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-24"><a href="run-rsa-searchlight.html#cb151-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># store the function definition as text</span></span>
<span id="cb151-25"><a href="run-rsa-searchlight.html#cb151-25" aria-hidden="true" tabindex="-1"></a>  func_def <span class="ot">&lt;-</span> <span class="fu">capture.output</span>(run_motion_glm)</span>
<span id="cb151-26"><a href="run-rsa-searchlight.html#cb151-26" aria-hidden="true" tabindex="-1"></a>  func_def[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;run_motion_glm &lt;- &quot;</span>,func_def[<span class="dv">1</span>])</span>
<span id="cb151-27"><a href="run-rsa-searchlight.html#cb151-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">#func_def &lt;- func_def[-length(func_def)]</span></span>
<span id="cb151-28"><a href="run-rsa-searchlight.html#cb151-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-29"><a href="run-rsa-searchlight.html#cb151-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">#write the Rscript that we want to run</span></span>
<span id="cb151-30"><a href="run-rsa-searchlight.html#cb151-30" aria-hidden="true" tabindex="-1"></a>  rscript_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;searchlight&quot;</span>, <span class="st">&quot;clean_timeseries&quot;</span>, <span class="st">&quot;run_clean_timeseries.R&quot;</span>)</span>
<span id="cb151-31"><a href="run-rsa-searchlight.html#cb151-31" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">file</span>(rscript_fn)</span>
<span id="cb151-32"><a href="run-rsa-searchlight.html#cb151-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">open</span>(con, <span class="st">&quot;w&quot;</span>)</span>
<span id="cb151-33"><a href="run-rsa-searchlight.html#cb151-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(<span class="fu">c</span>(</span>
<span id="cb151-34"><a href="run-rsa-searchlight.html#cb151-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st"># handle input&quot;</span>,</span>
<span id="cb151-35"><a href="run-rsa-searchlight.html#cb151-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;args = commandArgs()&quot;</span>,</span>
<span id="cb151-36"><a href="run-rsa-searchlight.html#cb151-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;i &lt;- as.numeric(args[length(args)])&quot;</span>,</span>
<span id="cb151-37"><a href="run-rsa-searchlight.html#cb151-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st">#load required packages&quot;</span>,</span>
<span id="cb151-38"><a href="run-rsa-searchlight.html#cb151-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">noquote</span>(<span class="fu">sprintf</span>(<span class="st">&#39;lib_dir &lt;- &quot;%s&quot;&#39;</span>,<span class="st">&quot;/data/pt_02261/virtem/virtem_code/R3.6.1/library/Linux&quot;</span>)),</span>
<span id="cb151-39"><a href="run-rsa-searchlight.html#cb151-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;.libPaths(c(lib_dir,.libPaths()))&#39;</span>,</span>
<span id="cb151-40"><a href="run-rsa-searchlight.html#cb151-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;lapply(c(&quot;oro.nifti&quot;, &quot;assertthat&quot;, &quot;dplyr&quot;, &quot;neurobase&quot;), library, character.only = TRUE)&#39;</span>,</span>
<span id="cb151-41"><a href="run-rsa-searchlight.html#cb151-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st"># read the data and transform ROI column back to list&quot;</span>,</span>
<span id="cb151-42"><a href="run-rsa-searchlight.html#cb151-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">noquote</span>(<span class="fu">sprintf</span>(<span class="st">&#39;fn &lt;- &quot;%s&quot;&#39;</span>,fn)),</span>
<span id="cb151-43"><a href="run-rsa-searchlight.html#cb151-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;func_dat_df &lt;- read.table(fn, sep = &quot;,&quot;, header = TRUE, stringsAsFactors = FALSE)&#39;</span>,</span>
<span id="cb151-44"><a href="run-rsa-searchlight.html#cb151-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st">#define the function to run motion GLM&quot;</span>,</span>
<span id="cb151-45"><a href="run-rsa-searchlight.html#cb151-45" aria-hidden="true" tabindex="-1"></a>    func_def,</span>
<span id="cb151-46"><a href="run-rsa-searchlight.html#cb151-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st"># run the function on one line of the data frame&quot;</span>,</span>
<span id="cb151-47"><a href="run-rsa-searchlight.html#cb151-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;run_motion_glm(df = func_dat_df[i,])&quot;</span>),con)</span>
<span id="cb151-48"><a href="run-rsa-searchlight.html#cb151-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(con)</span>
<span id="cb151-49"><a href="run-rsa-searchlight.html#cb151-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-50"><a href="run-rsa-searchlight.html#cb151-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># folder for condor output</span></span>
<span id="cb151-51"><a href="run-rsa-searchlight.html#cb151-51" aria-hidden="true" tabindex="-1"></a>  htc_dir <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;htc_logs&quot;</span>, <span class="st">&quot;clean_timeseries&quot;</span>)</span>
<span id="cb151-52"><a href="run-rsa-searchlight.html#cb151-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(htc_dir)){<span class="fu">dir.create</span>(htc_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb151-53"><a href="run-rsa-searchlight.html#cb151-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-54"><a href="run-rsa-searchlight.html#cb151-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write the submit script</span></span>
<span id="cb151-55"><a href="run-rsa-searchlight.html#cb151-55" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;searchlight&quot;</span>, <span class="st">&quot;clean_timeseries&quot;</span>, <span class="st">&quot;run_clean_timeseries.submit&quot;</span>)</span>
<span id="cb151-56"><a href="run-rsa-searchlight.html#cb151-56" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">file</span>(fn)</span>
<span id="cb151-57"><a href="run-rsa-searchlight.html#cb151-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">open</span>(con, <span class="st">&quot;w&quot;</span>)</span>
<span id="cb151-58"><a href="run-rsa-searchlight.html#cb151-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(<span class="fu">c</span>(</span>
<span id="cb151-59"><a href="run-rsa-searchlight.html#cb151-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;universe = vanilla&quot;</span>,</span>
<span id="cb151-60"><a href="run-rsa-searchlight.html#cb151-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;executable = /afs/cbs.mpg.de/software/scripts/envwrap&quot;</span>,</span>
<span id="cb151-61"><a href="run-rsa-searchlight.html#cb151-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;request_memory = 9000&quot;</span>,</span>
<span id="cb151-62"><a href="run-rsa-searchlight.html#cb151-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;notification = error&quot;</span></span>
<span id="cb151-63"><a href="run-rsa-searchlight.html#cb151-63" aria-hidden="true" tabindex="-1"></a>    ),con)</span>
<span id="cb151-64"><a href="run-rsa-searchlight.html#cb151-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-65"><a href="run-rsa-searchlight.html#cb151-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(func_dat_df)){</span>
<span id="cb151-66"><a href="run-rsa-searchlight.html#cb151-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">writeLines</span>(<span class="fu">c</span>(</span>
<span id="cb151-67"><a href="run-rsa-searchlight.html#cb151-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">arguments = R+ --version 3.6.1 Rscript %s %d&quot;</span>, rscript_fn, i),</span>
<span id="cb151-68"><a href="run-rsa-searchlight.html#cb151-68" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;log = %s/%d.log&quot;</span>, htc_dir, i),</span>
<span id="cb151-69"><a href="run-rsa-searchlight.html#cb151-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;output = %s/%d.out&quot;</span>, htc_dir, i),</span>
<span id="cb151-70"><a href="run-rsa-searchlight.html#cb151-70" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;error = %s/%d.err&quot;</span>, htc_dir, i),</span>
<span id="cb151-71"><a href="run-rsa-searchlight.html#cb151-71" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sprintf</span>(<span class="st">&quot;Queue</span><span class="sc">\n</span><span class="st">&quot;</span>)),con)</span>
<span id="cb151-72"><a href="run-rsa-searchlight.html#cb151-72" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb151-73"><a href="run-rsa-searchlight.html#cb151-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(con)</span>
<span id="cb151-74"><a href="run-rsa-searchlight.html#cb151-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-75"><a href="run-rsa-searchlight.html#cb151-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># submit to condor</span></span>
<span id="cb151-76"><a href="run-rsa-searchlight.html#cb151-76" aria-hidden="true" tabindex="-1"></a>  <span class="co">#system(&quot;reset-memory-max&quot;)</span></span>
<span id="cb151-77"><a href="run-rsa-searchlight.html#cb151-77" aria-hidden="true" tabindex="-1"></a>  batch_id <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="fu">paste</span>(<span class="st">&quot;condor_submit&quot;</span>, fn), <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb151-78"><a href="run-rsa-searchlight.html#cb151-78" aria-hidden="true" tabindex="-1"></a>  batch_id <span class="ot">&lt;-</span> <span class="fu">regmatches</span>(batch_id[<span class="dv">2</span>], <span class="fu">gregexpr</span>(<span class="st">&quot;[[:digit:]]+&quot;</span>, batch_id[<span class="dv">2</span>]))[[<span class="dv">1</span>]][<span class="dv">2</span>]</span>
<span id="cb151-79"><a href="run-rsa-searchlight.html#cb151-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;submitted jobs (ID = %s) to clean time series for searchlights. Time to wait...&quot;</span>, batch_id))</span>
<span id="cb151-80"><a href="run-rsa-searchlight.html#cb151-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pause_until_batch_done</span>(<span class="at">batch_id =</span> batch_id, <span class="at">wait_interval =</span> <span class="dv">600</span>)</span>
<span id="cb151-81"><a href="run-rsa-searchlight.html#cb151-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-82"><a href="run-rsa-searchlight.html#cb151-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-83"><a href="run-rsa-searchlight.html#cb151-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">#system(&quot;reset-memory-max&quot;)</span></span>
<span id="cb151-84"><a href="run-rsa-searchlight.html#cb151-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">#system(&quot;condor_q&quot;)</span></span>
<span id="cb151-85"><a href="run-rsa-searchlight.html#cb151-85" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="extract-relevant-volumes-1" class="section level3 unnumbered">
<h3>Extract relevant volumes</h3>
<p>As the presentation of images in the PVT pre and post blocks was locked to the onset of a new volume (see above), the second volume after image onset was selected for every trial (effectively covering the time between 2270-4540 ms after stimulus onset).</p>
<p>In this step, we split the presentation logfile from the picture viewing task into the 10 blocks. We reference the volume count to the first volume of each block and extract the relevant volumes from the cleaned 4D timeseries data, accounting for the temporal offset. This is done for each block separately in both the pre and post runs. The data are written to 3D-niftis.</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="run-rsa-searchlight.html#cb152-1" aria-hidden="true" tabindex="-1"></a>offset_tr <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb152-2"><a href="run-rsa-searchlight.html#cb152-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-3"><a href="run-rsa-searchlight.html#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb152-4"><a href="run-rsa-searchlight.html#cb152-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_run <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_runs){</span>
<span id="cb152-5"><a href="run-rsa-searchlight.html#cb152-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-6"><a href="run-rsa-searchlight.html#cb152-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load the logfile for this run (pre or post)</span></span>
<span id="cb152-7"><a href="run-rsa-searchlight.html#cb152-7" aria-hidden="true" tabindex="-1"></a>    log_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>pvt_log_dir, <span class="fu">sprintf</span>(<span class="st">&#39;P%s_%svirtem.txt&#39;</span>, i_sub, runs[i_run]))</span>
<span id="cb152-8"><a href="run-rsa-searchlight.html#cb152-8" aria-hidden="true" tabindex="-1"></a>    log <span class="ot">&lt;-</span> <span class="fu">read.table</span>(log_fn)</span>
<span id="cb152-9"><a href="run-rsa-searchlight.html#cb152-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(log) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;pic&quot;</span>, <span class="st">&quot;fix_start&quot;</span>, <span class="st">&quot;pic_start&quot;</span>, <span class="st">&quot;volume&quot;</span>, <span class="st">&quot;response&quot;</span>, <span class="st">&quot;RT&quot;</span>, <span class="st">&quot;trial_end&quot;</span>)</span>
<span id="cb152-10"><a href="run-rsa-searchlight.html#cb152-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-11"><a href="run-rsa-searchlight.html#cb152-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># split the log file into the 10 blocks</span></span>
<span id="cb152-12"><a href="run-rsa-searchlight.html#cb152-12" aria-hidden="true" tabindex="-1"></a>    log_split <span class="ot">&lt;-</span> <span class="fu">split</span>(log, <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">each =</span> <span class="dv">21</span>))</span>
<span id="cb152-13"><a href="run-rsa-searchlight.html#cb152-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-14"><a href="run-rsa-searchlight.html#cb152-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># reference volume numbers to the first volume of that block</span></span>
<span id="cb152-15"><a href="run-rsa-searchlight.html#cb152-15" aria-hidden="true" tabindex="-1"></a>    vol_block <span class="ot">&lt;-</span> <span class="fu">lapply</span>(log_split, <span class="cf">function</span>(x){x<span class="sc">$</span>volume <span class="sc">-</span> x<span class="sc">$</span>volume[<span class="dv">1</span>]})</span>
<span id="cb152-16"><a href="run-rsa-searchlight.html#cb152-16" aria-hidden="true" tabindex="-1"></a>    log_split <span class="ot">&lt;-</span> <span class="fu">mapply</span>(cbind, log_split, <span class="st">&quot;vol_block&quot;</span><span class="ot">=</span>vol_block, <span class="at">SIMPLIFY=</span><span class="cn">FALSE</span>)</span>
<span id="cb152-17"><a href="run-rsa-searchlight.html#cb152-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-18"><a href="run-rsa-searchlight.html#cb152-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_block <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_blocks){</span>
<span id="cb152-19"><a href="run-rsa-searchlight.html#cb152-19" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-20"><a href="run-rsa-searchlight.html#cb152-20" aria-hidden="true" tabindex="-1"></a>      <span class="co"># define the full 4D file</span></span>
<span id="cb152-21"><a href="run-rsa-searchlight.html#cb152-21" aria-hidden="true" tabindex="-1"></a>      clean_func_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;clean_timeseries&quot;</span>, i_sub,</span>
<span id="cb152-22"><a href="run-rsa-searchlight.html#cb152-22" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">sprintf</span>(<span class="st">&quot;%s_run%02d_block%02d_clean_func_data.nii.gz&quot;</span>,</span>
<span id="cb152-23"><a href="run-rsa-searchlight.html#cb152-23" aria-hidden="true" tabindex="-1"></a>                                         i_sub, i_run, i_block))</span>
<span id="cb152-24"><a href="run-rsa-searchlight.html#cb152-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb152-25"><a href="run-rsa-searchlight.html#cb152-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># index of relevant volumes when accounting for offset</span></span>
<span id="cb152-26"><a href="run-rsa-searchlight.html#cb152-26" aria-hidden="true" tabindex="-1"></a>      rel_vols <span class="ot">&lt;-</span> log_split[[i_block]]<span class="sc">$</span>vol_block <span class="sc">+</span> offset_tr</span>
<span id="cb152-27"><a href="run-rsa-searchlight.html#cb152-27" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-28"><a href="run-rsa-searchlight.html#cb152-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># extract the relevant volumes from the ROI timeseries data</span></span>
<span id="cb152-29"><a href="run-rsa-searchlight.html#cb152-29" aria-hidden="true" tabindex="-1"></a>      out_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;rel_vols_3D&quot;</span>, i_sub)</span>
<span id="cb152-30"><a href="run-rsa-searchlight.html#cb152-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)){<span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb152-31"><a href="run-rsa-searchlight.html#cb152-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-32"><a href="run-rsa-searchlight.html#cb152-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i_vol <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(rel_vols)){</span>
<span id="cb152-33"><a href="run-rsa-searchlight.html#cb152-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># subtract 1 from volume number because of 0-based FSL indexing</span></span>
<span id="cb152-34"><a href="run-rsa-searchlight.html#cb152-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fslroi</span>(<span class="at">file =</span> clean_func_fn, <span class="at">tmin =</span> rel_vols[i_vol]<span class="sc">-</span><span class="dv">1</span>, <span class="at">tsize =</span> <span class="dv">1</span>, </span>
<span id="cb152-35"><a href="run-rsa-searchlight.html#cb152-35" aria-hidden="true" tabindex="-1"></a>               <span class="at">outfile =</span> <span class="fu">file.path</span>(out_dir, </span>
<span id="cb152-36"><a href="run-rsa-searchlight.html#cb152-36" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">sprintf</span>(<span class="st">&quot;%s_run%02d_block%02d_pic%02d.nii.gz&quot;</span>,</span>
<span id="cb152-37"><a href="run-rsa-searchlight.html#cb152-37" aria-hidden="true" tabindex="-1"></a>                                           i_sub, i_run, i_block, log_split[[i_block]]<span class="sc">$</span>pic[i_vol])),</span>
<span id="cb152-38"><a href="run-rsa-searchlight.html#cb152-38" aria-hidden="true" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb152-39"><a href="run-rsa-searchlight.html#cb152-39" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb152-40"><a href="run-rsa-searchlight.html#cb152-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb152-41"><a href="run-rsa-searchlight.html#cb152-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb152-42"><a href="run-rsa-searchlight.html#cb152-42" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="concatenate-relevant-volumes" class="section level3 unnumbered">
<h3>Concatenate relevant volumes</h3>
<p>Next, we create 4D-files for both the pre and the post run. Each file will have consist of 200 (20 relevant pictures x 10 blocks) volumes. We take care to order the volumes according to picture identity as this is most convenient for later RSA.</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="run-rsa-searchlight.html#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb153-2"><a href="run-rsa-searchlight.html#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_run <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_runs){</span>
<span id="cb153-3"><a href="run-rsa-searchlight.html#cb153-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-4"><a href="run-rsa-searchlight.html#cb153-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># files to concatenate</span></span>
<span id="cb153-5"><a href="run-rsa-searchlight.html#cb153-5" aria-hidden="true" tabindex="-1"></a>    in_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;rel_vols_3D&quot;</span>, i_sub)</span>
<span id="cb153-6"><a href="run-rsa-searchlight.html#cb153-6" aria-hidden="true" tabindex="-1"></a>    files <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">file.path</span>(in_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_run%02d_block%02d_pic%02d.nii.gz&quot;</span>,</span>
<span id="cb153-7"><a href="run-rsa-searchlight.html#cb153-7" aria-hidden="true" tabindex="-1"></a>                                         i_sub, i_run, <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,n_pics)), <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_pics, <span class="at">each =</span> n_blocks)))))</span>
<span id="cb153-8"><a href="run-rsa-searchlight.html#cb153-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-9"><a href="run-rsa-searchlight.html#cb153-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># output file</span></span>
<span id="cb153-10"><a href="run-rsa-searchlight.html#cb153-10" aria-hidden="true" tabindex="-1"></a>    out_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;rel_vols_4D&quot;</span>)</span>
<span id="cb153-11"><a href="run-rsa-searchlight.html#cb153-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)){<span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb153-12"><a href="run-rsa-searchlight.html#cb153-12" aria-hidden="true" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_run%02d_rel_vols.nii.gz&quot;</span>, </span>
<span id="cb153-13"><a href="run-rsa-searchlight.html#cb153-13" aria-hidden="true" tabindex="-1"></a>                                     i_sub, i_run)) </span>
<span id="cb153-14"><a href="run-rsa-searchlight.html#cb153-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-15"><a href="run-rsa-searchlight.html#cb153-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># merge the files</span></span>
<span id="cb153-16"><a href="run-rsa-searchlight.html#cb153-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fslmerge</span>(<span class="at">infiles =</span> files, <span class="at">direction =</span> <span class="st">&quot;t&quot;</span>, <span class="at">outfile =</span> fn, </span>
<span id="cb153-17"><a href="run-rsa-searchlight.html#cb153-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">retimg =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb153-18"><a href="run-rsa-searchlight.html#cb153-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-19"><a href="run-rsa-searchlight.html#cb153-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># change datatype to short to save space and memory for the cluster jobs</span></span>
<span id="cb153-20"><a href="run-rsa-searchlight.html#cb153-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fslmaths</span>(<span class="at">file =</span> fn, <span class="at">outfile =</span> fn, <span class="at">retimg =</span> <span class="cn">FALSE</span>,</span>
<span id="cb153-21"><a href="run-rsa-searchlight.html#cb153-21" aria-hidden="true" tabindex="-1"></a>             <span class="at">opts =</span> <span class="st">&quot;-odt short&quot;</span>, <span class="at">opts_after_outfile =</span> <span class="cn">TRUE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb153-22"><a href="run-rsa-searchlight.html#cb153-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb153-23"><a href="run-rsa-searchlight.html#cb153-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>

</div>
</div>
<div id="first-level-rsa-searchlight" class="section level2" number="7.2">
<h2><span class="header-section-number">7.2</span> First-level RSA searchlight</h2>
<blockquote>
<p>We further probed how temporal distances between events shaped representational change using searchlight analyses. Using the procedures described above, we calculated pattern similarity change values for search spheres with a radius of 3 voxels around the center voxel. Search spheres were centered on all brain voxels within our field of view. Within a given search sphere, only gray matter voxels were analyzed. Search spheres not containing more than 25 gray matter voxels were discarded.</p>
</blockquote>
<p>Building on the prepared data, we want to run the searchlight analysis. To speed things up, we split the brain into chunks that we analyze in parallel jobs.</p>
<div id="set-analysis-parameters" class="section level3 unnumbered">
<h3>Set analysis parameters</h3>
<p>First, let’s set some analysis parameters. These include</p>
<ul>
<li>the radius of the search spheres. This is the radius around the center voxel, so that the diameter of the spheres is given by 2*radius + 1</li>
<li>the minimum number of valid voxels that a sphere has to contain to be analyzed</li>
<li>the number of chunks into which we split the analysis to speed up the computations using the HPC cluster</li>
</ul>
<p>Further, we define a function that returns the voxels in the sphere of a given radius around. This canonical sphere definition will then be combined with the actual sphere center coordinates. It is based on the way the sphere definition is implemented in the <a href="https://rdrr.io/cran/fmri/src/R/searchlight.r">fmri package for R</a>.</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="run-rsa-searchlight.html#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how large should the searchlights be </span></span>
<span id="cb154-2"><a href="run-rsa-searchlight.html#cb154-2" aria-hidden="true" tabindex="-1"></a>radius <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># radius around center voxel</span></span>
<span id="cb154-3"><a href="run-rsa-searchlight.html#cb154-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-4"><a href="run-rsa-searchlight.html#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="co"># how many voxels (counting the center) must be in a searchlight for it to be run; smaller ones are skipped.</span></span>
<span id="cb154-5"><a href="run-rsa-searchlight.html#cb154-5" aria-hidden="true" tabindex="-1"></a>min_voxels <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb154-6"><a href="run-rsa-searchlight.html#cb154-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-7"><a href="run-rsa-searchlight.html#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="co"># how many chunks to split the analysis up into (for speed reasons)</span></span>
<span id="cb154-8"><a href="run-rsa-searchlight.html#cb154-8" aria-hidden="true" tabindex="-1"></a>n_chunks <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb154-9"><a href="run-rsa-searchlight.html#cb154-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-10"><a href="run-rsa-searchlight.html#cb154-10" aria-hidden="true" tabindex="-1"></a><span class="co"># function to get searchsphere of given radius (based on: https://rdrr.io/cran/fmri/src/R/searchlight.r)</span></span>
<span id="cb154-11"><a href="run-rsa-searchlight.html#cb154-11" aria-hidden="true" tabindex="-1"></a>searchlight <span class="ot">&lt;-</span> <span class="cf">function</span>(radius){</span>
<span id="cb154-12"><a href="run-rsa-searchlight.html#cb154-12" aria-hidden="true" tabindex="-1"></a>    rad <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(radius)</span>
<span id="cb154-13"><a href="run-rsa-searchlight.html#cb154-13" aria-hidden="true" tabindex="-1"></a>    nr <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>rad<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb154-14"><a href="run-rsa-searchlight.html#cb154-14" aria-hidden="true" tabindex="-1"></a>    indices <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">rep</span>(<span class="sc">-</span>rad<span class="sc">:</span>rad,nr<span class="sc">*</span>nr),</span>
<span id="cb154-15"><a href="run-rsa-searchlight.html#cb154-15" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">rep</span>(<span class="sc">-</span>rad<span class="sc">:</span>rad,<span class="fu">rep</span>(nr,nr)),</span>
<span id="cb154-16"><a href="run-rsa-searchlight.html#cb154-16" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">rep</span>(<span class="sc">-</span>rad<span class="sc">:</span>rad,<span class="fu">rep</span>(nr<span class="sc">*</span>nr,nr)))</span>
<span id="cb154-17"><a href="run-rsa-searchlight.html#cb154-17" aria-hidden="true" tabindex="-1"></a>    indices[,<span class="fu">apply</span>(indices<span class="sc">^</span><span class="dv">2</span>,<span class="dv">2</span>,sum)<span class="sc">&lt;=</span>radius<span class="sc">^</span><span class="dv">2</span>]</span>
<span id="cb154-18"><a href="run-rsa-searchlight.html#cb154-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="prepare-rsa-predictions" class="section level3 unnumbered">
<h3>Prepare RSA-predictions</h3>
<p>To relate pattern similarity change in each search sphere to the temporal structure of the sequences we need the relationships of the events in virtual time. We calculate these here analogously to the main ROI analyses, but save them for each subject separately.</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="run-rsa-searchlight.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb155-2"><a href="run-rsa-searchlight.html#cb155-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-3"><a href="run-rsa-searchlight.html#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set up the dataframe to use for RSA</span></span>
<span id="cb155-4"><a href="run-rsa-searchlight.html#cb155-4" aria-hidden="true" tabindex="-1"></a>  pics <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">upper.tri</span>(<span class="fu">matrix</span>(<span class="cn">TRUE</span>, n_pics, n_pics), <span class="at">diag =</span> <span class="cn">FALSE</span>), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb155-5"><a href="run-rsa-searchlight.html#cb155-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-6"><a href="run-rsa-searchlight.html#cb155-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the behavioral data</span></span>
<span id="cb155-7"><a href="run-rsa-searchlight.html#cb155-7" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>timeline_dat_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_behavior_tbl_timeline.txt&quot;</span>, i_sub))</span>
<span id="cb155-8"><a href="run-rsa-searchlight.html#cb155-8" aria-hidden="true" tabindex="-1"></a>  col_types_list <span class="ot">&lt;-</span> <span class="fu">cols_only</span>(<span class="at">sub_id =</span> <span class="fu">col_character</span>(), <span class="at">day =</span> <span class="fu">col_factor</span>(), </span>
<span id="cb155-9"><a href="run-rsa-searchlight.html#cb155-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">event =</span> <span class="fu">col_integer</span>(), <span class="at">pic =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb155-10"><a href="run-rsa-searchlight.html#cb155-10" aria-hidden="true" tabindex="-1"></a>                              <span class="at">virtual_time =</span> <span class="fu">col_double</span>(), <span class="at">real_time =</span> <span class="fu">col_double</span>(),</span>
<span id="cb155-11"><a href="run-rsa-searchlight.html#cb155-11" aria-hidden="true" tabindex="-1"></a>                              <span class="at">memory_time =</span> <span class="fu">col_double</span>(), <span class="at">memory_order =</span> <span class="fu">col_double</span>(), </span>
<span id="cb155-12"><a href="run-rsa-searchlight.html#cb155-12" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sorted_day =</span> <span class="fu">col_integer</span>())</span>
<span id="cb155-13"><a href="run-rsa-searchlight.html#cb155-13" aria-hidden="true" tabindex="-1"></a>  beh_dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fn, <span class="at">col_types =</span> col_types_list)</span>
<span id="cb155-14"><a href="run-rsa-searchlight.html#cb155-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-15"><a href="run-rsa-searchlight.html#cb155-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sort behavioral data according to picture identity</span></span>
<span id="cb155-16"><a href="run-rsa-searchlight.html#cb155-16" aria-hidden="true" tabindex="-1"></a>  beh_dat_ordered <span class="ot">&lt;-</span> beh_dat[<span class="fu">order</span>(beh_dat<span class="sc">$</span>pic),]</span>
<span id="cb155-17"><a href="run-rsa-searchlight.html#cb155-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-18"><a href="run-rsa-searchlight.html#cb155-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># find the order of comparisons</span></span>
<span id="cb155-19"><a href="run-rsa-searchlight.html#cb155-19" aria-hidden="true" tabindex="-1"></a>  pics <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">upper.tri</span>(<span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="dv">20</span>, <span class="at">ncol =</span> <span class="dv">20</span>)), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb155-20"><a href="run-rsa-searchlight.html#cb155-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-21"><a href="run-rsa-searchlight.html#cb155-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract the data for the first and second picture in each pair from the behavioral data</span></span>
<span id="cb155-22"><a href="run-rsa-searchlight.html#cb155-22" aria-hidden="true" tabindex="-1"></a>  pic1_dat <span class="ot">&lt;-</span> beh_dat_ordered[pics[,<span class="dv">1</span>],]</span>
<span id="cb155-23"><a href="run-rsa-searchlight.html#cb155-23" aria-hidden="true" tabindex="-1"></a>  pic2_dat <span class="ot">&lt;-</span> beh_dat_ordered[pics[,<span class="dv">2</span>],]</span>
<span id="cb155-24"><a href="run-rsa-searchlight.html#cb155-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(pic1_dat) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">colnames</span>(pic1_dat), <span class="st">&quot;1&quot;</span>)</span>
<span id="cb155-25"><a href="run-rsa-searchlight.html#cb155-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(pic2_dat) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">colnames</span>(pic2_dat), <span class="st">&quot;2&quot;</span>)</span>
<span id="cb155-26"><a href="run-rsa-searchlight.html#cb155-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-27"><a href="run-rsa-searchlight.html#cb155-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine the two tibbles</span></span>
<span id="cb155-28"><a href="run-rsa-searchlight.html#cb155-28" aria-hidden="true" tabindex="-1"></a>  pair_dat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(pic1_dat, pic2_dat)</span>
<span id="cb155-29"><a href="run-rsa-searchlight.html#cb155-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-30"><a href="run-rsa-searchlight.html#cb155-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reorder the tibble columns to make a bit more sense</span></span>
<span id="cb155-31"><a href="run-rsa-searchlight.html#cb155-31" aria-hidden="true" tabindex="-1"></a>  pair_dat <span class="ot">&lt;-</span> pair_dat <span class="sc">%&gt;%</span></span>
<span id="cb155-32"><a href="run-rsa-searchlight.html#cb155-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sub_id1,</span>
<span id="cb155-33"><a href="run-rsa-searchlight.html#cb155-33" aria-hidden="true" tabindex="-1"></a>           day1, day2,</span>
<span id="cb155-34"><a href="run-rsa-searchlight.html#cb155-34" aria-hidden="true" tabindex="-1"></a>           pic1, pic2,</span>
<span id="cb155-35"><a href="run-rsa-searchlight.html#cb155-35" aria-hidden="true" tabindex="-1"></a>           event1, event2, </span>
<span id="cb155-36"><a href="run-rsa-searchlight.html#cb155-36" aria-hidden="true" tabindex="-1"></a>           virtual_time1, virtual_time2, </span>
<span id="cb155-37"><a href="run-rsa-searchlight.html#cb155-37" aria-hidden="true" tabindex="-1"></a>           real_time1, real_time2, </span>
<span id="cb155-38"><a href="run-rsa-searchlight.html#cb155-38" aria-hidden="true" tabindex="-1"></a>           memory_order1, memory_order2, </span>
<span id="cb155-39"><a href="run-rsa-searchlight.html#cb155-39" aria-hidden="true" tabindex="-1"></a>           memory_time1, memory_time2, </span>
<span id="cb155-40"><a href="run-rsa-searchlight.html#cb155-40" aria-hidden="true" tabindex="-1"></a>           sorted_day1, sorted_day2) <span class="sc">%&gt;%</span></span>
<span id="cb155-41"><a href="run-rsa-searchlight.html#cb155-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">sub_id =</span> sub_id1)</span>
<span id="cb155-42"><a href="run-rsa-searchlight.html#cb155-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-43"><a href="run-rsa-searchlight.html#cb155-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prepare RSA distance measures</span></span>
<span id="cb155-44"><a href="run-rsa-searchlight.html#cb155-44" aria-hidden="true" tabindex="-1"></a>  pair_dat <span class="ot">&lt;-</span> pair_dat <span class="sc">%&gt;%</span></span>
<span id="cb155-45"><a href="run-rsa-searchlight.html#cb155-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb155-46"><a href="run-rsa-searchlight.html#cb155-46" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb155-47"><a href="run-rsa-searchlight.html#cb155-47" aria-hidden="true" tabindex="-1"></a>      <span class="co"># pair of events from say or different day (dv = deviation code)</span></span>
<span id="cb155-48"><a href="run-rsa-searchlight.html#cb155-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">same_day =</span> day1 <span class="sc">==</span> day2,</span>
<span id="cb155-49"><a href="run-rsa-searchlight.html#cb155-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">same_day_dv =</span> plyr<span class="sc">::</span><span class="fu">mapvalues</span>(same_day, <span class="at">from =</span> <span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="cn">TRUE</span>), <span class="at">to =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb155-50"><a href="run-rsa-searchlight.html#cb155-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb155-51"><a href="run-rsa-searchlight.html#cb155-51" aria-hidden="true" tabindex="-1"></a>      <span class="co"># absolute difference in time metrics</span></span>
<span id="cb155-52"><a href="run-rsa-searchlight.html#cb155-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">vir_time_diff =</span> <span class="fu">abs</span>(virtual_time1 <span class="sc">-</span> virtual_time2),</span>
<span id="cb155-53"><a href="run-rsa-searchlight.html#cb155-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">order_diff =</span> <span class="fu">abs</span>(event1 <span class="sc">-</span> event2),</span>
<span id="cb155-54"><a href="run-rsa-searchlight.html#cb155-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">real_time_diff =</span> <span class="fu">abs</span>(real_time1 <span class="sc">-</span> real_time2)) <span class="sc">%&gt;%</span></span>
<span id="cb155-55"><a href="run-rsa-searchlight.html#cb155-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-56"><a href="run-rsa-searchlight.html#cb155-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># z-score the time metric predictors</span></span>
<span id="cb155-57"><a href="run-rsa-searchlight.html#cb155-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_at</span>(</span>
<span id="cb155-58"><a href="run-rsa-searchlight.html#cb155-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;vir_time_diff&quot;</span>, <span class="st">&quot;order_diff&quot;</span>, <span class="st">&quot;real_time_diff&quot;</span>), scale)</span>
<span id="cb155-59"><a href="run-rsa-searchlight.html#cb155-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-60"><a href="run-rsa-searchlight.html#cb155-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write to file</span></span>
<span id="cb155-61"><a href="run-rsa-searchlight.html#cb155-61" aria-hidden="true" tabindex="-1"></a>  out_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;rsa_predictions&quot;</span>)</span>
<span id="cb155-62"><a href="run-rsa-searchlight.html#cb155-62" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)){<span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb155-63"><a href="run-rsa-searchlight.html#cb155-63" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_rsa_info.txt&quot;</span>, i_sub))</span>
<span id="cb155-64"><a href="run-rsa-searchlight.html#cb155-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(pair_dat, <span class="at">file =</span> fn)</span>
<span id="cb155-65"><a href="run-rsa-searchlight.html#cb155-65" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="create-lookup-table-for-searchlight" class="section level3 unnumbered">
<h3>Create lookup table for searchlight</h3>
<p>As a first step, we prepare a table that - for each individual sphere - holds the coordinates of the voxels making up the search spheres. To find these voxels we rely on both a brain mask and a gray matter mask obtained during preprocessing. The brain mask is combined across the 10 preprocessing blocks and all voxels within this brain mask can be sphere centers. We get the coordinates of voxels around these sphere centers given the desired radius. Then, we exclude the non-gray matter voxels from the spheres. We check which spheres still contain the minimum number of voxels (do this here to speed up the subsequent computations) and discard the spheres that don’t hold enough voxels, e.g. because they are in white matter or on the edge of the brain/field of view.</p>
<p>We split this table into chunks to speed up the calculations and save the chunked lookup-tables for later use. To be able to relate the rows of the table (each row is a sphere) back to the brain, we create a nifti image that numbers all voxels which are sphere centers. These numbers correspond to the row names of the lookup table and will later be used to map the RSA results of each sphere back to the brain.</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="run-rsa-searchlight.html#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up dataframe</span></span>
<span id="cb156-2"><a href="run-rsa-searchlight.html#cb156-2" aria-hidden="true" tabindex="-1"></a>in_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">subject =</span> subjects)</span>
<span id="cb156-3"><a href="run-rsa-searchlight.html#cb156-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-4"><a href="run-rsa-searchlight.html#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="co"># how many chunks to run the analysis in for each</span></span>
<span id="cb156-5"><a href="run-rsa-searchlight.html#cb156-5" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>n_chunks <span class="ot">&lt;-</span> n_chunks</span>
<span id="cb156-6"><a href="run-rsa-searchlight.html#cb156-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-7"><a href="run-rsa-searchlight.html#cb156-7" aria-hidden="true" tabindex="-1"></a><span class="co"># input files with relevant functional volumes</span></span>
<span id="cb156-8"><a href="run-rsa-searchlight.html#cb156-8" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>rel_vol_pre_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;rel_vols_4D&quot;</span>, </span>
<span id="cb156-9"><a href="run-rsa-searchlight.html#cb156-9" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">sprintf</span>(<span class="st">&quot;%s_run%02d_rel_vols.nii.gz&quot;</span>, subjects, <span class="dv">1</span>)) </span>
<span id="cb156-10"><a href="run-rsa-searchlight.html#cb156-10" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>rel_vol_post_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;rel_vols_4D&quot;</span>, </span>
<span id="cb156-11"><a href="run-rsa-searchlight.html#cb156-11" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">sprintf</span>(<span class="st">&quot;%s_run%02d_rel_vols.nii.gz&quot;</span>, subjects, <span class="dv">2</span>)) </span>
<span id="cb156-12"><a href="run-rsa-searchlight.html#cb156-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-13"><a href="run-rsa-searchlight.html#cb156-13" aria-hidden="true" tabindex="-1"></a><span class="co"># which voxels should be center voxels of spheres --&gt; typically brain mask</span></span>
<span id="cb156-14"><a href="run-rsa-searchlight.html#cb156-14" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>ctr_mask_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>samespace_dir, <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb156-15"><a href="run-rsa-searchlight.html#cb156-15" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_mask_perBlock.nii.gz&quot;</span>,</span>
<span id="cb156-16"><a href="run-rsa-searchlight.html#cb156-16" aria-hidden="true" tabindex="-1"></a>                                       subjects))</span>
<span id="cb156-17"><a href="run-rsa-searchlight.html#cb156-17" aria-hidden="true" tabindex="-1"></a><span class="co"># which voxels should be used for correlations --&gt; typically graymatter mask</span></span>
<span id="cb156-18"><a href="run-rsa-searchlight.html#cb156-18" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>feat_mask_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>samespace_dir, <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb156-19"><a href="run-rsa-searchlight.html#cb156-19" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">sprintf</span>(<span class="st">&quot;VIRTEM_P%s_common_graymatter_mask_brainmasked.nii.gz&quot;</span>,</span>
<span id="cb156-20"><a href="run-rsa-searchlight.html#cb156-20" aria-hidden="true" tabindex="-1"></a>                                       subjects))</span>
<span id="cb156-21"><a href="run-rsa-searchlight.html#cb156-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-22"><a href="run-rsa-searchlight.html#cb156-22" aria-hidden="true" tabindex="-1"></a><span class="co"># radius of spheres</span></span>
<span id="cb156-23"><a href="run-rsa-searchlight.html#cb156-23" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>radius <span class="ot">&lt;-</span> radius</span>
<span id="cb156-24"><a href="run-rsa-searchlight.html#cb156-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-25"><a href="run-rsa-searchlight.html#cb156-25" aria-hidden="true" tabindex="-1"></a><span class="co"># where to store outputs</span></span>
<span id="cb156-26"><a href="run-rsa-searchlight.html#cb156-26" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>out_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="fu">sprintf</span>(<span class="st">&quot;first_level_%dvox_radius&quot;</span>, radius), subjects)</span>
<span id="cb156-27"><a href="run-rsa-searchlight.html#cb156-27" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>chunk_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(in_df<span class="sc">$</span>out_path, <span class="st">&quot;chunks&quot;</span>)</span>
<span id="cb156-28"><a href="run-rsa-searchlight.html#cb156-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-29"><a href="run-rsa-searchlight.html#cb156-29" aria-hidden="true" tabindex="-1"></a>prepare_searchlight_lut <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">in_df =</span> in_df[<span class="dv">1</span>,]){</span>
<span id="cb156-30"><a href="run-rsa-searchlight.html#cb156-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-31"><a href="run-rsa-searchlight.html#cb156-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(in_df<span class="sc">$</span>out_path)){<span class="fu">dir.create</span>(in_df<span class="sc">$</span>out_path, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb156-32"><a href="run-rsa-searchlight.html#cb156-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(in_df<span class="sc">$</span>chunk_path)){<span class="fu">dir.create</span>(in_df<span class="sc">$</span>chunk_path, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb156-33"><a href="run-rsa-searchlight.html#cb156-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-34"><a href="run-rsa-searchlight.html#cb156-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the mask with voxels that will be sphere centers (typically brain mask)</span></span>
<span id="cb156-35"><a href="run-rsa-searchlight.html#cb156-35" aria-hidden="true" tabindex="-1"></a>  ctr_mask_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI</span>(in_df<span class="sc">$</span>ctr_mask_fn, <span class="at">reorient=</span><span class="cn">FALSE</span>)</span>
<span id="cb156-36"><a href="run-rsa-searchlight.html#cb156-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all.equal</span>(<span class="fu">unique</span>(<span class="fu">c</span>(<span class="fu">img_data</span>(ctr_mask_nii))), <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))){</span>
<span id="cb156-37"><a href="run-rsa-searchlight.html#cb156-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;center mask not binary!&quot;</span>)}</span>
<span id="cb156-38"><a href="run-rsa-searchlight.html#cb156-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-39"><a href="run-rsa-searchlight.html#cb156-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the mask with voxels that will be the features used for correlations</span></span>
<span id="cb156-40"><a href="run-rsa-searchlight.html#cb156-40" aria-hidden="true" tabindex="-1"></a>  feat_mask_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI</span>(in_df<span class="sc">$</span>feat_mask_fn, <span class="at">reorient=</span><span class="cn">FALSE</span>)</span>
<span id="cb156-41"><a href="run-rsa-searchlight.html#cb156-41" aria-hidden="true" tabindex="-1"></a>  feat_mask_array <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">dim</span>(feat_mask_nii))</span>
<span id="cb156-42"><a href="run-rsa-searchlight.html#cb156-42" aria-hidden="true" tabindex="-1"></a>  feat_mask_array[feat_mask_nii <span class="sc">&gt;</span> <span class="fl">0.7</span> ] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb156-43"><a href="run-rsa-searchlight.html#cb156-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all.equal</span>(<span class="fu">unique</span>(<span class="fu">c</span>(feat_mask_array)), <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))){</span>
<span id="cb156-44"><a href="run-rsa-searchlight.html#cb156-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;make sure feature mask is binary!&quot;</span>)}</span>
<span id="cb156-45"><a href="run-rsa-searchlight.html#cb156-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-46"><a href="run-rsa-searchlight.html#cb156-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make sure mask dimensions match functional images and each other</span></span>
<span id="cb156-47"><a href="run-rsa-searchlight.html#cb156-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all.equal</span>(<span class="fu">dim</span>(ctr_mask_nii), <span class="fu">dim</span>(feat_mask_array))){</span>
<span id="cb156-48"><a href="run-rsa-searchlight.html#cb156-48" aria-hidden="true" tabindex="-1"></a>       <span class="fu">stop</span>(<span class="st">&quot;mask dimensions don&#39;t match each other!&quot;</span>)}</span>
<span id="cb156-49"><a href="run-rsa-searchlight.html#cb156-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-50"><a href="run-rsa-searchlight.html#cb156-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># find all the voxel coordinates that will be sphere centers</span></span>
<span id="cb156-51"><a href="run-rsa-searchlight.html#cb156-51" aria-hidden="true" tabindex="-1"></a>  ctr_inds <span class="ot">&lt;-</span> <span class="fu">which</span>(ctr_mask_nii <span class="sc">!=</span> <span class="dv">0</span>, <span class="at">arr.ind=</span><span class="cn">TRUE</span>) <span class="co"># inds has subscripts for 3D coords of center voxels</span></span>
<span id="cb156-52"><a href="run-rsa-searchlight.html#cb156-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">ncol</span>(ctr_inds) <span class="sc">!=</span> <span class="dv">3</span>) { <span class="fu">stop</span>(<span class="st">&#39;wrong dims on inds&#39;</span>)}</span>
<span id="cb156-53"><a href="run-rsa-searchlight.html#cb156-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-54"><a href="run-rsa-searchlight.html#cb156-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3D array with voxel numbers to save for future reference</span></span>
<span id="cb156-55"><a href="run-rsa-searchlight.html#cb156-55" aria-hidden="true" tabindex="-1"></a>  vox_num_array <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">dim</span>(ctr_mask_nii))  <span class="co"># make a blank 3d matrix &#39;brain&#39;, all zeros</span></span>
<span id="cb156-56"><a href="run-rsa-searchlight.html#cb156-56" aria-hidden="true" tabindex="-1"></a>  vox_num_array[ctr_inds] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ctr_inds)  <span class="co"># and put integers into the voxel places</span></span>
<span id="cb156-57"><a href="run-rsa-searchlight.html#cb156-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-58"><a href="run-rsa-searchlight.html#cb156-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create nifti with same header info as input data</span></span>
<span id="cb156-59"><a href="run-rsa-searchlight.html#cb156-59" aria-hidden="true" tabindex="-1"></a>  vox_num_nii <span class="ot">&lt;-</span> <span class="fu">copyNIfTIHeader</span>(<span class="at">img =</span> ctr_mask_nii, <span class="at">arr =</span> vox_num_array)</span>
<span id="cb156-60"><a href="run-rsa-searchlight.html#cb156-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_nifti</span>(vox_num_nii, <span class="fu">file.path</span>(in_df<span class="sc">$</span>out_path, <span class="st">&quot;vox_num&quot;</span>))    <span class="co"># write out as a NIfTI image</span></span>
<span id="cb156-61"><a href="run-rsa-searchlight.html#cb156-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-62"><a href="run-rsa-searchlight.html#cb156-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the search sphere 3D subscripts</span></span>
<span id="cb156-63"><a href="run-rsa-searchlight.html#cb156-63" aria-hidden="true" tabindex="-1"></a>  sphere_coords <span class="ot">&lt;-</span> <span class="fu">searchlight</span>(radius)</span>
<span id="cb156-64"><a href="run-rsa-searchlight.html#cb156-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-65"><a href="run-rsa-searchlight.html#cb156-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># actually fill up the lookup table. This goes through every voxel, so can take some time.</span></span>
<span id="cb156-66"><a href="run-rsa-searchlight.html#cb156-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the table will hold the sphere indices for each center voxel</span></span>
<span id="cb156-67"><a href="run-rsa-searchlight.html#cb156-67" aria-hidden="true" tabindex="-1"></a>  lookup_tbl <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="fu">c</span>(<span class="fu">nrow</span>(ctr_inds), <span class="fu">ncol</span>(sphere_coords)))  </span>
<span id="cb156-68"><a href="run-rsa-searchlight.html#cb156-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(lookup_tbl) <span class="ot">&lt;-</span> vox_num_nii[ctr_inds]</span>
<span id="cb156-69"><a href="run-rsa-searchlight.html#cb156-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ctr_inds)) {    <span class="co"># i &lt;- 1</span></span>
<span id="cb156-70"><a href="run-rsa-searchlight.html#cb156-70" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-71"><a href="run-rsa-searchlight.html#cb156-71" aria-hidden="true" tabindex="-1"></a>      <span class="co"># add the sphere coordinates to the current voxel coordinates</span></span>
<span id="cb156-72"><a href="run-rsa-searchlight.html#cb156-72" aria-hidden="true" tabindex="-1"></a>      curr_sphere <span class="ot">&lt;-</span> <span class="fu">t</span>(ctr_inds[i,] <span class="sc">+</span> sphere_coords)</span>
<span id="cb156-73"><a href="run-rsa-searchlight.html#cb156-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-74"><a href="run-rsa-searchlight.html#cb156-74" aria-hidden="true" tabindex="-1"></a>      <span class="co"># remove voxels that are out of bounds (i.e. out of image dimensions)    </span></span>
<span id="cb156-75"><a href="run-rsa-searchlight.html#cb156-75" aria-hidden="true" tabindex="-1"></a>      dims <span class="ot">&lt;-</span> <span class="fu">dim</span>(vox_num_array)</span>
<span id="cb156-76"><a href="run-rsa-searchlight.html#cb156-76" aria-hidden="true" tabindex="-1"></a>      curr_sphere[<span class="fu">which</span>(curr_sphere[,<span class="dv">1</span>]<span class="sc">&gt;</span>dims[<span class="dv">1</span>]),] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb156-77"><a href="run-rsa-searchlight.html#cb156-77" aria-hidden="true" tabindex="-1"></a>      curr_sphere[<span class="fu">which</span>(curr_sphere[,<span class="dv">2</span>]<span class="sc">&gt;</span>dims[<span class="dv">2</span>]),] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb156-78"><a href="run-rsa-searchlight.html#cb156-78" aria-hidden="true" tabindex="-1"></a>      curr_sphere[<span class="fu">which</span>(curr_sphere[,<span class="dv">3</span>]<span class="sc">&gt;</span>dims[<span class="dv">3</span>]),] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb156-79"><a href="run-rsa-searchlight.html#cb156-79" aria-hidden="true" tabindex="-1"></a>      curr_sphere[<span class="fu">which</span>(curr_sphere[,<span class="dv">1</span>]<span class="sc">&lt;</span><span class="dv">1</span>),] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb156-80"><a href="run-rsa-searchlight.html#cb156-80" aria-hidden="true" tabindex="-1"></a>      curr_sphere[<span class="fu">which</span>(curr_sphere[,<span class="dv">2</span>]<span class="sc">&lt;</span><span class="dv">1</span>),] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb156-81"><a href="run-rsa-searchlight.html#cb156-81" aria-hidden="true" tabindex="-1"></a>      curr_sphere[<span class="fu">which</span>(curr_sphere[,<span class="dv">3</span>]<span class="sc">&lt;</span><span class="dv">1</span>),] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb156-82"><a href="run-rsa-searchlight.html#cb156-82" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-83"><a href="run-rsa-searchlight.html#cb156-83" aria-hidden="true" tabindex="-1"></a>      <span class="co"># remove voxels that are not in the feature mask</span></span>
<span id="cb156-84"><a href="run-rsa-searchlight.html#cb156-84" aria-hidden="true" tabindex="-1"></a>      curr_sphere[<span class="sc">!</span>feat_mask_array[curr_sphere],] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb156-85"><a href="run-rsa-searchlight.html#cb156-85" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-86"><a href="run-rsa-searchlight.html#cb156-86" aria-hidden="true" tabindex="-1"></a>      <span class="co"># store the voxel numbers for this sphere</span></span>
<span id="cb156-87"><a href="run-rsa-searchlight.html#cb156-87" aria-hidden="true" tabindex="-1"></a>      vox.id <span class="ot">&lt;-</span> vox_num_array[ctr_inds[i,<span class="dv">1</span>], ctr_inds[i,<span class="dv">2</span>], ctr_inds[i,<span class="dv">3</span>]]</span>
<span id="cb156-88"><a href="run-rsa-searchlight.html#cb156-88" aria-hidden="true" tabindex="-1"></a>      lookup_tbl[vox.id,] <span class="ot">&lt;-</span> vox_num_array[curr_sphere]</span>
<span id="cb156-89"><a href="run-rsa-searchlight.html#cb156-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb156-90"><a href="run-rsa-searchlight.html#cb156-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-91"><a href="run-rsa-searchlight.html#cb156-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># replace the zeroes with NA so can sort better at runtime</span></span>
<span id="cb156-92"><a href="run-rsa-searchlight.html#cb156-92" aria-hidden="true" tabindex="-1"></a>  to_remove <span class="ot">&lt;-</span> <span class="fu">which</span>(lookup_tbl <span class="sc">==</span> <span class="dv">0</span>, <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb156-93"><a href="run-rsa-searchlight.html#cb156-93" aria-hidden="true" tabindex="-1"></a>  lookup_tbl[to_remove] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb156-94"><a href="run-rsa-searchlight.html#cb156-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-95"><a href="run-rsa-searchlight.html#cb156-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove rows that don&#39;t have the minimum amount of voxels (do this here because this speeds up all later computations)</span></span>
<span id="cb156-96"><a href="run-rsa-searchlight.html#cb156-96" aria-hidden="true" tabindex="-1"></a>  lookup_tbl <span class="ot">&lt;-</span> lookup_tbl[<span class="fu">rowSums</span>(<span class="sc">!</span><span class="fu">is.na</span>(lookup_tbl)) <span class="sc">&gt;</span> min_voxels,]</span>
<span id="cb156-97"><a href="run-rsa-searchlight.html#cb156-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-98"><a href="run-rsa-searchlight.html#cb156-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write the table, gzipped to save file size</span></span>
<span id="cb156-99"><a href="run-rsa-searchlight.html#cb156-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(lookup_tbl, <span class="fu">gzfile</span>(<span class="fu">file.path</span>(in_df<span class="sc">$</span>out_path, <span class="fu">sprintf</span>(<span class="st">&quot;lookup_radius%d&quot;</span>, in_df<span class="sc">$</span>radius, <span class="st">&quot;.txt.gz&quot;</span>))), <span class="at">row.names =</span> <span class="cn">TRUE</span>)   </span>
<span id="cb156-100"><a href="run-rsa-searchlight.html#cb156-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-101"><a href="run-rsa-searchlight.html#cb156-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># vector to split lookupt table into chunks (last chunk will be slightly smaller)</span></span>
<span id="cb156-102"><a href="run-rsa-searchlight.html#cb156-102" aria-hidden="true" tabindex="-1"></a>  r  <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>in_df<span class="sc">$</span>n_chunks,<span class="at">each=</span><span class="fu">ceiling</span>(<span class="fu">nrow</span>(lookup_tbl)<span class="sc">/</span>in_df<span class="sc">$</span>n_chunks))[<span class="dv">1</span><span class="sc">:</span> <span class="fu">nrow</span>(lookup_tbl)]</span>
<span id="cb156-103"><a href="run-rsa-searchlight.html#cb156-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-104"><a href="run-rsa-searchlight.html#cb156-104" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_chunk <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>in_df<span class="sc">$</span>n_chunks){</span>
<span id="cb156-105"><a href="run-rsa-searchlight.html#cb156-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-106"><a href="run-rsa-searchlight.html#cb156-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extract current chunk and write to file</span></span>
<span id="cb156-107"><a href="run-rsa-searchlight.html#cb156-107" aria-hidden="true" tabindex="-1"></a>    curr_chunk <span class="ot">&lt;-</span> lookup_tbl[r <span class="sc">==</span> i_chunk,]</span>
<span id="cb156-108"><a href="run-rsa-searchlight.html#cb156-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.table</span>(curr_chunk, </span>
<span id="cb156-109"><a href="run-rsa-searchlight.html#cb156-109" aria-hidden="true" tabindex="-1"></a>                <span class="fu">gzfile</span>(<span class="fu">file.path</span>(in_df<span class="sc">$</span>chunk_path,</span>
<span id="cb156-110"><a href="run-rsa-searchlight.html#cb156-110" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">sprintf</span>(<span class="st">&quot;lookup_radius%d_chunk_%02d.txt.gz&quot;</span>, in_df<span class="sc">$</span>radius, i_chunk))), </span>
<span id="cb156-111"><a href="run-rsa-searchlight.html#cb156-111" aria-hidden="true" tabindex="-1"></a>                <span class="at">row.names =</span> <span class="cn">TRUE</span>)   </span>
<span id="cb156-112"><a href="run-rsa-searchlight.html#cb156-112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb156-113"><a href="run-rsa-searchlight.html#cb156-113" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb156-114"><a href="run-rsa-searchlight.html#cb156-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-115"><a href="run-rsa-searchlight.html#cb156-115" aria-hidden="true" tabindex="-1"></a><span class="co"># run for all datasets</span></span>
<span id="cb156-116"><a href="run-rsa-searchlight.html#cb156-116" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(in_df)){</span>
<span id="cb156-117"><a href="run-rsa-searchlight.html#cb156-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prepare_searchlight_lut</span>(<span class="at">in_df =</span> in_df[i,])</span>
<span id="cb156-118"><a href="run-rsa-searchlight.html#cb156-118" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We want to create some diagnostic images of the spheres we created to make sure the resulting search spheres look as expected.<br />
For this a random subject is picked and a number of random spheres is plotted on the gray matter mask.</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="run-rsa-searchlight.html#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pick random subject</span></span>
<span id="cb157-2"><a href="run-rsa-searchlight.html#cb157-2" aria-hidden="true" tabindex="-1"></a>rand_sub <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n_subs)[<span class="dv">1</span>]</span>
<span id="cb157-3"><a href="run-rsa-searchlight.html#cb157-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-4"><a href="run-rsa-searchlight.html#cb157-4" aria-hidden="true" tabindex="-1"></a><span class="co"># read their lookup-table</span></span>
<span id="cb157-5"><a href="run-rsa-searchlight.html#cb157-5" aria-hidden="true" tabindex="-1"></a>lookup_tbl<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="fu">gzfile</span>(</span>
<span id="cb157-6"><a href="run-rsa-searchlight.html#cb157-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(in_df<span class="sc">$</span>out_path[rand_sub], </span>
<span id="cb157-7"><a href="run-rsa-searchlight.html#cb157-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sprintf</span>(<span class="st">&quot;lookup_radius%d&quot;</span>, in_df<span class="sc">$</span>radius[rand_sub], <span class="st">&quot;.txt.gz&quot;</span>))))   </span>
<span id="cb157-8"><a href="run-rsa-searchlight.html#cb157-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-9"><a href="run-rsa-searchlight.html#cb157-9" aria-hidden="true" tabindex="-1"></a><span class="co"># load their graymatter mask and the nifti linking indices</span></span>
<span id="cb157-10"><a href="run-rsa-searchlight.html#cb157-10" aria-hidden="true" tabindex="-1"></a>gm_mask_nii <span class="ot">&lt;-</span> in_df[rand_sub,]<span class="sc">$</span>feat_mask_fn <span class="sc">%&gt;%</span> <span class="fu">readNIfTI2</span>()</span>
<span id="cb157-11"><a href="run-rsa-searchlight.html#cb157-11" aria-hidden="true" tabindex="-1"></a>vox_num_nii <span class="ot">&lt;-</span> <span class="fu">file.path</span>(in_df<span class="sc">$</span>out_path[rand_sub], <span class="st">&quot;vox_num.nii.gz&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">readNIfTI2</span>()</span>
<span id="cb157-12"><a href="run-rsa-searchlight.html#cb157-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-13"><a href="run-rsa-searchlight.html#cb157-13" aria-hidden="true" tabindex="-1"></a><span class="co"># pick 10 searchlights to plot at random</span></span>
<span id="cb157-14"><a href="run-rsa-searchlight.html#cb157-14" aria-hidden="true" tabindex="-1"></a>do.searchlights <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(lookup_tbl))[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb157-15"><a href="run-rsa-searchlight.html#cb157-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-16"><a href="run-rsa-searchlight.html#cb157-16" aria-hidden="true" tabindex="-1"></a><span class="co"># make a blank 3d matrix &#39;brain&#39; to put the searchlights into</span></span>
<span id="cb157-17"><a href="run-rsa-searchlight.html#cb157-17" aria-hidden="true" tabindex="-1"></a>sphere_test_array <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">dim</span>(gm_mask_nii))</span>
<span id="cb157-18"><a href="run-rsa-searchlight.html#cb157-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-19"><a href="run-rsa-searchlight.html#cb157-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(do.searchlights)) {    <span class="co"># i &lt;- 1</span></span>
<span id="cb157-20"><a href="run-rsa-searchlight.html#cb157-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-21"><a href="run-rsa-searchlight.html#cb157-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># voxels of this example sphere</span></span>
<span id="cb157-22"><a href="run-rsa-searchlight.html#cb157-22" aria-hidden="true" tabindex="-1"></a>    voxs <span class="ot">&lt;-</span> <span class="fu">unlist</span>(lookup_tbl[do.searchlights[i],], <span class="at">use.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb157-23"><a href="run-rsa-searchlight.html#cb157-23" aria-hidden="true" tabindex="-1"></a>    voxs <span class="ot">&lt;-</span> voxs[<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(voxs))]  <span class="co"># get rid of NAs</span></span>
<span id="cb157-24"><a href="run-rsa-searchlight.html#cb157-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">sprintf</span>(<span class="st">&#39;sphere %02d: %d voxels&#39;</span>, i, <span class="fu">length</span>(voxs)))</span>
<span id="cb157-25"><a href="run-rsa-searchlight.html#cb157-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-26"><a href="run-rsa-searchlight.html#cb157-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># put integers into the sphere test array for each searchlight</span></span>
<span id="cb157-27"><a href="run-rsa-searchlight.html#cb157-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(voxs)) {    <span class="co"># j &lt;- 1</span></span>
<span id="cb157-28"><a href="run-rsa-searchlight.html#cb157-28" aria-hidden="true" tabindex="-1"></a>        coords <span class="ot">&lt;-</span> <span class="fu">which</span>(vox_num_nii <span class="sc">==</span> voxs[j], <span class="at">arr.ind=</span><span class="cn">TRUE</span>)   <span class="co"># location of this voxel</span></span>
<span id="cb157-29"><a href="run-rsa-searchlight.html#cb157-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">ncol</span>(coords) <span class="sc">!=</span> <span class="dv">3</span> <span class="sc">|</span> <span class="fu">nrow</span>(coords) <span class="sc">!=</span> <span class="dv">1</span>) { <span class="fu">stop</span>(<span class="st">&quot;wrong sized coords&quot;</span>)}</span>
<span id="cb157-30"><a href="run-rsa-searchlight.html#cb157-30" aria-hidden="true" tabindex="-1"></a>        sphere_test_array[coords[<span class="dv">1</span>], coords[<span class="dv">2</span>], coords[<span class="dv">3</span>]] <span class="ot">&lt;-</span> i   <span class="co"># assign this voxel the searchlight number</span></span>
<span id="cb157-31"><a href="run-rsa-searchlight.html#cb157-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb157-32"><a href="run-rsa-searchlight.html#cb157-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb157-33"><a href="run-rsa-searchlight.html#cb157-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># visualize the sphere at the most frequent coordinate</span></span>
<span id="cb157-34"><a href="run-rsa-searchlight.html#cb157-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ortho2</span>(gm_mask_nii, <span class="at">y=</span>sphere_test_array<span class="sc">==</span>i, <span class="at">col.y =</span> <span class="st">&quot;red&quot;</span>,  <span class="at">col.crosshairs =</span> <span class="st">&quot;lightgrey&quot;</span>,</span>
<span id="cb157-35"><a href="run-rsa-searchlight.html#cb157-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">xyz =</span> <span class="fu">c</span>(statip<span class="sc">::</span><span class="fu">mfv1</span>(<span class="fu">which</span>(sphere_test_array<span class="sc">==</span>i, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[,<span class="dv">1</span>]),</span>
<span id="cb157-36"><a href="run-rsa-searchlight.html#cb157-36" aria-hidden="true" tabindex="-1"></a>                 statip<span class="sc">::</span><span class="fu">mfv1</span>(<span class="fu">which</span>(sphere_test_array<span class="sc">==</span>i, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[,<span class="dv">2</span>]),</span>
<span id="cb157-37"><a href="run-rsa-searchlight.html#cb157-37" aria-hidden="true" tabindex="-1"></a>                 statip<span class="sc">::</span><span class="fu">mfv1</span>(<span class="fu">which</span>(sphere_test_array<span class="sc">==</span>i, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[,<span class="dv">3</span>])))</span>
<span id="cb157-38"><a href="run-rsa-searchlight.html#cb157-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb157-39"><a href="run-rsa-searchlight.html#cb157-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-40"><a href="run-rsa-searchlight.html#cb157-40" aria-hidden="true" tabindex="-1"></a><span class="co"># create nifti with same header info as input data and save</span></span>
<span id="cb157-41"><a href="run-rsa-searchlight.html#cb157-41" aria-hidden="true" tabindex="-1"></a>sphere_test_nii <span class="ot">=</span> <span class="fu">copyNIfTIHeader</span>(<span class="at">img =</span> gm_mask_nii, <span class="at">arr =</span> sphere_test_array)</span>
<span id="cb157-42"><a href="run-rsa-searchlight.html#cb157-42" aria-hidden="true" tabindex="-1"></a><span class="fu">write_nifti</span>(sphere_test_nii, </span>
<span id="cb157-43"><a href="run-rsa-searchlight.html#cb157-43" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, </span>
<span id="cb157-44"><a href="run-rsa-searchlight.html#cb157-44" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;first_level_%dvox_radius&quot;</span>, radius), </span>
<span id="cb157-45"><a href="run-rsa-searchlight.html#cb157-45" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;sphere_test_sub%s&quot;</span>, rand_sub)))    </span></code></pre></div>
</div>
<div id="dataframe-with-input-for-analysis" class="section level3 unnumbered">
<h3>Dataframe with input for analysis</h3>
<p>We start by preparing a data frame with one line for each chunk of each subject. The entries define the files to be used for this chunk and some basic analysis parameters. The function to be defined subsequently takes one row of this data frame as input.</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="run-rsa-searchlight.html#cb158-1" aria-hidden="true" tabindex="-1"></a>in_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">subject =</span> <span class="fu">rep</span>(subjects, <span class="at">each=</span>n_chunks))</span>
<span id="cb158-2"><a href="run-rsa-searchlight.html#cb158-2" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>chunk <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_chunks, <span class="fu">length</span>(subjects))</span>
<span id="cb158-3"><a href="run-rsa-searchlight.html#cb158-3" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>lut_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="fu">sprintf</span>(<span class="st">&quot;first_level_%dvox_radius&quot;</span>, radius), <span class="fu">rep</span>(subjects, <span class="at">each=</span>n_chunks), </span>
<span id="cb158-4"><a href="run-rsa-searchlight.html#cb158-4" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;chunks&quot;</span>, <span class="fu">sprintf</span>(<span class="st">&quot;lookup_radius%d_chunk_%02d.txt.gz&quot;</span>, </span>
<span id="cb158-5"><a href="run-rsa-searchlight.html#cb158-5" aria-hidden="true" tabindex="-1"></a>                                              radius, <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_chunks, <span class="fu">length</span>(subjects))))</span>
<span id="cb158-6"><a href="run-rsa-searchlight.html#cb158-6" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>pred_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;rsa_predictions&quot;</span>, </span>
<span id="cb158-7"><a href="run-rsa-searchlight.html#cb158-7" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">sprintf</span>(<span class="st">&quot;%s_rsa_info.txt&quot;</span>, <span class="fu">rep</span>(subjects, <span class="at">each=</span>n_chunks)))</span>
<span id="cb158-8"><a href="run-rsa-searchlight.html#cb158-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-9"><a href="run-rsa-searchlight.html#cb158-9" aria-hidden="true" tabindex="-1"></a><span class="co"># input files with relevant functional volumes</span></span>
<span id="cb158-10"><a href="run-rsa-searchlight.html#cb158-10" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>rel_vol_pre_fn <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;rel_vols_4D&quot;</span>,</span>
<span id="cb158-11"><a href="run-rsa-searchlight.html#cb158-11" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">sprintf</span>(<span class="st">&quot;%s_run%02d_rel_vols.nii.gz&quot;</span>, </span>
<span id="cb158-12"><a href="run-rsa-searchlight.html#cb158-12" aria-hidden="true" tabindex="-1"></a>                                              subjects, <span class="dv">1</span>)), <span class="at">each =</span> n_chunks) </span>
<span id="cb158-13"><a href="run-rsa-searchlight.html#cb158-13" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>rel_vol_post_fn <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;rel_vols_4D&quot;</span>,</span>
<span id="cb158-14"><a href="run-rsa-searchlight.html#cb158-14" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">sprintf</span>(<span class="st">&quot;%s_run%02d_rel_vols.nii.gz&quot;</span>, </span>
<span id="cb158-15"><a href="run-rsa-searchlight.html#cb158-15" aria-hidden="true" tabindex="-1"></a>                                               subjects, <span class="dv">2</span>)), <span class="at">each =</span> n_chunks) </span>
<span id="cb158-16"><a href="run-rsa-searchlight.html#cb158-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-17"><a href="run-rsa-searchlight.html#cb158-17" aria-hidden="true" tabindex="-1"></a><span class="co"># file to use to bring data back into brain shape</span></span>
<span id="cb158-18"><a href="run-rsa-searchlight.html#cb158-18" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>vox_num_fn <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="fu">sprintf</span>(<span class="st">&quot;first_level_%dvox_radius&quot;</span>, radius), subjects, <span class="st">&quot;vox_num.nii.gz&quot;</span>), <span class="at">each =</span> n_chunks)</span>
<span id="cb158-19"><a href="run-rsa-searchlight.html#cb158-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-20"><a href="run-rsa-searchlight.html#cb158-20" aria-hidden="true" tabindex="-1"></a><span class="co"># output directory</span></span>
<span id="cb158-21"><a href="run-rsa-searchlight.html#cb158-21" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>out_path <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="fu">sprintf</span>(<span class="st">&quot;first_level_%dvox_radius&quot;</span>, radius), subjects, <span class="st">&quot;chunks&quot;</span>), <span class="at">each =</span> n_chunks)</span>
<span id="cb158-22"><a href="run-rsa-searchlight.html#cb158-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-23"><a href="run-rsa-searchlight.html#cb158-23" aria-hidden="true" tabindex="-1"></a><span class="co"># minimum number of features</span></span>
<span id="cb158-24"><a href="run-rsa-searchlight.html#cb158-24" aria-hidden="true" tabindex="-1"></a>in_df<span class="sc">$</span>min_voxels <span class="ot">&lt;-</span> min_voxels</span>
<span id="cb158-25"><a href="run-rsa-searchlight.html#cb158-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-26"><a href="run-rsa-searchlight.html#cb158-26" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(in_df)</span></code></pre></div>
</div>
<div id="searchlight-implementation" class="section level3 unnumbered">
<h3>Searchlight implementation</h3>
<p>Here, we define the function that implements RSA within each searchlight. The logic of running the searchlight analysis via the look-up table is inspired by and partly based on <a href="http://mvpa.blogspot.com/2014/01/demo-r-code-to-perform-searchlight.html">this blogpost</a> by Joset A. Etzel and <a href="https://www.dropbox.com/s/qon127nu8ni1zaq/searchlightDemo_spherical.R?dl=0">the code</a> accompanying it.</p>
<blockquote>
<p>For each search sphere, we implemented linear models to quantify the relationship between representational change and the learned temporal structure. Specifically, we assessed the relationship of pattern similarity change and absolute virtual temporal distances, separately for event pairs from the same sequences and from pairs from different sequences. In a third model, we included all event pairs and tested for an interaction effect of a sequence (same or different) predictor and virtual temporal distances. The t-values of the respective regressors of interest were stored at the center voxel of a given search sphere.</p>
</blockquote>
<p>The function goes through the same steps as the ROI-based analysis. First, the data of the voxels in each sphere is extracted. The resulting multi-voxel patterns are correlated between picture presentations to yield a trial-by-trial (200-by-200) correlation matrix. For each pair of images, the trial-wise correlations (10-by-10) are averaged such that comparisons of trials from the same block are excluded (i.e. excluding the diagonal of the 10-by-10 squares). This results in the condition-by-condition similarity matrix (20-by-20), which is then subjected to further analysis based on the temporal structure of events. Specifically, linear models are implemented for the different analyses. The resulting t-values are stored at the location of the center voxels of the respective sphere. Thus, for each model we test, we end up with a nifti image that has t-values at the voxel locations of the current chunk.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="run-rsa-searchlight.html#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># FUNCTION DEFINITION</span></span>
<span id="cb159-2"><a href="run-rsa-searchlight.html#cb159-2" aria-hidden="true" tabindex="-1"></a>run_searchlight <span class="ot">&lt;-</span> <span class="cf">function</span>(in_df){ <span class="co">#in_df &lt;- in_df[1,]</span></span>
<span id="cb159-3"><a href="run-rsa-searchlight.html#cb159-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-4"><a href="run-rsa-searchlight.html#cb159-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">########## SET UP A FEW PARAMS</span></span>
<span id="cb159-5"><a href="run-rsa-searchlight.html#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sprintf</span>(<span class="st">&quot;working on: %s&quot;</span>, in_df<span class="sc">$</span>lut_file)</span>
<span id="cb159-6"><a href="run-rsa-searchlight.html#cb159-6" aria-hidden="true" tabindex="-1"></a>  n_pics <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb159-7"><a href="run-rsa-searchlight.html#cb159-7" aria-hidden="true" tabindex="-1"></a>  n_blocks <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb159-8"><a href="run-rsa-searchlight.html#cb159-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-9"><a href="run-rsa-searchlight.html#cb159-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for all 10x10 comparisons we will be averaging all comparisons apart from the diagonal</span></span>
<span id="cb159-10"><a href="run-rsa-searchlight.html#cb159-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># to exclude same_block comparisons</span></span>
<span id="cb159-11"><a href="run-rsa-searchlight.html#cb159-11" aria-hidden="true" tabindex="-1"></a>  no_diag <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="cn">TRUE</span>, <span class="at">nrow=</span>n_blocks, <span class="at">ncol=</span>n_blocks)</span>
<span id="cb159-12"><a href="run-rsa-searchlight.html#cb159-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">diag</span>(no_diag)<span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb159-13"><a href="run-rsa-searchlight.html#cb159-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-14"><a href="run-rsa-searchlight.html#cb159-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># indices to extract upper triangle excluding diagonal from pic-by-pic matrices</span></span>
<span id="cb159-15"><a href="run-rsa-searchlight.html#cb159-15" aria-hidden="true" tabindex="-1"></a>  triu_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">upper.tri</span>(<span class="fu">matrix</span>(<span class="cn">TRUE</span>, n_pics, n_pics), <span class="at">diag =</span> <span class="cn">FALSE</span>), <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)</span>
<span id="cb159-16"><a href="run-rsa-searchlight.html#cb159-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-17"><a href="run-rsa-searchlight.html#cb159-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-18"><a href="run-rsa-searchlight.html#cb159-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">########## LOAD THE DATA TO BE USED</span></span>
<span id="cb159-19"><a href="run-rsa-searchlight.html#cb159-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the data about the learned temporal relationships</span></span>
<span id="cb159-20"><a href="run-rsa-searchlight.html#cb159-20" aria-hidden="true" tabindex="-1"></a>  rsa_info <span class="ot">&lt;-</span> <span class="fu">read.table</span>(in_df<span class="sc">$</span>pred_file)  </span>
<span id="cb159-21"><a href="run-rsa-searchlight.html#cb159-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-22"><a href="run-rsa-searchlight.html#cb159-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># initialize dataframe to fill (later ps-change data will be added)</span></span>
<span id="cb159-23"><a href="run-rsa-searchlight.html#cb159-23" aria-hidden="true" tabindex="-1"></a>  pics <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">upper.tri</span>(<span class="fu">matrix</span>(<span class="cn">TRUE</span>, n_pics, n_pics), <span class="at">diag =</span> <span class="cn">FALSE</span>), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb159-24"><a href="run-rsa-searchlight.html#cb159-24" aria-hidden="true" tabindex="-1"></a>  rsa_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">pic1 =</span> pics[,<span class="dv">1</span>], <span class="at">pic2 =</span> pics[,<span class="dv">2</span>])</span>
<span id="cb159-25"><a href="run-rsa-searchlight.html#cb159-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-26"><a href="run-rsa-searchlight.html#cb159-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make sure the data frames have the same order    </span></span>
<span id="cb159-27"><a href="run-rsa-searchlight.html#cb159-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>(<span class="fu">all.equal</span>(rsa_df<span class="sc">$</span>pic1, rsa_info<span class="sc">$</span>pic1) <span class="sc">&amp;</span> <span class="fu">all.equal</span>(rsa_df<span class="sc">$</span>pic2, rsa_info<span class="sc">$</span>pic2))){</span>
<span id="cb159-28"><a href="run-rsa-searchlight.html#cb159-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&#39;order of data frames does not match [RSA preparations]&#39;</span>)}</span>
<span id="cb159-29"><a href="run-rsa-searchlight.html#cb159-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-30"><a href="run-rsa-searchlight.html#cb159-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># store the columns we need for RSA in the data frame</span></span>
<span id="cb159-31"><a href="run-rsa-searchlight.html#cb159-31" aria-hidden="true" tabindex="-1"></a>  rsa_df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(rsa_df, rsa_info[<span class="fu">names</span>(rsa_info) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;same_day&quot;</span>, <span class="st">&quot;same_day_dv&quot;</span>, </span>
<span id="cb159-32"><a href="run-rsa-searchlight.html#cb159-32" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;vir_time_diff&quot;</span>, <span class="st">&quot;order_diff&quot;</span>, </span>
<span id="cb159-33"><a href="run-rsa-searchlight.html#cb159-33" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;real_time_diff&quot;</span>)])</span>
<span id="cb159-34"><a href="run-rsa-searchlight.html#cb159-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-35"><a href="run-rsa-searchlight.html#cb159-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># read the look up table</span></span>
<span id="cb159-36"><a href="run-rsa-searchlight.html#cb159-36" aria-hidden="true" tabindex="-1"></a>  lookup_tbl <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">gzfile</span>(in_df<span class="sc">$</span>lut_file), <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb159-37"><a href="run-rsa-searchlight.html#cb159-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-38"><a href="run-rsa-searchlight.html#cb159-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># figure out which voxels to run in this chunk</span></span>
<span id="cb159-39"><a href="run-rsa-searchlight.html#cb159-39" aria-hidden="true" tabindex="-1"></a>  n_voxels <span class="ot">&lt;-</span> <span class="fu">nrow</span>(lookup_tbl)</span>
<span id="cb159-40"><a href="run-rsa-searchlight.html#cb159-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-41"><a href="run-rsa-searchlight.html#cb159-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># read the functional images (takes ~ 2 mins)</span></span>
<span id="cb159-42"><a href="run-rsa-searchlight.html#cb159-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;starting to load functional images&quot;</span>)</span>
<span id="cb159-43"><a href="run-rsa-searchlight.html#cb159-43" aria-hidden="true" tabindex="-1"></a>  func_nii_pre <span class="ot">&lt;-</span> <span class="fu">readNIfTI</span>(in_df<span class="sc">$</span>rel_vol_pre_fn, <span class="at">reorient=</span><span class="cn">FALSE</span>)</span>
<span id="cb159-44"><a href="run-rsa-searchlight.html#cb159-44" aria-hidden="true" tabindex="-1"></a>  func_nii_post <span class="ot">&lt;-</span> <span class="fu">readNIfTI</span>(in_df<span class="sc">$</span>rel_vol_post_fn, <span class="at">reorient=</span><span class="cn">FALSE</span>)</span>
<span id="cb159-45"><a href="run-rsa-searchlight.html#cb159-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">all.equal</span>(<span class="fu">dim</span>(func_nii_pre),<span class="fu">dim</span>(func_nii_post))){</span>
<span id="cb159-46"><a href="run-rsa-searchlight.html#cb159-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;functional images of different size!&quot;</span>)}<span class="co"># make sure inputs have same dimensions</span></span>
<span id="cb159-47"><a href="run-rsa-searchlight.html#cb159-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-48"><a href="run-rsa-searchlight.html#cb159-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the image with voxel numbers (linear subscripts) that will be used to sort back into brain shape</span></span>
<span id="cb159-49"><a href="run-rsa-searchlight.html#cb159-49" aria-hidden="true" tabindex="-1"></a>  vox_num_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI</span>(in_df<span class="sc">$</span>vox_num_fn, <span class="at">reorient=</span><span class="cn">FALSE</span>)</span>
<span id="cb159-50"><a href="run-rsa-searchlight.html#cb159-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all.equal</span>(<span class="fu">dim</span>(func_nii_pre)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>], <span class="fu">dim</span>(vox_num_nii))){</span>
<span id="cb159-51"><a href="run-rsa-searchlight.html#cb159-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;voxel number image dimensions don&#39;t match functional data!&quot;</span>)}</span>
<span id="cb159-52"><a href="run-rsa-searchlight.html#cb159-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;finished loading images&quot;</span>)</span>
<span id="cb159-53"><a href="run-rsa-searchlight.html#cb159-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-54"><a href="run-rsa-searchlight.html#cb159-54" aria-hidden="true" tabindex="-1"></a>  <span class="do">########## </span><span class="re">BEGIN</span><span class="do"> THE ACTUAL ANALYSIS</span></span>
<span id="cb159-55"><a href="run-rsa-searchlight.html#cb159-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># initialize the output as all 0 (because FSL does not like NAs)</span></span>
<span id="cb159-56"><a href="run-rsa-searchlight.html#cb159-56" aria-hidden="true" tabindex="-1"></a>  rsa_out_array_same_day_vir_time <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">dim</span>(vox_num_nii))</span>
<span id="cb159-57"><a href="run-rsa-searchlight.html#cb159-57" aria-hidden="true" tabindex="-1"></a>  rsa_out_array_diff_day_vir_time <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">dim</span>(vox_num_nii))</span>
<span id="cb159-58"><a href="run-rsa-searchlight.html#cb159-58" aria-hidden="true" tabindex="-1"></a>  rsa_out_array_all_pairs_vir_time <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">dim</span>(vox_num_nii))</span>
<span id="cb159-59"><a href="run-rsa-searchlight.html#cb159-59" aria-hidden="true" tabindex="-1"></a>  rsa_out_array_interaction <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="fu">dim</span>(vox_num_nii))</span>
<span id="cb159-60"><a href="run-rsa-searchlight.html#cb159-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rsa_out_array_n_in_sphere &lt;- array(0, dim(vox_num_nii))</span></span>
<span id="cb159-61"><a href="run-rsa-searchlight.html#cb159-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-62"><a href="run-rsa-searchlight.html#cb159-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># loop over all voxels (in this chunk)</span></span>
<span id="cb159-63"><a href="run-rsa-searchlight.html#cb159-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (v <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_voxels) {  <span class="co"># v &lt;- do.centers[500]</span></span>
<span id="cb159-64"><a href="run-rsa-searchlight.html#cb159-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-65"><a href="run-rsa-searchlight.html#cb159-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print a message to show progress</span></span>
<span id="cb159-66"><a href="run-rsa-searchlight.html#cb159-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (v<span class="sc">%%</span><span class="dv">100</span> <span class="sc">==</span> <span class="dv">0</span>) { <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;at&quot;</span>, v, <span class="st">&quot;of&quot;</span>, n_voxels))}</span>
<span id="cb159-67"><a href="run-rsa-searchlight.html#cb159-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-68"><a href="run-rsa-searchlight.html#cb159-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># find which voxels belong in this center voxel&#39;s searchlight</span></span>
<span id="cb159-69"><a href="run-rsa-searchlight.html#cb159-69" aria-hidden="true" tabindex="-1"></a>    voxs <span class="ot">&lt;-</span> <span class="fu">unlist</span>(lookup_tbl[v,], <span class="at">use.names=</span><span class="cn">FALSE</span>)</span>
<span id="cb159-70"><a href="run-rsa-searchlight.html#cb159-70" aria-hidden="true" tabindex="-1"></a>    voxs <span class="ot">&lt;-</span> voxs[<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(voxs))];  <span class="co"># get rid of NAs. There will be NA entries if some surrounding voxels not in gray matter or brain</span></span>
<span id="cb159-71"><a href="run-rsa-searchlight.html#cb159-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-72"><a href="run-rsa-searchlight.html#cb159-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># how many surrounding voxels must be in the searchlight? Smaller ones (edge of brain) will be skipped.</span></span>
<span id="cb159-73"><a href="run-rsa-searchlight.html#cb159-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(voxs) <span class="sc">&gt;</span> in_df<span class="sc">$</span>min_voxels) {</span>
<span id="cb159-74"><a href="run-rsa-searchlight.html#cb159-74" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-75"><a href="run-rsa-searchlight.html#cb159-75" aria-hidden="true" tabindex="-1"></a>      <span class="co"># initialize arrays to store data of current sphere for the pre and post runs</span></span>
<span id="cb159-76"><a href="run-rsa-searchlight.html#cb159-76" aria-hidden="true" tabindex="-1"></a>      <span class="co"># images in the rows (voxels in this searchlight only), voxels in the columns</span></span>
<span id="cb159-77"><a href="run-rsa-searchlight.html#cb159-77" aria-hidden="true" tabindex="-1"></a>      curr_dat_pre <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="fu">c</span>(n_pics<span class="sc">*</span>n_blocks, <span class="fu">length</span>(voxs)))  </span>
<span id="cb159-78"><a href="run-rsa-searchlight.html#cb159-78" aria-hidden="true" tabindex="-1"></a>      curr_dat_post <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="fu">c</span>(n_pics<span class="sc">*</span>n_blocks, <span class="fu">length</span>(voxs)))</span>
<span id="cb159-79"><a href="run-rsa-searchlight.html#cb159-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-80"><a href="run-rsa-searchlight.html#cb159-80" aria-hidden="true" tabindex="-1"></a>      <span class="co"># put the data into a matrix to run analysis</span></span>
<span id="cb159-81"><a href="run-rsa-searchlight.html#cb159-81" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(voxs)) {   <span class="co"># i &lt;- 1</span></span>
<span id="cb159-82"><a href="run-rsa-searchlight.html#cb159-82" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb159-83"><a href="run-rsa-searchlight.html#cb159-83" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for the current voxel, take the data from all conditions and store it (separately for pre and post)</span></span>
<span id="cb159-84"><a href="run-rsa-searchlight.html#cb159-84" aria-hidden="true" tabindex="-1"></a>        coords <span class="ot">&lt;-</span> <span class="fu">which</span>(vox_num_nii <span class="sc">==</span> voxs[i], <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb159-85"><a href="run-rsa-searchlight.html#cb159-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">ncol</span>(coords) <span class="sc">!=</span> <span class="dv">3</span> <span class="sc">|</span> <span class="fu">nrow</span>(coords) <span class="sc">!=</span> <span class="dv">1</span>) { <span class="fu">stop</span>(<span class="st">&quot;wrong sized coords&quot;</span>)}</span>
<span id="cb159-86"><a href="run-rsa-searchlight.html#cb159-86" aria-hidden="true" tabindex="-1"></a>        curr_vox <span class="ot">&lt;-</span> func_nii_pre[coords[<span class="dv">1</span>], coords[<span class="dv">2</span>], coords[<span class="dv">3</span>],] <span class="co"># pre</span></span>
<span id="cb159-87"><a href="run-rsa-searchlight.html#cb159-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">sd</span>(curr_vox) <span class="sc">&gt;</span> <span class="dv">0</span>) {curr_dat_pre[,i] <span class="ot">&lt;-</span> curr_vox} <span class="cf">else</span> { <span class="fu">stop</span>(<span class="st">&quot;zero variance voxel&quot;</span>)} </span>
<span id="cb159-88"><a href="run-rsa-searchlight.html#cb159-88" aria-hidden="true" tabindex="-1"></a>        curr_vox <span class="ot">&lt;-</span> func_nii_post[coords[<span class="dv">1</span>], coords[<span class="dv">2</span>], coords[<span class="dv">3</span>],] <span class="co"># post</span></span>
<span id="cb159-89"><a href="run-rsa-searchlight.html#cb159-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">sd</span>(curr_vox) <span class="sc">&gt;</span> <span class="dv">0</span>) {curr_dat_post[,i] <span class="ot">&lt;-</span> curr_vox} <span class="cf">else</span> { <span class="fu">stop</span>(<span class="st">&quot;zero variance voxel&quot;</span>)} </span>
<span id="cb159-90"><a href="run-rsa-searchlight.html#cb159-90" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb159-91"><a href="run-rsa-searchlight.html#cb159-91" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-92"><a href="run-rsa-searchlight.html#cb159-92" aria-hidden="true" tabindex="-1"></a>      <span class="co"># data is in repetition (row) by voxel (col) format, so we transpose </span></span>
<span id="cb159-93"><a href="run-rsa-searchlight.html#cb159-93" aria-hidden="true" tabindex="-1"></a>      <span class="co"># to get a voxel x repetition format</span></span>
<span id="cb159-94"><a href="run-rsa-searchlight.html#cb159-94" aria-hidden="true" tabindex="-1"></a>      curr_dat_pre <span class="ot">&lt;-</span> <span class="fu">t</span>(curr_dat_pre)</span>
<span id="cb159-95"><a href="run-rsa-searchlight.html#cb159-95" aria-hidden="true" tabindex="-1"></a>      curr_dat_post <span class="ot">&lt;-</span> <span class="fu">t</span>(curr_dat_post)</span>
<span id="cb159-96"><a href="run-rsa-searchlight.html#cb159-96" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-97"><a href="run-rsa-searchlight.html#cb159-97" aria-hidden="true" tabindex="-1"></a>      <span class="co"># calculate correlation matrix (trial by trial) for pre and post run</span></span>
<span id="cb159-98"><a href="run-rsa-searchlight.html#cb159-98" aria-hidden="true" tabindex="-1"></a>      cor_mat_pre_trial <span class="ot">&lt;-</span> <span class="fu">cor</span>(curr_dat_pre, curr_dat_pre)</span>
<span id="cb159-99"><a href="run-rsa-searchlight.html#cb159-99" aria-hidden="true" tabindex="-1"></a>      cor_mat_post_trial <span class="ot">&lt;-</span> <span class="fu">cor</span>(curr_dat_post, curr_dat_post)</span>
<span id="cb159-100"><a href="run-rsa-searchlight.html#cb159-100" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-101"><a href="run-rsa-searchlight.html#cb159-101" aria-hidden="true" tabindex="-1"></a>      <span class="co"># initialize condition by condition correlation matrix for pre and post run</span></span>
<span id="cb159-102"><a href="run-rsa-searchlight.html#cb159-102" aria-hidden="true" tabindex="-1"></a>      corr_mat_pre <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="dv">20</span>, <span class="at">ncol =</span> <span class="dv">20</span>)</span>
<span id="cb159-103"><a href="run-rsa-searchlight.html#cb159-103" aria-hidden="true" tabindex="-1"></a>      corr_mat_post <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="dv">20</span>, <span class="at">ncol =</span> <span class="dv">20</span>)</span>
<span id="cb159-104"><a href="run-rsa-searchlight.html#cb159-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-105"><a href="run-rsa-searchlight.html#cb159-105" aria-hidden="true" tabindex="-1"></a>      <span class="co"># loop over all picture comparisons</span></span>
<span id="cb159-106"><a href="run-rsa-searchlight.html#cb159-106" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i_pic1 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>){</span>
<span id="cb159-107"><a href="run-rsa-searchlight.html#cb159-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(i_pic2 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>){</span>
<span id="cb159-108"><a href="run-rsa-searchlight.html#cb159-108" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb159-109"><a href="run-rsa-searchlight.html#cb159-109" aria-hidden="true" tabindex="-1"></a>          <span class="co"># extract the current 10x10 correlation matrix</span></span>
<span id="cb159-110"><a href="run-rsa-searchlight.html#cb159-110" aria-hidden="true" tabindex="-1"></a>          i1 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">+</span>(i_pic1<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">10</span>)<span class="sc">:</span>(i_pic1<span class="sc">*</span><span class="dv">10</span>)</span>
<span id="cb159-111"><a href="run-rsa-searchlight.html#cb159-111" aria-hidden="true" tabindex="-1"></a>          i2 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">+</span>(i_pic2<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">10</span>)<span class="sc">:</span>(i_pic2<span class="sc">*</span><span class="dv">10</span>)</span>
<span id="cb159-112"><a href="run-rsa-searchlight.html#cb159-112" aria-hidden="true" tabindex="-1"></a>          curr_mat_pre <span class="ot">&lt;-</span> cor_mat_pre_trial[i1, i2]</span>
<span id="cb159-113"><a href="run-rsa-searchlight.html#cb159-113" aria-hidden="true" tabindex="-1"></a>          curr_mat_post <span class="ot">&lt;-</span> cor_mat_post_trial[i1, i2]</span>
<span id="cb159-114"><a href="run-rsa-searchlight.html#cb159-114" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb159-115"><a href="run-rsa-searchlight.html#cb159-115" aria-hidden="true" tabindex="-1"></a>          <span class="co"># average the correlations while excluding diagonal (same block comparisons)</span></span>
<span id="cb159-116"><a href="run-rsa-searchlight.html#cb159-116" aria-hidden="true" tabindex="-1"></a>          corr_mat_pre[i_pic1, i_pic2] <span class="ot">&lt;-</span> <span class="fu">mean</span>(curr_mat_pre[no_diag])</span>
<span id="cb159-117"><a href="run-rsa-searchlight.html#cb159-117" aria-hidden="true" tabindex="-1"></a>          corr_mat_post[i_pic1, i_pic2] <span class="ot">&lt;-</span> <span class="fu">mean</span>(curr_mat_post[no_diag])</span>
<span id="cb159-118"><a href="run-rsa-searchlight.html#cb159-118" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb159-119"><a href="run-rsa-searchlight.html#cb159-119" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb159-120"><a href="run-rsa-searchlight.html#cb159-120" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb159-121"><a href="run-rsa-searchlight.html#cb159-121" aria-hidden="true" tabindex="-1"></a>      <span class="co"># calculate pattern similarity change based on FisherZ-transformed upper </span></span>
<span id="cb159-122"><a href="run-rsa-searchlight.html#cb159-122" aria-hidden="true" tabindex="-1"></a>      <span class="co"># triangles of the correlation matrices</span></span>
<span id="cb159-123"><a href="run-rsa-searchlight.html#cb159-123" aria-hidden="true" tabindex="-1"></a>      rsa_df<span class="sc">$</span>ps_change <span class="ot">&lt;-</span> <span class="fu">FisherZ</span>(corr_mat_post[triu_idx]) <span class="sc">-</span> <span class="fu">FisherZ</span>(corr_mat_pre[triu_idx])</span>
<span id="cb159-124"><a href="run-rsa-searchlight.html#cb159-124" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-125"><a href="run-rsa-searchlight.html#cb159-125" aria-hidden="true" tabindex="-1"></a>      <span class="co"># find 3D-coordinates of this searchlight center to save output</span></span>
<span id="cb159-126"><a href="run-rsa-searchlight.html#cb159-126" aria-hidden="true" tabindex="-1"></a>      coords <span class="ot">&lt;-</span> <span class="fu">which</span>(vox_num_nii <span class="sc">==</span> <span class="fu">as.numeric</span>(<span class="fu">rownames</span>(lookup_tbl[v,])), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb159-127"><a href="run-rsa-searchlight.html#cb159-127" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">ncol</span>(coords) <span class="sc">!=</span> <span class="dv">3</span> <span class="sc">|</span> <span class="fu">nrow</span>(coords) <span class="sc">!=</span> <span class="dv">1</span>) { <span class="fu">stop</span>(<span class="st">&quot;wrong sized coords&quot;</span>); }</span>
<span id="cb159-128"><a href="run-rsa-searchlight.html#cb159-128" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-129"><a href="run-rsa-searchlight.html#cb159-129" aria-hidden="true" tabindex="-1"></a>      <span class="do">########## RUN RSA FOR THIS SPHERE</span></span>
<span id="cb159-130"><a href="run-rsa-searchlight.html#cb159-130" aria-hidden="true" tabindex="-1"></a>      <span class="co"># same day virtual time</span></span>
<span id="cb159-131"><a href="run-rsa-searchlight.html#cb159-131" aria-hidden="true" tabindex="-1"></a>      fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(ps_change <span class="sc">~</span> vir_time_diff, rsa_df[rsa_df<span class="sc">$</span>same_day,])</span>
<span id="cb159-132"><a href="run-rsa-searchlight.html#cb159-132" aria-hidden="true" tabindex="-1"></a>      rsa_out_array_same_day_vir_time[coords[<span class="dv">1</span>], coords[<span class="dv">2</span>], coords[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(fit))[, <span class="st">&quot;t value&quot;</span>][<span class="dv">2</span>]</span>
<span id="cb159-133"><a href="run-rsa-searchlight.html#cb159-133" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-134"><a href="run-rsa-searchlight.html#cb159-134" aria-hidden="true" tabindex="-1"></a>      <span class="co"># different day virtual time</span></span>
<span id="cb159-135"><a href="run-rsa-searchlight.html#cb159-135" aria-hidden="true" tabindex="-1"></a>      fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(ps_change <span class="sc">~</span> vir_time_diff, rsa_df[<span class="sc">!</span>rsa_df<span class="sc">$</span>same_day,])</span>
<span id="cb159-136"><a href="run-rsa-searchlight.html#cb159-136" aria-hidden="true" tabindex="-1"></a>      rsa_out_array_diff_day_vir_time[coords[<span class="dv">1</span>], coords[<span class="dv">2</span>], coords[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(fit))[, <span class="st">&quot;t value&quot;</span>][<span class="dv">2</span>]</span>
<span id="cb159-137"><a href="run-rsa-searchlight.html#cb159-137" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-138"><a href="run-rsa-searchlight.html#cb159-138" aria-hidden="true" tabindex="-1"></a>      <span class="co"># all pairs virtual time </span></span>
<span id="cb159-139"><a href="run-rsa-searchlight.html#cb159-139" aria-hidden="true" tabindex="-1"></a>      fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(ps_change <span class="sc">~</span> vir_time_diff, rsa_df)</span>
<span id="cb159-140"><a href="run-rsa-searchlight.html#cb159-140" aria-hidden="true" tabindex="-1"></a>      rsa_out_array_all_pairs_vir_time[coords[<span class="dv">1</span>], coords[<span class="dv">2</span>], coords[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(fit))[, <span class="st">&quot;t value&quot;</span>][<span class="dv">2</span>]</span>
<span id="cb159-141"><a href="run-rsa-searchlight.html#cb159-141" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-142"><a href="run-rsa-searchlight.html#cb159-142" aria-hidden="true" tabindex="-1"></a>      <span class="co"># day*time interaction</span></span>
<span id="cb159-143"><a href="run-rsa-searchlight.html#cb159-143" aria-hidden="true" tabindex="-1"></a>      fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(ps_change <span class="sc">~</span> vir_time_diff<span class="sc">*</span>same_day_dv, rsa_df)</span>
<span id="cb159-144"><a href="run-rsa-searchlight.html#cb159-144" aria-hidden="true" tabindex="-1"></a>      rsa_out_array_interaction[coords[<span class="dv">1</span>], coords[<span class="dv">2</span>], coords[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(fit))[, <span class="st">&quot;t value&quot;</span>][<span class="dv">4</span>]</span>
<span id="cb159-145"><a href="run-rsa-searchlight.html#cb159-145" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-146"><a href="run-rsa-searchlight.html#cb159-146" aria-hidden="true" tabindex="-1"></a>      <span class="co"># number of features</span></span>
<span id="cb159-147"><a href="run-rsa-searchlight.html#cb159-147" aria-hidden="true" tabindex="-1"></a>      <span class="co">#rsa_out_array_n_in_sphere[coords[1], coords[2], coords[3]] &lt;- length(voxs)</span></span>
<span id="cb159-148"><a href="run-rsa-searchlight.html#cb159-148" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-149"><a href="run-rsa-searchlight.html#cb159-149" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb159-150"><a href="run-rsa-searchlight.html#cb159-150" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;number of features too small!&quot;</span>)</span>
<span id="cb159-151"><a href="run-rsa-searchlight.html#cb159-151" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-152"><a href="run-rsa-searchlight.html#cb159-152" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-153"><a href="run-rsa-searchlight.html#cb159-153" aria-hidden="true" tabindex="-1"></a>  <span class="do">########## SAVE RESULTS</span></span>
<span id="cb159-154"><a href="run-rsa-searchlight.html#cb159-154" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create nifti with same header info as input data and write to file</span></span>
<span id="cb159-155"><a href="run-rsa-searchlight.html#cb159-155" aria-hidden="true" tabindex="-1"></a>  <span class="co"># same day virtual time</span></span>
<span id="cb159-156"><a href="run-rsa-searchlight.html#cb159-156" aria-hidden="true" tabindex="-1"></a>  rsa_out_nii <span class="ot">=</span> <span class="fu">copyNIfTIHeader</span>(<span class="at">img =</span> vox_num_nii, <span class="at">arr =</span> rsa_out_array_same_day_vir_time)</span>
<span id="cb159-157"><a href="run-rsa-searchlight.html#cb159-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_nifti</span>(rsa_out_nii, <span class="fu">file.path</span>(in_df<span class="sc">$</span>out_path, </span>
<span id="cb159-158"><a href="run-rsa-searchlight.html#cb159-158" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">sprintf</span>(<span class="st">&quot;%s_searchlight_same_day_vir_time_chunk%02d&quot;</span>, </span>
<span id="cb159-159"><a href="run-rsa-searchlight.html#cb159-159" aria-hidden="true" tabindex="-1"></a>                                             in_df<span class="sc">$</span>subject, in_df<span class="sc">$</span>chunk)))</span>
<span id="cb159-160"><a href="run-rsa-searchlight.html#cb159-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-161"><a href="run-rsa-searchlight.html#cb159-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># different day virtual time</span></span>
<span id="cb159-162"><a href="run-rsa-searchlight.html#cb159-162" aria-hidden="true" tabindex="-1"></a>  rsa_out_nii <span class="ot">=</span> <span class="fu">copyNIfTIHeader</span>(<span class="at">img =</span> vox_num_nii, <span class="at">arr =</span> rsa_out_array_diff_day_vir_time)</span>
<span id="cb159-163"><a href="run-rsa-searchlight.html#cb159-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_nifti</span>(rsa_out_nii, <span class="fu">file.path</span>(in_df<span class="sc">$</span>out_path, </span>
<span id="cb159-164"><a href="run-rsa-searchlight.html#cb159-164" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">sprintf</span>(<span class="st">&quot;%s_searchlight_diff_day_vir_time_chunk%02d&quot;</span>, </span>
<span id="cb159-165"><a href="run-rsa-searchlight.html#cb159-165" aria-hidden="true" tabindex="-1"></a>                                             in_df<span class="sc">$</span>subject, in_df<span class="sc">$</span>chunk)))</span>
<span id="cb159-166"><a href="run-rsa-searchlight.html#cb159-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-167"><a href="run-rsa-searchlight.html#cb159-167" aria-hidden="true" tabindex="-1"></a>  <span class="co"># all pairs virtual time</span></span>
<span id="cb159-168"><a href="run-rsa-searchlight.html#cb159-168" aria-hidden="true" tabindex="-1"></a>  rsa_out_nii <span class="ot">=</span> <span class="fu">copyNIfTIHeader</span>(<span class="at">img =</span> vox_num_nii, <span class="at">arr =</span> rsa_out_array_all_pairs_vir_time)</span>
<span id="cb159-169"><a href="run-rsa-searchlight.html#cb159-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_nifti</span>(rsa_out_nii, <span class="fu">file.path</span>(in_df<span class="sc">$</span>out_path, </span>
<span id="cb159-170"><a href="run-rsa-searchlight.html#cb159-170" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">sprintf</span>(<span class="st">&quot;%s_searchlight_all_pairs_vir_time_chunk%02d&quot;</span>, </span>
<span id="cb159-171"><a href="run-rsa-searchlight.html#cb159-171" aria-hidden="true" tabindex="-1"></a>                                             in_df<span class="sc">$</span>subject, in_df<span class="sc">$</span>chunk))) </span>
<span id="cb159-172"><a href="run-rsa-searchlight.html#cb159-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-173"><a href="run-rsa-searchlight.html#cb159-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># day*time interaction</span></span>
<span id="cb159-174"><a href="run-rsa-searchlight.html#cb159-174" aria-hidden="true" tabindex="-1"></a>  rsa_out_nii <span class="ot">=</span> <span class="fu">copyNIfTIHeader</span>(<span class="at">img =</span> vox_num_nii, <span class="at">arr =</span> rsa_out_array_interaction)</span>
<span id="cb159-175"><a href="run-rsa-searchlight.html#cb159-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_nifti</span>(rsa_out_nii, <span class="fu">file.path</span>(in_df<span class="sc">$</span>out_path, </span>
<span id="cb159-176"><a href="run-rsa-searchlight.html#cb159-176" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">sprintf</span>(<span class="st">&quot;%s_searchlight_day_time_interaction_chunk%02d&quot;</span>, </span>
<span id="cb159-177"><a href="run-rsa-searchlight.html#cb159-177" aria-hidden="true" tabindex="-1"></a>                                             in_df<span class="sc">$</span>subject, in_df<span class="sc">$</span>chunk)))</span>
<span id="cb159-178"><a href="run-rsa-searchlight.html#cb159-178" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-179"><a href="run-rsa-searchlight.html#cb159-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># no. voxels in sphere</span></span>
<span id="cb159-180"><a href="run-rsa-searchlight.html#cb159-180" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rsa_out_nii = copyNIfTIHeader(img = vox_num_nii, arr = rsa_out_array_n_in_sphere)</span></span>
<span id="cb159-181"><a href="run-rsa-searchlight.html#cb159-181" aria-hidden="true" tabindex="-1"></a>  <span class="co">#write_nifti(rsa_out_nii, file.path(in_df$out_path, sprintf(&quot;%s_searchlight_n_vox_sphere_chunk%02d&quot;, in_df$subject, in_df$chunk)))</span></span>
<span id="cb159-182"><a href="run-rsa-searchlight.html#cb159-182" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now actually run the function for each chunk; either in parallel or serially. Because the analysis is slow (several hours per chunk when using 50 chunks), it is not feasible to run it serially.</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="run-rsa-searchlight.html#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># next step depends on whether we are in parallel or serial mode</span></span>
<span id="cb160-2"><a href="run-rsa-searchlight.html#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_parallel){ <span class="co"># run serially</span></span>
<span id="cb160-3"><a href="run-rsa-searchlight.html#cb160-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-4"><a href="run-rsa-searchlight.html#cb160-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;Running the searchlight analysis serially. Do this only for testing purposes because the code will run forever&quot;</span>)</span>
<span id="cb160-5"><a href="run-rsa-searchlight.html#cb160-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-6"><a href="run-rsa-searchlight.html#cb160-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># run the function for each row of the data frame,</span></span>
<span id="cb160-7"><a href="run-rsa-searchlight.html#cb160-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># i.e. for each block in each run for each subject</span></span>
<span id="cb160-8"><a href="run-rsa-searchlight.html#cb160-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(in_df)){</span>
<span id="cb160-9"><a href="run-rsa-searchlight.html#cb160-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-10"><a href="run-rsa-searchlight.html#cb160-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tic</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Subject %s, chunk %d&quot;</span>,</span>
<span id="cb160-11"><a href="run-rsa-searchlight.html#cb160-11" aria-hidden="true" tabindex="-1"></a>                in_df<span class="sc">$</span>subject[i], in_df<span class="sc">$</span>chunk[i]))</span>
<span id="cb160-12"><a href="run-rsa-searchlight.html#cb160-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">run_searchlight</span>(<span class="at">in_df =</span> in_df[i,])</span>
<span id="cb160-13"><a href="run-rsa-searchlight.html#cb160-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toc</span>()</span>
<span id="cb160-14"><a href="run-rsa-searchlight.html#cb160-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-15"><a href="run-rsa-searchlight.html#cb160-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-16"><a href="run-rsa-searchlight.html#cb160-16" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (run_parallel){ <span class="co"># run in parallel, assumes CBS HTCondor is available</span></span>
<span id="cb160-17"><a href="run-rsa-searchlight.html#cb160-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-18"><a href="run-rsa-searchlight.html#cb160-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write the data frame to file</span></span>
<span id="cb160-19"><a href="run-rsa-searchlight.html#cb160-19" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;searchlight&quot;</span>, <span class="fu">sprintf</span>(<span class="st">&quot;first_level_%dvox_radius&quot;</span>, radius)),</span>
<span id="cb160-20"><a href="run-rsa-searchlight.html#cb160-20" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;htc_config_run_searchlight.txt&quot;</span>)</span>
<span id="cb160-21"><a href="run-rsa-searchlight.html#cb160-21" aria-hidden="true" tabindex="-1"></a>  fn_def <span class="ot">&lt;-</span> <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&#39;&quot;fn &lt;- &quot;%s&quot;&#39;</span>,fn))</span>
<span id="cb160-22"><a href="run-rsa-searchlight.html#cb160-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(in_df, fn,</span>
<span id="cb160-23"><a href="run-rsa-searchlight.html#cb160-23" aria-hidden="true" tabindex="-1"></a>              <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb160-24"><a href="run-rsa-searchlight.html#cb160-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-25"><a href="run-rsa-searchlight.html#cb160-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># store the function definition as text</span></span>
<span id="cb160-26"><a href="run-rsa-searchlight.html#cb160-26" aria-hidden="true" tabindex="-1"></a>  func_def <span class="ot">&lt;-</span> <span class="fu">capture.output</span>(run_searchlight)</span>
<span id="cb160-27"><a href="run-rsa-searchlight.html#cb160-27" aria-hidden="true" tabindex="-1"></a>  func_def[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;run_searchlight &lt;- &quot;</span>,func_def[<span class="dv">1</span>])</span>
<span id="cb160-28"><a href="run-rsa-searchlight.html#cb160-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">#func_def &lt;- func_def[-length(func_def)]</span></span>
<span id="cb160-29"><a href="run-rsa-searchlight.html#cb160-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-30"><a href="run-rsa-searchlight.html#cb160-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">#write the Rscript that we want to run</span></span>
<span id="cb160-31"><a href="run-rsa-searchlight.html#cb160-31" aria-hidden="true" tabindex="-1"></a>  rscript_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;searchlight&quot;</span>, <span class="fu">sprintf</span>(<span class="st">&quot;first_level_%dvox_radius&quot;</span>, radius), <span class="st">&quot;run_searchlight.R&quot;</span>)</span>
<span id="cb160-32"><a href="run-rsa-searchlight.html#cb160-32" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">file</span>(rscript_fn)</span>
<span id="cb160-33"><a href="run-rsa-searchlight.html#cb160-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">open</span>(con, <span class="st">&quot;w&quot;</span>)</span>
<span id="cb160-34"><a href="run-rsa-searchlight.html#cb160-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(<span class="fu">c</span>(</span>
<span id="cb160-35"><a href="run-rsa-searchlight.html#cb160-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st"># handle input&quot;</span>,</span>
<span id="cb160-36"><a href="run-rsa-searchlight.html#cb160-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;args = commandArgs()&quot;</span>,</span>
<span id="cb160-37"><a href="run-rsa-searchlight.html#cb160-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;i &lt;- as.numeric(args[length(args)])&quot;</span>,</span>
<span id="cb160-38"><a href="run-rsa-searchlight.html#cb160-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st">#load required packages&quot;</span>,</span>
<span id="cb160-39"><a href="run-rsa-searchlight.html#cb160-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">noquote</span>(<span class="fu">sprintf</span>(<span class="st">&#39;lib_dir &lt;- &quot;%s&quot;&#39;</span>,<span class="st">&quot;/data/pt_02261/virtem/virtem_code/R3.6.1/library/Linux&quot;</span>)),</span>
<span id="cb160-40"><a href="run-rsa-searchlight.html#cb160-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;.libPaths(c(lib_dir,.libPaths()))&#39;</span>,</span>
<span id="cb160-41"><a href="run-rsa-searchlight.html#cb160-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;lapply(c(&quot;oro.nifti&quot;, &quot;assertthat&quot;, &quot;dplyr&quot;, &quot;neurobase&quot;, &quot;DescTools&quot;), library, character.only = TRUE)&#39;</span>,</span>
<span id="cb160-42"><a href="run-rsa-searchlight.html#cb160-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st"># read the data and transform ROI column back to list&quot;</span>,</span>
<span id="cb160-43"><a href="run-rsa-searchlight.html#cb160-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">noquote</span>(<span class="fu">sprintf</span>(<span class="st">&#39;fn &lt;- &quot;%s&quot;&#39;</span>,fn)),</span>
<span id="cb160-44"><a href="run-rsa-searchlight.html#cb160-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;func_dat_df &lt;- read.table(fn, sep = &quot;,&quot;, header = TRUE, stringsAsFactors = FALSE)&#39;</span>,</span>
<span id="cb160-45"><a href="run-rsa-searchlight.html#cb160-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st">#define the function to run motion GLM&quot;</span>,</span>
<span id="cb160-46"><a href="run-rsa-searchlight.html#cb160-46" aria-hidden="true" tabindex="-1"></a>    func_def,</span>
<span id="cb160-47"><a href="run-rsa-searchlight.html#cb160-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;</span><span class="sc">\n</span><span class="st"># run the function on one line of the data frame&quot;</span>,</span>
<span id="cb160-48"><a href="run-rsa-searchlight.html#cb160-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;run_searchlight(in_df = func_dat_df[i,])&quot;</span>),con)</span>
<span id="cb160-49"><a href="run-rsa-searchlight.html#cb160-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(con)</span>
<span id="cb160-50"><a href="run-rsa-searchlight.html#cb160-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-51"><a href="run-rsa-searchlight.html#cb160-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># folder for condor output</span></span>
<span id="cb160-52"><a href="run-rsa-searchlight.html#cb160-52" aria-hidden="true" tabindex="-1"></a>  htc_dir <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;htc_logs&quot;</span>, <span class="st">&quot;first_level_searchlight&quot;</span>)</span>
<span id="cb160-53"><a href="run-rsa-searchlight.html#cb160-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(htc_dir)){<span class="fu">dir.create</span>(htc_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb160-54"><a href="run-rsa-searchlight.html#cb160-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-55"><a href="run-rsa-searchlight.html#cb160-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write the submit script</span></span>
<span id="cb160-56"><a href="run-rsa-searchlight.html#cb160-56" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>,<span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rsa&quot;</span>, <span class="st">&quot;searchlight&quot;</span>, <span class="fu">sprintf</span>(<span class="st">&quot;first_level_%dvox_radius&quot;</span>, radius), <span class="st">&quot;run_searchlight.submit&quot;</span>)</span>
<span id="cb160-57"><a href="run-rsa-searchlight.html#cb160-57" aria-hidden="true" tabindex="-1"></a>  con <span class="ot">&lt;-</span> <span class="fu">file</span>(fn)</span>
<span id="cb160-58"><a href="run-rsa-searchlight.html#cb160-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">open</span>(con, <span class="st">&quot;w&quot;</span>)</span>
<span id="cb160-59"><a href="run-rsa-searchlight.html#cb160-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(<span class="fu">c</span>(</span>
<span id="cb160-60"><a href="run-rsa-searchlight.html#cb160-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;universe = vanilla&quot;</span>,</span>
<span id="cb160-61"><a href="run-rsa-searchlight.html#cb160-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;executable = /afs/cbs.mpg.de/software/scripts/envwrap&quot;</span>,</span>
<span id="cb160-62"><a href="run-rsa-searchlight.html#cb160-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;request_memory = 13500&quot;</span>, <span class="co"># &quot;request_memory = 13500&quot;, # works for 3 voxel radius &amp; 40 chunks</span></span>
<span id="cb160-63"><a href="run-rsa-searchlight.html#cb160-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;notification = error&quot;</span></span>
<span id="cb160-64"><a href="run-rsa-searchlight.html#cb160-64" aria-hidden="true" tabindex="-1"></a>    ),con)</span>
<span id="cb160-65"><a href="run-rsa-searchlight.html#cb160-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-66"><a href="run-rsa-searchlight.html#cb160-66" aria-hidden="true" tabindex="-1"></a>    c <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb160-67"><a href="run-rsa-searchlight.html#cb160-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(in_df)){</span>
<span id="cb160-68"><a href="run-rsa-searchlight.html#cb160-68" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(<span class="fu">file.path</span>(in_df[i,]<span class="sc">$</span>out_path, </span>
<span id="cb160-69"><a href="run-rsa-searchlight.html#cb160-69" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">sprintf</span>(<span class="st">&quot;%d_searchlight_all_pairs_vir_time_chunk%02d.nii.gz&quot;</span>,</span>
<span id="cb160-70"><a href="run-rsa-searchlight.html#cb160-70" aria-hidden="true" tabindex="-1"></a>                                         <span class="fu">as.numeric</span>(in_df[i,]<span class="sc">$</span>subject), in_df[i,]<span class="sc">$</span>chunk)))){</span>
<span id="cb160-71"><a href="run-rsa-searchlight.html#cb160-71" aria-hidden="true" tabindex="-1"></a>        c <span class="ot">&lt;-</span> c <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb160-72"><a href="run-rsa-searchlight.html#cb160-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb160-73"><a href="run-rsa-searchlight.html#cb160-73" aria-hidden="true" tabindex="-1"></a>          <span class="fu">writeLines</span>(<span class="fu">c</span>(</span>
<span id="cb160-74"><a href="run-rsa-searchlight.html#cb160-74" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sprintf</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">arguments = R+ --version 3.6.1 Rscript %s %d&quot;</span>, rscript_fn, i),</span>
<span id="cb160-75"><a href="run-rsa-searchlight.html#cb160-75" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sprintf</span>(<span class="st">&quot;log = %s/%d.log&quot;</span>, htc_dir, i),</span>
<span id="cb160-76"><a href="run-rsa-searchlight.html#cb160-76" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sprintf</span>(<span class="st">&quot;output = %s/%d.out&quot;</span>, htc_dir, i),</span>
<span id="cb160-77"><a href="run-rsa-searchlight.html#cb160-77" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sprintf</span>(<span class="st">&quot;error = %s/%d.err&quot;</span>, htc_dir, i),</span>
<span id="cb160-78"><a href="run-rsa-searchlight.html#cb160-78" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sprintf</span>(<span class="st">&quot;Queue</span><span class="sc">\n</span><span class="st">&quot;</span>)),con)</span>
<span id="cb160-79"><a href="run-rsa-searchlight.html#cb160-79" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb160-80"><a href="run-rsa-searchlight.html#cb160-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-81"><a href="run-rsa-searchlight.html#cb160-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(con)</span>
<span id="cb160-82"><a href="run-rsa-searchlight.html#cb160-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-83"><a href="run-rsa-searchlight.html#cb160-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># submit to condor and play the waiting game</span></span>
<span id="cb160-84"><a href="run-rsa-searchlight.html#cb160-84" aria-hidden="true" tabindex="-1"></a>  batch_id <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="fu">paste</span>(<span class="st">&quot;condor_submit&quot;</span>, fn), <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb160-85"><a href="run-rsa-searchlight.html#cb160-85" aria-hidden="true" tabindex="-1"></a>  batch_id <span class="ot">&lt;-</span> <span class="fu">regmatches</span>(batch_id[<span class="dv">2</span>], <span class="fu">gregexpr</span>(<span class="st">&quot;[[:digit:]]+&quot;</span>, batch_id[<span class="dv">2</span>]))[[<span class="dv">1</span>]][<span class="dv">2</span>]</span>
<span id="cb160-86"><a href="run-rsa-searchlight.html#cb160-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;submitted jobs (ID = %s) for 1st-level searchlights. Time to wait...&quot;</span>, batch_id))</span>
<span id="cb160-87"><a href="run-rsa-searchlight.html#cb160-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pause_until_batch_done</span>(<span class="at">batch_id =</span> batch_id, <span class="at">wait_interval =</span> <span class="dv">1800</span>) <span class="co"># check every half hour if done </span></span>
<span id="cb160-88"><a href="run-rsa-searchlight.html#cb160-88" aria-hidden="true" tabindex="-1"></a>  <span class="co">#system(&quot;condor_q&quot;)</span></span>
<span id="cb160-89"><a href="run-rsa-searchlight.html#cb160-89" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div id="combine-the-chunks" class="section level4 unnumbered">
<h4>Combine the chunks</h4>
<p>Lastly, we need to combine the results across chunks to get the whole picture.</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="run-rsa-searchlight.html#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># analyses that we ran the searchlights for</span></span>
<span id="cb161-2"><a href="run-rsa-searchlight.html#cb161-2" aria-hidden="true" tabindex="-1"></a>searchlights <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;same_day_vir_time&quot;</span>, </span>
<span id="cb161-3"><a href="run-rsa-searchlight.html#cb161-3" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;diff_day_vir_time&quot;</span>, </span>
<span id="cb161-4"><a href="run-rsa-searchlight.html#cb161-4" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;day_time_interaction&quot;</span>, </span>
<span id="cb161-5"><a href="run-rsa-searchlight.html#cb161-5" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;all_pairs_vir_time&quot;</span><span class="co">#, </span></span>
<span id="cb161-6"><a href="run-rsa-searchlight.html#cb161-6" aria-hidden="true" tabindex="-1"></a>                  <span class="co">#&quot;n_vox_sphere&quot;</span></span>
<span id="cb161-7"><a href="run-rsa-searchlight.html#cb161-7" aria-hidden="true" tabindex="-1"></a>                  )</span>
<span id="cb161-8"><a href="run-rsa-searchlight.html#cb161-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-9"><a href="run-rsa-searchlight.html#cb161-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb161-10"><a href="run-rsa-searchlight.html#cb161-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb161-11"><a href="run-rsa-searchlight.html#cb161-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># where are the chinks</span></span>
<span id="cb161-12"><a href="run-rsa-searchlight.html#cb161-12" aria-hidden="true" tabindex="-1"></a>  in_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="fu">sprintf</span>(<span class="st">&quot;first_level_%dvox_radius&quot;</span>, radius), i_sub, <span class="st">&quot;chunks&quot;</span>)</span>
<span id="cb161-13"><a href="run-rsa-searchlight.html#cb161-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb161-14"><a href="run-rsa-searchlight.html#cb161-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_srchlght <span class="cf">in</span> searchlights){</span>
<span id="cb161-15"><a href="run-rsa-searchlight.html#cb161-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-16"><a href="run-rsa-searchlight.html#cb161-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># file names of the individual chunks</span></span>
<span id="cb161-17"><a href="run-rsa-searchlight.html#cb161-17" aria-hidden="true" tabindex="-1"></a>    in_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(in_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%d_searchlight_%s_chunk%02d.nii.gz&quot;</span>, </span>
<span id="cb161-18"><a href="run-rsa-searchlight.html#cb161-18" aria-hidden="true" tabindex="-1"></a>                                          <span class="fu">as.numeric</span>(i_sub), i_srchlght, <span class="dv">1</span><span class="sc">:</span>n_chunks))</span>
<span id="cb161-19"><a href="run-rsa-searchlight.html#cb161-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-20"><a href="run-rsa-searchlight.html#cb161-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load the first chunk image, this will serve as the basis for combining all chunks</span></span>
<span id="cb161-21"><a href="run-rsa-searchlight.html#cb161-21" aria-hidden="true" tabindex="-1"></a>    comb_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI</span>(in_files[<span class="dv">1</span>], <span class="at">reorient =</span> <span class="cn">FALSE</span>)</span>
<span id="cb161-22"><a href="run-rsa-searchlight.html#cb161-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-23"><a href="run-rsa-searchlight.html#cb161-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i_chunk <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n_chunks){</span>
<span id="cb161-24"><a href="run-rsa-searchlight.html#cb161-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb161-25"><a href="run-rsa-searchlight.html#cb161-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># load this chunk&#39;s nifti  </span></span>
<span id="cb161-26"><a href="run-rsa-searchlight.html#cb161-26" aria-hidden="true" tabindex="-1"></a>      new_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI</span>(in_files[i_chunk], <span class="at">reorient =</span> <span class="cn">FALSE</span>)</span>
<span id="cb161-27"><a href="run-rsa-searchlight.html#cb161-27" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb161-28"><a href="run-rsa-searchlight.html#cb161-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># find where the data is (i.e. where the image is non-zero)</span></span>
<span id="cb161-29"><a href="run-rsa-searchlight.html#cb161-29" aria-hidden="true" tabindex="-1"></a>      <span class="co">#new_nii[is.na(new_nii)] &lt;- 0</span></span>
<span id="cb161-30"><a href="run-rsa-searchlight.html#cb161-30" aria-hidden="true" tabindex="-1"></a>      coords <span class="ot">&lt;-</span> <span class="fu">which</span>(new_nii <span class="sc">!=</span><span class="dv">0</span>, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)</span>
<span id="cb161-31"><a href="run-rsa-searchlight.html#cb161-31" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb161-32"><a href="run-rsa-searchlight.html#cb161-32" aria-hidden="true" tabindex="-1"></a>      <span class="co"># the combined image should be 0 at all these coordinates</span></span>
<span id="cb161-33"><a href="run-rsa-searchlight.html#cb161-33" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span>(<span class="fu">sum</span>(comb_nii[coords]<span class="sc">==</span><span class="dv">0</span>) <span class="sc">==</span> <span class="fu">nrow</span>(coords))){</span>
<span id="cb161-34"><a href="run-rsa-searchlight.html#cb161-34" aria-hidden="true" tabindex="-1"></a>          <span class="fu">stop</span>(<span class="st">&quot;chunks overlap!&quot;</span>)}</span>
<span id="cb161-35"><a href="run-rsa-searchlight.html#cb161-35" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb161-36"><a href="run-rsa-searchlight.html#cb161-36" aria-hidden="true" tabindex="-1"></a>      <span class="co"># add this chunk&#39;s data to the combined nifti</span></span>
<span id="cb161-37"><a href="run-rsa-searchlight.html#cb161-37" aria-hidden="true" tabindex="-1"></a>      comb_nii[coords] <span class="ot">&lt;-</span> new_nii[coords]</span>
<span id="cb161-38"><a href="run-rsa-searchlight.html#cb161-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb161-39"><a href="run-rsa-searchlight.html#cb161-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-40"><a href="run-rsa-searchlight.html#cb161-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make a simple plot to check that the output is shaped like a brain  </span></span>
<span id="cb161-41"><a href="run-rsa-searchlight.html#cb161-41" aria-hidden="true" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="fu">sprintf</span>(<span class="st">&quot;first_level_%dvox_radius&quot;</span>, radius), </span>
<span id="cb161-42"><a href="run-rsa-searchlight.html#cb161-42" aria-hidden="true" tabindex="-1"></a>                    i_sub, <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s&quot;</span>, i_sub, i_srchlght))</span>
<span id="cb161-43"><a href="run-rsa-searchlight.html#cb161-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">jpeg</span>(<span class="at">file =</span> <span class="fu">paste0</span>(fn,<span class="st">&quot;.jpg&quot;</span>), <span class="at">width =</span> <span class="dv">1000</span>, <span class="at">height =</span> <span class="dv">1000</span>, <span class="at">units =</span> <span class="st">&quot;px&quot;</span>)</span>
<span id="cb161-44"><a href="run-rsa-searchlight.html#cb161-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ortho2</span>(comb_nii, <span class="at">NA.x=</span><span class="cn">TRUE</span>)</span>
<span id="cb161-45"><a href="run-rsa-searchlight.html#cb161-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dev.off</span>()</span>
<span id="cb161-46"><a href="run-rsa-searchlight.html#cb161-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-47"><a href="run-rsa-searchlight.html#cb161-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write nifti to file</span></span>
<span id="cb161-48"><a href="run-rsa-searchlight.html#cb161-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_nifti</span>(comb_nii, fn)</span>
<span id="cb161-49"><a href="run-rsa-searchlight.html#cb161-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb161-50"><a href="run-rsa-searchlight.html#cb161-50" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>

</div>
</div>
</div>
<div id="group-level-searchlight-analysis" class="section level2" number="7.3">
<h2><span class="header-section-number">7.3</span> Group-level searchlight analysis</h2>
<p>After running the first level analysis, we want to run group-level statistics. Group-level stats will be run using permutation-based one sample t-tests as implemented by the sign-flipping procedure in <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/Randomise/UserGuide#One-Sample_T-test">FSL Randomise</a>. This test will be run for all voxels in our field of view as well as in a mask comprising the aHPC and alEC to correct for multiple comparisons within our a priori regions of interest.</p>
<p>First, let’s define some parameters and folders for these analyses.</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="run-rsa-searchlight.html#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># searchlight radius (used in file names)</span></span>
<span id="cb162-2"><a href="run-rsa-searchlight.html#cb162-2" aria-hidden="true" tabindex="-1"></a>radius <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb162-3"><a href="run-rsa-searchlight.html#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="run-rsa-searchlight.html#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="co"># analyses that we ran the searchlights for</span></span>
<span id="cb162-5"><a href="run-rsa-searchlight.html#cb162-5" aria-hidden="true" tabindex="-1"></a>searchlights <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;same_day_vir_time&quot;</span>, </span>
<span id="cb162-6"><a href="run-rsa-searchlight.html#cb162-6" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;diff_day_vir_time&quot;</span>, </span>
<span id="cb162-7"><a href="run-rsa-searchlight.html#cb162-7" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;day_time_interaction&quot;</span>, </span>
<span id="cb162-8"><a href="run-rsa-searchlight.html#cb162-8" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;all_pairs_vir_time&quot;</span></span>
<span id="cb162-9"><a href="run-rsa-searchlight.html#cb162-9" aria-hidden="true" tabindex="-1"></a>                  )</span>
<span id="cb162-10"><a href="run-rsa-searchlight.html#cb162-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-11"><a href="run-rsa-searchlight.html#cb162-11" aria-hidden="true" tabindex="-1"></a><span class="co"># what smoothing to apply</span></span>
<span id="cb162-12"><a href="run-rsa-searchlight.html#cb162-12" aria-hidden="true" tabindex="-1"></a>FWHM <span class="ot">=</span> <span class="dv">3</span> <span class="co"># in mm</span></span>
<span id="cb162-13"><a href="run-rsa-searchlight.html#cb162-13" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">=</span> FWHM<span class="sc">/</span><span class="fl">2.3548</span> <span class="co"># fslmaths needs sigma not FWHM of kernel</span></span>
<span id="cb162-14"><a href="run-rsa-searchlight.html#cb162-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-15"><a href="run-rsa-searchlight.html#cb162-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Output folder</span></span>
<span id="cb162-16"><a href="run-rsa-searchlight.html#cb162-16" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb162-17"><a href="run-rsa-searchlight.html#cb162-17" aria-hidden="true" tabindex="-1"></a>                           searchlights), </span>
<span id="cb162-18"><a href="run-rsa-searchlight.html#cb162-18" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">function</span>(x) <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(x)) <span class="fu">dir.create</span>(x, <span class="at">recursive=</span><span class="cn">TRUE</span>)))</span>
<span id="cb162-19"><a href="run-rsa-searchlight.html#cb162-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-20"><a href="run-rsa-searchlight.html#cb162-20" aria-hidden="true" tabindex="-1"></a><span class="co"># folder for condor output</span></span>
<span id="cb162-21"><a href="run-rsa-searchlight.html#cb162-21" aria-hidden="true" tabindex="-1"></a>htc_dir <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;htc_logs&quot;</span>, <span class="st">&quot;srchlght&quot;</span>)</span>
<span id="cb162-22"><a href="run-rsa-searchlight.html#cb162-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(htc_dir)){<span class="fu">dir.create</span>(htc_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span></code></pre></div>
<div id="move-first-level-images-to-mni-space" class="section level3 unnumbered">
<h3>Move first-level images to MNI space</h3>
<blockquote>
<p>The resulting t-maps were registered to MNI space for group level statistics and spatially smoothed (FWHM 3mm).</p>
</blockquote>
<p>The first level searchlight output is in each participant’s common functional space. For group-level stats we need to register the searchlight outputs to MNI (1mm) space.</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="run-rsa-searchlight.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># name of transformation matrix file to move from the shared functional space to MNI 1mm</span></span>
<span id="cb163-2"><a href="run-rsa-searchlight.html#cb163-2" aria-hidden="true" tabindex="-1"></a>func2standard <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb163-3"><a href="run-rsa-searchlight.html#cb163-3" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, <span class="fu">rep</span>(subjects, <span class="at">each =</span> <span class="fu">length</span>(searchlights)), <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb163-4"><a href="run-rsa-searchlight.html#cb163-4" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;example_func2standard.mat&quot;</span>)</span>
<span id="cb163-5"><a href="run-rsa-searchlight.html#cb163-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-6"><a href="run-rsa-searchlight.html#cb163-6" aria-hidden="true" tabindex="-1"></a><span class="co"># searchlight result in whole-brain functional space</span></span>
<span id="cb163-7"><a href="run-rsa-searchlight.html#cb163-7" aria-hidden="true" tabindex="-1"></a>in_nii_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="fu">sprintf</span>(<span class="st">&quot;first_level_%dvox_radius&quot;</span>, radius), </span>
<span id="cb163-8"><a href="run-rsa-searchlight.html#cb163-8" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">rep</span>(subjects, <span class="at">each =</span> <span class="fu">length</span>(searchlights)),</span>
<span id="cb163-9"><a href="run-rsa-searchlight.html#cb163-9" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s.nii.gz&quot;</span>, <span class="fu">rep</span>(subjects, <span class="at">each =</span> <span class="fu">length</span>(searchlights)), searchlights))</span>
<span id="cb163-10"><a href="run-rsa-searchlight.html#cb163-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-11"><a href="run-rsa-searchlight.html#cb163-11" aria-hidden="true" tabindex="-1"></a><span class="co"># output folder &amp; file name in MNI space</span></span>
<span id="cb163-12"><a href="run-rsa-searchlight.html#cb163-12" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(<span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="fu">sprintf</span>(<span class="st">&quot;mni_%dvox_radius&quot;</span>, radius), </span>
<span id="cb163-13"><a href="run-rsa-searchlight.html#cb163-13" aria-hidden="true" tabindex="-1"></a>                           searchlights, <span class="st">&quot;3d&quot;</span>), </span>
<span id="cb163-14"><a href="run-rsa-searchlight.html#cb163-14" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">function</span>(x) <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(x)) <span class="fu">dir.create</span>(x, <span class="at">recursive=</span><span class="cn">TRUE</span>)))</span>
<span id="cb163-15"><a href="run-rsa-searchlight.html#cb163-15" aria-hidden="true" tabindex="-1"></a>out_nii_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="fu">sprintf</span>(<span class="st">&quot;mni_%dvox_radius&quot;</span>, radius),</span>
<span id="cb163-16"><a href="run-rsa-searchlight.html#cb163-16" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">rep</span>(searchlights,n_subs), <span class="st">&quot;3d&quot;</span>,</span>
<span id="cb163-17"><a href="run-rsa-searchlight.html#cb163-17" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s.nii.gz&quot;</span>, </span>
<span id="cb163-18"><a href="run-rsa-searchlight.html#cb163-18" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rep</span>(subjects, <span class="at">each =</span> <span class="fu">length</span>(searchlights)), searchlights))</span>
<span id="cb163-19"><a href="run-rsa-searchlight.html#cb163-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-20"><a href="run-rsa-searchlight.html#cb163-20" aria-hidden="true" tabindex="-1"></a><span class="co"># apply FSL flirt to move from whole-brain functional space to 1mm MNI space</span></span>
<span id="cb163-21"><a href="run-rsa-searchlight.html#cb163-21" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">mapply</span>(flirt_apply,</span>
<span id="cb163-22"><a href="run-rsa-searchlight.html#cb163-22" aria-hidden="true" tabindex="-1"></a>                 <span class="at">infile =</span> in_nii_fn, </span>
<span id="cb163-23"><a href="run-rsa-searchlight.html#cb163-23" aria-hidden="true" tabindex="-1"></a>                 <span class="at">reffile =</span> <span class="fu">mni_fname</span>(<span class="st">&quot;1&quot;</span>),</span>
<span id="cb163-24"><a href="run-rsa-searchlight.html#cb163-24" aria-hidden="true" tabindex="-1"></a>                 <span class="at">initmat =</span> func2standard,</span>
<span id="cb163-25"><a href="run-rsa-searchlight.html#cb163-25" aria-hidden="true" tabindex="-1"></a>                 <span class="at">outfile =</span> out_nii_fn,</span>
<span id="cb163-26"><a href="run-rsa-searchlight.html#cb163-26" aria-hidden="true" tabindex="-1"></a>                 <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>))</span></code></pre></div>
</div>
<div id="merge-and-smooth-first-level-images" class="section level3 unnumbered">
<h3>Merge and smooth first-level images</h3>
<p>Now that all first-level images are in MNI space, we are ready to concatenate the images across participants. Then, we subject them to Gaussian smoothing.</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="run-rsa-searchlight.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># field of view mask</span></span>
<span id="cb164-2"><a href="run-rsa-searchlight.html#cb164-2" aria-hidden="true" tabindex="-1"></a>fov_mask <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;fov&quot;</span>, <span class="st">&quot;fov_mask_mni.nii.gz&quot;</span>)</span>
<span id="cb164-3"><a href="run-rsa-searchlight.html#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="run-rsa-searchlight.html#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="co"># open the task list</span></span>
<span id="cb164-5"><a href="run-rsa-searchlight.html#cb164-5" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(htc_dir, <span class="st">&quot;smooth_searchlights_tasklist.txt&quot;</span>)</span>
<span id="cb164-6"><a href="run-rsa-searchlight.html#cb164-6" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">file</span>(fn)</span>
<span id="cb164-7"><a href="run-rsa-searchlight.html#cb164-7" aria-hidden="true" tabindex="-1"></a><span class="fu">open</span>(con, <span class="st">&quot;w&quot;</span>)</span>
<span id="cb164-8"><a href="run-rsa-searchlight.html#cb164-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-9"><a href="run-rsa-searchlight.html#cb164-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_srchlght <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(searchlights)){</span>
<span id="cb164-10"><a href="run-rsa-searchlight.html#cb164-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-11"><a href="run-rsa-searchlight.html#cb164-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># file names of files to merge</span></span>
<span id="cb164-12"><a href="run-rsa-searchlight.html#cb164-12" aria-hidden="true" tabindex="-1"></a>  in_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="fu">sprintf</span>(<span class="st">&quot;mni_%dvox_radius&quot;</span>, radius),</span>
<span id="cb164-13"><a href="run-rsa-searchlight.html#cb164-13" aria-hidden="true" tabindex="-1"></a>                        searchlights[i_srchlght], <span class="st">&quot;3d&quot;</span>,</span>
<span id="cb164-14"><a href="run-rsa-searchlight.html#cb164-14" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s.nii.gz&quot;</span>, subjects,searchlights[i_srchlght]))</span>
<span id="cb164-15"><a href="run-rsa-searchlight.html#cb164-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-16"><a href="run-rsa-searchlight.html#cb164-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># file name of 4D output file</span></span>
<span id="cb164-17"><a href="run-rsa-searchlight.html#cb164-17" aria-hidden="true" tabindex="-1"></a>  fn_4d <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="fu">sprintf</span>(<span class="st">&quot;mni_%dvox_radius&quot;</span>, radius),</span>
<span id="cb164-18"><a href="run-rsa-searchlight.html#cb164-18" aria-hidden="true" tabindex="-1"></a>                     searchlights[i_srchlght], <span class="fu">sprintf</span>(<span class="st">&quot;%s_4d.nii.gz&quot;</span>, </span>
<span id="cb164-19"><a href="run-rsa-searchlight.html#cb164-19" aria-hidden="true" tabindex="-1"></a>                                                       searchlights[i_srchlght]))</span>
<span id="cb164-20"><a href="run-rsa-searchlight.html#cb164-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-21"><a href="run-rsa-searchlight.html#cb164-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># concatenate the images</span></span>
<span id="cb164-22"><a href="run-rsa-searchlight.html#cb164-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fslmerge</span>(<span class="at">infiles =</span> in_files, <span class="at">direction =</span> <span class="st">&quot;t&quot;</span>, <span class="at">outfile =</span> fn_4d, <span class="at">retimg =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb164-23"><a href="run-rsa-searchlight.html#cb164-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-24"><a href="run-rsa-searchlight.html#cb164-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-25"><a href="run-rsa-searchlight.html#cb164-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># name of smoothed output file</span></span>
<span id="cb164-26"><a href="run-rsa-searchlight.html#cb164-26" aria-hidden="true" tabindex="-1"></a>  fn_4d_smooth <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb164-27"><a href="run-rsa-searchlight.html#cb164-27" aria-hidden="true" tabindex="-1"></a>                            searchlights[i_srchlght],</span>
<span id="cb164-28"><a href="run-rsa-searchlight.html#cb164-28" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">sprintf</span>(<span class="st">&quot;%s_4d_smooth_fwhm%d.nii.gz&quot;</span>, </span>
<span id="cb164-29"><a href="run-rsa-searchlight.html#cb164-29" aria-hidden="true" tabindex="-1"></a>                                    searchlights[i_srchlght], FWHM))</span>
<span id="cb164-30"><a href="run-rsa-searchlight.html#cb164-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-31"><a href="run-rsa-searchlight.html#cb164-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write smoothing command to file</span></span>
<span id="cb164-32"><a href="run-rsa-searchlight.html#cb164-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(<span class="fu">sprintf</span>(<span class="st">&quot;fslmaths %s -s %f -mas %s %s&quot;</span>, </span>
<span id="cb164-33"><a href="run-rsa-searchlight.html#cb164-33" aria-hidden="true" tabindex="-1"></a>                     fn_4d, sigma, fov_mask, fn_4d_smooth), con)</span>
<span id="cb164-34"><a href="run-rsa-searchlight.html#cb164-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb164-35"><a href="run-rsa-searchlight.html#cb164-35" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(con)</span>
<span id="cb164-36"><a href="run-rsa-searchlight.html#cb164-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-37"><a href="run-rsa-searchlight.html#cb164-37" aria-hidden="true" tabindex="-1"></a><span class="co"># submit to cluster</span></span>
<span id="cb164-38"><a href="run-rsa-searchlight.html#cb164-38" aria-hidden="true" tabindex="-1"></a>cmd <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;fsl_sub -T 30 -t %s -l %s -M bellmund@cbs.mpg.de -N smooth_srchlghts&quot;</span>, fn, htc_dir)</span>
<span id="cb164-39"><a href="run-rsa-searchlight.html#cb164-39" aria-hidden="true" tabindex="-1"></a>batch_id <span class="ot">&lt;-</span> <span class="fu">system</span>(cmd, <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb164-40"><a href="run-rsa-searchlight.html#cb164-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-41"><a href="run-rsa-searchlight.html#cb164-41" aria-hidden="true" tabindex="-1"></a><span class="fu">pause_until_batch_done</span>(<span class="at">batch_id =</span> batch_id, <span class="at">wait_interval =</span> <span class="dv">300</span>)</span></code></pre></div>
</div>
<div id="run-fsl-randomise" class="section level3 unnumbered">
<h3>Run FSL Randomise</h3>
<p>Now we are ready to run FSL Randomise.</p>
<blockquote>
<p>Group level statistics were carried out using random sign flipping implemented with FSL Randomise and threshold-free cluster enhancement. We corrected for multiple comparisons using a small volume correction mask including our a priori regions of interest, the anterior hippocampus and the anterior-lateral entorhinal cortex.</p>
</blockquote>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="run-rsa-searchlight.html#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co"># masks to use</span></span>
<span id="cb165-2"><a href="run-rsa-searchlight.html#cb165-2" aria-hidden="true" tabindex="-1"></a>gm_mask_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;gray_matter&quot;</span>, <span class="st">&quot;gray_matter_mask.nii.gz&quot;</span>)</span>
<span id="cb165-3"><a href="run-rsa-searchlight.html#cb165-3" aria-hidden="true" tabindex="-1"></a>svc_mask_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;svc&quot;</span>, <span class="st">&quot;svc_mask.nii.gz&quot;</span>)</span>
<span id="cb165-4"><a href="run-rsa-searchlight.html#cb165-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-5"><a href="run-rsa-searchlight.html#cb165-5" aria-hidden="true" tabindex="-1"></a><span class="co"># open the tasklist</span></span>
<span id="cb165-6"><a href="run-rsa-searchlight.html#cb165-6" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(htc_dir, <span class="st">&quot;randomise_searchlights_tasklist.txt&quot;</span>)</span>
<span id="cb165-7"><a href="run-rsa-searchlight.html#cb165-7" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">file</span>(fn)</span>
<span id="cb165-8"><a href="run-rsa-searchlight.html#cb165-8" aria-hidden="true" tabindex="-1"></a><span class="fu">open</span>(con, <span class="st">&quot;w&quot;</span>)</span>
<span id="cb165-9"><a href="run-rsa-searchlight.html#cb165-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-10"><a href="run-rsa-searchlight.html#cb165-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_srchlght <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(searchlights)){</span>
<span id="cb165-11"><a href="run-rsa-searchlight.html#cb165-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-12"><a href="run-rsa-searchlight.html#cb165-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># do we want to look at the positive or negative contrast?</span></span>
<span id="cb165-13"><a href="run-rsa-searchlight.html#cb165-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(searchlights[i_srchlght] <span class="sc">==</span> <span class="fu">c</span>(<span class="st">&quot;same_day_vir_time&quot;</span>, <span class="st">&quot;day_time_interaction&quot;</span>))){</span>
<span id="cb165-14"><a href="run-rsa-searchlight.html#cb165-14" aria-hidden="true" tabindex="-1"></a>    test_side <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb165-15"><a href="run-rsa-searchlight.html#cb165-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb165-16"><a href="run-rsa-searchlight.html#cb165-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-17"><a href="run-rsa-searchlight.html#cb165-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we want to test for a negative effect for these searchlights</span></span>
<span id="cb165-18"><a href="run-rsa-searchlight.html#cb165-18" aria-hidden="true" tabindex="-1"></a>    test_side <span class="ot">=</span> <span class="st">&quot;_neg&quot;</span></span>
<span id="cb165-19"><a href="run-rsa-searchlight.html#cb165-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-20"><a href="run-rsa-searchlight.html#cb165-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># multiply by -1 to get the negative contrast </span></span>
<span id="cb165-21"><a href="run-rsa-searchlight.html#cb165-21" aria-hidden="true" tabindex="-1"></a>    orig_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb165-22"><a href="run-rsa-searchlight.html#cb165-22" aria-hidden="true" tabindex="-1"></a>                           searchlights[i_srchlght], </span>
<span id="cb165-23"><a href="run-rsa-searchlight.html#cb165-23" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">sprintf</span>(<span class="st">&quot;%s_4d_smooth_fwhm%d.nii.gz&quot;</span>, </span>
<span id="cb165-24"><a href="run-rsa-searchlight.html#cb165-24" aria-hidden="true" tabindex="-1"></a>                                   searchlights[i_srchlght], FWHM))</span>
<span id="cb165-25"><a href="run-rsa-searchlight.html#cb165-25" aria-hidden="true" tabindex="-1"></a>    mul_neg1_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb165-26"><a href="run-rsa-searchlight.html#cb165-26" aria-hidden="true" tabindex="-1"></a>                             searchlights[i_srchlght],</span>
<span id="cb165-27"><a href="run-rsa-searchlight.html#cb165-27" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">sprintf</span>(<span class="st">&quot;%s%s_4d_smooth_fwhm%d.nii.gz&quot;</span>, </span>
<span id="cb165-28"><a href="run-rsa-searchlight.html#cb165-28" aria-hidden="true" tabindex="-1"></a>                                     searchlights[i_srchlght], test_side, FWHM))</span>
<span id="cb165-29"><a href="run-rsa-searchlight.html#cb165-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fslmaths</span>(<span class="at">file =</span> orig_file, <span class="at">outfile =</span> mul_neg1_fn, <span class="at">opts =</span> <span class="st">&quot;-mul -1&quot;</span>)</span>
<span id="cb165-30"><a href="run-rsa-searchlight.html#cb165-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb165-31"><a href="run-rsa-searchlight.html#cb165-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-32"><a href="run-rsa-searchlight.html#cb165-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4D input image to run randomise on</span></span>
<span id="cb165-33"><a href="run-rsa-searchlight.html#cb165-33" aria-hidden="true" tabindex="-1"></a>  in_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb165-34"><a href="run-rsa-searchlight.html#cb165-34" aria-hidden="true" tabindex="-1"></a>                     searchlights[i_srchlght],</span>
<span id="cb165-35"><a href="run-rsa-searchlight.html#cb165-35" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">sprintf</span>(<span class="st">&quot;%s%s_4d_smooth_fwhm%d.nii.gz&quot;</span>, </span>
<span id="cb165-36"><a href="run-rsa-searchlight.html#cb165-36" aria-hidden="true" tabindex="-1"></a>                             searchlights[i_srchlght], test_side, FWHM))</span>
<span id="cb165-37"><a href="run-rsa-searchlight.html#cb165-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-38"><a href="run-rsa-searchlight.html#cb165-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># output file name for FOV</span></span>
<span id="cb165-39"><a href="run-rsa-searchlight.html#cb165-39" aria-hidden="true" tabindex="-1"></a>  out_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb165-40"><a href="run-rsa-searchlight.html#cb165-40" aria-hidden="true" tabindex="-1"></a>                      searchlights[i_srchlght], </span>
<span id="cb165-41"><a href="run-rsa-searchlight.html#cb165-41" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;%s%s_randomise_fov_fwhm%d&quot;</span>,</span>
<span id="cb165-42"><a href="run-rsa-searchlight.html#cb165-42" aria-hidden="true" tabindex="-1"></a>                              searchlights[i_srchlght], test_side, FWHM))</span>
<span id="cb165-43"><a href="run-rsa-searchlight.html#cb165-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-44"><a href="run-rsa-searchlight.html#cb165-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define randomise command for full FOV and write to file</span></span>
<span id="cb165-45"><a href="run-rsa-searchlight.html#cb165-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(<span class="fu">sprintf</span>(<span class="st">&quot;randomise -i %s -o %s -1 -T --uncorrp -m %s -n 5000&quot;</span>,</span>
<span id="cb165-46"><a href="run-rsa-searchlight.html#cb165-46" aria-hidden="true" tabindex="-1"></a>                     in_fn, out_fn, gm_mask_fn),con)</span>
<span id="cb165-47"><a href="run-rsa-searchlight.html#cb165-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-48"><a href="run-rsa-searchlight.html#cb165-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># output file name for SVC</span></span>
<span id="cb165-49"><a href="run-rsa-searchlight.html#cb165-49" aria-hidden="true" tabindex="-1"></a>  out_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb165-50"><a href="run-rsa-searchlight.html#cb165-50" aria-hidden="true" tabindex="-1"></a>                      searchlights[i_srchlght], </span>
<span id="cb165-51"><a href="run-rsa-searchlight.html#cb165-51" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">sprintf</span>(<span class="st">&quot;%s%s_randomise_svc_fwhm%d&quot;</span>, </span>
<span id="cb165-52"><a href="run-rsa-searchlight.html#cb165-52" aria-hidden="true" tabindex="-1"></a>                              searchlights[i_srchlght], test_side, FWHM))</span>
<span id="cb165-53"><a href="run-rsa-searchlight.html#cb165-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-54"><a href="run-rsa-searchlight.html#cb165-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define randomise command for small-volume correction and and write to file</span></span>
<span id="cb165-55"><a href="run-rsa-searchlight.html#cb165-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(<span class="fu">sprintf</span>(<span class="st">&quot;randomise -i %s -o %s -1 -T --uncorrp -m %s -n 5000&quot;</span>,</span>
<span id="cb165-56"><a href="run-rsa-searchlight.html#cb165-56" aria-hidden="true" tabindex="-1"></a>                     in_fn, out_fn, svc_mask_fn),con)</span>
<span id="cb165-57"><a href="run-rsa-searchlight.html#cb165-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb165-58"><a href="run-rsa-searchlight.html#cb165-58" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(con)</span>
<span id="cb165-59"><a href="run-rsa-searchlight.html#cb165-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-60"><a href="run-rsa-searchlight.html#cb165-60" aria-hidden="true" tabindex="-1"></a><span class="co"># submit to cluster</span></span>
<span id="cb165-61"><a href="run-rsa-searchlight.html#cb165-61" aria-hidden="true" tabindex="-1"></a>cmd <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;fsl_sub -T 300 -t %s -l %s -M bellmund@cbs.mpg.de -N randomise_srchlghts&quot;</span>, fn, htc_dir)</span>
<span id="cb165-62"><a href="run-rsa-searchlight.html#cb165-62" aria-hidden="true" tabindex="-1"></a>batch_id <span class="ot">&lt;-</span> <span class="fu">system</span>(cmd, <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb165-63"><a href="run-rsa-searchlight.html#cb165-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-64"><a href="run-rsa-searchlight.html#cb165-64" aria-hidden="true" tabindex="-1"></a><span class="fu">pause_until_batch_done</span>(<span class="at">batch_id =</span> batch_id, <span class="at">wait_interval =</span> <span class="dv">600</span>)</span></code></pre></div>
</div>
<div id="find-searchlight-clusters-and-atlas-labels" class="section level3 unnumbered">
<h3>Find searchlight clusters and atlas labels</h3>
<p>Next, we do an automated search in the Randomise results. This is done via <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/Cluster">FSL cluster</a> and the result is stored in a text file. Then, we add atlas labels based on the Harvard-Oxford Cortical/Subcortial Structural Atlas using <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/Atlasquery">FSL atlasquery</a>.</p>
<p>Here is a function that runs the atlasquery command and removes some excess characters around the return string.</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="run-rsa-searchlight.html#cb166-1" aria-hidden="true" tabindex="-1"></a>find_FSL_atlas_label <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">atlas =</span> <span class="st">&quot;Harvard-Oxford Cortical Structural Atlas&quot;</span>, <span class="at">x=</span><span class="sc">-</span><span class="dv">20</span>, <span class="at">y=</span><span class="sc">-</span><span class="dv">3</span>, <span class="at">z=</span><span class="sc">-</span><span class="dv">26</span>){</span>
<span id="cb166-2"><a href="run-rsa-searchlight.html#cb166-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-3"><a href="run-rsa-searchlight.html#cb166-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># build FSL atlasquery command and send to command line</span></span>
<span id="cb166-4"><a href="run-rsa-searchlight.html#cb166-4" aria-hidden="true" tabindex="-1"></a>  cmd<span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&#39;atlasquery -a &quot;%s&quot; -c %s&#39;</span>, atlas,<span class="fu">sprintf</span>(<span class="st">&quot;%f,%f,%f&quot;</span>,x,y,z))</span>
<span id="cb166-5"><a href="run-rsa-searchlight.html#cb166-5" aria-hidden="true" tabindex="-1"></a>  cmd<span class="ot">&lt;-</span><span class="fu">sprintf</span>(<span class="st">&quot;%s | sed &#39;s/&lt;b&gt;//g&#39; | sed &#39;s/&lt;</span><span class="sc">\\</span><span class="st">/b&gt;&lt;br&gt;/</span><span class="sc">\\</span><span class="st">,/g&#39;&quot;</span>, cmd) <span class="co"># based on FSL autoaq (l.106)</span></span>
<span id="cb166-6"><a href="run-rsa-searchlight.html#cb166-6" aria-hidden="true" tabindex="-1"></a>  string <span class="ot">&lt;-</span> <span class="fu">system</span>(cmd,<span class="at">intern=</span><span class="cn">TRUE</span>)</span>
<span id="cb166-7"><a href="run-rsa-searchlight.html#cb166-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-8"><a href="run-rsa-searchlight.html#cb166-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove atlas name</span></span>
<span id="cb166-9"><a href="run-rsa-searchlight.html#cb166-9" aria-hidden="true" tabindex="-1"></a>  label <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(string, <span class="fu">sprintf</span>(<span class="st">&quot;%s,&quot;</span>, atlas))</span>
<span id="cb166-10"><a href="run-rsa-searchlight.html#cb166-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-11"><a href="run-rsa-searchlight.html#cb166-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(label)</span>
<span id="cb166-12"><a href="run-rsa-searchlight.html#cb166-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We extract clusters that are significant at p&lt;0.05 after correcting for multiple comparisons using small volume correction. To explore the searchlight results beyond the hippocampal-entorhinal region, we look for clusters at a threshold of p&lt;0.001 uncorrected with a minimum extent of 30 voxels.</p>
<blockquote>
<p>We corrected for multiple comparisons using a small volume correction mask including our a priori regions of interest, the anterior hippocampus and the anterior-lateral entorhinal cortex. Further, we used a liberal threshold of puncorrected&lt;0.001 to explore the data for additional effects within our field of view. Exploratory searchlight results are shown in Supplemental Figure 9 and clusters with a minimum extent of 30 voxels are listed in Supplemental Tables 9, 11 and 12.</p>
</blockquote>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="run-rsa-searchlight.html#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_srchlght <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(searchlights)){</span>
<span id="cb167-2"><a href="run-rsa-searchlight.html#cb167-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-3"><a href="run-rsa-searchlight.html#cb167-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># searchlight with positive or negative contrast?</span></span>
<span id="cb167-4"><a href="run-rsa-searchlight.html#cb167-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(searchlights[i_srchlght] <span class="sc">==</span> <span class="fu">c</span>(<span class="st">&quot;same_day_vir_time&quot;</span>, <span class="st">&quot;day_time_interaction&quot;</span>))){</span>
<span id="cb167-5"><a href="run-rsa-searchlight.html#cb167-5" aria-hidden="true" tabindex="-1"></a>    test_side <span class="ot">&lt;-</span> <span class="st">&quot;&quot;</span></span>
<span id="cb167-6"><a href="run-rsa-searchlight.html#cb167-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb167-7"><a href="run-rsa-searchlight.html#cb167-7" aria-hidden="true" tabindex="-1"></a>    test_side <span class="ot">&lt;-</span> <span class="st">&quot;_neg&quot;</span></span>
<span id="cb167-8"><a href="run-rsa-searchlight.html#cb167-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb167-9"><a href="run-rsa-searchlight.html#cb167-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-10"><a href="run-rsa-searchlight.html#cb167-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># file with t-values</span></span>
<span id="cb167-11"><a href="run-rsa-searchlight.html#cb167-11" aria-hidden="true" tabindex="-1"></a>  t_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb167-12"><a href="run-rsa-searchlight.html#cb167-12" aria-hidden="true" tabindex="-1"></a>                    searchlights[i_srchlght], </span>
<span id="cb167-13"><a href="run-rsa-searchlight.html#cb167-13" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sprintf</span>(<span class="st">&quot;%s%s_randomise_fov_fwhm%d_tstat1.nii.gz&quot;</span>,</span>
<span id="cb167-14"><a href="run-rsa-searchlight.html#cb167-14" aria-hidden="true" tabindex="-1"></a>                            searchlights[i_srchlght], test_side, FWHM))</span>
<span id="cb167-15"><a href="run-rsa-searchlight.html#cb167-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-16"><a href="run-rsa-searchlight.html#cb167-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SVC-CORRECTED CLUSTERS</span></span>
<span id="cb167-17"><a href="run-rsa-searchlight.html#cb167-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># file with corrected p-values based on SVC</span></span>
<span id="cb167-18"><a href="run-rsa-searchlight.html#cb167-18" aria-hidden="true" tabindex="-1"></a>  corrp_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb167-19"><a href="run-rsa-searchlight.html#cb167-19" aria-hidden="true" tabindex="-1"></a>                          searchlights[i_srchlght], </span>
<span id="cb167-20"><a href="run-rsa-searchlight.html#cb167-20" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sprintf</span>(<span class="st">&quot;%s%s_randomise_svc_fwhm%d_tfce_corrp_tstat1.nii.gz&quot;</span>,</span>
<span id="cb167-21"><a href="run-rsa-searchlight.html#cb167-21" aria-hidden="true" tabindex="-1"></a>                                  searchlights[i_srchlght], test_side, FWHM))</span>
<span id="cb167-22"><a href="run-rsa-searchlight.html#cb167-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-23"><a href="run-rsa-searchlight.html#cb167-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># output text file for clusters significant after small volume correction</span></span>
<span id="cb167-24"><a href="run-rsa-searchlight.html#cb167-24" aria-hidden="true" tabindex="-1"></a>  cluster_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb167-25"><a href="run-rsa-searchlight.html#cb167-25" aria-hidden="true" tabindex="-1"></a>                                searchlights[i_srchlght], </span>
<span id="cb167-26"><a href="run-rsa-searchlight.html#cb167-26" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">sprintf</span>(<span class="st">&quot;cluster_%s%s_svc_corrp.txt&quot;</span>,</span>
<span id="cb167-27"><a href="run-rsa-searchlight.html#cb167-27" aria-hidden="true" tabindex="-1"></a>                                        searchlights[i_srchlght], test_side, FWHM))</span>
<span id="cb167-28"><a href="run-rsa-searchlight.html#cb167-28" aria-hidden="true" tabindex="-1"></a>  cmd <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&#39;cluster -i %s -t 0.95 -c %s --mm &gt; %s&#39;</span>, </span>
<span id="cb167-29"><a href="run-rsa-searchlight.html#cb167-29" aria-hidden="true" tabindex="-1"></a>                 corrp_fn, t_fn, cluster_fn)</span>
<span id="cb167-30"><a href="run-rsa-searchlight.html#cb167-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system</span>(cmd)</span>
<span id="cb167-31"><a href="run-rsa-searchlight.html#cb167-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-32"><a href="run-rsa-searchlight.html#cb167-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># read the cluster file</span></span>
<span id="cb167-33"><a href="run-rsa-searchlight.html#cb167-33" aria-hidden="true" tabindex="-1"></a>  cluster_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_tsv</span>(cluster_fn, </span>
<span id="cb167-34"><a href="run-rsa-searchlight.html#cb167-34" aria-hidden="true" tabindex="-1"></a>                              <span class="at">col_types =</span> <span class="fu">c</span>(<span class="st">&quot;dddddddddd____&quot;</span>))</span>
<span id="cb167-35"><a href="run-rsa-searchlight.html#cb167-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(cluster_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;cluster_index&quot;</span>, <span class="st">&quot;n_voxel&quot;</span>, <span class="st">&quot;max_1minusp&quot;</span>,</span>
<span id="cb167-36"><a href="run-rsa-searchlight.html#cb167-36" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;z&quot;</span>, <span class="st">&quot;cog_x&quot;</span>, <span class="st">&quot;cog_y&quot;</span>, <span class="st">&quot;cog_z&quot;</span>, <span class="st">&quot;t_extr&quot;</span>)</span>
<span id="cb167-37"><a href="run-rsa-searchlight.html#cb167-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-38"><a href="run-rsa-searchlight.html#cb167-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add columns for atlas label info</span></span>
<span id="cb167-39"><a href="run-rsa-searchlight.html#cb167-39" aria-hidden="true" tabindex="-1"></a>  cluster_df <span class="ot">&lt;-</span> cluster_df <span class="sc">%&gt;%</span> </span>
<span id="cb167-40"><a href="run-rsa-searchlight.html#cb167-40" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">add_column</span>(<span class="at">Harvard_Oxford_Cortical =</span> <span class="cn">NA</span>, <span class="at">.before =</span> <span class="st">&quot;cluster_index&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb167-41"><a href="run-rsa-searchlight.html#cb167-41" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">add_column</span>(<span class="at">Harvard_Oxford_Subcortical =</span> <span class="cn">NA</span>, <span class="at">.before =</span> <span class="st">&quot;cluster_index&quot;</span>)</span>
<span id="cb167-42"><a href="run-rsa-searchlight.html#cb167-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb167-43"><a href="run-rsa-searchlight.html#cb167-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get atlas label info</span></span>
<span id="cb167-44"><a href="run-rsa-searchlight.html#cb167-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(cluster_df)<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb167-45"><a href="run-rsa-searchlight.html#cb167-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cluster_df)){</span>
<span id="cb167-46"><a href="run-rsa-searchlight.html#cb167-46" aria-hidden="true" tabindex="-1"></a>      cluster_df<span class="sc">$</span>Harvard_Oxford_Cortical[i] <span class="ot">&lt;-</span> <span class="fu">find_FSL_atlas_label</span>(</span>
<span id="cb167-47"><a href="run-rsa-searchlight.html#cb167-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">atlas =</span> <span class="st">&quot;Harvard-Oxford Cortical Structural Atlas&quot;</span>, </span>
<span id="cb167-48"><a href="run-rsa-searchlight.html#cb167-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">x=</span>cluster_df<span class="sc">$</span>x[i], <span class="at">y=</span>cluster_df<span class="sc">$</span>y[i], <span class="at">z=</span>cluster_df<span class="sc">$</span>z[i])</span>
<span id="cb167-49"><a href="run-rsa-searchlight.html#cb167-49" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb167-50"><a href="run-rsa-searchlight.html#cb167-50" aria-hidden="true" tabindex="-1"></a>      cluster_df<span class="sc">$</span>Harvard_Oxford_Subcortical[i] <span class="ot">&lt;-</span> <span class="fu">find_FSL_atlas_label</span>(</span>
<span id="cb167-51"><a href="run-rsa-searchlight.html#cb167-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">atlas =</span> <span class="st">&quot;Harvard-Oxford Subcortical Structural Atlas&quot;</span>, </span>
<span id="cb167-52"><a href="run-rsa-searchlight.html#cb167-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">x=</span>cluster_df<span class="sc">$</span>x[i], <span class="at">y=</span>cluster_df<span class="sc">$</span>y[i], <span class="at">z=</span>cluster_df<span class="sc">$</span>z[i])</span>
<span id="cb167-53"><a href="run-rsa-searchlight.html#cb167-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb167-54"><a href="run-rsa-searchlight.html#cb167-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb167-55"><a href="run-rsa-searchlight.html#cb167-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-56"><a href="run-rsa-searchlight.html#cb167-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write to new file</span></span>
<span id="cb167-57"><a href="run-rsa-searchlight.html#cb167-57" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb167-58"><a href="run-rsa-searchlight.html#cb167-58" aria-hidden="true" tabindex="-1"></a>                  searchlights[i_srchlght], </span>
<span id="cb167-59"><a href="run-rsa-searchlight.html#cb167-59" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">sprintf</span>(<span class="st">&quot;cluster_%s%s_svc_corrp_atlas.txt&quot;</span>,</span>
<span id="cb167-60"><a href="run-rsa-searchlight.html#cb167-60" aria-hidden="true" tabindex="-1"></a>                          searchlights[i_srchlght], test_side, FWHM))</span>
<span id="cb167-61"><a href="run-rsa-searchlight.html#cb167-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_tsv</span>(cluster_df, <span class="at">path=</span>fn)</span>
<span id="cb167-62"><a href="run-rsa-searchlight.html#cb167-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-63"><a href="run-rsa-searchlight.html#cb167-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FOV CLUSTERS AT p&lt;0.001 UNCORRECTED</span></span>
<span id="cb167-64"><a href="run-rsa-searchlight.html#cb167-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># file with uncorrected p-values in entire FOV</span></span>
<span id="cb167-65"><a href="run-rsa-searchlight.html#cb167-65" aria-hidden="true" tabindex="-1"></a>  uncorrp_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb167-66"><a href="run-rsa-searchlight.html#cb167-66" aria-hidden="true" tabindex="-1"></a>                          searchlights[i_srchlght], </span>
<span id="cb167-67"><a href="run-rsa-searchlight.html#cb167-67" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sprintf</span>(<span class="st">&quot;%s%s_randomise_fov_fwhm%d_tfce_p_tstat1.nii.gz&quot;</span>,</span>
<span id="cb167-68"><a href="run-rsa-searchlight.html#cb167-68" aria-hidden="true" tabindex="-1"></a>                                  searchlights[i_srchlght], test_side, FWHM))</span>
<span id="cb167-69"><a href="run-rsa-searchlight.html#cb167-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># output text file for clusters significant after small volume correction</span></span>
<span id="cb167-70"><a href="run-rsa-searchlight.html#cb167-70" aria-hidden="true" tabindex="-1"></a>  cluster_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb167-71"><a href="run-rsa-searchlight.html#cb167-71" aria-hidden="true" tabindex="-1"></a>                                searchlights[i_srchlght], </span>
<span id="cb167-72"><a href="run-rsa-searchlight.html#cb167-72" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">sprintf</span>(<span class="st">&quot;cluster_%s%s_fov_uncorrp.txt&quot;</span>,</span>
<span id="cb167-73"><a href="run-rsa-searchlight.html#cb167-73" aria-hidden="true" tabindex="-1"></a>                                        searchlights[i_srchlght], test_side, FWHM))</span>
<span id="cb167-74"><a href="run-rsa-searchlight.html#cb167-74" aria-hidden="true" tabindex="-1"></a>  cmd <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&#39;cluster -i %s -t 0.999 -c %s --mm --minextent=30 &gt; %s&#39;</span>, </span>
<span id="cb167-75"><a href="run-rsa-searchlight.html#cb167-75" aria-hidden="true" tabindex="-1"></a>                 uncorrp_fn, t_fn, cluster_fn)</span>
<span id="cb167-76"><a href="run-rsa-searchlight.html#cb167-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system</span>(cmd)</span>
<span id="cb167-77"><a href="run-rsa-searchlight.html#cb167-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-78"><a href="run-rsa-searchlight.html#cb167-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># read the cluster file</span></span>
<span id="cb167-79"><a href="run-rsa-searchlight.html#cb167-79" aria-hidden="true" tabindex="-1"></a>  cluster_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_tsv</span>(cluster_fn, </span>
<span id="cb167-80"><a href="run-rsa-searchlight.html#cb167-80" aria-hidden="true" tabindex="-1"></a>                              <span class="at">col_types =</span> <span class="fu">c</span>(<span class="st">&quot;dddddddddd____&quot;</span>))</span>
<span id="cb167-81"><a href="run-rsa-searchlight.html#cb167-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(cluster_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;cluster_index&quot;</span>, <span class="st">&quot;n_voxel&quot;</span>, <span class="st">&quot;max_1minusp&quot;</span>,</span>
<span id="cb167-82"><a href="run-rsa-searchlight.html#cb167-82" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;z&quot;</span>, <span class="st">&quot;cog_x&quot;</span>, <span class="st">&quot;cog_y&quot;</span>, <span class="st">&quot;cog_z&quot;</span>, <span class="st">&quot;t_extr&quot;</span>)</span>
<span id="cb167-83"><a href="run-rsa-searchlight.html#cb167-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-84"><a href="run-rsa-searchlight.html#cb167-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add columns for atlas label info</span></span>
<span id="cb167-85"><a href="run-rsa-searchlight.html#cb167-85" aria-hidden="true" tabindex="-1"></a>  cluster_df <span class="ot">&lt;-</span> cluster_df <span class="sc">%&gt;%</span> </span>
<span id="cb167-86"><a href="run-rsa-searchlight.html#cb167-86" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">add_column</span>(<span class="at">Harvard_Oxford_Cortical =</span> <span class="cn">NA</span>, <span class="at">.before =</span> <span class="st">&quot;cluster_index&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb167-87"><a href="run-rsa-searchlight.html#cb167-87" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">add_column</span>(<span class="at">Harvard_Oxford_Subcortical =</span> <span class="cn">NA</span>, <span class="at">.before =</span> <span class="st">&quot;cluster_index&quot;</span>)</span>
<span id="cb167-88"><a href="run-rsa-searchlight.html#cb167-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb167-89"><a href="run-rsa-searchlight.html#cb167-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get atlas label info</span></span>
<span id="cb167-90"><a href="run-rsa-searchlight.html#cb167-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(cluster_df)){</span>
<span id="cb167-91"><a href="run-rsa-searchlight.html#cb167-91" aria-hidden="true" tabindex="-1"></a>    cluster_df<span class="sc">$</span>Harvard_Oxford_Cortical[i] <span class="ot">&lt;-</span> <span class="fu">find_FSL_atlas_label</span>(</span>
<span id="cb167-92"><a href="run-rsa-searchlight.html#cb167-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">atlas =</span> <span class="st">&quot;Harvard-Oxford Cortical Structural Atlas&quot;</span>, </span>
<span id="cb167-93"><a href="run-rsa-searchlight.html#cb167-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">x=</span>cluster_df<span class="sc">$</span>cog_x[i], <span class="at">y=</span>cluster_df<span class="sc">$</span>cog_y[i], <span class="at">z=</span>cluster_df<span class="sc">$</span>cog_z[i])</span>
<span id="cb167-94"><a href="run-rsa-searchlight.html#cb167-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb167-95"><a href="run-rsa-searchlight.html#cb167-95" aria-hidden="true" tabindex="-1"></a>    cluster_df<span class="sc">$</span>Harvard_Oxford_Subcortical[i] <span class="ot">&lt;-</span> <span class="fu">find_FSL_atlas_label</span>(</span>
<span id="cb167-96"><a href="run-rsa-searchlight.html#cb167-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">atlas =</span> <span class="st">&quot;Harvard-Oxford Subcortical Structural Atlas&quot;</span>, </span>
<span id="cb167-97"><a href="run-rsa-searchlight.html#cb167-97" aria-hidden="true" tabindex="-1"></a>      <span class="at">x=</span>cluster_df<span class="sc">$</span>cog_x[i], <span class="at">y=</span>cluster_df<span class="sc">$</span>cog_y[i], <span class="at">z=</span>cluster_df<span class="sc">$</span>cog_z[i])</span>
<span id="cb167-98"><a href="run-rsa-searchlight.html#cb167-98" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb167-99"><a href="run-rsa-searchlight.html#cb167-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-100"><a href="run-rsa-searchlight.html#cb167-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write to new file</span></span>
<span id="cb167-101"><a href="run-rsa-searchlight.html#cb167-101" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,</span>
<span id="cb167-102"><a href="run-rsa-searchlight.html#cb167-102" aria-hidden="true" tabindex="-1"></a>                  searchlights[i_srchlght], </span>
<span id="cb167-103"><a href="run-rsa-searchlight.html#cb167-103" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">sprintf</span>(<span class="st">&quot;cluster_%s%s_fov_uncorrp_atlas.txt&quot;</span>,</span>
<span id="cb167-104"><a href="run-rsa-searchlight.html#cb167-104" aria-hidden="true" tabindex="-1"></a>                          searchlights[i_srchlght], test_side, FWHM))</span>
<span id="cb167-105"><a href="run-rsa-searchlight.html#cb167-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_tsv</span>(cluster_df, <span class="at">path=</span>fn)</span>
<span id="cb167-106"><a href="run-rsa-searchlight.html#cb167-106" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="create-outlines-of-significant-clusters" class="section level3 unnumbered">
<h3>Create outlines of significant clusters</h3>
<p>To later show which voxels survive corrections for multiple comparisons based on our small-volume correction, we create an outline of the clusters surviving at corrected p&lt;0.05. We do this by dilating a binarized mask of this effect with a spherical kernel with a radius of 2mm.</p>
<blockquote>
<p>voxels within black outline are significant after correction for multiple comparisons using small volume correction</p>
</blockquote>
<div id="same-day-event-pairs" class="section level4 unnumbered">
<h4>Same Day Event Pairs</h4>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="run-rsa-searchlight.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to create an outline of the significant cluster, we threshold the small-volume corrected p-image</span></span>
<span id="cb168-2"><a href="run-rsa-searchlight.html#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="co"># at 0.95 (i.e. 1-0.05) and binarize it. Then we dilate it using a spherical kernel.</span></span>
<span id="cb168-3"><a href="run-rsa-searchlight.html#cb168-3" aria-hidden="true" tabindex="-1"></a>corrpsvc_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>, <span class="st">&quot;same_day_vir_time&quot;</span>,</span>
<span id="cb168-4"><a href="run-rsa-searchlight.html#cb168-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;same_day_vir_time_randomise_svc_fwhm3_tfce_corrp_tstat1.nii.gz&quot;</span>)</span>
<span id="cb168-5"><a href="run-rsa-searchlight.html#cb168-5" aria-hidden="true" tabindex="-1"></a>outl_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>, <span class="st">&quot;same_day_vir_time&quot;</span>,</span>
<span id="cb168-6"><a href="run-rsa-searchlight.html#cb168-6" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;same_day_vir_time_randomise_svc_fwhm3_tfce_corrp_outline.nii.gz&quot;</span>)</span>
<span id="cb168-7"><a href="run-rsa-searchlight.html#cb168-7" aria-hidden="true" tabindex="-1"></a><span class="fu">fslmaths</span>(<span class="at">file=</span>corrpsvc_fn,<span class="at">outfile =</span> outl_fn, <span class="at">opts =</span> <span class="st">&quot;-thr 0.95 -bin&quot;</span>, </span>
<span id="cb168-8"><a href="run-rsa-searchlight.html#cb168-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">retimg =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-9"><a href="run-rsa-searchlight.html#cb168-9" aria-hidden="true" tabindex="-1"></a>outl_nii <span class="ot">&lt;-</span> <span class="fu">fslmaths</span>(<span class="at">file=</span>outl_fn, <span class="at">outfile =</span> outl_fn, </span>
<span id="cb168-10"><a href="run-rsa-searchlight.html#cb168-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">opts =</span> <span class="fu">sprintf</span>(<span class="st">&quot;-kernel sphere 2 -dilM -sub %s&quot;</span>, outl_fn),</span>
<span id="cb168-11"><a href="run-rsa-searchlight.html#cb168-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="sequence-time-interaction" class="section level4 unnumbered">
<h4>Sequence-Time Interaction</h4>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="run-rsa-searchlight.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to create an outline of the significant cluster, we threshold the small-volume corrected p-image</span></span>
<span id="cb169-2"><a href="run-rsa-searchlight.html#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="co"># at 0.95 (i.e. 1-0.05) and binarize it. Then we dilate it using a spherical kernel.</span></span>
<span id="cb169-3"><a href="run-rsa-searchlight.html#cb169-3" aria-hidden="true" tabindex="-1"></a>corrpsvc_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,<span class="st">&quot;day_time_interaction&quot;</span>,</span>
<span id="cb169-4"><a href="run-rsa-searchlight.html#cb169-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;day_time_interaction_randomise_svc_fwhm3_tfce_corrp_tstat1.nii.gz&quot;</span>)</span>
<span id="cb169-5"><a href="run-rsa-searchlight.html#cb169-5" aria-hidden="true" tabindex="-1"></a>outl_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>,<span class="st">&quot;day_time_interaction&quot;</span>,</span>
<span id="cb169-6"><a href="run-rsa-searchlight.html#cb169-6" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;day_time_interaction_randomise_svc_fwhm3_tfce_corrp_outline.nii.gz&quot;</span>)</span>
<span id="cb169-7"><a href="run-rsa-searchlight.html#cb169-7" aria-hidden="true" tabindex="-1"></a><span class="fu">fslmaths</span>(<span class="at">file=</span>corrpsvc_fn,<span class="at">outfile =</span> outl_fn, <span class="at">opts =</span> <span class="st">&quot;-thr 0.95 -bin&quot;</span>, </span>
<span id="cb169-8"><a href="run-rsa-searchlight.html#cb169-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">retimg =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb169-9"><a href="run-rsa-searchlight.html#cb169-9" aria-hidden="true" tabindex="-1"></a>outl_nii <span class="ot">&lt;-</span> <span class="fu">fslmaths</span>(<span class="at">file=</span>outl_fn, <span class="at">outfile =</span> outl_fn, </span>
<span id="cb169-10"><a href="run-rsa-searchlight.html#cb169-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">opts =</span> <span class="fu">sprintf</span>(<span class="st">&quot;-kernel sphere 2 -dilM -sub %s&quot;</span>, outl_fn), </span>
<span id="cb169-11"><a href="run-rsa-searchlight.html#cb169-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code></pre></div>

</div>
</div>
</div>
<div id="prepare-rsa-in-searchlight-peak" class="section level2" number="7.4">
<h2><span class="header-section-number">7.4</span> Prepare RSA in searchlight peak</h2>
<p>To show that overlapping clusters of voxels drive both the within- and across sequence effects, we will run the across-sequence analysis in the cluster of voxels that show the within-day effect. Because these are independent comparisons, we can use the within-day searchlight to define a region of interest for the across-day analysis.</p>
<blockquote>
<p>To test whether within- and across-sequence representations overlap, we defined an ROI based on the within-sequence searchlight analysis. Specifically, voxels belonging to the cluster around the peak voxel, thresholded at p&lt;0.01 uncorrected within our small volume correction mask, were included. The analysis of representational change was then carried out as described for the other ROIs above.</p>
</blockquote>
<div id="create-the-roi-mask" class="section level3 unnumbered">
<h3>Create the ROI mask</h3>
<p>The first steps are to prepare the ROI mask we want to use. Thus, we need to threshold the ROI from the main analysis in MNI space and move the resulting mask to each participant’s functional space for the analysis.</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="run-rsa-searchlight.html#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co"># threshold the searchlight results</span></span>
<span id="cb170-2"><a href="run-rsa-searchlight.html#cb170-2" aria-hidden="true" tabindex="-1"></a>in_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;searchlight_results&quot;</span>, <span class="st">&quot;same_day_vir_time&quot;</span>,</span>
<span id="cb170-3"><a href="run-rsa-searchlight.html#cb170-3" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;same_day_vir_time_randomise_svc_fwhm3_tfce_p_tstat1.nii.gz&quot;</span>)</span>
<span id="cb170-4"><a href="run-rsa-searchlight.html#cb170-4" aria-hidden="true" tabindex="-1"></a>svc_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>mask_dir, <span class="st">&quot;svc&quot;</span>, <span class="st">&quot;svc_mask.nii.gz&quot;</span>)</span>
<span id="cb170-5"><a href="run-rsa-searchlight.html#cb170-5" aria-hidden="true" tabindex="-1"></a>bin_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;mni_masks&quot;</span>, <span class="st">&quot;searchlight_same-day_svc.nii.gz&quot;</span>)</span>
<span id="cb170-6"><a href="run-rsa-searchlight.html#cb170-6" aria-hidden="true" tabindex="-1"></a><span class="fu">fsl_thresh</span>(<span class="at">file =</span> in_fn, <span class="at">outfile =</span> bin_fn, <span class="at">thresh =</span> <span class="fl">0.99</span>, <span class="at">opts =</span> <span class="fu">sprintf</span>(<span class="st">&quot;-bin -mas %s&quot;</span>, svc_fn),</span>
<span id="cb170-7"><a href="run-rsa-searchlight.html#cb170-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>)</span>
<span id="cb170-8"><a href="run-rsa-searchlight.html#cb170-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-9"><a href="run-rsa-searchlight.html#cb170-9" aria-hidden="true" tabindex="-1"></a><span class="co"># peak cluster is in left hemisphere, so don&#39;t include any voxels in right hemisphere</span></span>
<span id="cb170-10"><a href="run-rsa-searchlight.html#cb170-10" aria-hidden="true" tabindex="-1"></a>lh_fn <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;mni_masks&quot;</span>, <span class="st">&quot;left_hemi.nii.gz&quot;</span>)</span>
<span id="cb170-11"><a href="run-rsa-searchlight.html#cb170-11" aria-hidden="true" tabindex="-1"></a><span class="fu">fsl_maths</span>(<span class="at">file=</span>bin_fn, <span class="at">outfile =</span> lh_fn, <span class="at">opts =</span> <span class="st">&quot;-mul 0 -add 1 -roi 91 182 0 218 0 182 0 1&quot;</span>,</span>
<span id="cb170-12"><a href="run-rsa-searchlight.html#cb170-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">retimg =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb170-13"><a href="run-rsa-searchlight.html#cb170-13" aria-hidden="true" tabindex="-1"></a><span class="fu">fsl_mul</span>(<span class="at">file=</span>bin_fn, <span class="at">file2=</span>lh_fn, <span class="at">outfile=</span>bin_fn,</span>
<span id="cb170-14"><a href="run-rsa-searchlight.html#cb170-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">retimg =</span> <span class="cn">FALSE</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb170-15"><a href="run-rsa-searchlight.html#cb170-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-16"><a href="run-rsa-searchlight.html#cb170-16" aria-hidden="true" tabindex="-1"></a><span class="co"># let&#39;s have a look at the mask we created</span></span>
<span id="cb170-17"><a href="run-rsa-searchlight.html#cb170-17" aria-hidden="true" tabindex="-1"></a>mni_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(<span class="fu">mni_fname</span>(<span class="st">&quot;1&quot;</span>))</span>
<span id="cb170-18"><a href="run-rsa-searchlight.html#cb170-18" aria-hidden="true" tabindex="-1"></a>roi_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI2</span>(bin_fn)</span>
<span id="cb170-19"><a href="run-rsa-searchlight.html#cb170-19" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">c</span>(statip<span class="sc">::</span><span class="fu">mfv1</span>(<span class="fu">which</span>(roi_nii<span class="sc">==</span><span class="dv">1</span>, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[,<span class="dv">1</span>]), </span>
<span id="cb170-20"><a href="run-rsa-searchlight.html#cb170-20" aria-hidden="true" tabindex="-1"></a>            statip<span class="sc">::</span><span class="fu">mfv1</span>(<span class="fu">which</span>(roi_nii<span class="sc">==</span><span class="dv">1</span>, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[,<span class="dv">2</span>]),</span>
<span id="cb170-21"><a href="run-rsa-searchlight.html#cb170-21" aria-hidden="true" tabindex="-1"></a>            statip<span class="sc">::</span><span class="fu">mfv1</span>(<span class="fu">which</span>(roi_nii<span class="sc">==</span><span class="dv">1</span>, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[,<span class="dv">3</span>]))</span>
<span id="cb170-22"><a href="run-rsa-searchlight.html#cb170-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ortho2</span>(mni_nii, <span class="at">y =</span> roi_nii, <span class="at">xyz =</span> coords, <span class="at">add.orient =</span> <span class="cn">TRUE</span>)</span>
<span id="cb170-23"><a href="run-rsa-searchlight.html#cb170-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-24"><a href="run-rsa-searchlight.html#cb170-24" aria-hidden="true" tabindex="-1"></a><span class="co"># check the number of voxels in this ROI</span></span>
<span id="cb170-25"><a href="run-rsa-searchlight.html#cb170-25" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">c</span>(roi_nii))</span></code></pre></div>
<p>The resulting ROI mask is now coregistered from MNI 1mm space to the analysis space of the wholebrain functional sequence. Finally, it is thresholded at a probability of 0.5.</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="run-rsa-searchlight.html#cb171-1" aria-hidden="true" tabindex="-1"></a>samespace_dir <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;rois&quot;</span>, <span class="st">&quot;same-day_searchlight&quot;</span>, <span class="st">&quot;samespace&quot;</span>)</span>
<span id="cb171-2"><a href="run-rsa-searchlight.html#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(samespace_dir)){<span class="fu">dir.create</span>(samespace_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb171-3"><a href="run-rsa-searchlight.html#cb171-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-4"><a href="run-rsa-searchlight.html#cb171-4" aria-hidden="true" tabindex="-1"></a><span class="co"># name of transformation matrix file to move from highres to functional space</span></span>
<span id="cb171-5"><a href="run-rsa-searchlight.html#cb171-5" aria-hidden="true" tabindex="-1"></a>standard2func <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;wholebrain&quot;</span>, </span>
<span id="cb171-6"><a href="run-rsa-searchlight.html#cb171-6" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;.feat&quot;</span>),</span>
<span id="cb171-7"><a href="run-rsa-searchlight.html#cb171-7" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;reg&quot;</span>, <span class="st">&quot;standard2example_func.mat&quot;</span>)</span>
<span id="cb171-8"><a href="run-rsa-searchlight.html#cb171-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-9"><a href="run-rsa-searchlight.html#cb171-9" aria-hidden="true" tabindex="-1"></a><span class="co"># use the mean EPI of wholebrain image as a reference</span></span>
<span id="cb171-10"><a href="run-rsa-searchlight.html#cb171-10" aria-hidden="true" tabindex="-1"></a>mean_epi <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>, <span class="st">&quot;processed&quot;</span>, <span class="st">&quot;samespace&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects),</span>
<span id="cb171-11"><a href="run-rsa-searchlight.html#cb171-11" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">paste0</span>(<span class="st">&quot;VIRTEM_P&quot;</span>, subjects, <span class="st">&quot;_wholebrain.nii.gz&quot;</span>))</span>
<span id="cb171-12"><a href="run-rsa-searchlight.html#cb171-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-13"><a href="run-rsa-searchlight.html#cb171-13" aria-hidden="true" tabindex="-1"></a><span class="co"># define output files in samespace (ss) = analysis space based on the wholebrain EPI</span></span>
<span id="cb171-14"><a href="run-rsa-searchlight.html#cb171-14" aria-hidden="true" tabindex="-1"></a>roi_ss <span class="ot">&lt;-</span> <span class="fu">file.path</span>(samespace_dir, <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_ss.nii.gz&quot;</span>, </span>
<span id="cb171-15"><a href="run-rsa-searchlight.html#cb171-15" aria-hidden="true" tabindex="-1"></a>                                           subjects, <span class="st">&quot;same-day_searchlight&quot;</span>))</span>
<span id="cb171-16"><a href="run-rsa-searchlight.html#cb171-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-17"><a href="run-rsa-searchlight.html#cb171-17" aria-hidden="true" tabindex="-1"></a><span class="co"># apply FSL flirt to move ROI from standard to wholebrain functional space</span></span>
<span id="cb171-18"><a href="run-rsa-searchlight.html#cb171-18" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">mapply</span>(flirt_apply, <span class="at">infile =</span> bin_fn, <span class="at">reffile =</span> mean_epi, </span>
<span id="cb171-19"><a href="run-rsa-searchlight.html#cb171-19" aria-hidden="true" tabindex="-1"></a>                 <span class="at">initmat =</span> standard2func, <span class="at">outfile =</span> roi_ss,</span>
<span id="cb171-20"><a href="run-rsa-searchlight.html#cb171-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>))</span>
<span id="cb171-21"><a href="run-rsa-searchlight.html#cb171-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-22"><a href="run-rsa-searchlight.html#cb171-22" aria-hidden="true" tabindex="-1"></a><span class="co"># use fslmaths to binarize the masked ROIs using a threshold of 0.5</span></span>
<span id="cb171-23"><a href="run-rsa-searchlight.html#cb171-23" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mapply</span>(fsl_thresh, <span class="at">file =</span> roi_ss, <span class="at">outfile =</span> roi_ss, <span class="at">thresh =</span> <span class="fl">0.5</span>, <span class="at">opts =</span> <span class="st">&quot;-bin&quot;</span>,</span>
<span id="cb171-24"><a href="run-rsa-searchlight.html#cb171-24" aria-hidden="true" tabindex="-1"></a>              <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">retimg =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="calculating-the-correlation-matrices" class="section level3 unnumbered">
<h3>Calculating the correlation matrices</h3>
<p>The following steps are analogous to the preparation of the functional data in the ROI and searchlight analyses. For the main searchlight analyses we already cleaned the voxel-wise time series and extracted the volumes relevant to RSA. Thus, to calculate the correlation matrices and to calculate pattern similarity changes, we fall back onto the scripts from the main ROI analyses and the searchlight.</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="run-rsa-searchlight.html#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for all 10x10 comparisons we will be averaging all comparisons apart from the diagonal</span></span>
<span id="cb172-2"><a href="run-rsa-searchlight.html#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to exclude same_block comparisons</span></span>
<span id="cb172-3"><a href="run-rsa-searchlight.html#cb172-3" aria-hidden="true" tabindex="-1"></a>no_diag <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="cn">TRUE</span>, <span class="at">nrow=</span><span class="dv">10</span>, <span class="at">ncol =</span> <span class="dv">10</span>)</span>
<span id="cb172-4"><a href="run-rsa-searchlight.html#cb172-4" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(no_diag)<span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb172-5"><a href="run-rsa-searchlight.html#cb172-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-6"><a href="run-rsa-searchlight.html#cb172-6" aria-hidden="true" tabindex="-1"></a>out_dir <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>,<span class="st">&quot;rsa&quot;</span>,<span class="st">&quot;correlation_matrices&quot;</span>, <span class="st">&quot;same-day_searchlight&quot;</span>)</span>
<span id="cb172-7"><a href="run-rsa-searchlight.html#cb172-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)){<span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb172-8"><a href="run-rsa-searchlight.html#cb172-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-9"><a href="run-rsa-searchlight.html#cb172-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb172-10"><a href="run-rsa-searchlight.html#cb172-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-11"><a href="run-rsa-searchlight.html#cb172-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the ROI based on the searchlight</span></span>
<span id="cb172-12"><a href="run-rsa-searchlight.html#cb172-12" aria-hidden="true" tabindex="-1"></a>  roi_fn <span class="ot">&lt;-</span><span class="fu">file.path</span>(samespace_dir, <span class="fu">sprintf</span>(<span class="st">&quot;P%s_%s_ss.nii.gz&quot;</span>, </span>
<span id="cb172-13"><a href="run-rsa-searchlight.html#cb172-13" aria-hidden="true" tabindex="-1"></a>                                            i_sub, <span class="st">&quot;same-day_searchlight&quot;</span>))</span>
<span id="cb172-14"><a href="run-rsa-searchlight.html#cb172-14" aria-hidden="true" tabindex="-1"></a>  roi_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI</span>(roi_fn, <span class="at">reorient=</span><span class="cn">FALSE</span>)</span>
<span id="cb172-15"><a href="run-rsa-searchlight.html#cb172-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-16"><a href="run-rsa-searchlight.html#cb172-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># array indices of ROI voxels</span></span>
<span id="cb172-17"><a href="run-rsa-searchlight.html#cb172-17" aria-hidden="true" tabindex="-1"></a>  roi_vox <span class="ot">&lt;-</span> <span class="fu">which</span>(roi_nii <span class="sc">==</span> <span class="dv">1</span>, <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb172-18"><a href="run-rsa-searchlight.html#cb172-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sprintf</span>(<span class="st">&quot;%s: %d voxels</span><span class="sc">\n</span><span class="st">&quot;</span>, i_sub, <span class="fu">nrow</span>(roi_vox))</span>
<span id="cb172-19"><a href="run-rsa-searchlight.html#cb172-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-20"><a href="run-rsa-searchlight.html#cb172-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i_run <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_runs){</span>
<span id="cb172-21"><a href="run-rsa-searchlight.html#cb172-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb172-22"><a href="run-rsa-searchlight.html#cb172-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load the relevant functional volumes</span></span>
<span id="cb172-23"><a href="run-rsa-searchlight.html#cb172-23" aria-hidden="true" tabindex="-1"></a>    rel_vol_fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>searchlight, <span class="st">&quot;rel_vols_4D&quot;</span>, </span>
<span id="cb172-24"><a href="run-rsa-searchlight.html#cb172-24" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">sprintf</span>(<span class="st">&quot;%s_run%02d_rel_vols.nii.gz&quot;</span>, i_sub, i_run))</span>
<span id="cb172-25"><a href="run-rsa-searchlight.html#cb172-25" aria-hidden="true" tabindex="-1"></a>    func_nii <span class="ot">&lt;-</span> <span class="fu">readNIfTI</span>(rel_vol_fn, <span class="at">reorient=</span><span class="cn">FALSE</span>)</span>
<span id="cb172-26"><a href="run-rsa-searchlight.html#cb172-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb172-27"><a href="run-rsa-searchlight.html#cb172-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the ROI voxels</span></span>
<span id="cb172-28"><a href="run-rsa-searchlight.html#cb172-28" aria-hidden="true" tabindex="-1"></a>    rel_dat <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="fu">c</span>(n_pics<span class="sc">*</span>n_blocks, <span class="fu">nrow</span>(roi_vox)));  <span class="co"># images in rows (ROI voxels), voxels in columns</span></span>
<span id="cb172-29"><a href="run-rsa-searchlight.html#cb172-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(roi_vox)) {   <span class="co"># i &lt;- 1</span></span>
<span id="cb172-30"><a href="run-rsa-searchlight.html#cb172-30" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb172-31"><a href="run-rsa-searchlight.html#cb172-31" aria-hidden="true" tabindex="-1"></a>        curr_vox <span class="ot">&lt;-</span> func_nii[roi_vox[i,<span class="dv">1</span>], roi_vox[i,<span class="dv">2</span>], roi_vox[i,<span class="dv">3</span>],]</span>
<span id="cb172-32"><a href="run-rsa-searchlight.html#cb172-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">sd</span>(curr_vox) <span class="sc">&gt;</span> <span class="dv">0</span>) {rel_dat[,i] <span class="ot">&lt;-</span> curr_vox} <span class="cf">else</span> { <span class="fu">stop</span>(<span class="st">&quot;zero variance voxel&quot;</span>)}</span>
<span id="cb172-33"><a href="run-rsa-searchlight.html#cb172-33" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb172-34"><a href="run-rsa-searchlight.html#cb172-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-35"><a href="run-rsa-searchlight.html#cb172-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># data is in repetition (row) by voxel (col) format, so we transpose </span></span>
<span id="cb172-36"><a href="run-rsa-searchlight.html#cb172-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to get a voxel x repetition format</span></span>
<span id="cb172-37"><a href="run-rsa-searchlight.html#cb172-37" aria-hidden="true" tabindex="-1"></a>    rel_dat <span class="ot">&lt;-</span> <span class="fu">t</span>(rel_dat)</span>
<span id="cb172-38"><a href="run-rsa-searchlight.html#cb172-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb172-39"><a href="run-rsa-searchlight.html#cb172-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate correlation matrix (trial by trial) for pre and post run</span></span>
<span id="cb172-40"><a href="run-rsa-searchlight.html#cb172-40" aria-hidden="true" tabindex="-1"></a>    cor_mat_trial <span class="ot">&lt;-</span> <span class="fu">cor</span>(rel_dat, rel_dat)</span>
<span id="cb172-41"><a href="run-rsa-searchlight.html#cb172-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-42"><a href="run-rsa-searchlight.html#cb172-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># initialize condition by condition correlation matrix for pre and post run</span></span>
<span id="cb172-43"><a href="run-rsa-searchlight.html#cb172-43" aria-hidden="true" tabindex="-1"></a>    corr_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="dv">20</span>, <span class="at">ncol =</span> <span class="dv">20</span>)</span>
<span id="cb172-44"><a href="run-rsa-searchlight.html#cb172-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb172-45"><a href="run-rsa-searchlight.html#cb172-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># loop over all picture comparisons</span></span>
<span id="cb172-46"><a href="run-rsa-searchlight.html#cb172-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i_pic1 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>){</span>
<span id="cb172-47"><a href="run-rsa-searchlight.html#cb172-47" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i_pic2 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>){</span>
<span id="cb172-48"><a href="run-rsa-searchlight.html#cb172-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb172-49"><a href="run-rsa-searchlight.html#cb172-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># extract the current 10x10 correlation matrix</span></span>
<span id="cb172-50"><a href="run-rsa-searchlight.html#cb172-50" aria-hidden="true" tabindex="-1"></a>        i1 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">+</span>(i_pic1<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">10</span>)<span class="sc">:</span>(i_pic1<span class="sc">*</span><span class="dv">10</span>)</span>
<span id="cb172-51"><a href="run-rsa-searchlight.html#cb172-51" aria-hidden="true" tabindex="-1"></a>        i2 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">+</span>(i_pic2<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">10</span>)<span class="sc">:</span>(i_pic2<span class="sc">*</span><span class="dv">10</span>)</span>
<span id="cb172-52"><a href="run-rsa-searchlight.html#cb172-52" aria-hidden="true" tabindex="-1"></a>        curr_mat <span class="ot">&lt;-</span> cor_mat_trial[i1, i2]</span>
<span id="cb172-53"><a href="run-rsa-searchlight.html#cb172-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-54"><a href="run-rsa-searchlight.html#cb172-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># average the correlations while excluding diagonal (same block comparisons)</span></span>
<span id="cb172-55"><a href="run-rsa-searchlight.html#cb172-55" aria-hidden="true" tabindex="-1"></a>        corr_mat[i_pic1, i_pic2] <span class="ot">&lt;-</span> <span class="fu">mean</span>(curr_mat[no_diag])</span>
<span id="cb172-56"><a href="run-rsa-searchlight.html#cb172-56" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb172-57"><a href="run-rsa-searchlight.html#cb172-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb172-58"><a href="run-rsa-searchlight.html#cb172-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb172-59"><a href="run-rsa-searchlight.html#cb172-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save the correlation matrix</span></span>
<span id="cb172-60"><a href="run-rsa-searchlight.html#cb172-60" aria-hidden="true" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_%s_corr_mat.txt&quot;</span>, </span>
<span id="cb172-61"><a href="run-rsa-searchlight.html#cb172-61" aria-hidden="true" tabindex="-1"></a>                                     i_sub, <span class="st">&quot;same-day_searchlight&quot;</span>, runs[i_run]))</span>
<span id="cb172-62"><a href="run-rsa-searchlight.html#cb172-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.table</span>(corr_mat, fn, <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb172-63"><a href="run-rsa-searchlight.html#cb172-63" aria-hidden="true" tabindex="-1"></a>                <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb172-64"><a href="run-rsa-searchlight.html#cb172-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb172-65"><a href="run-rsa-searchlight.html#cb172-65" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="calculate-pattern-similarity-change-1" class="section level3 unnumbered">
<h3>Calculate Pattern Similarity Change</h3>
<p>In the next step, we calculate how the correlation between patterns change from the first to the second picture viewing task, i.e. through the day learning task. To do this, we load both correlation matrices and reduce them to the upper triangle, excluding the diagonal. Then, the correlations are Fisher Z-transformed and the similarity values from the pre-learning picture viewing task are subtracted from those of the post-learning picture viewing task to isolate pattern similarity change. The correlations and their changes are then saved together with information about the pictures that were compared.</p>
<p>This part is based on the corresponding script from the main ROI analyses.</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="run-rsa-searchlight.html#cb173-1" aria-hidden="true" tabindex="-1"></a>in_dir <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>,<span class="st">&quot;rsa&quot;</span>,<span class="st">&quot;correlation_matrices&quot;</span>, <span class="st">&quot;same-day_searchlight&quot;</span>)</span>
<span id="cb173-2"><a href="run-rsa-searchlight.html#cb173-2" aria-hidden="true" tabindex="-1"></a>out_dir <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>,<span class="st">&quot;rsa&quot;</span>,<span class="st">&quot;pattern_similarity_change&quot;</span>, <span class="st">&quot;same-day_searchlight&quot;</span>)</span>
<span id="cb173-3"><a href="run-rsa-searchlight.html#cb173-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)){<span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb173-4"><a href="run-rsa-searchlight.html#cb173-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-5"><a href="run-rsa-searchlight.html#cb173-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i_sub <span class="cf">in</span> subjects){</span>
<span id="cb173-6"><a href="run-rsa-searchlight.html#cb173-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-7"><a href="run-rsa-searchlight.html#cb173-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load pre correlation matrix</span></span>
<span id="cb173-8"><a href="run-rsa-searchlight.html#cb173-8" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(in_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_pre_corr_mat.txt&quot;</span>, </span>
<span id="cb173-9"><a href="run-rsa-searchlight.html#cb173-9" aria-hidden="true" tabindex="-1"></a>                                  i_sub, <span class="st">&quot;same-day_searchlight&quot;</span>))</span>
<span id="cb173-10"><a href="run-rsa-searchlight.html#cb173-10" aria-hidden="true" tabindex="-1"></a>  corr_mat_pre <span class="ot">&lt;-</span> <span class="fu">read.table</span>(fn, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>)    </span>
<span id="cb173-11"><a href="run-rsa-searchlight.html#cb173-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-12"><a href="run-rsa-searchlight.html#cb173-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load post correlation matrix</span></span>
<span id="cb173-13"><a href="run-rsa-searchlight.html#cb173-13" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(in_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_post_corr_mat.txt&quot;</span>, </span>
<span id="cb173-14"><a href="run-rsa-searchlight.html#cb173-14" aria-hidden="true" tabindex="-1"></a>                                  i_sub, <span class="st">&quot;same-day_searchlight&quot;</span>))</span>
<span id="cb173-15"><a href="run-rsa-searchlight.html#cb173-15" aria-hidden="true" tabindex="-1"></a>  corr_mat_post <span class="ot">&lt;-</span> <span class="fu">read.table</span>(fn, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>)</span>
<span id="cb173-16"><a href="run-rsa-searchlight.html#cb173-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-17"><a href="run-rsa-searchlight.html#cb173-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reduce to upper triangle of correlations (without diagonal)</span></span>
<span id="cb173-18"><a href="run-rsa-searchlight.html#cb173-18" aria-hidden="true" tabindex="-1"></a>  pre_corrs <span class="ot">&lt;-</span> corr_mat_pre[<span class="fu">upper.tri</span>(corr_mat_pre, <span class="at">diag =</span> <span class="cn">FALSE</span>)]</span>
<span id="cb173-19"><a href="run-rsa-searchlight.html#cb173-19" aria-hidden="true" tabindex="-1"></a>  post_corrs <span class="ot">&lt;-</span> corr_mat_post[<span class="fu">upper.tri</span>(corr_mat_post, <span class="at">diag =</span> <span class="cn">FALSE</span>)]</span>
<span id="cb173-20"><a href="run-rsa-searchlight.html#cb173-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-21"><a href="run-rsa-searchlight.html#cb173-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a tibble with the correlations </span></span>
<span id="cb173-22"><a href="run-rsa-searchlight.html#cb173-22" aria-hidden="true" tabindex="-1"></a>  pics <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">upper.tri</span>(corr_mat_post), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb173-23"><a href="run-rsa-searchlight.html#cb173-23" aria-hidden="true" tabindex="-1"></a>  corr_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">pic1 =</span> pics[,<span class="dv">1</span>], <span class="at">pic2 =</span> pics[,<span class="dv">2</span>], pre_corrs, post_corrs)</span>
<span id="cb173-24"><a href="run-rsa-searchlight.html#cb173-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-25"><a href="run-rsa-searchlight.html#cb173-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fisher Z transform correlations and calculate pattern similarity change</span></span>
<span id="cb173-26"><a href="run-rsa-searchlight.html#cb173-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># by subtracting the pre-correlations from the post-correlations</span></span>
<span id="cb173-27"><a href="run-rsa-searchlight.html#cb173-27" aria-hidden="true" tabindex="-1"></a>  corr_df<span class="sc">$</span>ps_change <span class="ot">&lt;-</span> <span class="fu">FisherZ</span>(corr_df<span class="sc">$</span>post_corrs) <span class="sc">-</span> <span class="fu">FisherZ</span>(corr_df<span class="sc">$</span>pre_corrs)</span>
<span id="cb173-28"><a href="run-rsa-searchlight.html#cb173-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-29"><a href="run-rsa-searchlight.html#cb173-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write to file</span></span>
<span id="cb173-30"><a href="run-rsa-searchlight.html#cb173-30" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_pattern_similarity_change.txt&quot;</span>, </span>
<span id="cb173-31"><a href="run-rsa-searchlight.html#cb173-31" aria-hidden="true" tabindex="-1"></a>                                   i_sub, <span class="st">&quot;same-day_searchlight&quot;</span>))</span>
<span id="cb173-32"><a href="run-rsa-searchlight.html#cb173-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(corr_df, fn, <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb173-33"><a href="run-rsa-searchlight.html#cb173-33" aria-hidden="true" tabindex="-1"></a>              <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb173-34"><a href="run-rsa-searchlight.html#cb173-34" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="combine-behavioral-and-fmri-data-for-rsa-1" class="section level3 unnumbered">
<h3>Combine behavioral and fMRI data for RSA</h3>
<p>To create input for the RSA the next step is to combine the similarity change data with the behavioral data, so that we can do meaningful analyses. First the behavioral data is loaded and brought into the same pair-wise format as the similarity change data. Both datasets are combined for each subject and then written to disk.</p>
<p>This part is based on the corresponding script from the main ROI analyses.</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="run-rsa-searchlight.html#cb174-1" aria-hidden="true" tabindex="-1"></a>in_dir <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>,<span class="st">&quot;rsa&quot;</span>,<span class="st">&quot;pattern_similarity_change&quot;</span>, <span class="st">&quot;same-day_searchlight&quot;</span>)</span>
<span id="cb174-2"><a href="run-rsa-searchlight.html#cb174-2" aria-hidden="true" tabindex="-1"></a>out_dir <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;mri&quot;</span>,<span class="st">&quot;rsa&quot;</span>,<span class="st">&quot;data_for_rsa&quot;</span>)</span>
<span id="cb174-3"><a href="run-rsa-searchlight.html#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)){<span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb174-4"><a href="run-rsa-searchlight.html#cb174-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-5"><a href="run-rsa-searchlight.html#cb174-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb174-6"><a href="run-rsa-searchlight.html#cb174-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-7"><a href="run-rsa-searchlight.html#cb174-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the behavioral data</span></span>
<span id="cb174-8"><a href="run-rsa-searchlight.html#cb174-8" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>timeline_dat_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_behavior_tbl_timeline.txt&quot;</span>, i_sub))</span>
<span id="cb174-9"><a href="run-rsa-searchlight.html#cb174-9" aria-hidden="true" tabindex="-1"></a>  col_types_list <span class="ot">&lt;-</span> <span class="fu">cols_only</span>(<span class="at">sub_id =</span> <span class="fu">col_character</span>(), <span class="at">day =</span> <span class="fu">col_factor</span>(), </span>
<span id="cb174-10"><a href="run-rsa-searchlight.html#cb174-10" aria-hidden="true" tabindex="-1"></a>                              <span class="at">event =</span> <span class="fu">col_integer</span>(), <span class="at">pic =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb174-11"><a href="run-rsa-searchlight.html#cb174-11" aria-hidden="true" tabindex="-1"></a>                              <span class="at">virtual_time =</span> <span class="fu">col_double</span>(), <span class="at">real_time =</span> <span class="fu">col_double</span>(),</span>
<span id="cb174-12"><a href="run-rsa-searchlight.html#cb174-12" aria-hidden="true" tabindex="-1"></a>                              <span class="at">memory_time =</span> <span class="fu">col_double</span>(), <span class="at">memory_order =</span> <span class="fu">col_double</span>(), </span>
<span id="cb174-13"><a href="run-rsa-searchlight.html#cb174-13" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sorted_day =</span> <span class="fu">col_integer</span>())</span>
<span id="cb174-14"><a href="run-rsa-searchlight.html#cb174-14" aria-hidden="true" tabindex="-1"></a>  beh_dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fn, <span class="at">col_types =</span> col_types_list)</span>
<span id="cb174-15"><a href="run-rsa-searchlight.html#cb174-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-16"><a href="run-rsa-searchlight.html#cb174-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sort behavioral data according to picture identity</span></span>
<span id="cb174-17"><a href="run-rsa-searchlight.html#cb174-17" aria-hidden="true" tabindex="-1"></a>  beh_dat_ordered <span class="ot">&lt;-</span> beh_dat[<span class="fu">order</span>(beh_dat<span class="sc">$</span>pic),]</span>
<span id="cb174-18"><a href="run-rsa-searchlight.html#cb174-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-19"><a href="run-rsa-searchlight.html#cb174-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># find the order of comparisons</span></span>
<span id="cb174-20"><a href="run-rsa-searchlight.html#cb174-20" aria-hidden="true" tabindex="-1"></a>  pairs <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">upper.tri</span>(<span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="dv">20</span>, <span class="at">ncol =</span> <span class="dv">20</span>)), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb174-21"><a href="run-rsa-searchlight.html#cb174-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-22"><a href="run-rsa-searchlight.html#cb174-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract the data for the first and second picture in each pair from the behavioral data</span></span>
<span id="cb174-23"><a href="run-rsa-searchlight.html#cb174-23" aria-hidden="true" tabindex="-1"></a>  pic1_dat <span class="ot">&lt;-</span> beh_dat_ordered[pairs[,<span class="dv">1</span>],]</span>
<span id="cb174-24"><a href="run-rsa-searchlight.html#cb174-24" aria-hidden="true" tabindex="-1"></a>  pic2_dat <span class="ot">&lt;-</span> beh_dat_ordered[pairs[,<span class="dv">2</span>],]</span>
<span id="cb174-25"><a href="run-rsa-searchlight.html#cb174-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(pic1_dat) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">colnames</span>(pic1_dat), <span class="st">&quot;1&quot;</span>)</span>
<span id="cb174-26"><a href="run-rsa-searchlight.html#cb174-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(pic2_dat) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">colnames</span>(pic2_dat), <span class="st">&quot;2&quot;</span>)</span>
<span id="cb174-27"><a href="run-rsa-searchlight.html#cb174-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-28"><a href="run-rsa-searchlight.html#cb174-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine the two tibbles</span></span>
<span id="cb174-29"><a href="run-rsa-searchlight.html#cb174-29" aria-hidden="true" tabindex="-1"></a>  pair_dat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(pic1_dat, pic2_dat)</span>
<span id="cb174-30"><a href="run-rsa-searchlight.html#cb174-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-31"><a href="run-rsa-searchlight.html#cb174-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reorder the tibble columns to make a bit more sense</span></span>
<span id="cb174-32"><a href="run-rsa-searchlight.html#cb174-32" aria-hidden="true" tabindex="-1"></a>  pair_dat <span class="ot">&lt;-</span> pair_dat <span class="sc">%&gt;%</span></span>
<span id="cb174-33"><a href="run-rsa-searchlight.html#cb174-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sub_id1,</span>
<span id="cb174-34"><a href="run-rsa-searchlight.html#cb174-34" aria-hidden="true" tabindex="-1"></a>           day1, day2,</span>
<span id="cb174-35"><a href="run-rsa-searchlight.html#cb174-35" aria-hidden="true" tabindex="-1"></a>           pic1, pic2,</span>
<span id="cb174-36"><a href="run-rsa-searchlight.html#cb174-36" aria-hidden="true" tabindex="-1"></a>           event1, event2, </span>
<span id="cb174-37"><a href="run-rsa-searchlight.html#cb174-37" aria-hidden="true" tabindex="-1"></a>           virtual_time1, virtual_time2, </span>
<span id="cb174-38"><a href="run-rsa-searchlight.html#cb174-38" aria-hidden="true" tabindex="-1"></a>           real_time1, real_time2, </span>
<span id="cb174-39"><a href="run-rsa-searchlight.html#cb174-39" aria-hidden="true" tabindex="-1"></a>           memory_order1, memory_order2, </span>
<span id="cb174-40"><a href="run-rsa-searchlight.html#cb174-40" aria-hidden="true" tabindex="-1"></a>           memory_time1, memory_time2, </span>
<span id="cb174-41"><a href="run-rsa-searchlight.html#cb174-41" aria-hidden="true" tabindex="-1"></a>           sorted_day1, sorted_day2) <span class="sc">%&gt;%</span></span>
<span id="cb174-42"><a href="run-rsa-searchlight.html#cb174-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">sub_id =</span> sub_id1)</span>
<span id="cb174-43"><a href="run-rsa-searchlight.html#cb174-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-44"><a href="run-rsa-searchlight.html#cb174-44" aria-hidden="true" tabindex="-1"></a>  rsa_dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb174-45"><a href="run-rsa-searchlight.html#cb174-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-46"><a href="run-rsa-searchlight.html#cb174-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the pattern similarity change data for this ROI</span></span>
<span id="cb174-47"><a href="run-rsa-searchlight.html#cb174-47" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(in_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_%s_pattern_similarity_change.txt&quot;</span>, </span>
<span id="cb174-48"><a href="run-rsa-searchlight.html#cb174-48" aria-hidden="true" tabindex="-1"></a>                                  i_sub, <span class="st">&quot;same-day_searchlight&quot;</span>))</span>
<span id="cb174-49"><a href="run-rsa-searchlight.html#cb174-49" aria-hidden="true" tabindex="-1"></a>  ps_change_dat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(fn)</span>
<span id="cb174-50"><a href="run-rsa-searchlight.html#cb174-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-51"><a href="run-rsa-searchlight.html#cb174-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make sure files have the same order</span></span>
<span id="cb174-52"><a href="run-rsa-searchlight.html#cb174-52" aria-hidden="true" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">are_equal</span>(<span class="fu">c</span>(pair_dat<span class="sc">$</span>pic1, pair_dat<span class="sc">$</span>pic2), <span class="fu">c</span>(ps_change_dat<span class="sc">$</span>pic1, ps_change_dat<span class="sc">$</span>pic2))</span>
<span id="cb174-53"><a href="run-rsa-searchlight.html#cb174-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-54"><a href="run-rsa-searchlight.html#cb174-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add column with ROI name</span></span>
<span id="cb174-55"><a href="run-rsa-searchlight.html#cb174-55" aria-hidden="true" tabindex="-1"></a>  ps_change_dat <span class="ot">&lt;-</span> <span class="fu">add_column</span>(ps_change_dat, <span class="at">roi =</span> <span class="st">&quot;same-day_searchlight&quot;</span>)</span>
<span id="cb174-56"><a href="run-rsa-searchlight.html#cb174-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-57"><a href="run-rsa-searchlight.html#cb174-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># collect the data from this ROI and merge into long data frame</span></span>
<span id="cb174-58"><a href="run-rsa-searchlight.html#cb174-58" aria-hidden="true" tabindex="-1"></a>  roi_dat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(pair_dat, ps_change_dat[,<span class="dv">3</span><span class="sc">:</span><span class="dv">6</span>])</span>
<span id="cb174-59"><a href="run-rsa-searchlight.html#cb174-59" aria-hidden="true" tabindex="-1"></a>  rsa_dat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(rsa_dat, roi_dat)</span>
<span id="cb174-60"><a href="run-rsa-searchlight.html#cb174-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-61"><a href="run-rsa-searchlight.html#cb174-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write to file</span></span>
<span id="cb174-62"><a href="run-rsa-searchlight.html#cb174-62" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>rsa_dat_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_data_for_rsa_same-day_searchlight.txt&quot;</span>,i_sub))</span>
<span id="cb174-63"><a href="run-rsa-searchlight.html#cb174-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(rsa_dat, fn, <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb174-64"><a href="run-rsa-searchlight.html#cb174-64" aria-hidden="true" tabindex="-1"></a>              <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb174-65"><a href="run-rsa-searchlight.html#cb174-65" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Finally, the datasets are combined across subjects.</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="run-rsa-searchlight.html#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up a dataframe to collect the data</span></span>
<span id="cb175-2"><a href="run-rsa-searchlight.html#cb175-2" aria-hidden="true" tabindex="-1"></a>rsa_dat <span class="ot">=</span> <span class="fu">tibble</span>()</span>
<span id="cb175-3"><a href="run-rsa-searchlight.html#cb175-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-4"><a href="run-rsa-searchlight.html#cb175-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i_sub <span class="cf">in</span> subjects){</span>
<span id="cb175-5"><a href="run-rsa-searchlight.html#cb175-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-6"><a href="run-rsa-searchlight.html#cb175-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load data from CSV</span></span>
<span id="cb175-7"><a href="run-rsa-searchlight.html#cb175-7" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">sprintf</span>(<span class="st">&quot;%s_data_for_rsa_same-day_searchlight.txt&quot;</span>,i_sub))</span>
<span id="cb175-8"><a href="run-rsa-searchlight.html#cb175-8" aria-hidden="true" tabindex="-1"></a>  col_types_list <span class="ot">&lt;-</span> <span class="fu">cols_only</span>(</span>
<span id="cb175-9"><a href="run-rsa-searchlight.html#cb175-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">sub_id =</span> <span class="fu">col_character</span>(),</span>
<span id="cb175-10"><a href="run-rsa-searchlight.html#cb175-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">day1 =</span> <span class="fu">col_integer</span>(), <span class="at">day2 =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb175-11"><a href="run-rsa-searchlight.html#cb175-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">event1 =</span> <span class="fu">col_integer</span>(), <span class="at">event2 =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb175-12"><a href="run-rsa-searchlight.html#cb175-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">pic1 =</span> <span class="fu">col_integer</span>(), <span class="at">pic2 =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb175-13"><a href="run-rsa-searchlight.html#cb175-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">virtual_time1 =</span> <span class="fu">col_double</span>(), <span class="at">virtual_time2 =</span> <span class="fu">col_double</span>(),</span>
<span id="cb175-14"><a href="run-rsa-searchlight.html#cb175-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">real_time1 =</span> <span class="fu">col_double</span>(), <span class="at">real_time2 =</span> <span class="fu">col_double</span>(),</span>
<span id="cb175-15"><a href="run-rsa-searchlight.html#cb175-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">memory_time1 =</span> <span class="fu">col_double</span>(), <span class="at">memory_time2 =</span> <span class="fu">col_double</span>(), </span>
<span id="cb175-16"><a href="run-rsa-searchlight.html#cb175-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">memory_order1 =</span> <span class="fu">col_double</span>(), <span class="at">memory_order2 =</span> <span class="fu">col_double</span>(), </span>
<span id="cb175-17"><a href="run-rsa-searchlight.html#cb175-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">sorted_day1 =</span> <span class="fu">col_integer</span>(), <span class="at">sorted_day2 =</span> <span class="fu">col_integer</span>(),</span>
<span id="cb175-18"><a href="run-rsa-searchlight.html#cb175-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">pre_corrs  =</span> <span class="fu">col_double</span>(), <span class="at">post_corrs =</span> <span class="fu">col_double</span>(),</span>
<span id="cb175-19"><a href="run-rsa-searchlight.html#cb175-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">ps_change =</span> <span class="fu">col_double</span>(), <span class="at">roi =</span> <span class="fu">col_factor</span>()</span>
<span id="cb175-20"><a href="run-rsa-searchlight.html#cb175-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb175-21"><a href="run-rsa-searchlight.html#cb175-21" aria-hidden="true" tabindex="-1"></a>  sub_dat <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(<span class="fu">read_csv</span>(fn, <span class="at">col_types =</span> col_types_list))</span>
<span id="cb175-22"><a href="run-rsa-searchlight.html#cb175-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-23"><a href="run-rsa-searchlight.html#cb175-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append to table with data from all subjects</span></span>
<span id="cb175-24"><a href="run-rsa-searchlight.html#cb175-24" aria-hidden="true" tabindex="-1"></a>  rsa_dat <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sub_dat, rsa_dat)</span>
<span id="cb175-25"><a href="run-rsa-searchlight.html#cb175-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb175-26"><a href="run-rsa-searchlight.html#cb175-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-27"><a href="run-rsa-searchlight.html#cb175-27" aria-hidden="true" tabindex="-1"></a><span class="co"># sort the data</span></span>
<span id="cb175-28"><a href="run-rsa-searchlight.html#cb175-28" aria-hidden="true" tabindex="-1"></a>rsa_dat <span class="ot">&lt;-</span> rsa_dat[<span class="fu">with</span>(rsa_dat, <span class="fu">order</span>(sub_id, day1, day2, event1, event2)),]</span>
<span id="cb175-29"><a href="run-rsa-searchlight.html#cb175-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-30"><a href="run-rsa-searchlight.html#cb175-30" aria-hidden="true" tabindex="-1"></a><span class="co"># write to file</span></span>
<span id="cb175-31"><a href="run-rsa-searchlight.html#cb175-31" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dirs<span class="sc">$</span>data4analysis, <span class="st">&quot;rsa_data_in_same-seq_searchlight_peak.txt&quot;</span>)</span>
<span id="cb175-32"><a href="run-rsa-searchlight.html#cb175-32" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(rsa_dat, fn, <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>,</span>
<span id="cb175-33"><a href="run-rsa-searchlight.html#cb175-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">dec =</span> <span class="st">&quot;.&quot;</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">col.names =</span> <span class="cn">TRUE</span>)</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="prepare-fmri-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="rsa-on-pattern-similarity-change.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
